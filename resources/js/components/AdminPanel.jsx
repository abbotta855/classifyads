import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { utcToLocalDateTime, localDateTimeToUTC, getUserTimezone, initializeTimezone } from '../utils/timezone';
import { useAuth } from '../contexts/AuthContext';
import { useParams, useNavigate, Link, useLocation } from 'react-router-dom';
import Layout from './Layout';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { Button } from './ui/button';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { adminAPI, getAdUrl } from '../utils/api';
import PhotoCropModal from './PhotoCropModal';
import axios from 'axios';

// Job category options
const JOB_CATEGORY_OPTIONS = [
  'Accounting',
  'Agriculture Job',
  'Architecture Job',
  'Art Job',
  'Automotive Job',
  'Banking Job',
  'Construction Job',
  'Courier & parcel delivery Job',
  'Customer service Job',
  'Education',
  'Engineering job',
  'Executive Job',
  'Fitness Job',
  'Food & Beverage Job',
  'General labor Job',
  'Government job',
  'Healthcare job',
  'Hospitality & tourism job',
  'Human resources job',
  'Insurance Job',
  'Internet Web Job',
  'IT Job',
  'Legal job',
  'Management job',
  'Manufacturing & operations job',
  'Marketing Job',
  'Media & communications job',
  'Office & Administration job',
  'Real estate Job',
  'Retail job',
  'Sales Job',
  'Salon Job',
  'Security Job',
  'Software Developer Job',
  'Spa Job',
  'Systems / network Job',
  'Technical support Job',
  'Television/ Radio Job',
  'Transport Job',
  'Web design Job',
  'Writing / editing Job',
  'Other',
];

function AdminPanel() {
  const { user } = useAuth();
  const { section, subsection } = useParams();
  const navigate = useNavigate();
  const location = useLocation();
  const activeSection = section || null; // No section selected when on /admin
  const activeSubsection = subsection || null;
  
  // Set selectedRole based on user role - super_admin always uses super-admin role
  const isSuperAdmin = user?.role === 'super_admin';
  const isSuperAdminRoute = location.pathname.startsWith('/super_admin');
  const [selectedRole, setSelectedRole] = useState(
    isSuperAdmin ? 'super-admin' : 'admin'
  );
  
  // Update selectedRole when user changes - super_admin always uses super-admin
  useEffect(() => {
    if (!user) return;
    
    if (isSuperAdmin) {
      setSelectedRole('super-admin');
      // Redirect to super_admin route if on admin route
      if (location.pathname.startsWith('/admin')) {
        const path = location.pathname.replace('/admin', '/super_admin');
        navigate(path, { replace: true });
      }
    } else if (user.role === 'admin') {
      setSelectedRole('admin');
      // Redirect to admin route if on super_admin route (only for regular admins)
      if (location.pathname.startsWith('/super_admin')) {
        const path = location.pathname.replace('/super_admin', '/admin');
        navigate(path, { replace: true });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user?.role]); // Only depend on user role to avoid loops
  const [showAuctionForm, setShowAuctionForm] = useState(false);
  const [showPostAdForm, setShowPostAdForm] = useState(false);
  const [showAddLocationForm, setShowAddLocationForm] = useState(false);
  const [showAddCategoryForm, setShowAddCategoryForm] = useState(false);
  const [auctions, setAuctions] = useState([]);
  const [auctionsLoading, setAuctionsLoading] = useState(false);
  const [editingAuction, setEditingAuction] = useState(null);
  const [showEditAuctionModal, setShowEditAuctionModal] = useState(false);
  const [auctionFormData, setAuctionFormData] = useState({
    user_id: '',
    category_id: '',
    location_id: '',
    title: '',
    description: '',
    starting_price: '',
    reserve_price: '',
    buy_now_price: '',
    bid_increment: '1.00',
    start_time: '',
    end_time: '',
  });
  const [auctionImages, setAuctionImages] = useState([null, null, null, null]);
  // Auction category dropdown state
  const [auctionSelectedCategoryName, setAuctionSelectedCategoryName] = useState(''); // Selected category for Auction form
  const [auctionSelectedSubcategoryId, setAuctionSelectedSubcategoryId] = useState(''); // Selected subcategory for Auction form
  const [auctionSelectedItemCategoryId, setAuctionSelectedItemCategoryId] = useState(''); // Selected item category for Auction form
  const [auctionShowCategoryDropdown, setAuctionShowCategoryDropdown] = useState(false); // Category dropdown for Auction form
  const [auctionExpandedCategories, setAuctionExpandedCategories] = useState(new Set()); // Expanded categories for Auction (using name as key)
  const [auctionExpandedSubcategories, setAuctionExpandedSubcategories] = useState(new Set()); // Expanded subcategories for Auction (using name as key)
  const auctionCategoryDropdownRef = useRef(null);
  // Auction location dropdown state (hierarchical tree like Post Ad)
  const [auctionSelectedLocations, setAuctionSelectedLocations] = useState(new Set()); // Selected locations for Auction form (single selection)
  const [auctionShowLocationDropdown, setAuctionShowLocationDropdown] = useState(false); // Location dropdown for Auction form
  const [auctionExpandedProvinces, setAuctionExpandedProvinces] = useState(new Set()); // For Auction location dropdown
  const [auctionExpandedDistricts, setAuctionExpandedDistricts] = useState(new Set()); // For Auction location dropdown
  const [auctionExpandedLocalLevels, setAuctionExpandedLocalLevels] = useState(new Set()); // For Auction location dropdown
  const auctionLocationDropdownRef = useRef(null);
  const isAuctionParentToggleInProgress = useRef(false); // Flag to prevent useEffect sync during parent toggle
  const isAuctionIndividualAddressToggle = useRef(false); // Flag to prevent useEffect sync during individual address selection
  // Crop modal state for ads
  const [cropImageIndex, setCropImageIndex] = useState(null);
  const [cropImageFile, setCropImageFile] = useState(null);
  const [cropImageType, setCropImageType] = useState(null); // 'ad' or 'auction'
  const [postAdFormData, setPostAdFormData] = useState({
    title: '',
    description: '',
    price: '',
    category_id: '',
    user_id: '',
  });
  const [postAdImages, setPostAdImages] = useState([null, null, null, null]); // 4 image slots
  const [postAdSelectedCategoryName, setPostAdSelectedCategoryName] = useState(''); // Selected category for Post Ad form
  const [postAdSelectedSubcategoryId, setPostAdSelectedSubcategoryId] = useState(''); // Selected subcategory for Post Ad form
  const [postAdSelectedItemCategoryId, setPostAdSelectedItemCategoryId] = useState(''); // Selected item category for Post Ad form
  const [postAdShowCategoryDropdown, setPostAdShowCategoryDropdown] = useState(false); // Category dropdown for Post Ad form
  const [postAdExpandedCategories, setPostAdExpandedCategories] = useState(new Set()); // Expanded categories for Post Ad (using name as key)
  const [postAdExpandedSubcategories, setPostAdExpandedSubcategories] = useState(new Set()); // Expanded subcategories for Post Ad (using name as key)
  const [postAdSelectedLocations, setPostAdSelectedLocations] = useState(new Set()); // Selected locations for Post Ad form
  const [postAdShowLocationDropdown, setPostAdShowLocationDropdown] = useState(false); // Location dropdown for Post Ad form
  const [postAdExpandedProvinces, setPostAdExpandedProvinces] = useState(new Set()); // For Post Ad location dropdown
  const [postAdExpandedDistricts, setPostAdExpandedDistricts] = useState(new Set()); // For Post Ad location dropdown
  const [postAdExpandedLocalLevels, setPostAdExpandedLocalLevels] = useState(new Set()); // For Post Ad location dropdown
  const postAdCategoryDropdownRef = useRef(null);
  const postAdLocationDropdownRef = useRef(null);
  const [addLocationFormData, setAddLocationFormData] = useState({
    province: '',
    district: '',
    localLevel: '',
    localLevelType: 'Municipality',
    wardNumber: '',
    localAddress: '',
  });
  const [addCategoryFormData, setAddCategoryFormData] = useState({
    domainCategoryName: '',
    fieldCategoryName: '',
    itemCategoryName: '',
  });
  const [users, setUsers] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchCategory, setSearchCategory] = useState('');
  const [categories, setCategories] = useState([]); // Main categories for search bar (from API with subcategories)
  const [flattenedCategories, setFlattenedCategories] = useState([]); // All categories + subcategories for forms
  const [locationData, setLocationData] = useState({ provinces: [] }); // Location data from database
  const [showLocationDropdown, setShowLocationDropdown] = useState(false);
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
  const [selectedCategoryName, setSelectedCategoryName] = useState(''); // Selected category name for showing subcategories
  const [selectedSubcategoryId, setSelectedSubcategoryId] = useState(''); // Selected subcategory ID
  const [loading, setLoading] = useState(true);
  const locationDropdownRef = useRef(null);
  const categoryDropdownRef = useRef(null);
  
  // New state variables for search bar matching Homepage design
  const [expandedCategories, setExpandedCategories] = useState(new Set()); // For category dropdown - track expanded categories (using name as key)
  const [expandedSubcategories, setExpandedSubcategories] = useState(new Set()); // For subcategory dropdown - track expanded subcategories (using name as key)
  const [selectedCategories, setSelectedCategories] = useState(new Set()); // Selected category IDs (checkboxes)
  const [selectedSubcategories, setSelectedSubcategories] = useState(new Set()); // Selected subcategory IDs (checkboxes)
  const [expandedWards, setExpandedWards] = useState(new Set()); // For search bar location dropdown - ward expansion
  const [adSort, setAdSort] = useState('most relevant'); // Sort option matching Homepage
  const [currentPage, setCurrentPage] = useState(1);
  const adsPerPage = 40; // Matching Homepage

  // Ad totals and ads data
  const [adTotals, setAdTotals] = useState({
    userPosted: 0,
    vendorPosted: 0,
    adminPosted: 0,
    total: 0
  });
  const [ads, setAds] = useState([]);
  const [adsLoading, setAdsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [successMessage, setSuccessMessage] = useState(null);
  const [editingAdId, setEditingAdId] = useState(null);
  const [editingAdData, setEditingAdData] = useState(null);
  const [editingAdSelectedCategoryName, setEditingAdSelectedCategoryName] = useState(''); // Selected category for Edit Ad form
  const [editingAdSelectedSubcategoryId, setEditingAdSelectedSubcategoryId] = useState(''); // Selected subcategory for Edit Ad form
  const [editingAdSelectedItemCategoryId, setEditingAdSelectedItemCategoryId] = useState(''); // Selected item category for Edit Ad form
  const [editingAdShowCategoryDropdown, setEditingAdShowCategoryDropdown] = useState(false); // Category dropdown for Edit Ad form
  const [editingAdExpandedCategories, setEditingAdExpandedCategories] = useState(new Set()); // Expanded categories for Edit Ad (using name as key)
  const [editingAdExpandedSubcategories, setEditingAdExpandedSubcategories] = useState(new Set()); // Expanded subcategories for Edit Ad (using name as key)
  const [editingAdSelectedLocations, setEditingAdSelectedLocations] = useState(new Set()); // Selected locations for Edit Ad form
  const [editingAdShowLocationDropdown, setEditingAdShowLocationDropdown] = useState(false); // Location dropdown for Edit Ad form
  const [editingAdExpandedProvinces, setEditingAdExpandedProvinces] = useState(new Set()); // For Edit Ad location dropdown
  const [editingAdExpandedDistricts, setEditingAdExpandedDistricts] = useState(new Set()); // For Edit Ad location dropdown
  const [editingAdExpandedLocalLevels, setEditingAdExpandedLocalLevels] = useState(new Set()); // For Edit Ad location dropdown
  const editingAdCategoryDropdownRef = useRef(null);
  const editingAdLocationDropdownRef = useRef(null);

  // Location data - fetched from database via API
  const [locations, setLocations] = useState([]);
  const [locationsLoading, setLocationsLoading] = useState(false);
  const [editingLocationId, setEditingLocationId] = useState(null);
  const [editingLocationData, setEditingLocationData] = useState(null);

  // Category management data - fetched from database via API
  const [categoryManagementData, setCategoryManagementData] = useState([]);
  const [categoryManagementLoading, setCategoryManagementLoading] = useState(false);

  // eBook management data
  const [ebookData, setEbookData] = useState([]);
  const [ebookLoading, setEbookLoading] = useState(false);
  const [editingEbookId, setEditingEbookId] = useState(null);
  const [editingEbookData, setEditingEbookData] = useState(null);
  const [showAddEbookForm, setShowAddEbookForm] = useState(false);
  const [showEditEbookModal, setShowEditEbookModal] = useState(false);
  const [ebookFormData, setEbookFormData] = useState({
    user_id: '',
    category_id: '',
    title: '',
    description: '',
    writer: '',
    language: '',
    pages: '',
    book_size: '',
    file_format: '',
    price: '',
    publisher_name: '',
    publisher_address: '',
    publisher_website: '',
    publisher_email: '',
    publisher_phone: '',
    copyright_declared: false,
    book_type: 'ebook',
    shipping_cost: '',
    delivery_time: '',
    status: 'active',
  });
  const [ebookFile, setEbookFile] = useState(null);
  const [ebookCoverImage, setEbookCoverImage] = useState(null);
  // E-Book category dropdown state
  const [ebookSelectedCategoryName, setEbookSelectedCategoryName] = useState(''); // Selected category for E-Book form
  const [ebookSelectedSubcategoryId, setEbookSelectedSubcategoryId] = useState(''); // Selected subcategory for E-Book form
  const [ebookSelectedItemCategoryId, setEbookSelectedItemCategoryId] = useState(''); // Selected item category for E-Book form
  const [ebookShowCategoryDropdown, setEbookShowCategoryDropdown] = useState(false); // Category dropdown for E-Book form
  const [ebookExpandedCategories, setEbookExpandedCategories] = useState(new Set()); // Expanded categories for E-Book (using name as key)
  const [ebookExpandedSubcategories, setEbookExpandedSubcategories] = useState(new Set()); // Expanded subcategories for E-Book (using name as key)
  const ebookCategoryDropdownRef = useRef(null);
  // Edit E-Book category dropdown state
  const [editingEbookSelectedCategoryName, setEditingEbookSelectedCategoryName] = useState(''); // Selected category for Edit E-Book form
  const [editingEbookSelectedSubcategoryId, setEditingEbookSelectedSubcategoryId] = useState(''); // Selected subcategory for Edit E-Book form
  const [editingEbookSelectedItemCategoryId, setEditingEbookSelectedItemCategoryId] = useState(''); // Selected item category for Edit E-Book form
  const [editingEbookShowCategoryDropdown, setEditingEbookShowCategoryDropdown] = useState(false); // Category dropdown for Edit E-Book form
  const [editingEbookExpandedCategories, setEditingEbookExpandedCategories] = useState(new Set()); // Expanded categories for Edit E-Book (using name as key)
  const [editingEbookExpandedSubcategories, setEditingEbookExpandedSubcategories] = useState(new Set()); // Expanded subcategories for Edit E-Book (using name as key)
  const editingEbookCategoryDropdownRef = useRef(null);
  const [editingCategoryId, setEditingCategoryId] = useState(null);
  const [editingCategoryData, setEditingCategoryData] = useState(null);

  // Nepali Products management data
  const [nepaliProducts, setNepaliProducts] = useState([]);
  const [nepaliProductsLoading, setNepaliProductsLoading] = useState(false);
  const [nepaliProductsStatusFilter, setNepaliProductsStatusFilter] = useState('pending'); // pending, approved, rejected
  const [viewingNepaliProduct, setViewingNepaliProduct] = useState(null);

  // Order management data
  const [orders, setOrders] = useState([]);
  const [ordersLoading, setOrdersLoading] = useState(false);
  const [ordersStatusFilter, setOrdersStatusFilter] = useState('');
  const [viewingOrder, setViewingOrder] = useState(null);

  // Bidding history data - fetched from database via API
  const [biddingHistoryData, setBiddingHistoryData] = useState([]);
  const [biddingHistoryGrouped, setBiddingHistoryGrouped] = useState([]);
  const [expandedAuctionIds, setExpandedAuctionIds] = useState(new Set());
  const [biddingHistoryLoading, setBiddingHistoryLoading] = useState(false);
  const [selectedAuctionIds, setSelectedAuctionIds] = useState([]); // Array of selected auction IDs
  const [availableAuctions, setAvailableAuctions] = useState([]); // List of auctions with bidding history
  const [editingBiddingHistoryId, setEditingBiddingHistoryId] = useState(null);
  const [editingBiddingHistoryData, setEditingBiddingHistoryData] = useState(null);

  // Bid winner data - fetched from database via API
  const [bidWinnerData, setBidWinnerData] = useState([]);
  const [bidWinnerLoading, setBidWinnerLoading] = useState(false);
  const [editingBidWinnerId, setEditingBidWinnerId] = useState(null);
  const [editingBidWinnerData, setEditingBidWinnerData] = useState(null);

  // Blocked user data - fetched from database via API
  const [blockedUserData, setBlockedUserData] = useState([]);
  const [blockedUserLoading, setBlockedUserLoading] = useState(false);
  const [editingBlockedUserId, setEditingBlockedUserId] = useState(null);
  const [editingBlockedUserData, setEditingBlockedUserData] = useState(null);

  // Bidding tracking data - fetched from database via API
  const [biddingTrackingData, setBiddingTrackingData] = useState([]);
  const [biddingTrackingLoading, setBiddingTrackingLoading] = useState(false);
  const [editingBiddingTrackingId, setEditingBiddingTrackingId] = useState(null);
  const [editingBiddingTrackingData, setEditingBiddingTrackingData] = useState(null);

  // Delivery management data - fetched from database via API
  const [deliveryData, setDeliveryData] = useState([]);
  const [deliveryLoading, setDeliveryLoading] = useState(false);
  const [editingDeliveryId, setEditingDeliveryId] = useState(null);
  const [editingDeliveryData, setEditingDeliveryData] = useState(null);

  // Purchase verification data - fetched from database via API
  const [purchaseVerificationData, setPurchaseVerificationData] = useState([]);
  const [purchaseVerificationLoading, setPurchaseVerificationLoading] = useState(false);
  const [editingPurchaseVerificationId, setEditingPurchaseVerificationId] = useState(null);
  const [editingPurchaseVerificationData, setEditingPurchaseVerificationData] = useState(null);

  // Job management data
  const [jobCategories, setJobCategories] = useState([]);
  const [jobCategoriesLoading, setJobCategoriesLoading] = useState(false);
  const [editingJobCategoryId, setEditingJobCategoryId] = useState(null);
  const [editingJobCategoryData, setEditingJobCategoryData] = useState(null);
  const [showAddJobCategoryForm, setShowAddJobCategoryForm] = useState(false);
  const [jobCategoryFormData, setJobCategoryFormData] = useState({
    job_category_name: '',
    job_status: 'draft',
  });

  const [jobApplicants, setJobApplicants] = useState([]);
  const [jobApplicantsLoading, setJobApplicantsLoading] = useState(false);
  const [editingJobApplicantId, setEditingJobApplicantId] = useState(null);
  const [editingJobApplicantData, setEditingJobApplicantData] = useState(null);
  const [showPostJobApplicantForm, setShowPostJobApplicantForm] = useState(false);
  const [showApplyJobForm, setShowApplyJobForm] = useState(false);
  const [jobApplicantFormData, setJobApplicantFormData] = useState({
    job_title: '',
    posted_date: '',
    expected_salary: '',
    applicant_name: '',
    interview_date: '',
    job_progress: 'applied',
    job_category_id: '',
  });
  const [applyJobFormData, setApplyJobFormData] = useState({
    job_title: '',
    applicant_name: '',
    expected_salary: '',
    posted_date: '',
    interview_date: '',
    job_progress: 'applied',
  });
  const [jobApplicantFiles, setJobApplicantFiles] = useState({
    cv_file: null,
    cover_letter_file: null,
    reference_letter_file: null,
  });
  const [applyJobFiles, setApplyJobFiles] = useState({
    cv_file: null,
    cover_letter_file: null,
    reference_letter_file: null,
  });

  // Live chat data
  const [liveChats, setLiveChats] = useState([]);
  const [liveChatsLoading, setLiveChatsLoading] = useState(false);
  const [liveChatUnreadCount, setLiveChatUnreadCount] = useState(0);
  const [selectedLiveChat, setSelectedLiveChat] = useState(null);
  const [chatMessages, setChatMessages] = useState([]);
  const [chatMessagesLoading, setChatMessagesLoading] = useState(false);
  const [liveChatError, setLiveChatError] = useState(null);
  const [openChatSelectedUserId, setOpenChatSelectedUserId] = useState('');
  const [openChatQuery, setOpenChatQuery] = useState('');
  const [newChatMessage, setNewChatMessage] = useState('');

  // Offers/Discounts data
  const [offers, setOffers] = useState([]);
  const [offersLoading, setOffersLoading] = useState(false);
  const [editingOfferId, setEditingOfferId] = useState(null);
  const [editingOfferData, setEditingOfferData] = useState(null);
  const [showPostDiscountForm, setShowPostDiscountForm] = useState(false);
  const [offerFormData, setOfferFormData] = useState({
    item_name: '',
    vendor_id: '',
    offer_percentage: '',
    created_date: '',
    valid_until: '',
    status: 'pending',
  });

  // Ratings/Reviews data
  const [ratings, setRatings] = useState([]);
  const [ratingsLoading, setRatingsLoading] = useState(false);
  const [editingRatingId, setEditingRatingId] = useState(null);
  const [editingRatingData, setEditingRatingData] = useState(null);
  
  // Rating Criteria data
  const [ratingCriteria, setRatingCriteria] = useState([]);
  const [ratingCriteriaLoading, setRatingCriteriaLoading] = useState(false);
  const [editingCriteriaId, setEditingCriteriaId] = useState(null);
  const [editingCriteriaData, setEditingCriteriaData] = useState(null);
  const [showAddCriteriaForm, setShowAddCriteriaForm] = useState(false);
  const [criteriaFormData, setCriteriaFormData] = useState({
    name: '',
    description: '',
    sort_order: 0,
    is_active: true,
  });

  // Change Password data (Super Admin only - for changing other users' passwords)
  const [changePasswordData, setChangePasswordData] = useState({
    user_id: '',
    new_password: '',
    new_password_confirmation: '',
  });
  const [changingPassword, setChangingPassword] = useState(false);

  // Sales Report data
  const [salesReport, setSalesReport] = useState(null);
  const [salesReportLoading, setSalesReportLoading] = useState(false);
  const [editingSalesReportId, setEditingSalesReportId] = useState(null);
  const [editingSalesReportData, setEditingSalesReportData] = useState(null);

  // Stock Management data
  const [stockManagement, setStockManagement] = useState([]);
  const [stockManagementLoading, setStockManagementLoading] = useState(false);
  const [lowStockAlerts, setLowStockAlerts] = useState([]);
  const [editingStockId, setEditingStockId] = useState(null);
  const [editingStockData, setEditingStockData] = useState(null);
  const [showStockAlert, setShowStockAlert] = useState(false);
  const [stockManagementCategories, setStockManagementCategories] = useState([]); // All categories grouped by main category
  const [stockManagementMainCategories, setStockManagementMainCategories] = useState([]); // Unique main categories

  // Email Subscriber List data
  const [emailSubscribers, setEmailSubscribers] = useState([]);
  const [emailSubscribersLoading, setEmailSubscribersLoading] = useState(false);
  const [editingEmailSubscriberId, setEditingEmailSubscriberId] = useState(null);
  const [editingEmailSubscriberData, setEditingEmailSubscriberData] = useState(null);
  const [showAddEmailSubscriberForm, setShowAddEmailSubscriberForm] = useState(false);
  const [addEmailSubscriberFormData, setAddEmailSubscriberFormData] = useState({
    user_id: '',
    username: '',
    email: '',
    subscribe_volume: '',
    amount: '',
    start_date: '',
    end_date: '',
    subscription_type: '',
  });

  // Support Management data
  const [supportManagement, setSupportManagement] = useState([]);
  const [unsolvedIssues, setUnsolvedIssues] = useState([]);
  const [supportManagementLoading, setSupportManagementLoading] = useState(false);
  const [editingSupportId, setEditingSupportId] = useState(null);
  const [editingSupportData, setEditingSupportData] = useState(null);
  const [showAddSupportForm, setShowAddSupportForm] = useState(false);
  const [addSupportFormData, setAddSupportFormData] = useState({
    issue_error: '',
    issue_reporter_id: '',
    date: '',
    assign_to_id: '',
    assign_date: '',
    error_status: 'pending',
    note_solution: '',
  });

  // Transaction Management data
  const [transactionManagement, setTransactionManagement] = useState([]);
  const [earningSummary, setEarningSummary] = useState(null);
  const [transactionManagementLoading, setTransactionManagementLoading] = useState(false);
  const [editingTransactionId, setEditingTransactionId] = useState(null);
  const [editingTransactionData, setEditingTransactionData] = useState(null);
  const [showEditTransactionModal, setShowEditTransactionModal] = useState(false);
  const [showPostAdTransactionForm, setShowPostAdTransactionForm] = useState(false);
  
  // Wallet Transactions data
  const [walletTransactions, setWalletTransactions] = useState([]);
  const [walletTransactionsLoading, setWalletTransactionsLoading] = useState(false);
  const [walletTransactionTypeFilter, setWalletTransactionTypeFilter] = useState('all'); // all, deposit, withdraw, seller_verification
  const [walletTransactionStatusFilter, setWalletTransactionStatusFilter] = useState('all'); // all, pending, completed, failed, cancelled
  const [transactionManagementTab, setTransactionManagementTab] = useState('ad-post'); // 'ad-post' or 'wallet'
  
  // Modal states for edit modals
  const [showEditAdModal, setShowEditAdModal] = useState(false);
  const [showEditJobApplicantModal, setShowEditJobApplicantModal] = useState(false);
  const [showEditOfferModal, setShowEditOfferModal] = useState(false);
  const [showEditStockModal, setShowEditStockModal] = useState(false);
  const [showEditSupportModal, setShowEditSupportModal] = useState(false);
  const [showEditUserModal, setShowEditUserModal] = useState(false);
  const [postAdTransactionFormData, setPostAdTransactionFormData] = useState({
    vendor_id: '',
    num_of_posted_ad: '',
    category_id: '',
    amount: '',
    payment_method: 'Credit Card',
    start_date: '',
    end_date: '',
    email: '',
    status: 'active',
  });
  const [transactionSelectedCategoryName, setTransactionSelectedCategoryName] = useState(''); // Selected category for Transaction form
  const [transactionSelectedSubcategoryId, setTransactionSelectedSubcategoryId] = useState(''); // Selected subcategory for Transaction form
  const [transactionShowCategoryDropdown, setTransactionShowCategoryDropdown] = useState(false); // Category dropdown for Transaction form
  const transactionCategoryDropdownRef = useRef(null);
  const [showCategoryWiseDropdown, setShowCategoryWiseDropdown] = useState(false);

  // User Management data
  const [userManagementData, setUserManagementData] = useState([]);
  const [totalUsers, setTotalUsers] = useState(0);
  const [totalVendors, setTotalVendors] = useState(0);
  const [userManagementLoading, setUserManagementLoading] = useState(false);
  const [editingUserId, setEditingUserId] = useState(null);
  const [editingUserData, setEditingUserData] = useState(null);
  const [editingUserSelectedLocations, setEditingUserSelectedLocations] = useState(new Set()); // Selected locations for Edit User form
  const [editingUserShowLocationDropdown, setEditingUserShowLocationDropdown] = useState(false); // Location dropdown for Edit User form
  const [editingUserExpandedProvinces, setEditingUserExpandedProvinces] = useState(new Set()); // For Edit User location dropdown
  const [editingUserExpandedDistricts, setEditingUserExpandedDistricts] = useState(new Set()); // For Edit User location dropdown
  const [editingUserExpandedLocalLevels, setEditingUserExpandedLocalLevels] = useState(new Set()); // For Edit User location dropdown
  const editingUserLocationDropdownRef = useRef(null);
  const [commentingUserId, setCommentingUserId] = useState(null);
  const [userComment, setUserComment] = useState('');

  // Fetch ads data
  useEffect(() => {
    if (activeSection === 'ads-management' || !activeSection) {
      fetchAds();
      fetchUsers();
    }
  }, [activeSection, activeSubsection]);

  // Sync auctionSelectedLocations with auctionFormData.location_id when locationData is available
  // Skip sync if we're in the middle of a parent toggle or individual address selection to prevent resetting the selection
  useEffect(() => {
    // Skip sync if parent toggle or individual address selection is in progress
    if (isAuctionParentToggleInProgress.current || isAuctionIndividualAddressToggle.current) {
      return;
    }
    
    if (auctionFormData.location_id && locationData?.provinces && locationData.provinces.length > 0) {
      const locationIdStr = auctionFormData.location_id.toString();
      const selectedLocationIds = new Set();
      let foundWard = false;
      
      // Find the ward with this location_id and populate selectedLocationIds with ward + all local addresses
      for (const province of locationData.provinces) {
        for (const district of province.districts || []) {
          for (const localLevel of district.localLevels || []) {
            for (const ward of localLevel.wards || []) {
              if (ward.id.toString() === locationIdStr) {
                // Found the ward - add ward ID and all local addresses
                foundWard = true;
                selectedLocationIds.add(ward.id.toString());
                if (ward.local_addresses && ward.local_addresses.length > 0) {
                  ward.local_addresses.forEach((_, idx) => {
                    selectedLocationIds.add(`${ward.id}-${idx}`);
                  });
                }
                // Expand the hierarchy so user can see the selected location
                setAuctionExpandedProvinces(prev => new Set([...prev, province.id]));
                setAuctionExpandedDistricts(prev => new Set([...prev, `${province.id}-${district.id}`]));
                setAuctionExpandedLocalLevels(prev => new Set([...prev, `${province.id}-${district.id}-${localLevel.id}`]));
                break;
              }
            }
            if (foundWard) break;
          }
          if (foundWard) break;
        }
        if (foundWard) break;
      }
      
      // Only update if we found the ward and the selection is different
      if (foundWard) {
        const currentIds = Array.from(auctionSelectedLocations).sort().join(',');
        const newIds = Array.from(selectedLocationIds).sort().join(',');
        if (currentIds !== newIds) {
          setAuctionSelectedLocations(selectedLocationIds);
        }
      }
    } else if (!auctionFormData.location_id) {
      // Clear selection if location_id is cleared (but not if parent toggle is in progress)
      if (auctionSelectedLocations.size > 0) {
        setAuctionSelectedLocations(new Set());
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [auctionFormData.location_id, locationData]);

  // Fetch users and categories for auction form
  useEffect(() => {
    if (activeSection === 'auction-management') {
      fetchUsers();
    }
  }, [activeSection]);

  // Fetch offers data
  useEffect(() => {
    if (activeSection === 'offer-discount') {
      fetchOffers();
      fetchUsers();
    }
  }, [activeSection]);

  // Fetch ratings data
  useEffect(() => {
    if (activeSection === 'rating-review') {
      fetchRatings();
      fetchUsers();
      fetchRatingCriteria();
    }
  }, [activeSection]);

  // Fetch sales report data
  useEffect(() => {
    if (activeSection === 'sales-report') {
      fetchSalesReport();
      fetchUsers();
    }
  }, [activeSection]);

  // Fetch stock management data
  useEffect(() => {
    if (activeSection === 'stock-management') {
      fetchStockManagement();
      fetchUsers();
      fetchStockManagementCategories();
    }
  }, [activeSection]);

  // Fetch email subscriber data
  useEffect(() => {
    if (activeSection === 'email-subscriber') {
      fetchEmailSubscribers();
      fetchUsers();
    }
  }, [activeSection]);

  // Fetch support management data
  useEffect(() => {
    if (activeSection === 'support-management') {
      fetchSupportManagement();
      fetchUsers();
    }
  }, [activeSection]);

  // Fetch transaction management data
  useEffect(() => {
    if (activeSection === 'transaction-management') {
      fetchTransactionManagement();
      fetchUsers();
      fetchCategories();
    }
  }, [activeSection]);

  // Fetch wallet transactions when wallet tab is active
  useEffect(() => {
    if (activeSection === 'transaction-management' && transactionManagementTab === 'wallet') {
      fetchWalletTransactions();
    }
  }, [activeSection, transactionManagementTab, walletTransactionTypeFilter, walletTransactionStatusFilter]);

  // Fetch user management data
  useEffect(() => {
    if (activeSection === 'user-management') {
      fetchUserManagement();
    }
  }, [activeSection]);

  // Fetch users for change password section
  useEffect(() => {
    if (activeSection === 'change-password' && isSuperAdmin) {
      fetchUsers();
    }
  }, [activeSection, isSuperAdmin]);

  // Check for low stock alerts periodically
  useEffect(() => {
    const interval = setInterval(() => {
      if (activeSection === 'stock-management') {
        fetchStockManagement();
      }
    }, 30000); // Check every 30 seconds

    return () => clearInterval(interval);
  }, [activeSection]);

  // Fetch job management data
  useEffect(() => {
    if (activeSection === 'job-management') {
      fetchJobCategories();
      fetchJobApplicants();
    }
  }, [activeSection]);

  useEffect(() => {
    if (activeSection === 'live-chat') {
      fetchLiveChats();
      fetchUsers();
    }
  }, [activeSection]);

  // Poll live chats to keep unread badge updated even when not in Live Chat section
  useEffect(() => {
    fetchLiveChats();
    const interval = setInterval(fetchLiveChats, 15000);
    return () => clearInterval(interval);
  }, []);

  // Fetch users for Post Ad form
  const fetchUsers = async () => {
    try {
      const response = await adminAPI.getUsers();
      
      // Handle different response structures - ensure we get an array
      let usersData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        usersData = response.data;
      }
      // Check if response.data.users exists and is an array (for user management endpoint)
      else if (response.data && response.data.users && Array.isArray(response.data.users)) {
        usersData = response.data.users;
      }
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        usersData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        usersData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        usersData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        usersData = [];
      }
      
      setUsers(usersData);
    } catch (err) {
      console.error('Error fetching users:', err);
      setUsers([]); // Set empty array on error
    }
  };

  const fetchJobCategories = async () => {
    setJobCategoriesLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getJobCategories();
      
      // Handle different response structures - ensure we get an array
      let jobCategoriesData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        jobCategoriesData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        jobCategoriesData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        jobCategoriesData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        jobCategoriesData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        jobCategoriesData = [];
      }
      
      setJobCategories(jobCategoriesData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch job categories: ' + errorMessage);
      console.error('Error fetching job categories:', err);
      console.error('Error response:', err.response);
      setJobCategories([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setJobCategoriesLoading(false);
    }
  };

  const fetchJobApplicants = async () => {
    setJobApplicantsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getJobApplicants();
      
      // Handle different response structures - ensure we get an array
      let jobApplicantsData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        jobApplicantsData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        jobApplicantsData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        jobApplicantsData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        jobApplicantsData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        jobApplicantsData = [];
      }
      
      setJobApplicants(jobApplicantsData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch job applicants: ' + errorMessage);
      console.error('Error fetching job applicants:', err);
      console.error('Error response:', err.response);
      setJobApplicants([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setJobApplicantsLoading(false);
    }
  };

  const fetchOffers = async () => {
    setOffersLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getOffers();
      
      // Handle different response structures - ensure we get an array
      let offersData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        offersData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        offersData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        offersData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        offersData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        offersData = [];
      }
      
      setOffers(offersData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch offers: ' + errorMessage);
      console.error('Error fetching offers:', err);
      console.error('Error response:', err.response);
      setOffers([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setOffersLoading(false);
    }
  };

  const fetchRatings = async () => {
    setRatingsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getRatings();
      
      // Handle different response structures - ensure we get an array
      let ratingsData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        ratingsData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        ratingsData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        ratingsData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        ratingsData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        ratingsData = [];
      }
      
      setRatings(ratingsData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch ratings: ' + errorMessage);
      console.error('Error fetching ratings:', err);
      console.error('Error response:', err.response);
      setRatings([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setRatingsLoading(false);
    }
  };

  const fetchRatingCriteria = async () => {
    setRatingCriteriaLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getRatingCriteria();
      let criteriaData = [];
      
      if (Array.isArray(response.data)) {
        criteriaData = response.data;
      } else if (Array.isArray(response)) {
        criteriaData = response;
      } else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        criteriaData = response.data.data;
      } else {
        criteriaData = [];
      }
      
      setRatingCriteria(criteriaData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch rating criteria: ' + errorMessage);
      console.error('Error fetching rating criteria:', err);
      setRatingCriteria([]);
      setTimeout(() => setError(null), 5000);
    } finally {
      setRatingCriteriaLoading(false);
    }
  };

  const handleAddCriteriaSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createRatingCriteria(criteriaFormData);
      setSuccessMessage('Rating criteria added successfully');
      setShowAddCriteriaForm(false);
      setCriteriaFormData({
        name: '',
        description: '',
        sort_order: 0,
        is_active: true,
      });
      fetchRatingCriteria();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to add rating criteria: ' + (err.response?.data?.message || err.message));
      console.error('Error adding rating criteria:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditCriteria = (criteria) => {
    setEditingCriteriaId(criteria.id);
    setEditingCriteriaData({
      name: criteria.name,
      description: criteria.description || '',
      sort_order: criteria.sort_order || 0,
      is_active: criteria.is_active !== undefined ? criteria.is_active : true,
    });
  };

  const handleSaveCriteria = async (criteriaId) => {
    try {
      await adminAPI.updateRatingCriteria(criteriaId, editingCriteriaData);
      setSuccessMessage('Rating criteria updated successfully');
      setEditingCriteriaId(null);
      setEditingCriteriaData(null);
      fetchRatingCriteria();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update rating criteria: ' + (err.response?.data?.message || err.message));
      console.error('Error updating rating criteria:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditCriteria = () => {
    setEditingCriteriaId(null);
    setEditingCriteriaData(null);
  };

  const handleDeleteCriteria = async (criteriaId) => {
    if (!window.confirm('Are you sure you want to delete this rating criteria?')) {
      return;
    }
    try {
      await adminAPI.deleteRatingCriteria(criteriaId);
      setSuccessMessage('Rating criteria deleted successfully');
      fetchRatingCriteria();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete rating criteria: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting rating criteria:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleChangePassword = async (e) => {
    e.preventDefault();
    
    if (!changePasswordData.user_id) {
      setError('Please select a user.');
      setTimeout(() => setError(null), 5000);
      return;
    }

    // Validate passwords match
    if (changePasswordData.new_password !== changePasswordData.new_password_confirmation) {
      setError('New password and confirmation do not match.');
      setTimeout(() => setError(null), 5000);
      return;
    }

    // Validate password length
    if (changePasswordData.new_password.length < 8) {
      setError('New password must be at least 8 characters long.');
      setTimeout(() => setError(null), 5000);
      return;
    }

    setChangingPassword(true);
    setError(null);
    
    try {
      const response = await adminAPI.changePassword({
        user_id: changePasswordData.user_id,
        new_password: changePasswordData.new_password,
        new_password_confirmation: changePasswordData.new_password_confirmation,
      });
      
      const userName = response.data?.user?.name || 'User';
      setSuccessMessage(`Password changed successfully for ${userName}!`);
      setChangePasswordData({
        user_id: '',
        new_password: '',
        new_password_confirmation: '',
      });
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Failed to change password';
      setError(errorMessage);
      setTimeout(() => setError(null), 5000);
    } finally {
      setChangingPassword(false);
    }
  };

  const fetchSalesReport = async () => {
    setSalesReportLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getSalesReport();
      setSalesReport(response.data);
    } catch (err) {
      setError('Failed to fetch sales report: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching sales report:', err);
      setTimeout(() => setError(null), 5000);
    } finally {
      setSalesReportLoading(false);
    }
  };

  const fetchStockManagement = async () => {
    setStockManagementLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getStockManagement();
      setStockManagement(response.data.stocks || []);
      
      // Show alert if there are low stock items
      if (response.data.low_stock_alerts && response.data.low_stock_alerts.length > 0) {
        setLowStockAlerts(response.data.low_stock_alerts);
        setShowStockAlert(true);
      } else {
        setLowStockAlerts([]);
        setShowStockAlert(false);
      }
    } catch (err) {
      setError('Failed to fetch stock management: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching stock management:', err);
      setTimeout(() => setError(null), 5000);
    } finally {
      setStockManagementLoading(false);
    }
  };

  const fetchEmailSubscribers = async () => {
    setEmailSubscribersLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getEmailSubscribers();
      
      // Handle different response structures - ensure we get an array
      let emailSubscribersData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        emailSubscribersData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        emailSubscribersData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        emailSubscribersData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        emailSubscribersData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        emailSubscribersData = [];
      }
      
      setEmailSubscribers(emailSubscribersData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch email subscribers: ' + errorMessage);
      console.error('Error fetching email subscribers:', err);
      console.error('Error response:', err.response);
      setEmailSubscribers([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setEmailSubscribersLoading(false);
    }
  };

  const fetchSupportManagement = async () => {
    setSupportManagementLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getSupportManagement();
      
      // Handle different response structures - ensure we get arrays
      let supportsData = [];
      let unsolvedIssuesData = [];
      
      // Check if response.data exists
      if (response.data) {
        // Check if response.data.supports is an array
        if (Array.isArray(response.data.supports)) {
          supportsData = response.data.supports;
        } else if (response.data.supports) {
          console.error('Unexpected response format - response.data.supports is not an array:', response.data.supports);
          supportsData = [];
        }
        
        // Check if response.data.unsolved_issues is an array
        if (Array.isArray(response.data.unsolved_issues)) {
          unsolvedIssuesData = response.data.unsolved_issues;
        } else if (response.data.unsolved_issues) {
          console.error('Unexpected response format - response.data.unsolved_issues is not an array:', response.data.unsolved_issues);
          unsolvedIssuesData = [];
        }
      } else if (Array.isArray(response)) {
        // If response itself is an array, treat it as supports
        supportsData = response;
      } else {
        console.error('Unexpected response format:', response);
      }
      
      setSupportManagement(supportsData);
      setUnsolvedIssues(unsolvedIssuesData);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch support management: ' + errorMessage);
      console.error('Error fetching support management:', err);
      console.error('Error response:', err.response);
      setSupportManagement([]); // Set empty array on error
      setUnsolvedIssues([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setSupportManagementLoading(false);
    }
  };

  const fetchTransactionManagement = async () => {
    setTransactionManagementLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getTransactionManagement();
      setTransactionManagement(response.data.transactions || []);
      setEarningSummary(response.data.earning_summary || null);
    } catch (err) {
      setError('Failed to fetch transaction management: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching transaction management:', err);
      setTimeout(() => setError(null), 5000);
    } finally {
      setTransactionManagementLoading(false);
    }
  };

  const fetchWalletTransactions = async () => {
    setWalletTransactionsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getWalletTransactions(
        walletTransactionTypeFilter,
        walletTransactionStatusFilter
      );
      console.log('Wallet transactions API response:', response);
      console.log('Wallet transactions data:', response.data);
      // The API returns the array directly as response.data
      const transactions = Array.isArray(response.data) ? response.data : [];
      console.log('Processed transactions:', transactions);
      setWalletTransactions(transactions);
    } catch (err) {
      setError('Failed to fetch wallet transactions: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching wallet transactions:', err);
      console.error('Error response:', err.response);
      setTimeout(() => setError(null), 5000);
    } finally {
      setWalletTransactionsLoading(false);
    }
  };

  const fetchUserManagement = async () => {
    setUserManagementLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getUsers();
      setUserManagementData(response.data.users || []);
      setTotalUsers(response.data.total_users || 0);
      setTotalVendors(response.data.total_vendors || 0);
    } catch (err) {
      setError('Failed to fetch user management: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching user management:', err);
      setTimeout(() => setError(null), 5000);
    } finally {
      setUserManagementLoading(false);
    }
  };

  const handleAddJobCategorySubmit = async (e) => {
    e.preventDefault();
    
    if (!jobCategoryFormData.job_category_name) {
      setError('Please select a job category');
      setTimeout(() => setError(null), 5000);
      return;
    }

    try {
      await adminAPI.createJobCategory({
        job_category_name: jobCategoryFormData.job_category_name,
        job_status: jobCategoryFormData.job_status,
      });
      setSuccessMessage('Job category created successfully');
      setShowAddJobCategoryForm(false);
      setJobCategoryFormData({
        job_category_name: '',
        job_status: 'draft',
      });
      fetchJobCategories();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create job category: ' + (err.response?.data?.message || err.message));
      console.error('Error creating job category:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditJobCategory = (category) => {
    setEditingJobCategoryId(category.id);
    setEditingJobCategoryData({
      job_category_name: category.job_category_name || '',
      job_status: category.job_status,
    });
  };

  const handleSaveJobCategory = async (categoryId) => {
    try {
      if (!editingJobCategoryData.job_category_name) {
        setError('Please select a job category');
        setTimeout(() => setError(null), 5000);
        return;
      }

      await adminAPI.updateJobCategory(categoryId, {
        job_category_name: editingJobCategoryData.job_category_name,
        job_status: editingJobCategoryData.job_status,
      });
      setSuccessMessage('Job category updated successfully');
      setEditingJobCategoryId(null);
      setEditingJobCategoryData(null);
      fetchJobCategories();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update job category: ' + (err.response?.data?.message || err.message));
      console.error('Error updating job category:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditJobCategory = () => {
    setEditingJobCategoryId(null);
    setEditingJobCategoryData(null);
  };

  const handleDeleteJobCategory = async (categoryId) => {
    if (!window.confirm('Are you sure you want to delete this job category?')) {
      return;
    }
    try {
      await adminAPI.deleteJobCategory(categoryId);
      setSuccessMessage('Job category deleted successfully');
      fetchJobCategories();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete job category: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting job category:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handlePostJobApplicantSubmit = async (e) => {
    e.preventDefault();
    try {
      const formData = new FormData();
      formData.append('job_title', jobApplicantFormData.job_title);
      formData.append('applicant_name', jobApplicantFormData.applicant_name);
      formData.append('job_progress', jobApplicantFormData.job_progress);
      formData.append('job_category_id', jobApplicantFormData.job_category_id);
      
      if (jobApplicantFormData.posted_date) {
        formData.append('posted_date', jobApplicantFormData.posted_date);
      }
      if (jobApplicantFormData.expected_salary) {
        formData.append('expected_salary', parseFloat(jobApplicantFormData.expected_salary));
      }
      if (jobApplicantFormData.interview_date) {
        formData.append('interview_date', jobApplicantFormData.interview_date);
      }
      
      // Add file uploads
      if (jobApplicantFiles.cv_file) {
        formData.append('cv_file', jobApplicantFiles.cv_file);
      }
      if (jobApplicantFiles.cover_letter_file) {
        formData.append('cover_letter_file', jobApplicantFiles.cover_letter_file);
      }
      if (jobApplicantFiles.reference_letter_file) {
        formData.append('reference_letter_file', jobApplicantFiles.reference_letter_file);
      }

      await adminAPI.createJobApplicant(formData);
      setSuccessMessage('Job applicant posted successfully');
      setShowPostJobApplicantForm(false);
      setJobApplicantFormData({
        job_title: '',
        posted_date: '',
        expected_salary: '',
        applicant_name: '',
        interview_date: '',
        job_progress: 'applied',
        job_category_id: '',
      });
      setJobApplicantFiles({
        cv_file: null,
        cover_letter_file: null,
        reference_letter_file: null,
      });
      fetchJobApplicants();
      fetchJobCategories(); // Refresh categories to update counts
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to post job applicant: ' + (err.response?.data?.message || err.message));
      console.error('Error posting job applicant:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleApplyJobSubmit = async (e) => {
    e.preventDefault();
    try {
      const formData = new FormData();
      formData.append('job_title', applyJobFormData.job_title);
      formData.append('applicant_name', applyJobFormData.applicant_name);
      formData.append('job_progress', applyJobFormData.job_progress);
      
      if (applyJobFormData.expected_salary) {
        formData.append('expected_salary', parseFloat(applyJobFormData.expected_salary));
      }
      if (applyJobFormData.posted_date) {
        formData.append('posted_date', applyJobFormData.posted_date);
      }
      if (applyJobFormData.interview_date) {
        formData.append('interview_date', applyJobFormData.interview_date);
      }
      
      // Add file uploads
      if (applyJobFiles.cv_file) {
        formData.append('cv_file', applyJobFiles.cv_file);
      }
      if (applyJobFiles.cover_letter_file) {
        formData.append('cover_letter_file', applyJobFiles.cover_letter_file);
      }
      if (applyJobFiles.reference_letter_file) {
        formData.append('reference_letter_file', applyJobFiles.reference_letter_file);
      }

      await adminAPI.createJobApplicant(formData);
      setSuccessMessage('Job application submitted successfully');
      setShowApplyJobForm(false);
      setApplyJobFormData({
        job_title: '',
        applicant_name: '',
        expected_salary: '',
        posted_date: '',
        interview_date: '',
        job_progress: 'applied',
      });
      setApplyJobFiles({
        cv_file: null,
        cover_letter_file: null,
        reference_letter_file: null,
      });
      fetchJobApplicants();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to submit job application: ' + (err.response?.data?.message || err.message));
      console.error('Error submitting job application:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditJobApplicant = (applicant) => {
    setEditingJobApplicantId(applicant.id);
    setEditingJobApplicantData({
      job_title: applicant.job_title,
      posted_date: applicant.posted_date || '',
      expected_salary: applicant.expected_salary ?? '',
      applicant_name: applicant.applicant_name,
      interview_date: applicant.interview_date || '',
      job_progress: applicant.job_progress,
      job_category_id: applicant.job_category_id || '',
    });
    setShowEditJobApplicantModal(true);
  };

  const handleSaveJobApplicant = async (applicantId) => {
    try {
      await adminAPI.updateJobApplicant(applicantId, {
        ...editingJobApplicantData,
        expected_salary: editingJobApplicantData.expected_salary !== '' && editingJobApplicantData.expected_salary !== null
          ? parseFloat(editingJobApplicantData.expected_salary)
          : null,
        posted_date: editingJobApplicantData.posted_date || null,
        interview_date: editingJobApplicantData.interview_date || null,
        job_category_id: editingJobApplicantData.job_category_id || null,
      });
      setSuccessMessage('Job applicant updated successfully');
      setEditingJobApplicantId(null);
      setEditingJobApplicantData(null);
      setShowEditJobApplicantModal(false);
      fetchJobApplicants();
      fetchJobCategories(); // Refresh categories to update counts
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update job applicant: ' + (err.response?.data?.message || err.message));
      console.error('Error updating job applicant:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditJobApplicant = () => {
    setEditingJobApplicantId(null);
    setEditingJobApplicantData(null);
    setShowEditJobApplicantModal(false);
  };

  const handleDeleteJobApplicant = async (applicantId) => {
    if (!window.confirm('Are you sure you want to delete this job applicant?')) {
      return;
    }
    try {
      await adminAPI.deleteJobApplicant(applicantId);
      setSuccessMessage('Job applicant deleted successfully');
      fetchJobApplicants();
      fetchJobCategories(); // Refresh categories to update counts
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete job applicant: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting job applicant:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handlePostDiscountSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createOffer({
        item_name: offerFormData.item_name,
        vendor_id: parseInt(offerFormData.vendor_id, 10),
        offer_percentage: parseFloat(offerFormData.offer_percentage),
        created_date: offerFormData.created_date,
        valid_until: offerFormData.valid_until,
        status: offerFormData.status,
      });
      setSuccessMessage('Discount/Coupon created successfully');
      setShowPostDiscountForm(false);
      setOfferFormData({
        item_name: '',
        vendor_id: '',
        offer_percentage: '',
        created_date: '',
        valid_until: '',
        status: 'pending',
      });
      fetchOffers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create discount/coupon: ' + (err.response?.data?.message || err.message));
      console.error('Error creating discount/coupon:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditOffer = (offer) => {
    setEditingOfferId(offer.id);
    setEditingOfferData({
      item_name: offer.item_name,
      vendor_id: offer.vendor_id.toString(),
      offer_percentage: offer.offer_percentage.toString(),
      created_date: offer.created_date,
      valid_until: offer.valid_until,
      status: offer.status,
    });
    setShowEditOfferModal(true);
  };

  const handleSaveOffer = async (offerId) => {
    try {
      await adminAPI.updateOffer(offerId, {
        ...editingOfferData,
        vendor_id: parseInt(editingOfferData.vendor_id, 10),
        offer_percentage: parseFloat(editingOfferData.offer_percentage),
      });
      setSuccessMessage('Offer updated successfully');
      setEditingOfferId(null);
      setEditingOfferData(null);
      setShowEditOfferModal(false);
      fetchOffers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update offer: ' + (err.response?.data?.message || err.message));
      console.error('Error updating offer:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditOffer = () => {
    setEditingOfferId(null);
    setEditingOfferData(null);
    setShowEditOfferModal(false);
  };

  const handleDeleteOffer = async (offerId) => {
    if (!window.confirm('Are you sure you want to delete this offer?')) {
      return;
    }
    try {
      await adminAPI.deleteOffer(offerId);
      setSuccessMessage('Offer deleted successfully');
      fetchOffers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete offer: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting offer:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleApproveOffer = async (offerId) => {
    try {
      await adminAPI.approveOffer(offerId);
      setSuccessMessage('Offer approved successfully');
      fetchOffers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to approve offer: ' + (err.response?.data?.message || err.message));
      console.error('Error approving offer:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditRating = (rating) => {
    setEditingRatingId(rating.id);
    setEditingRatingData({
      user_id: rating.user_id.toString(),
      seller_id: rating.seller_id.toString(),
      rating: rating.rating.toString(),
      comment: rating.comment || '',
    });
  };

  const handleSaveRating = async (ratingId) => {
    try {
      await adminAPI.updateRating(ratingId, {
        ...editingRatingData,
        user_id: parseInt(editingRatingData.user_id, 10),
        seller_id: parseInt(editingRatingData.seller_id, 10),
        rating: parseInt(editingRatingData.rating, 10),
      });
      setSuccessMessage('Rating updated successfully');
      setEditingRatingId(null);
      setEditingRatingData(null);
      fetchRatings();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update rating: ' + (err.response?.data?.message || err.message));
      console.error('Error updating rating:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditRating = () => {
    setEditingRatingId(null);
    setEditingRatingData(null);
  };

  const handleDeleteRating = async (ratingId) => {
    if (!window.confirm('Are you sure you want to delete this rating?')) {
      return;
    }
    try {
      await adminAPI.deleteRating(ratingId);
      setSuccessMessage('Rating deleted successfully');
      fetchRatings();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete rating: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting rating:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditSalesReport = (report) => {
    setEditingSalesReportId(report.id);
    setEditingSalesReportData({
      user_id: report.user_id.toString(),
      listed_items: report.listed_items.toString(),
      sold_items: report.sold_items.toString(),
      earning: report.earning.toString(),
      total_earning: report.total_earning.toString(),
    });
  };

  const handleSaveSalesReport = async (reportId) => {
    try {
      await adminAPI.updateSalesReport(reportId, {
        ...editingSalesReportData,
        user_id: parseInt(editingSalesReportData.user_id, 10),
        listed_items: parseInt(editingSalesReportData.listed_items, 10),
        sold_items: parseInt(editingSalesReportData.sold_items, 10),
        earning: parseFloat(editingSalesReportData.earning),
        total_earning: parseFloat(editingSalesReportData.total_earning),
      });
      setSuccessMessage('Sales report updated successfully');
      setEditingSalesReportId(null);
      setEditingSalesReportData(null);
      fetchSalesReport();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update sales report: ' + (err.response?.data?.message || err.message));
      console.error('Error updating sales report:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditSalesReport = () => {
    setEditingSalesReportId(null);
    setEditingSalesReportData(null);
  };

  const handleDeleteSalesReport = async (reportId) => {
    if (!window.confirm('Are you sure you want to delete this sales report?')) {
      return;
    }
    try {
      await adminAPI.deleteSalesReport(reportId);
      setSuccessMessage('Sales report deleted successfully');
      fetchSalesReport();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete sales report: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting sales report:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const fetchStockManagementCategories = async () => {
    try {
      const response = await adminAPI.getCategories();
      
      // Handle different response structures - ensure we get an array
      let allCategories = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        allCategories = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        allCategories = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        allCategories = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        allCategories = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        allCategories = [];
      }
      
      // Get unique main categories (unique category names)
      const mainCategoriesMap = new Map();
      const categoriesByMain = new Map();
      
      // First, collect all unique category names and their first ID
      const uniqueCategoryNames = new Set();
      if (Array.isArray(allCategories)) {
        allCategories.forEach((cat) => {
          const categoryName = cat.categoryName || cat.category || '';
          if (categoryName) {
            uniqueCategoryNames.add(categoryName);
          }
        });
      }
      
      // For each unique category name, find the first entry to use as main category ID
      uniqueCategoryNames.forEach((categoryName) => {
        // Find first category entry for this category name
        const firstCat = allCategories.find(c => {
          const catName = c.categoryName || c.category || '';
          return catName === categoryName;
        });
        
        if (firstCat) {
          // Use categoryId if it exists, otherwise use id
          const mainCategoryId = firstCat.categoryId || firstCat.id;
          mainCategoriesMap.set(categoryName, {
            id: mainCategoryId,
            name: categoryName,
          });
          categoriesByMain.set(categoryName, []);
        }
      });
      
      // Now collect all subcategories grouped by category name
      if (Array.isArray(allCategories)) {
        allCategories.forEach((cat) => {
          const categoryName = cat.categoryName || cat.category || '';
          
          if (!categoryName) return;
          
          // If it has a subcategoryId, it's a subcategory
          if (cat.subcategoryId && cat.subcategoryId !== null) {
            if (!categoriesByMain.has(categoryName)) {
              categoriesByMain.set(categoryName, []);
            }
            categoriesByMain.get(categoryName).push({
              id: cat.subcategoryId || cat.id,
              name: cat.subcategoryName || cat.sub_category || '',
            });
          }
        });
      }
      
      // Sort main categories alphabetically
      const sortedMainCategories = Array.from(mainCategoriesMap.values()).sort((a, b) => 
        a.name.localeCompare(b.name)
      );
      
      // Sort subcategories within each main category
      categoriesByMain.forEach((subcats, categoryName) => {
        if (Array.isArray(subcats)) {
          subcats.sort((a, b) => a.name.localeCompare(b.name));
        }
      });
      
      setStockManagementMainCategories(sortedMainCategories);
      setStockManagementCategories(categoriesByMain);
    } catch (err) {
      const errorMessage = err.message || 'Unknown error';
      console.error('Error fetching categories for stock management:', err);
      console.error('Error response:', err.response);
      setError('Failed to load categories: ' + errorMessage);
      setStockManagementMainCategories([]); // Set empty array on error
      setStockManagementCategories(new Map()); // Set empty Map on error
    }
  };

  const handleEditStock = async (stock) => {
    if (!stock) return;
    
    try {
      setEditingStockId(stock.id);
      
      // Fetch categories if not already loaded
      if (stockManagementMainCategories.length === 0) {
        await fetchStockManagementCategories();
      }
      
      // Wait a bit to ensure categories are loaded
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Find the main category for this stock item by matching category_name
      let selectedMainCategory = null;
      if (stock.category_name) {
        selectedMainCategory = stockManagementMainCategories.find(
          cat => cat.name === stock.category_name
        );
      }
      
      // If still not found, use the first main category as default
      if (!selectedMainCategory && stockManagementMainCategories.length > 0) {
        selectedMainCategory = stockManagementMainCategories[0];
      }
      
      const selectedMainCategoryId = selectedMainCategory?.id || stock.category_id;
      
      // Determine the final category_id
      // If subcategory_name exists, use the current category_id (which is the subcategory_id)
      // Otherwise, use the main category_id
      const finalCategoryId = (stock.subcategory_name && stock.subcategory_name.trim() !== '') 
        ? stock.category_id.toString() 
        : selectedMainCategoryId.toString();
      
      setEditingStockData({
        item_name: stock.item_name || '',
        vendor_seller_id: stock.vendor_seller_id?.toString() || '',
        main_category_id: selectedMainCategoryId.toString(),
        category_id: finalCategoryId, // This will be the final category_id (subcategory if exists, main if not)
        quantity: stock.quantity?.toString() || '0',
        sold_item_qty: stock.sold_item_qty?.toString() || '0',
        low_stock_threshold: stock.low_stock_threshold?.toString() || '10',
      });
      setShowEditStockModal(true);
    } catch (err) {
      console.error('Error setting up edit stock:', err);
      setError('Failed to initialize edit mode: ' + (err.message || 'Unknown error'));
      setEditingStockId(null);
      setEditingStockData(null);
      setShowEditStockModal(false);
    }
  };

  const handleSaveStock = async (stockId) => {
    if (!editingStockData) return;
    
    try {
      // category_id is already set correctly (either subcategory_id or main_category_id)
      await adminAPI.updateStockItem(stockId, {
        item_name: editingStockData.item_name || '',
        vendor_seller_id: parseInt(editingStockData.vendor_seller_id, 10),
        category_id: parseInt(editingStockData.category_id, 10), // Final category_id (subcategory if selected, main if not)
        quantity: parseInt(editingStockData.quantity, 10),
        sold_item_qty: parseInt(editingStockData.sold_item_qty, 10),
        low_stock_threshold: parseInt(editingStockData.low_stock_threshold, 10),
      });
      setSuccessMessage('Stock item updated successfully');
      setEditingStockId(null);
      setEditingStockData(null);
      setShowEditStockModal(false);
      fetchStockManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update stock item: ' + (err.response?.data?.message || err.message));
      console.error('Error updating stock item:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleMainCategoryChange = (mainCategoryId) => {
    const mainCategory = stockManagementMainCategories.find(cat => cat.id.toString() === mainCategoryId);
    const mainCategoryName = mainCategory?.name || '';
    
    // Reset subcategory selection when main category changes
    setEditingStockData({
      ...editingStockData,
      main_category_id: mainCategoryId,
      category_id: mainCategoryId, // Default to main category, user can select subcategory
    });
  };

  const handleSubcategoryChange = (subcategoryId) => {
    // If subcategory is selected, use it; otherwise use main category
    const finalCategoryId = subcategoryId || editingStockData.main_category_id;
    setEditingStockData({
      ...editingStockData,
      category_id: finalCategoryId,
    });
  };

  const handleCancelEditStock = () => {
    setEditingStockId(null);
    setEditingStockData(null);
    setShowEditStockModal(false);
  };

  const handleDeleteStock = async (stockId) => {
    if (!window.confirm('Are you sure you want to delete this stock item?')) {
      return;
    }
    try {
      await adminAPI.deleteStockItem(stockId);
      setSuccessMessage('Stock item deleted successfully');
      fetchStockManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete stock item: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting stock item:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleDismissStockAlert = async (alertId) => {
    try {
      await adminAPI.markStockAlertRead(alertId);
      fetchStockManagement();
    } catch (err) {
      console.error('Error marking alert as read:', err);
    }
  };

  const handleDismissAllAlerts = () => {
    lowStockAlerts.forEach(alert => {
      handleDismissStockAlert(alert.id);
    });
    setShowStockAlert(false);
  };

  const handleAddEmailSubscriberUserChange = (userId) => {
    const selectedUser = users.find((user) => user.id.toString() === userId);
    setAddEmailSubscriberFormData((prev) => ({
      ...prev,
      user_id: userId,
      username: selectedUser ? selectedUser.name : '',
      email: selectedUser ? selectedUser.email : '',
    }));
  };

  const handleAddEmailSubscriberSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createEmailSubscriber({
        user_id: addEmailSubscriberFormData.user_id ? parseInt(addEmailSubscriberFormData.user_id, 10) : null,
        username: addEmailSubscriberFormData.username,
        email: addEmailSubscriberFormData.email,
        subscribe_volume: parseInt(addEmailSubscriberFormData.subscribe_volume || '0', 10),
        amount: parseFloat(addEmailSubscriberFormData.amount || '0'),
        start_date: addEmailSubscriberFormData.start_date,
        end_date: addEmailSubscriberFormData.end_date,
        subscription_type: addEmailSubscriberFormData.subscription_type,
      });
      setSuccessMessage('Email subscriber added successfully');
      setShowAddEmailSubscriberForm(false);
      setAddEmailSubscriberFormData({
        user_id: '',
        username: '',
        email: '',
        subscribe_volume: '',
        amount: '',
        start_date: '',
        end_date: '',
        subscription_type: '',
      });
      fetchEmailSubscribers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to add email subscriber: ' + (err.response?.data?.message || err.message));
      console.error('Error adding email subscriber:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditEmailSubscriber = (subscriber) => {
    setEditingEmailSubscriberId(subscriber.id);
    setEditingEmailSubscriberData({
      user_id: subscriber.user_id?.toString() || '',
      username: subscriber.username || '',
      email: subscriber.email || '',
      subscribe_volume: subscriber.subscribe_volume?.toString() || '0',
      amount: subscriber.amount?.toString() || '0',
      start_date: subscriber.start_date || '',
      end_date: subscriber.end_date || '',
      subscription_type: subscriber.subscription_type || '',
    });
  };

  const handleSaveEmailSubscriber = async (subscriberId) => {
    if (!editingEmailSubscriberData) return;
    try {
      await adminAPI.updateEmailSubscriber(subscriberId, {
        user_id: editingEmailSubscriberData.user_id ? parseInt(editingEmailSubscriberData.user_id, 10) : null,
        username: editingEmailSubscriberData.username,
        email: editingEmailSubscriberData.email,
        subscribe_volume: parseInt(editingEmailSubscriberData.subscribe_volume || '0', 10),
        amount: parseFloat(editingEmailSubscriberData.amount || '0'),
        start_date: editingEmailSubscriberData.start_date,
        end_date: editingEmailSubscriberData.end_date,
        subscription_type: editingEmailSubscriberData.subscription_type,
      });
      setSuccessMessage('Email subscriber updated successfully');
      setEditingEmailSubscriberId(null);
      setEditingEmailSubscriberData(null);
      fetchEmailSubscribers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update email subscriber: ' + (err.response?.data?.message || err.message));
      console.error('Error updating email subscriber:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditEmailSubscriber = () => {
    setEditingEmailSubscriberId(null);
    setEditingEmailSubscriberData(null);
  };

  const handleDeleteEmailSubscriber = async (subscriberId) => {
    if (!window.confirm('Are you sure you want to delete this subscriber?')) {
      return;
    }
    try {
      await adminAPI.deleteEmailSubscriber(subscriberId);
      setSuccessMessage('Email subscriber deleted successfully');
      fetchEmailSubscribers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete email subscriber: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting email subscriber:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleAddSupportSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createSupportItem({
        ...addSupportFormData,
        issue_reporter_id: addSupportFormData.issue_reporter_id ? parseInt(addSupportFormData.issue_reporter_id, 10) : null,
        assign_to_id: addSupportFormData.assign_to_id ? parseInt(addSupportFormData.assign_to_id, 10) : null,
      });
      setSuccessMessage('Support issue added successfully');
      setShowAddSupportForm(false);
      setAddSupportFormData({
        issue_error: '',
        issue_reporter_id: '',
        date: '',
        assign_to_id: '',
        assign_date: '',
        error_status: 'pending',
        note_solution: '',
      });
      fetchSupportManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to add support issue: ' + (err.response?.data?.message || err.message));
      console.error('Error adding support issue:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditSupport = (support) => {
    setEditingSupportId(support.id);
    setEditingSupportData({
      issue_error: support.issue_error || '',
      issue_reporter_id: support.issue_reporter_id?.toString() || '',
      date: support.date || '',
      assign_to_id: support.assign_to_id?.toString() || '',
      assign_date: support.assign_date || '',
      error_status: support.error_status || 'pending',
      note_solution: support.note_solution || '',
    });
    setShowEditSupportModal(true);
  };

  const handleSaveSupport = async (supportId) => {
    if (!editingSupportData) return;
    
    try {
      await adminAPI.updateSupportItem(supportId, {
        ...editingSupportData,
        issue_reporter_id: editingSupportData.issue_reporter_id ? parseInt(editingSupportData.issue_reporter_id, 10) : null,
        assign_to_id: editingSupportData.assign_to_id ? parseInt(editingSupportData.assign_to_id, 10) : null,
      });
      setSuccessMessage('Support issue updated successfully');
      setEditingSupportId(null);
      setEditingSupportData(null);
      setShowEditSupportModal(false);
      fetchSupportManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update support issue: ' + (err.response?.data?.message || err.message));
      console.error('Error updating support issue:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditSupport = () => {
    setEditingSupportId(null);
    setEditingSupportData(null);
    setShowEditSupportModal(false);
  };

  const handleDeleteSupport = async (supportId) => {
    if (!window.confirm('Are you sure you want to delete this support issue?')) {
      return;
    }
    try {
      await adminAPI.deleteSupportItem(supportId);
      setSuccessMessage('Support issue deleted successfully');
      fetchSupportManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete support issue: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting support issue:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handlePostAdTransactionSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createTransactionItem({
        ...postAdTransactionFormData,
        vendor_id: parseInt(postAdTransactionFormData.vendor_id, 10),
        num_of_posted_ad: parseInt(postAdTransactionFormData.num_of_posted_ad, 10),
        category_id: postAdTransactionFormData.category_id ? parseInt(postAdTransactionFormData.category_id, 10) : null,
        amount: parseFloat(postAdTransactionFormData.amount),
      });
      setSuccessMessage('Ad post transaction created successfully');
      setShowPostAdTransactionForm(false);
      setPostAdTransactionFormData({
        vendor_id: '',
        num_of_posted_ad: '',
        category_id: '',
        amount: '',
        payment_method: 'Credit Card',
        start_date: '',
        end_date: '',
        email: '',
        status: 'active',
      });
      setTransactionSelectedCategoryName('');
      setTransactionSelectedSubcategoryId('');
      fetchTransactionManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create transaction: ' + (err.response?.data?.message || err.message));
      console.error('Error creating transaction:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEditTransaction = (transaction) => {
    setEditingTransactionId(transaction.id);
    setEditingTransactionData({
      vendor_id: transaction.vendor_id?.toString() || '',
      num_of_posted_ad: transaction.num_of_posted_ad?.toString() || '0',
      category_id: transaction.category_id?.toString() || '',
      amount: transaction.amount?.toString() || '0',
      payment_method: transaction.payment_method || 'Credit Card',
      start_date: transaction.start_date || '',
      end_date: transaction.end_date || '',
      email: transaction.email || '',
      status: transaction.status || 'active',
    });

    // Initialize category selection from category_id
    if (transaction.category_id) {
      // Find the category in the categories list by ID
      let foundCategory = null;
      let foundSubcategory = null;
      
      for (const cat of categories) {
        // Check if it's a main category match
        if (cat.id === parseInt(transaction.category_id)) {
          foundCategory = cat;
          break;
        }
        // Check if it's a subcategory match
        if (cat.subcategories) {
          const subcat = cat.subcategories.find(s => s.id === parseInt(transaction.category_id));
          if (subcat) {
            foundCategory = cat;
            foundSubcategory = subcat;
            break;
          }
        }
      }

      if (foundCategory) {
        setTransactionSelectedCategoryName(foundCategory.name);
        if (foundSubcategory) {
          setTransactionSelectedSubcategoryId(foundSubcategory.id.toString());
        } else {
          setTransactionSelectedSubcategoryId('');
        }
      } else {
        setTransactionSelectedCategoryName('');
        setTransactionSelectedSubcategoryId('');
      }
    } else {
      setTransactionSelectedCategoryName('');
      setTransactionSelectedSubcategoryId('');
    }
    
    setShowEditTransactionModal(true);
  };

  const handleSaveTransaction = async (transactionId) => {
    if (!editingTransactionData) return;
    
    try {
      await adminAPI.updateTransactionItem(transactionId, {
        ...editingTransactionData,
        vendor_id: parseInt(editingTransactionData.vendor_id, 10),
        num_of_posted_ad: parseInt(editingTransactionData.num_of_posted_ad, 10),
        category_id: editingTransactionData.category_id ? parseInt(editingTransactionData.category_id, 10) : null,
        amount: parseFloat(editingTransactionData.amount),
      });
      setSuccessMessage('Transaction updated successfully');
      setEditingTransactionId(null);
      setEditingTransactionData(null);
      setTransactionSelectedCategoryName('');
      setTransactionSelectedSubcategoryId('');
      setShowEditTransactionModal(false);
      fetchTransactionManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update transaction: ' + (err.response?.data?.message || err.message));
      console.error('Error updating transaction:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditTransaction = () => {
    setEditingTransactionId(null);
    setEditingTransactionData(null);
    setTransactionSelectedCategoryName('');
    setTransactionSelectedSubcategoryId('');
    setShowEditTransactionModal(false);
  };

  const handleEditUser = (user) => {
    // Prevent editing super_admin users
    if (user.role === 'super_admin') {
      setError('Super admin users cannot be edited through this interface.');
      setTimeout(() => setError(null), 5000);
      return;
    }
    // Prevent regular admins from editing other admin accounts
    if (user.role === 'admin' && !isSuperAdmin) {
      setError('Regular admins cannot edit other admin accounts. Only super admins can manage admin accounts.');
      setTimeout(() => setError(null), 5000);
      return;
    }
    setEditingUserId(user.id);
    setShowEditUserModal(true);
    setEditingUserData({
      name: user.name,
      email: user.email,
      role: user.role,
      location_id: user.location_id || null,
      selected_local_address: user.selected_local_address || null,
      comment: user.comment || '',
    });
    
    // Initialize location selection
    if (user.location_id) {
      const selectedSet = new Set([user.location_id.toString()]);
      // If user has a selected_local_address, find and add it to the selection
      if (user.selected_local_address && locationData?.provinces) {
        // Find the ward and local address in the locationData structure
        for (const province of locationData.provinces) {
          for (const district of province.districts || []) {
            for (const localLevel of district.localLevels || []) {
              for (const ward of localLevel.wards || []) {
                if (ward.id === user.location_id && ward.local_addresses) {
                  const addressIndex = ward.local_addresses.findIndex(addr => addr === user.selected_local_address || addr.name === user.selected_local_address);
                  if (addressIndex !== -1) {
                    selectedSet.add(`${ward.id}-${addressIndex}`);
                  }
                  break;
                }
              }
            }
          }
        }
      }
      setEditingUserSelectedLocations(selectedSet);
    } else {
      setEditingUserSelectedLocations(new Set());
    }
  };

  const handleSaveUser = async (userId) => {
    try {
      // Get location ID and selected local address from selected locations
      let locationId = null;
      let selectedLocalAddress = null;
      
      if (editingUserSelectedLocations.size > 0) {
        const selectedLocationIds = Array.from(editingUserSelectedLocations);
        
        // Find local address IDs (those with dash format: "wardId-index")
        const localAddressIds = selectedLocationIds.filter(locId => 
          typeof locId === 'string' && locId.includes('-')
        );
        
        // Find ward IDs (numeric or string without dash)
        const wardIds = selectedLocationIds.filter(locId => {
          if (typeof locId === 'number') return true;
          if (typeof locId === 'string' && !locId.includes('-') && !isNaN(locId)) return true;
          return false;
        });
        
        // If a local address is selected, extract ward ID and address name
        if (localAddressIds.length > 0) {
          const localAddressId = localAddressIds[0]; // Use first selected local address
          const [wardIdStr, addressIndexStr] = localAddressId.split('-');
          const wardId = parseInt(wardIdStr);
          const addressIndex = parseInt(addressIndexStr);
          
          if (!isNaN(wardId) && !isNaN(addressIndex)) {
            locationId = wardId;
            
            // Find the actual address name from locationData
            if (locationData?.provinces) {
              for (const province of locationData.provinces) {
                for (const district of province.districts || []) {
                  for (const localLevel of district.localLevels || []) {
                    for (const ward of localLevel.wards || []) {
                      if (ward.id === wardId && ward.local_addresses && ward.local_addresses[addressIndex]) {
                        const address = ward.local_addresses[addressIndex];
                        selectedLocalAddress = typeof address === 'string' ? address : address.name || address;
                        break;
                      }
                    }
                  }
                }
              }
            }
          }
        } else if (wardIds.length > 0) {
          // Check if all wards in a local level are selected (meaning user selected local level, not specific ward)
          // We need to find if all wards belong to the same local level
          if (locationData?.provinces && wardIds.length > 1) {
            // Check if all selected wards belong to the same local level
            const wardIdNumbers = wardIds.map(id => typeof id === 'number' ? id : parseInt(id)).filter(id => !isNaN(id));
            const localLevelMap = new Map(); // localLevel key -> array of ward IDs
            
            for (const province of locationData.provinces) {
              for (const district of province.districts || []) {
                for (const localLevel of district.localLevels || []) {
                  if (localLevel.wards) {
                    const localLevelKey = `${province.id}-${district.id}-${localLevel.id}`;
                    const localLevelWardIds = localLevel.wards.map(w => w.id);
                    localLevelMap.set(localLevelKey, {
                      province: province.name,
                      district: district.name,
                      localLevel: localLevel.name,
                      wardIds: localLevelWardIds
                    });
                  }
                }
              }
            }
            
            // Check if all selected wards belong to the same local level
            let foundLocalLevelOnly = false;
            for (const [key, data] of localLevelMap.entries()) {
              const allWardsInLocalLevel = data.wardIds.every(wardId => wardIdNumbers.includes(wardId));
              const allSelectedWardsInLocalLevel = wardIdNumbers.every(wardId => data.wardIds.includes(wardId));
              
              if (allWardsInLocalLevel && allSelectedWardsInLocalLevel && wardIdNumbers.length === data.wardIds.length) {
                // User selected all wards in this local level = selected local level only
                // Use first ward ID for location_id, but mark as local level only
                locationId = wardIdNumbers[0];
                selectedLocalAddress = '__LOCAL_LEVEL_ONLY__'; // Special marker
                foundLocalLevelOnly = true;
                break;
              }
            }
            
            if (!foundLocalLevelOnly) {
              // Not all wards in same local level, treat as multiple ward selection
              // Use first ward ID
              const firstWardId = wardIdNumbers[0];
              locationId = firstWardId;
              selectedLocalAddress = null;
            }
          } else {
            // Single ward selected
            const firstWardId = wardIds[0];
            if (typeof firstWardId === 'number') {
              locationId = firstWardId;
            } else if (typeof firstWardId === 'string' && !isNaN(firstWardId)) {
              locationId = parseInt(firstWardId);
            }
            selectedLocalAddress = null; // Clear selected local address if only ward is selected
          }
        }
      }
      
      await adminAPI.updateUser(userId, {
        ...editingUserData,
        location_id: locationId,
        selected_local_address: selectedLocalAddress,
      });
      setSuccessMessage('User updated successfully');
      setEditingUserId(null);
      setEditingUserData(null);
      setEditingUserSelectedLocations(new Set());
      setEditingUserExpandedProvinces(new Set());
      setEditingUserExpandedDistricts(new Set());
      setEditingUserExpandedLocalLevels(new Set());
      setShowEditUserModal(false);
      fetchUserManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update user: ' + (err.response?.data?.message || err.message));
      console.error('Error updating user:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelEditUser = () => {
    setEditingUserId(null);
    setEditingUserData(null);
    setEditingUserSelectedLocations(new Set());
    setEditingUserExpandedProvinces(new Set());
    setEditingUserExpandedDistricts(new Set());
    setEditingUserExpandedLocalLevels(new Set());
    setShowEditUserModal(false);
  };

  const handleDeleteUser = async (userId) => {
    const user = userManagementData.find(u => u.id === userId);
    
    // Prevent deleting super_admin users
    if (user && user.role === 'super_admin') {
      setError('Super admin users cannot be deleted.');
      setTimeout(() => setError(null), 5000);
      return;
    }
    // Prevent regular admins from deleting other admin accounts
    if (user && user.role === 'admin' && !isSuperAdmin) {
      setError('Regular admins cannot delete other admin accounts. Only super admins can manage admin accounts.');
      setTimeout(() => setError(null), 5000);
      return;
    }

    if (!window.confirm('Are you sure you want to delete this user?')) {
      return;
    }
    try {
      await adminAPI.deleteUser(userId);
      setSuccessMessage('User deleted successfully');
      fetchUserManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete user: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting user:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleAddComment = (userId) => {
    const user = userManagementData.find(u => u.id === userId);
    
    // Prevent regular admins from adding comments to admin/super_admin accounts
    if (user && (user.role === 'admin' || user.role === 'super_admin') && !isSuperAdmin) {
      setError('Regular admins cannot add comments to admin accounts. Only super admins can manage admin accounts.');
      setTimeout(() => setError(null), 5000);
      return;
    }
    
    setCommentingUserId(userId);
    setUserComment(user?.comment || '');
  };

  const handleSaveComment = async (userId) => {
    if (!userComment.trim()) {
      setError('Comment cannot be empty');
      setTimeout(() => setError(null), 3000);
      return;
    }
    try {
      await adminAPI.addUserComment(userId, { comment: userComment });
      setSuccessMessage('Comment added successfully and notification sent to user');
      setCommentingUserId(null);
      setUserComment('');
      fetchUserManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to add comment: ' + (err.response?.data?.message || err.message));
      console.error('Error adding comment:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelComment = () => {
    setCommentingUserId(null);
    setUserComment('');
  };

  const handleDeleteTransaction = async (transactionId) => {
    if (!window.confirm('Are you sure you want to delete this transaction?')) {
      return;
    }
    try {
      await adminAPI.deleteTransactionItem(transactionId);
      setSuccessMessage('Transaction deleted successfully');
      fetchTransactionManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete transaction: ' + (err.response?.data?.message || err.message));
      console.error('Error deleting transaction:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const fetchLiveChats = async () => {
    setLiveChatsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getLiveChats();
      
      // Handle different response structures - ensure we get an array
      let chats = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        chats = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        chats = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        chats = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        chats = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        chats = [];
      }
      
      setLiveChats(chats);
      const unreadTotal = Array.isArray(chats)
        ? chats.reduce((sum, chat) => sum + (chat?.unread_admin_count || 0), 0)
        : 0;
      setLiveChatUnreadCount(unreadTotal);
      
      // Only update selectedLiveChat if it still exists in the list
      // Preserve the current selection to prevent showing wrong user
      if (selectedLiveChat && selectedLiveChat.id) {
        const updated = chats.find((chat) => chat && chat.id === selectedLiveChat.id);
        if (updated) {
          // Merge the updated chat data while preserving user relationship
          setSelectedLiveChat({
            ...updated,
            // Ensure user relationship is preserved if it exists
            user: updated.user || selectedLiveChat.user
          });
        }
        // If chat not found in list, keep the current selection (don't clear it)
      } else if (chats.length === 0) {
        setSelectedLiveChat(null);
        setChatMessages([]);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch live chats: ' + errorMessage);
      console.error('Error fetching live chats:', err);
      console.error('Error response:', err.response);
      setLiveChats([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setLiveChatsLoading(false);
    }
  };

  const handleOpenLiveChat = async () => {
    if (!openChatSelectedUserId) return;
    const userIdToOpen = openChatSelectedUserId; // Store before clearing
    try {
      setLiveChatError(null);
      const response = await adminAPI.openLiveChat(userIdToOpen);
      const newChat = response.data;
      
      // Refresh the chat list first (this maintains the original time-based order)
      await fetchLiveChats();
      
      // After refresh, find the chat in the list and select it
      // DO NOT reorder the list - maintain the original time-based order
      setLiveChats((prev) => {
        if (!Array.isArray(prev)) return prev;
        
        // Find the chat in the list (it should be there after refresh)
        const chatInList = prev.find(chat => chat && chat.id === newChat.id);
        
        if (chatInList) {
          // Chat found in list, select it and load messages
          // Use the chat from the list (which has all relationships loaded from backend)
          setSelectedLiveChat(chatInList);
          fetchChatMessages(chatInList.id);
          markChatAsRead(chatInList.id);
          
          // Scroll to the selected chat in the list (without changing order)
          setTimeout(() => {
            const chatRow = document.querySelector(`[data-chat-id="${chatInList.id}"]`);
            if (chatRow) {
              chatRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 200);
        } else {
          // Chat not in list yet (shouldn't happen, but handle it)
          // Select the new chat and it will appear in list on next refresh
          setSelectedLiveChat(newChat);
          fetchChatMessages(newChat.id);
          markChatAsRead(newChat.id);
        }
        
        // Return unchanged - maintain the original time-based order
        return prev;
      });
      
      // Clear the selection
      setOpenChatSelectedUserId('');
      setOpenChatQuery('');
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setLiveChatError('Failed to open chat: ' + errorMessage);
      setTimeout(() => setLiveChatError(null), 5000);
    }
  };

  const handleSelectLiveChat = async (chat) => {
    if (!chat || !chat.id) {
      console.warn('handleSelectLiveChat: Invalid chat object', chat);
      return;
    }
    
    // Store the chat ID we're selecting to prevent race conditions
    const chatIdToSelect = chat.id;
    
    // Immediately clear messages and set loading state to prevent showing old messages
    setChatMessages([]);
    setChatMessagesLoading(true);
    
    // Immediately set the selected chat with all its data to prevent showing wrong user
    // Make sure we preserve the user relationship if it exists
    // The backend should load the user relationship, but we ensure it's here
    const chatToSelect = {
      ...chat,
      // Ensure user relationship is included - use the chat's user if available
      user: chat.user || (chat.user_id ? { id: chat.user_id } : null),
      // Preserve all other properties
      is_guest: chat.is_guest || false,
      guest_name: chat.guest_name,
      guest_email: chat.guest_email
    };
    
    // CRITICAL: Set selected chat immediately using React's state update
    // This ensures the UI updates immediately to show the correct user
    setSelectedLiveChat(chatToSelect);
    
    try {
      // Fetch messages for this specific chat ID (use the stored ID to prevent race conditions)
      await fetchChatMessages(chatIdToSelect);
      await markChatAsRead(chatIdToSelect);
      
      // Update unread counts
      setLiveChats((prev) => {
        if (Array.isArray(prev)) {
          const updated = prev.map((item) =>
            item.id === chatIdToSelect ? { ...item, unread_admin_count: 0 } : item
          );
          const updatedUnread = updated.reduce((sum, c) => sum + (c?.unread_admin_count || 0), 0);
          setLiveChatUnreadCount(updatedUnread);
          return updated;
        }
        return prev;
      });
    } catch (error) {
      console.error('Error selecting chat:', error);
      // If fetching messages fails, still keep the chat selected
      // so the user can see which chat they selected
      setChatMessagesLoading(false);
    }
  };

  const fetchChatMessages = async (chatId) => {
    if (!chatId || chatId === 'undefined' || chatId === undefined) {
      console.warn('Cannot fetch chat messages: invalid chatId', chatId);
      setChatMessages([]);
      return;
    }
    // Loading state is set in handleSelectLiveChat to prevent showing old messages
    // Only set it here if not already loading
    if (!chatMessagesLoading) {
      setChatMessagesLoading(true);
    }
    setError(null);
    try {
      const response = await adminAPI.getLiveChatMessages(chatId);
      
      // Handle different response structures - ensure we get an array
      let messages = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        messages = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        messages = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        messages = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        messages = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        messages = [];
      }
      
      setChatMessages(messages);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch chat messages: ' + errorMessage);
      console.error('Error fetching chat messages:', err);
      console.error('Error response:', err.response);
      setChatMessages([]); // Set empty array on error
      setTimeout(() => setError(null), 5000);
    } finally {
      setChatMessagesLoading(false);
    }
  };

  const markChatAsRead = async (chatId) => {
    if (!chatId || chatId === 'undefined' || chatId === undefined) {
      console.warn('Cannot mark chat as read: invalid chatId', chatId);
      return;
    }
    try {
      await adminAPI.markLiveChatRead(chatId);
    } catch (err) {
      console.error('Error marking chat as read:', err);
      // Don't show error to user for this, it's not critical
    }
  };

  const handleSendChatMessage = async (e) => {
    e.preventDefault();
    if (!selectedLiveChat || !newChatMessage.trim()) return;
    try {
      const response = await adminAPI.sendLiveChatMessage(selectedLiveChat.id, {
        message: newChatMessage,
        sender_type: 'admin',
      });
      setChatMessages((prev) => [...prev, response.data]);
      setNewChatMessage('');
      fetchLiveChats();
    } catch (err) {
      setError('Failed to send message: ' + (err.response?.data?.message || err.message));
      console.error('Error sending message:', err);
      setTimeout(() => setError(null), 5000);
    }
  };

  const fetchAds = async () => {
    setAdsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getAds();
      const adsData = response.data.ads || [];
      const totals = response.data.totals || {
        userPosted: 0,
        vendorPosted: 0,
        adminPosted: 0,
        total: 0
      };
      
      // Transform ads data to match the expected format
      const transformedAds = adsData.map(ad => ({
        id: ad.id,
        sn: ad.id,
        title: ad.title,
        category: ad.category_path || ad.category || (ad.category?.category) || 'N/A',
        subcategory: ad.subcategory || ad.sub_category || null,
        category_id: ad.category_id,
        location_id: ad.location_id,
        selected_local_address_index: ad.selected_local_address_index !== undefined ? ad.selected_local_address_index : null,
        location: ad.location || (typeof ad.location === 'object' && ad.location ? (() => {
          // Fallback: build from location object if location string is not available
          const parts = [];
          if (ad.location.province) parts.push(ad.location.province);
          if (ad.location.district) parts.push(ad.location.district);
          if (ad.location.local_level) parts.push(ad.location.local_level);
          if (ad.location.ward_number) parts.push(`Ward ${ad.location.ward_number}`);
          if (ad.location.local_address) {
            const firstAddress = ad.location.local_address.split(', ')[0];
            if (firstAddress) parts.push(firstAddress);
          }
          return parts.length > 0 ? parts.join(' > ') : null;
        })() : null),
        description: ad.description,
        price: parseFloat(ad.price) || 0,
        views: ad.views || 0,
        date: ad.created_at,
        postedBy: ad.posted_by || 'user',
        status: ad.status || 'active',
        image1_url: ad.image1_url || ad.image || null
      }));
      
      setAds(transformedAds);
      setAdTotals(totals);
    } catch (err) {
      setError('Failed to fetch ads: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching ads:', err);
    } finally {
      setAdsLoading(false);
    }
  };

  // Handle delete ad
  const handleDeleteAd = async (id) => {
    if (!window.confirm('Are you sure you want to delete this ad?')) {
      return;
    }
    
    try {
      await adminAPI.deleteAd(id);
      setSuccessMessage('Ad deleted successfully');
      fetchAds(); // Refresh the list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete ad: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle edit ad - show modal
  const handleEditAd = (ad) => {
    setEditingAdId(ad.id);
    setEditingAdData({
      title: ad.title,
      description: ad.description,
      price: ad.price,
      category_id: ad.category_id || '',
      location_id: ad.location_id || null,
      status: ad.status || 'active',
    });

    // Initialize category selection
    if (ad.category_id) {
      // Find the category in the categories list
      let foundCategory = null;
      let foundSubcategory = null;
      let foundItemCategory = null;
      const categoryIdNum = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
      
      for (const category of categories) {
        // Check if it's the main category
        const catIdNum = typeof category.id === 'string' ? parseInt(category.id, 10) : Number(category.id);
        if (catIdNum === categoryIdNum) {
          foundCategory = category;
          break;
        }
        // Check subcategories and item categories
        if (category.subcategories) {
          for (const subcategory of category.subcategories) {
            const subIdNum = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
            if (subIdNum === categoryIdNum) {
            foundCategory = category;
            foundSubcategory = subcategory;
            break;
          }
            // Check item categories
            if (subcategory.item_categories && Array.isArray(subcategory.item_categories)) {
              const itemCat = subcategory.item_categories.find(item => {
                const itemIdNum = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                return itemIdNum === categoryIdNum;
              });
              if (itemCat) {
                foundCategory = category;
                foundSubcategory = subcategory;
                foundItemCategory = itemCat;
                break;
              }
            }
          }
          if (foundCategory) break;
        }
      }

      if (foundCategory) {
        setEditingAdSelectedCategoryName(foundCategory.name);
        if (foundItemCategory) {
          setEditingAdSelectedSubcategoryId(foundSubcategory.id.toString());
          setEditingAdSelectedItemCategoryId(foundItemCategory.id.toString());
        } else if (foundSubcategory) {
          setEditingAdSelectedSubcategoryId(foundSubcategory.id.toString());
          setEditingAdSelectedItemCategoryId('');
        } else {
          setEditingAdSelectedSubcategoryId('');
          setEditingAdSelectedItemCategoryId('');
        }
      } else {
        setEditingAdSelectedCategoryName('');
        setEditingAdSelectedSubcategoryId('');
        setEditingAdSelectedItemCategoryId('');
      }
    } else {
      setEditingAdSelectedCategoryName('');
      setEditingAdSelectedSubcategoryId('');
      setEditingAdSelectedItemCategoryId('');
    }

    // Initialize location selection
    if (ad.location_id) {
      setEditingAdSelectedLocations(new Set([ad.location_id.toString()]));
    } else {
      setEditingAdSelectedLocations(new Set());
    }
    
    setShowEditAdModal(true);
  };

  // Handle save ad - save changes
  const handleSaveAd = async (adId) => {
    try {
      // Get location ID from selected locations
      let locationId = null;
      if (editingAdSelectedLocations.size > 0) {
        const selectedLocationIds = Array.from(editingAdSelectedLocations);
        for (const locId of selectedLocationIds) {
          if (typeof locId === 'number') {
            locationId = locId;
            break;
          } else if (typeof locId === 'string') {
            if (locId.includes('-')) {
              const wardId = locId.split('-')[0];
              if (!isNaN(wardId)) {
                locationId = parseInt(wardId);
                break;
              }
            } else if (!isNaN(locId)) {
              locationId = parseInt(locId);
              break;
            }
          }
        }
      }

      await adminAPI.updateAd(adId, {
        title: editingAdData.title,
        description: editingAdData.description,
        price: parseFloat(editingAdData.price),
        category_id: parseInt(editingAdData.category_id),
        location_id: locationId,
        status: editingAdData.status || 'active',
      });
      setSuccessMessage('Ad updated successfully');
      setEditingAdId(null);
      setEditingAdData(null);
      setEditingAdSelectedCategoryName('');
      setEditingAdSelectedSubcategoryId('');
      setEditingAdSelectedLocations(new Set());
      setShowEditAdModal(false);
      fetchAds(); // Refresh the list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update ad: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit ad
  const handleCancelEditAd = () => {
    setEditingAdId(null);
    setEditingAdData(null);
    setEditingAdSelectedCategoryName('');
    setEditingAdSelectedSubcategoryId('');
    setEditingAdSelectedLocations(new Set());
    setShowEditAdModal(false);
  };

  // Handle Post Ad form submission
  const handlePostAdSubmit = async (e) => {
    e.preventDefault();
    
    // Validate that at least one image is uploaded
    const hasImages = postAdImages.some(img => img !== null);
    if (!hasImages) {
      setError('Please upload at least one image for the ad');
      setTimeout(() => setError(null), 5000);
      return;
    }

    // Validate that at least one location is selected
    if (postAdSelectedLocations.size === 0) {
      setError('Please select at least one location for the ad');
      setTimeout(() => setError(null), 5000);
      return;
    }
    
    try {
      // Get the first selected location ID (ward ID from locations table)
      // If user selected a local address (ward.id-0), extract the ward.id and address index
      const selectedLocationIds = Array.from(postAdSelectedLocations);
      let locationId = null;
      let selectedLocalAddress = null;
      
      // Find the first valid location ID (ward ID, not address index)
      for (const locId of selectedLocationIds) {
        if (typeof locId === 'number') {
          // It's a ward ID (number)
          locationId = locId;
          break;
        } else if (typeof locId === 'string') {
          if (locId.includes('-')) {
            // It's a local address ID like "123-0", extract the ward ID (123) and address index (0)
            const parts = locId.split('-');
            const wardId = parts[0];
            if (!isNaN(wardId)) {
              locationId = parseInt(wardId);
              // Extract address index (everything after the first dash)
              selectedLocalAddress = parts.slice(1).join('-');
              break;
            }
          } else if (!isNaN(locId)) {
            // It's a ward ID as string
            locationId = parseInt(locId);
            break;
          }
        }
      }

      if (!locationId) {
        setError('Please select a valid location for the ad');
        setTimeout(() => setError(null), 5000);
        return;
      }
      
      // Create FormData for file uploads
      const formData = new FormData();
      formData.append('title', postAdFormData.title);
      formData.append('description', postAdFormData.description);
      formData.append('price', parseFloat(postAdFormData.price));
      formData.append('category_id', parseInt(postAdFormData.category_id));
      formData.append('user_id', parseInt(postAdFormData.user_id));
      formData.append('location_id', locationId);
      if (selectedLocalAddress !== null) {
        formData.append('selected_local_address', selectedLocalAddress);
      }
      formData.append('posted_by', 'admin');

      // Append images (only non-null ones)
      const validImages = [];
      postAdImages.forEach((image, index) => {
        if (image) {
          formData.append(`images[${index}]`, image);
          validImages.push(image);
        }
      });

      // Ensure at least one image is provided
      if (validImages.length === 0) {
        setError('Please upload at least one image');
        setTimeout(() => setError(null), 5000);
        return;
      }

      // Use axios directly for FormData
      const token = localStorage.getItem('token');
      await axios.post('/api/admin/ads', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
          'Authorization': `Bearer ${token}`,
        },
      });
      
      setSuccessMessage('Ad created successfully');
      setShowPostAdForm(false);
      setPostAdFormData({
        title: '',
        description: '',
        price: '',
        category_id: '',
        user_id: '',
      });
      setPostAdImages([null, null, null, null]); // Reset images
      setPostAdSelectedCategoryName('');
      setPostAdSelectedSubcategoryId('');
      setPostAdSelectedLocations(new Set());
      fetchAds(); // Refresh the ads list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create ad: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Compress image before upload - automatically handles any size
  const compressImage = (file, maxWidth = 1920, maxHeight = 1920, quality = 0.8) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          // Calculate new dimensions
          if (width > height) {
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error('Compression failed'));
                return;
              }
              const compressedFile = new File([blob], file.name, {
                type: file.type,
                lastModified: Date.now(),
              });
              resolve(compressedFile);
            },
            file.type,
            quality
          );
        };
        img.onerror = () => reject(new Error('Failed to load image'));
      };
      reader.onerror = () => reject(new Error('Failed to read file'));
    });
  };

  // Handle image file selection - open crop modal (replaces old compression-based handler)
  const handleImageChange = async (index, file, type = 'ad') => {
    if (file && file.type.startsWith('image/')) {
      // Validate file size (max 10MB before crop)
      if (file.size > 10 * 1024 * 1024) {
        setError('Image size must be less than 10MB');
        setTimeout(() => setError(null), 3000);
        return;
      }
      // Open crop modal
      setCropImageIndex(index);
      setCropImageFile(file);
      setCropImageType(type);
    } else {
      setError('Please select a valid image file');
      setTimeout(() => setError(null), 3000);
    }
  };

  // Handle crop completion
  const handleCropComplete = async (croppedFile) => {
    if (cropImageIndex === null) return;
    
    // Verify the cropped image is 400x400
    const img = new Image();
    const objectUrl = URL.createObjectURL(croppedFile);
    img.onload = async () => {
      URL.revokeObjectURL(objectUrl);
      if (img.width !== 400 || img.height !== 400) {
        alert('Image must be exactly 400x400 pixels. Please crop again.');
        return;
      }
      
      // Compress if needed
      let processedFile = croppedFile;
      if (croppedFile.size > 1024 * 1024) { // 1MB
        try {
          processedFile = await compressImage(croppedFile);
        } catch (err) {
          console.error('Error compressing image:', err);
        }
      }
      
      // Update the appropriate image array
      if (cropImageType === 'ad') {
        const newImages = [...postAdImages];
        newImages[cropImageIndex] = processedFile;
        setPostAdImages(newImages);
      } else if (cropImageType === 'auction') {
        const newImages = [...auctionImages];
        newImages[cropImageIndex] = processedFile;
        setAuctionImages(newImages);
      } else if (cropImageType === 'ebook-cover') {
        setEbookCoverImage(processedFile);
      }
      
      // Close crop modal
      setCropImageIndex(null);
      setCropImageFile(null);
      setCropImageType(null);
    };
    img.onerror = () => {
      URL.revokeObjectURL(objectUrl);
      alert('Error processing image. Please try again.');
    };
    img.src = objectUrl;
  };

  const handleCropCancel = () => {
    setCropImageIndex(null);
    setCropImageFile(null);
    setCropImageType(null);
  };

  // Handle image removal
  const handleImageRemove = (index) => {
    const newImages = [...postAdImages];
    newImages[index] = null;
    setPostAdImages(newImages);
  };

  // Handle Add Location form submission
  const handleAddLocationSubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createLocation({
        province: addLocationFormData.province,
        district: addLocationFormData.district,
        local_level: addLocationFormData.localLevel,
        local_level_type: addLocationFormData.localLevelType,
        ward_number: addLocationFormData.wardNumber ? parseInt(addLocationFormData.wardNumber) : null,
        local_address: addLocationFormData.localAddress || null,
      });
      
      setSuccessMessage('Location created successfully');
      setShowAddLocationForm(false);
      setAddLocationFormData({
        province: '',
        district: '',
        localLevel: '',
        localLevelType: 'Municipality',
        wardNumber: '',
        localAddress: '',
      });
      fetchLocations(); // Refresh the locations list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create location: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle Add Category form submission
  const handleAddCategorySubmit = async (e) => {
    e.preventDefault();
    try {
      await adminAPI.createCategory({
        domainCategoryName: addCategoryFormData.domainCategoryName,
        fieldCategoryName: addCategoryFormData.fieldCategoryName || null,
        itemCategoryName: addCategoryFormData.itemCategoryName || null,
      });
      
      setSuccessMessage('Category created successfully');
      setShowAddCategoryForm(false);
      setAddCategoryFormData({
        domainCategoryName: '',
        fieldCategoryName: '',
        itemCategoryName: '',
      });
      fetchCategoryManagement(); // Refresh the categories list
      fetchCategories(); // Also refresh the public categories for dropdowns
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create category: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle Start Auction form submission
  const handleStartAuctionSubmit = async (e) => {
    e.preventDefault();
    
    console.log('Submitting auction form:', { editingAuction, auctionFormData });
    
    try {
      const formData = new FormData();
      formData.append('user_id', auctionFormData.user_id);
      formData.append('category_id', auctionFormData.category_id);
      if (auctionFormData.location_id) {
        formData.append('location_id', auctionFormData.location_id);
      }
      formData.append('title', auctionFormData.title);
      formData.append('description', auctionFormData.description);
      formData.append('starting_price', auctionFormData.starting_price);
      if (auctionFormData.reserve_price) {
        formData.append('reserve_price', auctionFormData.reserve_price);
      }
      if (auctionFormData.buy_now_price) {
        formData.append('buy_now_price', auctionFormData.buy_now_price);
      }
      formData.append('bid_increment', auctionFormData.bid_increment || '1.00');
      
      // Convert datetime-local to UTC ISO string for proper timezone handling
      // datetime-local gives us local time without timezone, we need to convert to UTC
      const startTimeUTC = localDateTimeToUTC(auctionFormData.start_time);
      const endTimeUTC = localDateTimeToUTC(auctionFormData.end_time);
      
      console.log('Time conversions:', {
        start_time_local: auctionFormData.start_time,
        start_time_utc: startTimeUTC,
        end_time_local: auctionFormData.end_time,
        end_time_utc: endTimeUTC,
      });
      
      if (!startTimeUTC || !endTimeUTC) {
        throw new Error('Start time and end time are required');
      }
      
      formData.append('start_time', startTimeUTC);
      formData.append('end_time', endTimeUTC);
      
      // Transaction options
      formData.append('self_pickup', auctionFormData.self_pickup ? '1' : '0');
      formData.append('seller_delivery', auctionFormData.seller_delivery ? '1' : '0');
      if (auctionFormData.payment_methods && auctionFormData.payment_methods.length > 0) {
        formData.append('payment_methods', JSON.stringify(auctionFormData.payment_methods));
      }
      formData.append('financing_available', auctionFormData.financing_available ? '1' : '0');
      if (auctionFormData.financing_available && auctionFormData.financing_terms) {
        formData.append('financing_terms', JSON.stringify(auctionFormData.financing_terms));
      }
      
      // Add images
      auctionImages.forEach((image, index) => {
        if (image) {
          formData.append(`images[${index}]`, image);
        }
      });

      if (editingAuction) {
        console.log('Updating auction:', editingAuction.id);
        
        // Log what we're sending
        console.log('FormData contents:');
        for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }
        
        const response = await adminAPI.updateAuction(editingAuction.id, formData);
        console.log('Update response:', response.data);
        
        // Immediately update the auction in the list with the response data
        if (response.data) {
          setAuctions(prevAuctions => {
            return prevAuctions.map(auction => {
              if (auction.id === editingAuction.id || auction.id === parseInt(editingAuction.id)) {
                // Transform the response to match our auction format
                const updatedAuction = {
                  ...auction,
                  ...response.data,
                  // Ensure status is calculated correctly
                  status: response.data.status || auction.status,
                  // Ensure times are formatted correctly
                  start_time: response.data.start_time || auction.start_time,
                  end_time: response.data.end_time || auction.end_time,
                };
                console.log('Updated auction in state:', updatedAuction);
                return updatedAuction;
              }
              return auction;
            });
          });
        }
        
        setSuccessMessage('Auction updated successfully');
      } else {
        console.log('Creating new auction');
        await adminAPI.createAuction(formData);
        setSuccessMessage('Auction created successfully');
      }
      
      setShowAuctionForm(false);
      setShowEditAuctionModal(false);
      setEditingAuction(null);
      // Reset auction category selection state
      setAuctionSelectedCategoryName('');
      setAuctionSelectedSubcategoryId('');
      setAuctionSelectedItemCategoryId('');
      // Reset auction location selection state
      setAuctionSelectedLocations(new Set());
      setAuctionExpandedProvinces(new Set());
      setAuctionExpandedDistricts(new Set());
      setAuctionExpandedLocalLevels(new Set());
      setAuctionFormData({
        user_id: '',
        category_id: '',
        location_id: '',
        title: '',
        description: '',
        starting_price: '',
        reserve_price: '',
        buy_now_price: '',
        bid_increment: '1.00',
        start_time: '',
        end_time: '',
      });
      setAuctionImages([null, null, null, null]);
      
      // Also do a full refresh to ensure all data is up to date
      setTimeout(() => {
        console.log('Refreshing auctions list...');
        fetchAuctions();
      }, 500);
      
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('Error submitting auction:', err);
      console.error('Error response:', err.response?.data);
      
      // Handle validation errors - show all errors
      let errorMessage = 'Failed to ' + (editingAuction ? 'update' : 'create') + ' auction: ';
      
      if (err.response?.data?.errors) {
        // Laravel validation errors
        const errors = err.response.data.errors;
        const errorList = [];
        Object.keys(errors).forEach(field => {
          errors[field].forEach(msg => errorList.push(`${field}: ${msg}`));
        });
        errorMessage += errorList.join('. ');
      } else if (err.response?.data?.message) {
        errorMessage += err.response.data.message;
      } else if (err.response?.data?.error) {
        errorMessage += err.response.data.error;
      } else {
        errorMessage += err.message;
      }
      
      setError(errorMessage);
      setTimeout(() => setError(null), 8000); // Show longer for multiple errors
    }
  };

  const handleEditAuction = (auction) => {
    setShowAuctionForm(false); // Make sure inline form is hidden
    setEditingAuction(auction);
    setAuctionFormData({
      user_id: auction.user?.id || '',
      category_id: auction.category_id || '',
      location_id: auction.location_id || '',
      title: auction.title || '',
      description: auction.description || '',
      starting_price: auction.starting_price || '',
      reserve_price: auction.reserve_price || '',
      buy_now_price: auction.buy_now_price || '',
      bid_increment: auction.bid_increment || '1.00',
      start_time: auction.start_time ? utcToLocalDateTime(auction.start_time) : '',
      end_time: auction.end_time ? utcToLocalDateTime(auction.end_time) : '', // Use utcToLocalDateTime like start_time
    });
    setAuctionImages([null, null, null, null]); // Reset images - could load existing if needed
    
    // Initialize category selection (similar to Edit Ad logic)
    if (auction.category_id) {
      let foundCategory = null;
      let foundSubcategory = null;
      let foundItemCategory = null;
      const categoryIdNum = typeof auction.category_id === 'string' ? parseInt(auction.category_id, 10) : Number(auction.category_id);
      
      for (const category of categories) {
        // Check if it's the main category
        const catIdNum = typeof category.id === 'string' ? parseInt(category.id, 10) : Number(category.id);
        if (catIdNum === categoryIdNum) {
          foundCategory = category;
          break;
        }
        // Check subcategories and item categories
        if (category.subcategories) {
          for (const subcategory of category.subcategories) {
            const subIdNum = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
            if (subIdNum === categoryIdNum) {
              foundCategory = category;
              foundSubcategory = subcategory;
              break;
            }
            // Check item categories
            if (subcategory.item_categories && Array.isArray(subcategory.item_categories)) {
              const itemCat = subcategory.item_categories.find(item => {
                const itemIdNum = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                return itemIdNum === categoryIdNum;
              });
              if (itemCat) {
                foundCategory = category;
                foundSubcategory = subcategory;
                foundItemCategory = itemCat;
                break;
              }
            }
          }
          if (foundCategory) break;
        }
      }
      
      if (foundCategory) {
        setAuctionSelectedCategoryName(foundCategory.name);
        if (foundItemCategory) {
          setAuctionSelectedSubcategoryId(foundSubcategory.id.toString());
          setAuctionSelectedItemCategoryId(foundItemCategory.id.toString());
        } else if (foundSubcategory) {
          setAuctionSelectedSubcategoryId(foundSubcategory.id.toString());
          setAuctionSelectedItemCategoryId('');
        } else {
          setAuctionSelectedSubcategoryId('');
          setAuctionSelectedItemCategoryId('');
        }
      } else {
        setAuctionSelectedCategoryName('');
        setAuctionSelectedSubcategoryId('');
        setAuctionSelectedItemCategoryId('');
      }
    } else {
      setAuctionSelectedCategoryName('');
      setAuctionSelectedSubcategoryId('');
      setAuctionSelectedItemCategoryId('');
    }
    
    // Initialize location selection (similar to Edit Ad logic, but with cascading for ward + local addresses)
    if (auction.location_id && locationData?.provinces) {
      const locationIdStr = auction.location_id.toString();
      const selectedLocationIds = new Set();
      
      // Find the ward with this location_id and populate selectedLocationIds with ward + all local addresses
      for (const province of locationData.provinces) {
        for (const district of province.districts || []) {
          for (const localLevel of district.localLevels || []) {
            for (const ward of localLevel.wards || []) {
              if (ward.id.toString() === locationIdStr) {
                // Found the ward - add ward ID and all local addresses
                selectedLocationIds.add(ward.id.toString());
                if (ward.local_addresses && ward.local_addresses.length > 0) {
                  ward.local_addresses.forEach((_, idx) => {
                    selectedLocationIds.add(`${ward.id}-${idx}`);
                  });
                }
                // Expand the hierarchy so user can see the selected location
                setAuctionExpandedProvinces(prev => new Set([...prev, province.id]));
                setAuctionExpandedDistricts(prev => new Set([...prev, `${province.id}-${district.id}`]));
                setAuctionExpandedLocalLevels(prev => new Set([...prev, `${province.id}-${district.id}-${localLevel.id}`]));
                break;
              }
            }
          }
        }
      }
      
      setAuctionSelectedLocations(selectedLocationIds);
    } else {
      setAuctionSelectedLocations(new Set());
    }
    
    setShowEditAuctionModal(true);
  };

  const handleDeleteAuction = async (id) => {
    if (!window.confirm('Are you sure you want to delete this auction?')) return;
    try {
      await adminAPI.deleteAuction(id);
      setSuccessMessage('Auction deleted successfully');
      fetchAuctions();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete auction: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleCancelAuction = async (id) => {
    const reason = window.prompt('Enter cancellation reason (optional):');
    if (reason === null) {
      // User cancelled the prompt
      return;
    }
    
    if (!window.confirm('Are you sure you want to cancel this auction? All bidders will be notified and refunds will be processed if payment was made.')) {
      return;
    }
    
    const auctionId = parseInt(id);
    console.log('Cancelling auction:', auctionId, 'Reason:', reason || 'No reason provided');
    
    try {
      const response = await axios.post(`/api/admin/auctions/${auctionId}/cancel`, {
        reason: reason || null,
      });
      
      console.log('Cancel auction response:', response.data);
      
      // Immediately update the auction status in the list
      setAuctions(prevAuctions => {
        const updated = prevAuctions.map(auction => {
          const currentAuctionId = typeof auction.id === 'string' ? parseInt(auction.id) : auction.id;
          
          if (currentAuctionId === auctionId) {
            const updatedAuction = response.data?.auction
              ? { ...auction, ...response.data.auction, status: 'cancelled' }
              : { ...auction, status: 'cancelled' };
            
            return updatedAuction;
          }
          return auction;
        });
        return updated;
      });
      
      setSuccessMessage(`Auction cancelled successfully. ${response.data?.refunds?.length ? `${response.data.refunds.length} refund(s) processed.` : ''}`);
      setTimeout(() => setSuccessMessage(null), 5000);
      
      // Refresh auctions list after a short delay
      setTimeout(() => {
        fetchAuctions();
      }, 1000);
    } catch (err) {
      console.error('Error cancelling auction:', err);
      setError(err.response?.data?.error || 'Failed to cancel auction');
      setTimeout(() => setError(null), 5000);
    }
  };

  const handleEndAuction = async (id) => {
    if (!window.confirm('Are you sure you want to end this auction?')) return;
    
    const auctionId = parseInt(id);
    console.log('Ending auction:', auctionId);
    
    try {
      const response = await axios.post(`/api/admin/auctions/${auctionId}/end`);
      
      console.log('End auction response:', response.data);
      
      // Immediately update the auction status in the list
      setAuctions(prevAuctions => {
        const updated = prevAuctions.map(auction => {
          // Compare both as numbers to ensure match
          const currentAuctionId = typeof auction.id === 'string' ? parseInt(auction.id) : auction.id;
          
          if (currentAuctionId === auctionId) {
            // Use the auction data from response if available, otherwise just update status
            const updatedAuction = response.data?.auction 
              ? { 
                  ...auction, 
                  ...response.data.auction, 
                  status: 'ended', // Force status to 'ended'
                  id: currentAuctionId // Preserve ID
                }
              : { 
                  ...auction, 
                  status: 'ended' // Force status to 'ended'
                };
            console.log('Updating auction in state:', updatedAuction);
            return updatedAuction;
          }
          return auction;
        });
        console.log('Updated auctions list:', updated);
        return updated;
      });
      
      setSuccessMessage(response.data?.message || 'Auction ended successfully');
      
      // Also do a full refresh to ensure all data is up to date
      setTimeout(() => {
        console.log('Refreshing auctions list...');
        fetchAuctions();
      }, 500);
      
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      console.error('Error ending auction:', err);
      console.error('Error response:', err.response?.data);
      const errorMessage = err.response?.data?.message || err.response?.data?.error || err.message;
      setError('Failed to end auction: ' + errorMessage);
      setTimeout(() => setError(null), 5000);
      // Still refresh to see current state
      fetchAuctions();
    }
  };

  // Fetch locations data
  useEffect(() => {
    if (activeSection === 'location-address') {
      fetchLocations();
    }
  }, [activeSection]);

  // Fetch deliveries data
  useEffect(() => {
    if (activeSection === 'delivery-management') {
      fetchDeliveries();
      fetchPurchaseVerifications();
    }
  }, [activeSection]);

  // Smart status update interval state (in seconds)
  const [statusUpdateInterval, setStatusUpdateInterval] = React.useState(10); // Default 10 seconds

  // Lightweight function to update only auction statuses (for real-time updates)
  // Only updates pending/active auctions, uses dynamic intervals based on time until status change
  const updateAuctionStatuses = React.useCallback(async () => {
    // Use functional setState to get current auctions
    setAuctions(prevAuctions => {
      if (prevAuctions.length === 0) return prevAuctions;
      
      // Filter to only pending/active auctions (no need to check ended/completed)
      const activeAuctionIds = prevAuctions
        .filter(auction => auction.status === 'pending' || auction.status === 'active')
        .map(auction => auction.id);
      
      if (activeAuctionIds.length === 0) {
        // No active auctions, no need to update
        return prevAuctions;
      }
      
      // Fetch statuses asynchronously
      adminAPI.getAuctionStatuses(activeAuctionIds)
        .then(response => {
          const statuses = response.data.statuses || {};
          const recommendedInterval = response.data.recommended_interval || 10;
          
          // Update recommended interval for dynamic polling
          if (recommendedInterval !== statusUpdateInterval) {
            setStatusUpdateInterval(recommendedInterval);
          }
          
          // Update only status field
          setAuctions(currentAuctions => 
            currentAuctions.map(auction => {
              // Only update if auction is pending/active (or was pending/active)
              if (auction.status === 'pending' || auction.status === 'active' || statuses[auction.id]) {
                const newStatus = statuses[auction.id];
                if (newStatus && newStatus !== auction.status) {
                  return { ...auction, status: newStatus };
                }
              }
              return auction;
            })
          );
        })
        .catch((error) => {
          // Log error but don't break the UI
          console.warn('Failed to update auction statuses:', error.response?.data?.message || error.message);
        });
      
      return prevAuctions; // Return immediately
    });
  }, [statusUpdateInterval]);

  // Fetch auction-related data
  useEffect(() => {
    if (activeSection === 'auction-management') {
      fetchAuctions();
      fetchBiddingHistory();
      fetchBidWinners();
      fetchBlockedUsers();
      fetchBiddingTracking();
      
      // Full refresh every 5 minutes (for bid counts, prices, etc.)
      const fullRefreshInterval = setInterval(() => {
        fetchAuctions();
      }, 300000); // Full refresh every 5 minutes
      
      return () => {
        clearInterval(fullRefreshInterval);
      };
    }
  }, [activeSection]); // fetchAuctions and other functions are stable, no need in deps

  // Separate effect for smart status updates with dynamic intervals
  // This effect restarts when statusUpdateInterval changes
  // PAUSES when form is open to avoid interfering with typing
  useEffect(() => {
    // Don't update status when form is open (prevents input lag)
    if (activeSection === 'auction-management' && auctions.length > 0 && !showAuctionForm && !showEditAuctionModal) {
      // Initial update
      updateAuctionStatuses();
      
      // Set up dynamic interval that adjusts based on time until status change
      const statusUpdateTimer = setInterval(() => {
        updateAuctionStatuses();
      }, statusUpdateInterval * 1000);
      
      return () => {
        clearInterval(statusUpdateTimer);
      };
    }
  }, [activeSection, auctions.length, statusUpdateInterval, updateAuctionStatuses, showAuctionForm, showEditAuctionModal]);

  // Clear errors when switching sections
  useEffect(() => {
    setError(null);
    setSuccessMessage(null);
  }, [activeSection]);

  // Fetch category management data
  useEffect(() => {
    if (activeSection === 'category-management') {
      fetchCategoryManagement();
    }
  }, [activeSection]);

  // Fetch eBook management data
  useEffect(() => {
    if (activeSection === 'ebook-management') {
      fetchEbooks();
      fetchUsers(); // Need users for seller selection
      fetchCategories(); // Need categories for eBook categorization
    }
  }, [activeSection]);

  // Fetch Nepali Products management data
  const fetchNepaliProducts = async () => {
    setNepaliProductsLoading(true);
    try {
      const response = await adminAPI.getNepaliProducts(nepaliProductsStatusFilter);
      const data = response.data.data || response.data || [];
      setNepaliProducts(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error('Error fetching Nepali products:', err);
      setError('Failed to fetch Nepali products: ' + (err.response?.data?.message || err.message));
    } finally {
      setNepaliProductsLoading(false);
    }
  };

  useEffect(() => {
    if (activeSection === 'nepali-products') {
      fetchNepaliProducts();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeSection, nepaliProductsStatusFilter]);

  const handleApproveNepaliProduct = async (id) => {
    try {
      await adminAPI.approveNepaliProduct(id);
      setSuccessMessage('Product approved successfully');
      fetchNepaliProducts();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to approve product: ' + (err.response?.data?.message || err.message));
    }
  };

  const handleRejectNepaliProduct = async (id, reason = '') => {
    try {
      await adminAPI.rejectNepaliProduct(id, reason);
      setSuccessMessage('Product rejected successfully');
      fetchNepaliProducts();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to reject product: ' + (err.response?.data?.message || err.message));
    }
  };

  const handleDeleteNepaliProduct = async (id) => {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
      return;
    }
    try {
      await adminAPI.deleteNepaliProduct(id);
      setSuccessMessage('Product deleted successfully');
      fetchNepaliProducts();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete product: ' + (err.response?.data?.message || err.message));
    }
  };

  const fetchLocations = async () => {
    setLocationsLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getLocations();
      
      // Handle different response structures - ensure we get an array
      let locationsData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        locationsData = response.data;
      } 
      // Check if response itself is an array
      else if (Array.isArray(response)) {
        locationsData = response;
      }
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        locationsData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        locationsData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        locationsData = [];
      }
      
      // Transform locations data to match the expected format
      const transformedLocations = Array.isArray(locationsData)
        ? locationsData.map(location => ({
            id: location.id,
            province: location.province,
            district: location.district,
            localLevel: location.local_level,
            localLevelType: location.local_level_type,
            wardNumber: location.ward_number,
            localAddress: location.local_address
          }))
        : [];
      
      setLocations(transformedLocations);
    } catch (err) {
      setError('Failed to fetch locations: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching locations:', err);
    } finally {
      setLocationsLoading(false);
    }
  };

  // Handle delete location
  const handleDeleteLocation = async (id) => {
    if (!window.confirm('Are you sure you want to delete this location?')) {
      return;
    }
    
    try {
      await adminAPI.deleteLocation(id);
      setSuccessMessage('Location deleted successfully');
      fetchLocations(); // Refresh the list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete location: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle edit location - start inline editing
  const handleEditLocation = (location) => {
    setEditingLocationId(location.id);
    setEditingLocationData({
      province: location.province,
      district: location.district,
      localLevel: location.localLevel,
      localLevelType: location.localLevelType,
      wardNumber: location.wardNumber || '',
      localAddress: location.localAddress || '',
    });
  };

  // Handle save location - save changes
  const handleSaveLocation = async (locationId) => {
    try {
      await adminAPI.updateLocation(locationId, {
        province: editingLocationData.province,
        district: editingLocationData.district,
        local_level: editingLocationData.localLevel,
        local_level_type: editingLocationData.localLevelType,
        ward_number: editingLocationData.wardNumber ? parseInt(editingLocationData.wardNumber) : null,
        local_address: editingLocationData.localAddress || null,
      });
      setSuccessMessage('Location updated successfully');
      setEditingLocationId(null);
      setEditingLocationData(null);
      fetchLocations(); // Refresh the list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update location: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit location
  const handleCancelEditLocation = () => {
    setEditingLocationId(null);
    setEditingLocationData(null);
  };

  // Fetch deliveries
  const fetchDeliveries = async () => {
    setDeliveryLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getDeliveries();
      
      // Handle different response structures - ensure we get an array
      let deliveriesData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        deliveriesData = response.data;
      } 
      // Check if response itself is an array (shouldn't happen with axios, but just in case)
      else if (Array.isArray(response)) {
        deliveriesData = response;
      } 
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        deliveriesData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        deliveriesData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        deliveriesData = [];
      }
      
      // Transform to match expected format - only if we have valid data
      const transformedDeliveries = Array.isArray(deliveriesData) 
        ? deliveriesData.map(delivery => ({
            id: delivery.id,
            sellerVendor: delivery.seller_vendor?.name || delivery.sellerVendor?.name || 'N/A',
            item: delivery.item,
            price: parseFloat(delivery.price) || 0,
            deliveryStatus: delivery.delivery_status,
            pickupDate: delivery.pickup_date
          }))
        : [];
      
      setDeliveryData(transformedDeliveries);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch deliveries: ' + errorMessage);
      console.error('Error fetching deliveries:', err);
      console.error('Error response:', err.response);
      setDeliveryData([]); // Set empty array on error
    } finally {
      setDeliveryLoading(false);
    }
  };

  // Handle edit delivery
  const handleEditDelivery = (delivery) => {
    setEditingDeliveryId(delivery.id);
    setEditingDeliveryData({
      item: delivery.item,
      price: delivery.price,
      deliveryStatus: delivery.deliveryStatus,
      pickupDate: delivery.pickupDate
    });
  };

  // Handle save delivery
  const handleSaveDelivery = async (deliveryId) => {
    try {
      await adminAPI.updateDelivery(deliveryId, {
        item: editingDeliveryData.item,
        price: editingDeliveryData.price,
        delivery_status: editingDeliveryData.deliveryStatus,
        pickup_date: editingDeliveryData.pickupDate,
      });
      setSuccessMessage('Delivery updated successfully');
      setEditingDeliveryId(null);
      setEditingDeliveryData(null);
      fetchDeliveries();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update delivery: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit delivery
  const handleCancelEditDelivery = () => {
    setEditingDeliveryId(null);
    setEditingDeliveryData(null);
  };

  // Handle delete delivery
  const handleDeleteDelivery = async (id) => {
    if (!window.confirm('Are you sure you want to delete this delivery?')) {
      return;
    }
    
    try {
      await adminAPI.deleteDelivery(id);
      setSuccessMessage('Delivery deleted successfully');
      fetchDeliveries();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete delivery: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Fetch purchase verifications
  const fetchPurchaseVerifications = async () => {
    setPurchaseVerificationLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getPurchaseVerifications();
      
      // Handle different response structures - ensure we get an array
      let purchaseData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        purchaseData = response.data;
      } 
      // Check if response itself is an array (shouldn't happen with axios, but just in case)
      else if (Array.isArray(response)) {
        purchaseData = response;
      } 
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        purchaseData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        purchaseData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        purchaseData = [];
      }
      
      // Transform to match expected format - only if we have valid data
      const transformedPurchases = Array.isArray(purchaseData) 
        ? purchaseData.map(purchase => ({
            id: purchase.id,
            buyerUser: purchase.buyer_user?.name || purchase.buyerUser?.name || 'N/A',
            item: purchase.item,
            price: parseFloat(purchase.price) || 0,
            purchaseDate: purchase.purchase_date,
            verificationCode: purchase.verification_code,
            deliveryStatus: purchase.delivery_status
          }))
        : [];
      
      setPurchaseVerificationData(transformedPurchases);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch purchase verifications: ' + errorMessage);
      console.error('Error fetching purchase verifications:', err);
      console.error('Error response:', err.response);
      setPurchaseVerificationData([]); // Set empty array on error
    } finally {
      setPurchaseVerificationLoading(false);
    }
  };

  // Handle edit purchase verification
  const handleEditPurchaseVerification = (purchase) => {
    setEditingPurchaseVerificationId(purchase.id);
    setEditingPurchaseVerificationData({
      item: purchase.item,
      price: purchase.price,
      purchaseDate: purchase.purchaseDate,
      verificationCode: purchase.verificationCode,
      deliveryStatus: purchase.deliveryStatus
    });
  };

  // Handle save purchase verification
  const handleSavePurchaseVerification = async (purchaseId) => {
    try {
      await adminAPI.updatePurchaseVerification(purchaseId, {
        item: editingPurchaseVerificationData.item,
        price: editingPurchaseVerificationData.price,
        purchase_date: editingPurchaseVerificationData.purchaseDate,
        verification_code: editingPurchaseVerificationData.verificationCode,
        delivery_status: editingPurchaseVerificationData.deliveryStatus,
      });
      setSuccessMessage('Purchase verification updated successfully');
      setEditingPurchaseVerificationId(null);
      setEditingPurchaseVerificationData(null);
      fetchPurchaseVerifications();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update purchase verification: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit purchase verification
  const handleCancelEditPurchaseVerification = () => {
    setEditingPurchaseVerificationId(null);
    setEditingPurchaseVerificationData(null);
  };

  // Handle delete purchase verification
  const handleDeletePurchaseVerification = async (id) => {
    if (!window.confirm('Are you sure you want to delete this purchase verification?')) {
      return;
    }
    
    try {
      await adminAPI.deletePurchaseVerification(id);
      setSuccessMessage('Purchase verification deleted successfully');
      fetchPurchaseVerifications();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete purchase verification: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Fetch bidding history
  const fetchAuctions = async () => {
    setAuctionsLoading(true);
    try {
      const response = await adminAPI.getAuctions();
      setAuctions(response.data.auctions || response.data || []);
    } catch (err) {
      console.error('Error fetching auctions:', err);
      setAuctions([]);
    } finally {
      setAuctionsLoading(false);
    }
  };


  const fetchBiddingHistory = async () => {
    setBiddingHistoryLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getBiddingHistory();
      
      // Handle new grouped response structure
      if (response.data && response.data.grouped) {
        // New grouped format
        const groupedData = response.data.grouped.map(group => ({
          auctionId: group.auction_id,
          auctionTitle: group.auction_title || 'Unknown Auction',
          auction: group.auction,
          totalCount: group.total_count,
          biddingHistory: (group.bidding_history || []).map(bid => ({
            id: bid.id,
            userName: bid.user?.name || 'N/A',
            itemName: bid.item_name,
            bidAmount: parseFloat(bid.bid_amount) || null,
            reservePrice: parseFloat(bid.reserve_price) || 0,
            buyNowPrice: parseFloat(bid.buy_now_price) || 0,
            paymentMethod: bid.payment_method,
            startDateTime: bid.start_date_time
          }))
        }));
        
        setBiddingHistoryGrouped(groupedData);
        
        // Extract available auctions for filter dropdown
        const auctions = groupedData.map(group => ({
          id: group.auctionId,
          title: group.auctionTitle,
          count: group.totalCount || 0, // Bidding history count
          bidCount: group.bidCount || 0 // Total bids from bids table
        }));
        setAvailableAuctions(auctions);
        
        // If no auctions selected, select all by default
        if (selectedAuctionIds.length === 0 && auctions.length > 0) {
          setSelectedAuctionIds(auctions.map(a => a.id));
        }
        
        // Also set flat data for backward compatibility
        const flatData = response.data.flat || [];
        const transformedBidding = Array.isArray(flatData)
          ? flatData.map(bid => ({
              id: bid.id,
              userName: bid.user?.name || 'N/A',
              itemName: bid.item_name,
              bidAmount: parseFloat(bid.bid_amount) || null,
              reservePrice: parseFloat(bid.reserve_price) || 0,
              buyNowPrice: parseFloat(bid.buy_now_price) || 0,
              paymentMethod: bid.payment_method,
              startDateTime: bid.start_date_time
            }))
          : [];
        setBiddingHistoryData(transformedBidding);
      } else {
        // Fallback to old format for backward compatibility
        let biddingData = [];
        
        if (Array.isArray(response.data)) {
          biddingData = response.data;
        } else if (Array.isArray(response)) {
          biddingData = response;
        } else if (response.data && response.data.data && Array.isArray(response.data.data)) {
          biddingData = response.data.data;
        } else if (response.data) {
          console.error('Unexpected response format - response.data is not an array:', response.data);
          biddingData = [];
        } else {
          console.error('Unexpected response format:', response);
          biddingData = [];
        }
        
        const transformedBidding = Array.isArray(biddingData)
          ? biddingData.map(bid => ({
              id: bid.id,
              userName: bid.user?.name || 'N/A',
              itemName: bid.item_name,
              bidAmount: parseFloat(bid.bid_amount) || null,
              reservePrice: parseFloat(bid.reserve_price) || 0,
              buyNowPrice: parseFloat(bid.buy_now_price) || 0,
              paymentMethod: bid.payment_method,
              startDateTime: bid.start_date_time
            }))
          : [];
        
        setBiddingHistoryData(transformedBidding);
        setBiddingHistoryGrouped([]);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch bidding history: ' + errorMessage);
      console.error('Error fetching bidding history:', err);
      console.error('Error response:', err.response);
      setBiddingHistoryData([]);
      setBiddingHistoryGrouped([]);
    } finally {
      setBiddingHistoryLoading(false);
    }
  };
  
  // Toggle auction expansion
  const toggleAuctionExpansion = (auctionId) => {
    setExpandedAuctionIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(auctionId)) {
        newSet.delete(auctionId);
      } else {
        newSet.add(auctionId);
      }
      return newSet;
    });
  };

  // Handle edit bidding history
  const handleEditBiddingHistory = (bid) => {
    setEditingBiddingHistoryId(bid.id);
    setEditingBiddingHistoryData({
      itemName: bid.itemName,
      reservePrice: bid.reservePrice,
      buyNowPrice: bid.buyNowPrice,
      paymentMethod: bid.paymentMethod,
      startDateTime: bid.startDateTime
    });
  };

  // Handle save bidding history
  const handleSaveBiddingHistory = async (bidId) => {
    try {
      await adminAPI.updateBiddingHistory(bidId, {
        item_name: editingBiddingHistoryData.itemName,
        reserve_price: editingBiddingHistoryData.reservePrice,
        buy_now_price: editingBiddingHistoryData.buyNowPrice,
        payment_method: editingBiddingHistoryData.paymentMethod,
        start_date_time: editingBiddingHistoryData.startDateTime,
      });
      setSuccessMessage('Bidding history updated successfully');
      setEditingBiddingHistoryId(null);
      setEditingBiddingHistoryData(null);
      fetchBiddingHistory();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update bidding history: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit bidding history
  const handleCancelEditBiddingHistory = () => {
    setEditingBiddingHistoryId(null);
    setEditingBiddingHistoryData(null);
  };

  // Handle delete bidding history
  const handleDeleteBiddingHistory = async (id) => {
    if (!window.confirm('Are you sure you want to delete this bidding history?')) {
      return;
    }
    
    try {
      await adminAPI.deleteBiddingHistory(id);
      setSuccessMessage('Bidding history deleted successfully');
      fetchBiddingHistory(); // Refresh the list
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      // If record not found (404), it was already deleted - refresh list and show info message
      if (err.response?.status === 404) {
        setSuccessMessage(err.response?.data?.message || 'Bidding history was already deleted. Refreshing list...');
        fetchBiddingHistory(); // Refresh to get updated list
        setTimeout(() => setSuccessMessage(null), 3000);
      } else {
        setError('Failed to delete bidding history: ' + (err.response?.data?.message || err.message));
        setTimeout(() => setError(null), 5000);
      }
    }
  };

  // Fetch bid winners
  const fetchBidWinners = async () => {
    setBidWinnerLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getBidWinners();
      // Handle different response structures - ensure we get an array
      let winnersData = [];
      
      if (Array.isArray(response.data)) {
        winnersData = response.data;
      } else if (Array.isArray(response)) {
        winnersData = response;
      } else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        winnersData = response.data.data;
      } else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        winnersData = [];
      } else {
        console.error('Unexpected response format:', response);
        winnersData = [];
      }
      
      const transformedWinners = Array.isArray(winnersData) ? winnersData.map(winner => ({
        id: winner.id,
        userName: winner.user?.name || 'N/A',
        biddingItem: winner.bidding_item,
        bidStartDate: winner.bid_start_date,
        bidWonDate: winner.bid_won_date,
        paymentProceedDate: winner.payment_proceed_date,
        totalPayment: parseFloat(winner.total_payment) || 0,
        sellerName: winner.seller?.name || 'N/A',
        emailSent: winner.congratulation_email_sent ? 'Yes' : 'No'
      })) : [];
      
      setBidWinnerData(transformedWinners);
    } catch (err) {
      setError('Failed to fetch bid winners: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching bid winners:', err);
    } finally {
      setBidWinnerLoading(false);
    }
  };

  // Handle edit bid winner
  const handleEditBidWinner = (winner) => {
    setEditingBidWinnerId(winner.id);
    setEditingBidWinnerData({
      biddingItem: winner.biddingItem,
      bidStartDate: winner.bidStartDate,
      bidWonDate: winner.bidWonDate,
      paymentProceedDate: winner.paymentProceedDate,
      totalPayment: winner.totalPayment,
      emailSent: winner.emailSent === 'Yes'
    });
  };

  // Handle save bid winner
  const handleSaveBidWinner = async (winnerId) => {
    try {
      await adminAPI.updateBidWinner(winnerId, {
        bidding_item: editingBidWinnerData.biddingItem,
        bid_start_date: editingBidWinnerData.bidStartDate,
        bid_won_date: editingBidWinnerData.bidWonDate,
        payment_proceed_date: editingBidWinnerData.paymentProceedDate,
        total_payment: editingBidWinnerData.totalPayment,
        congratulation_email_sent: editingBidWinnerData.emailSent,
      });
      setSuccessMessage('Bid winner updated successfully');
      setEditingBidWinnerId(null);
      setEditingBidWinnerData(null);
      fetchBidWinners();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update bid winner: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit bid winner
  const handleCancelEditBidWinner = () => {
    setEditingBidWinnerId(null);
    setEditingBidWinnerData(null);
  };

  // Handle delete bid winner
  const handleDeleteBidWinner = async (id) => {
    if (!window.confirm('Are you sure you want to delete this bid winner?')) {
      return;
    }
    
    try {
      await adminAPI.deleteBidWinner(id);
      setSuccessMessage('Bid winner deleted successfully');
      fetchBidWinners();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete bid winner: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Fetch blocked users
  const fetchBlockedUsers = async () => {
    setBlockedUserLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getBlockedUsers();
      // Handle different response structures - ensure we get an array
      let blockedData = [];
      
      if (Array.isArray(response.data)) {
        blockedData = response.data;
      } else if (Array.isArray(response)) {
        blockedData = response;
      } else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        blockedData = response.data.data;
      } else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        blockedData = [];
      } else {
        console.error('Unexpected response format:', response);
        blockedData = [];
      }
      
      const transformedBlocked = Array.isArray(blockedData) ? blockedData.map(blocked => ({
        id: blocked.id,
        userName: blocked.user?.name || 'N/A',
        email: blocked.email,
        address: blocked.address,
        dateToBlock: blocked.date_to_block,
        reasonToBlock: blocked.reason_to_block
      })) : [];
      
      setBlockedUserData(transformedBlocked);
    } catch (err) {
      setError('Failed to fetch blocked users: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching blocked users:', err);
    } finally {
      setBlockedUserLoading(false);
    }
  };

  // Handle edit blocked user
  const handleEditBlockedUser = (user) => {
    setEditingBlockedUserId(user.id);
    setEditingBlockedUserData({
      email: user.email,
      address: user.address,
      dateToBlock: user.dateToBlock,
      reasonToBlock: user.reasonToBlock
    });
  };

  // Handle save blocked user
  const handleSaveBlockedUser = async (userId) => {
    try {
      await adminAPI.updateBlockedUser(userId, {
        email: editingBlockedUserData.email,
        address: editingBlockedUserData.address,
        date_to_block: editingBlockedUserData.dateToBlock,
        reason_to_block: editingBlockedUserData.reasonToBlock,
      });
      setSuccessMessage('Blocked user updated successfully');
      setEditingBlockedUserId(null);
      setEditingBlockedUserData(null);
      fetchBlockedUsers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update blocked user: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit blocked user
  const handleCancelEditBlockedUser = () => {
    setEditingBlockedUserId(null);
    setEditingBlockedUserData(null);
  };

  // Handle delete blocked user
  const handleDeleteBlockedUser = async (id) => {
    if (!window.confirm('Are you sure you want to delete this blocked user?')) {
      return;
    }
    
    try {
      await adminAPI.deleteBlockedUser(id);
      setSuccessMessage('Blocked user deleted successfully');
      fetchBlockedUsers();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete blocked user: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Fetch bidding tracking
  const fetchBiddingTracking = async () => {
    setBiddingTrackingLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getBiddingTracking();
      // Handle different response structures - ensure we get an array
      let trackingData = [];
      
      if (Array.isArray(response.data)) {
        trackingData = response.data;
      } else if (Array.isArray(response)) {
        trackingData = response;
      } else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        trackingData = response.data.data;
      } else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        trackingData = [];
      } else {
        console.error('Unexpected response format:', response);
        trackingData = [];
      }
      
      const transformedTracking = Array.isArray(trackingData) ? trackingData.map(tracking => ({
        id: tracking.id,
        bidWinnerName: tracking.bid_winner_name,
        bidWonItemName: tracking.bid_won_item_name,
        paymentStatus: tracking.payment_status,
        pickupStatus: tracking.pickup_status,
        completeProcessDateTime: tracking.complete_process_date_time,
        alertSent: tracking.alert_sent ? 'Yes' : 'No'
      })) : [];
      
      setBiddingTrackingData(transformedTracking);
    } catch (err) {
      setError('Failed to fetch bidding tracking: ' + (err.response?.data?.message || err.message));
      console.error('Error fetching bidding tracking:', err);
    } finally {
      setBiddingTrackingLoading(false);
    }
  };

  // Handle edit bidding tracking
  const handleEditBiddingTracking = (tracking) => {
    setEditingBiddingTrackingId(tracking.id);
    setEditingBiddingTrackingData({
      bidWinnerName: tracking.bidWinnerName,
      bidWonItemName: tracking.bidWonItemName,
      paymentStatus: tracking.paymentStatus,
      pickupStatus: tracking.pickupStatus,
      completeProcessDateTime: tracking.completeProcessDateTime,
      alertSent: tracking.alertSent === 'Yes'
    });
  };

  // Handle save bidding tracking
  const handleSaveBiddingTracking = async (trackingId) => {
    try {
      await adminAPI.updateBiddingTracking(trackingId, {
        bid_winner_name: editingBiddingTrackingData.bidWinnerName,
        bid_won_item_name: editingBiddingTrackingData.bidWonItemName,
        payment_status: editingBiddingTrackingData.paymentStatus,
        pickup_status: editingBiddingTrackingData.pickupStatus,
        complete_process_date_time: editingBiddingTrackingData.completeProcessDateTime,
        alert_sent: editingBiddingTrackingData.alertSent,
      });
      setSuccessMessage('Bidding tracking updated successfully');
      setEditingBiddingTrackingId(null);
      setEditingBiddingTrackingData(null);
      fetchBiddingTracking();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update bidding tracking: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit bidding tracking
  const handleCancelEditBiddingTracking = () => {
    setEditingBiddingTrackingId(null);
    setEditingBiddingTrackingData(null);
  };

  // Handle delete bidding tracking
  const handleDeleteBiddingTracking = async (id) => {
    if (!window.confirm('Are you sure you want to delete this bidding tracking?')) {
      return;
    }
    
    try {
      await adminAPI.deleteBiddingTracking(id);
      setSuccessMessage('Bidding tracking deleted successfully');
      fetchBiddingTracking();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete bidding tracking: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Search location selections - multiple selections with checkboxes (must be declared before useMemo)
  const [selectedLocations, setSelectedLocations] = useState(new Set()); // Store location IDs as Set
  const [expandedProvinces, setExpandedProvinces] = useState(new Set());
  const [expandedDistricts, setExpandedDistricts] = useState(new Set());
  const [expandedLocalLevels, setExpandedLocalLevels] = useState(new Set());

  // Filter and sort ads based on search criteria (matching Homepage logic)
  // Only show active ads to match Homepage behavior
  const filteredAndSortedAds = useMemo(() => {
    if (!ads || ads.length === 0) {
      return [];
    }
    
    // Filter to only show active ads (matching Homepage behavior)
    let filtered = ads.filter(ad => ad.status === 'active');

    // Filter by search keyword
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(ad => 
        ad.title.toLowerCase().includes(query) || 
        ad.description.toLowerCase().includes(query)
      );
    }

    // Filter by selected categories and subcategories from search bar dropdown
    if (selectedCategories.size > 0 || selectedSubcategories.size > 0) {
      // Collect all relevant item category IDs for filtering
      // selectedSubcategories contains item category IDs (when field category checkboxes are clicked)
      // We need to collect all item category IDs that should be included
      const allItemCategoryIds = new Set();
      
      // Add directly selected item category IDs (selectedSubcategories contains item category IDs)
      selectedSubcategories.forEach(id => {
        const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
        allItemCategoryIds.add(idNum);
      });
          
      // For each selected main category, add all item category IDs from all its subcategories
      selectedCategories.forEach(id => {
        const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
        const category = categories.find(cat => {
          const catId = typeof cat.id === 'string' ? parseInt(cat.id, 10) : Number(cat.id);
          return catId === idNum;
        });
          
          if (category) {
          // Add all item category IDs from all subcategories under this main category
          if (category.subcategories && Array.isArray(category.subcategories)) {
            category.subcategories.forEach(sub => {
              // Add all item category IDs from this subcategory
              if (sub && sub.item_categories && Array.isArray(sub.item_categories)) {
                sub.item_categories.forEach(item => {
                  if (item && item.id != null) {
                    const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                    allItemCategoryIds.add(itemId);
                  }
                });
              }
            });
          }
        }
      });
      
      // Only filter if we have item category IDs to filter by
      if (allItemCategoryIds.size > 0) {
        // Filter ads by checking if their category_id matches any collected item category ID
        filtered = filtered.filter(ad => {
          if (!ad.category_id) return false;
          const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
          return allItemCategoryIds.has(adCategoryId);
        });
      } else {
        // If no item category IDs collected, don't show any ads (categories selected but no matching items)
        filtered = [];
      }
    }

    // Filter by selected locations (checkboxes)
    if (selectedLocations.size > 0) {
      filtered = filtered.filter(ad => {
        const adLocationId = ad.location_id || ad.locationId;
        if (!adLocationId) return false;
        
        const adLocationIdStr = String(adLocationId);
        const adLocationIdNum = Number(adLocationId);
        
        let adAddressIndex = null;
        if (ad.selected_local_address_index !== null && ad.selected_local_address_index !== undefined) {
          const indexValue = Number(ad.selected_local_address_index);
          if (!isNaN(indexValue)) {
            adAddressIndex = indexValue;
          }
        }
        
        for (const selectedId of selectedLocations) {
          if (typeof selectedId === 'number') {
            if (selectedId === adLocationIdNum) {
              return true;
            }
          } else if (typeof selectedId === 'string') {
            if (selectedId === adLocationIdStr) {
              return true;
            }
            if (selectedId.includes('-')) {
              const parts = selectedId.split('-');
              const wardIdStr = parts[0];
              const addressIndexStr = parts.slice(1).join('-');
              const wardIdNum = parseInt(wardIdStr, 10);
              const addressIndex = parseInt(addressIndexStr, 10);
              
              if (!isNaN(wardIdNum) && (wardIdNum === adLocationIdNum || String(wardIdNum) === adLocationIdStr)) {
                if (!isNaN(addressIndex)) {
                  if (addressIndex === 0) {
                    if (adAddressIndex === 0 || adAddressIndex === null) {
                      return true;
                    }
                  } else {
                    if (adAddressIndex === addressIndex) {
                      return true;
                    }
                  }
                } else {
                  return true;
                }
              }
            } else {
              const selectedIdNum = parseInt(selectedId, 10);
              if (!isNaN(selectedIdNum) && selectedIdNum === adLocationIdNum) {
                return true;
              }
            }
          }
        }
        
        return false;
      });
    }

    // Sort ads (matching Homepage logic)
    const sorted = [...filtered].sort((a, b) => {
      switch (adSort) {
        case 'lowest price':
          return a.price - b.price;
        case 'highest price':
          return b.price - a.price;
        case 'ascending order':
          return a.title.localeCompare(b.title);
        case 'descending order':
          return b.title.localeCompare(a.title);
        case 'latest listing':
          return b.id - a.id; // Assuming higher ID = newer
        case 'top review':
          // TODO: Implement when review system is ready
          return 0;
        default: // 'most relevant'
          return 0;
      }
    });
    return sorted;
  }, [ads, adSort, searchQuery, selectedCategories, selectedSubcategories, selectedLocations, categories]);

  // Pagination calculations
  const totalPages = Math.ceil(filteredAndSortedAds.length / adsPerPage);
  const startResult = filteredAndSortedAds.length > 0 ? (currentPage - 1) * adsPerPage + 1 : 0;
  const endResult = Math.min(currentPage * adsPerPage, filteredAndSortedAds.length);
  
  // Get paginated ads
  const displayedAds = filteredAndSortedAds.slice((currentPage - 1) * adsPerPage, currentPage * adsPerPage);

  // Handle page change
  const handlePageChange = (page) => {
    setCurrentPage(page);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Reset to page 1 when filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [searchQuery, selectedCategories, selectedSubcategories, selectedLocations]);

  // Helper functions for location selection with checkboxes
  const handleLocationToggle = (locationId) => {
    setSelectedLocations(prev => {
      const newSet = new Set(prev);
      if (newSet.has(locationId)) {
        newSet.delete(locationId);
      } else {
        newSet.add(locationId);
      }
      return newSet;
    });
  };

  const handleSelectAllLocations = () => {
    if (selectedLocations.size > 0) {
      setSelectedLocations(new Set());
    } else {
      // Select all location IDs from the database
      // This would require fetching all location IDs, but for now we'll just clear
      setSelectedLocations(new Set());
    }
  };

  const buildSearchLocationString = () => {
    // Count only addresses (leaf level) and wards without addresses - matching UserDashboard logic
    const selectedIds = Array.from(selectedLocations);
    const addressIds = selectedIds.filter(id => typeof id === 'string' && id.includes('-'));
    
    // Count wards without addresses (numeric IDs that don't have corresponding addresses selected)
    const wardIdsWithoutAddresses = selectedIds.filter(id => {
      if (typeof id === 'number' || (typeof id === 'string' && !id.includes('-'))) {
        // Check if this ward has any addresses selected
        const wardId = typeof id === 'number' ? id : parseInt(id, 10);
        const hasAddresses = selectedIds.some(selectedId => 
          typeof selectedId === 'string' && selectedId.startsWith(`${wardId}-`)
        );
        return !hasAddresses;
      }
      return false;
    });
    
    const totalCount = addressIds.length + wardIdsWithoutAddresses.length;
    
    if (totalCount === 0) {
      return 'All Locations';
    }
    if (totalCount === 1) {
      return '1 location selected';
    }
    return `${totalCount} locations selected`;
  };

  const toggleProvince = (provinceId) => {
    setExpandedProvinces(prev => {
      const newSet = new Set(prev);
      if (newSet.has(provinceId)) {
        newSet.delete(provinceId);
      } else {
        newSet.add(provinceId);
      }
      return newSet;
    });
  };

  const toggleDistrict = (districtKey) => {
    setExpandedDistricts(prev => {
      const newSet = new Set(prev);
      if (newSet.has(districtKey)) {
        newSet.delete(districtKey);
      } else {
        newSet.add(districtKey);
      }
      return newSet;
    });
  };

  const toggleLocalLevel = (localLevelKey) => {
    setExpandedLocalLevels(prev => {
      const newSet = new Set(prev);
      if (newSet.has(localLevelKey)) {
        newSet.delete(localLevelKey);
      } else {
        newSet.add(localLevelKey);
      }
      return newSet;
    });
  };

  // Category helper functions matching Homepage design
  const getTopLevelCategories = () => {
    // In AdminPanel, all categories in the array are already top-level categories with nested subcategories
    // So just return all categories
    return categories;
  };

  const getSubcategories = (parentId) => {
    const category = categories.find(cat => cat.id === parentId);
    return category && category.subcategories ? category.subcategories : [];
  };

  const toggleCategory = (categoryId) => {
    // Find category to get its name (use name as key to avoid ID collisions)
    const category = categories.find(cat => {
      const catId = typeof cat.id === 'string' ? parseInt(cat.id, 10) : Number(cat.id);
      const searchId = typeof categoryId === 'string' ? parseInt(categoryId, 10) : Number(categoryId);
      return catId === searchId;
    });
    
    if (!category) return;
    
    const categoryName = (category.name || '').trim();
    if (!categoryName) return;
    
    // Use category name as key (matching Homepage behavior to avoid ID collisions)
    setExpandedCategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(categoryName)) {
        newSet.delete(categoryName);
      } else {
        newSet.add(categoryName);
      }
      return newSet;
    });
  };

  const handleCategoryToggle = (categoryId) => {
    // Normalize ID to number for consistency
    const normalizedId = typeof categoryId === 'string' ? parseInt(categoryId, 10) : Number(categoryId);
    const category = categories.find(cat => {
      const catId = typeof cat.id === 'string' ? parseInt(cat.id, 10) : Number(cat.id);
      return catId === normalizedId;
    });
    if (!category) return;

    // If category has subcategories, toggle all item categories directly (matching Homepage behavior)
    if (category.subcategories && category.subcategories.length > 0) {
      // Collect all item category IDs from all subcategories
      const allItemCategoryIds = [];
      category.subcategories.forEach(sub => {
        if (sub.item_categories && Array.isArray(sub.item_categories) && sub.item_categories.length > 0) {
          sub.item_categories.forEach(item => {
            if (item && item.id != null) {
              allItemCategoryIds.push(typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id));
            }
          });
        }
    });

      // If no item categories exist, don't do anything (nothing to toggle)
      if (allItemCategoryIds.length === 0) {
        return;
      }
      
      // Check if all item categories are currently selected
      const allSelected = allItemCategoryIds.every(itemId => {
        return Array.from(selectedSubcategories).some(id => {
          const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
          return idNum === itemId;
        });
      });
      
      // Don't auto-expand - user must click the name/button to expand (matching Homepage behavior)
      
      // Toggle all item categories - matching Homepage logic exactly
      setSelectedSubcategories(prev => {
        const newSet = new Set(prev);
        allItemCategoryIds.forEach(itemId => {
          // Remove any existing variations of this ID
          newSet.forEach(id => {
            const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
            if (idNum === itemId) {
              newSet.delete(id);
            }
          });
          if (!allSelected) {
            newSet.add(itemId);
          }
        });
        return newSet;
      });
          } else {
      // If category has no subcategories, toggle the category itself
      let isCurrentlySelected = false;
      selectedCategories.forEach(id => {
        const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
        if (idNum === normalizedId) {
          isCurrentlySelected = true;
        }
      });
      
      setSelectedCategories(prev => {
        const newSet = new Set(prev);
        // Remove any existing variations of this ID
        newSet.forEach(id => {
          const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
          if (idNum === normalizedId) {
            newSet.delete(id);
          }
        });
        if (!isCurrentlySelected) {
          newSet.add(normalizedId);
        }
        return newSet;
      });
    }
  };

  const toggleSubcategory = (subcategoryId) => {
    // Find subcategory to get its name (use name as key to avoid ID collisions)
    let subcategory = null;
    for (const parentCat of categories) {
      if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
        const searchId = typeof subcategoryId === 'string' ? parseInt(subcategoryId, 10) : Number(subcategoryId);
        const found = parentCat.subcategories.find(sub => {
          const subId = typeof sub.id === 'string' ? parseInt(sub.id, 10) : Number(sub.id);
          return subId === searchId;
        });
        if (found) {
          subcategory = found;
          break;
        }
      }
    }
    
    if (!subcategory) return;
    
    const subcategoryName = (subcategory.name || '').trim();
    if (!subcategoryName) return;
    
    // Use subcategory name as key (matching Homepage behavior to avoid ID collisions)
    setExpandedSubcategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(subcategoryName)) {
        newSet.delete(subcategoryName);
      } else {
        newSet.add(subcategoryName);
      }
      return newSet;
    });
  };

  const handleSubcategoryToggle = (subcategoryId) => {
    // Normalize ID to number for consistency
    const normalizedId = typeof subcategoryId === 'string' ? parseInt(subcategoryId, 10) : Number(subcategoryId);
    
    // Find the subcategory to get its item categories
    let subcategory = null;
    for (const parentCat of categories) {
      if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
        const found = parentCat.subcategories.find(sub => {
          const subId = typeof sub.id === 'string' ? parseInt(sub.id, 10) : Number(sub.id);
          return subId === normalizedId;
        });
        if (found) {
          subcategory = found;
          break;
        }
      }
    }
    
    // If subcategory has item categories, toggle all item categories (matching Homepage behavior)
    if (subcategory && subcategory.item_categories && Array.isArray(subcategory.item_categories) && subcategory.item_categories.length > 0) {
      // Collect all item category IDs
      const allItemCategoryIds = subcategory.item_categories.map(item => {
        if (item && item.id != null) {
          return typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
        }
        return null;
      }).filter(id => id !== null);
      
      // If no valid item category IDs, don't do anything
      if (allItemCategoryIds.length === 0) {
        return;
      }
      
      // Check if all item categories are currently selected
      const allSelected = allItemCategoryIds.every(itemId => {
        return Array.from(selectedSubcategories).some(id => {
          const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
          return idNum === itemId;
        });
      });
      
      // Don't auto-expand - user must click the name/button to expand (matching Homepage behavior)
      
      // Toggle all item categories - matching Homepage logic exactly
    setSelectedSubcategories(prev => {
      const newSet = new Set(prev);
        allItemCategoryIds.forEach(itemId => {
          // Remove any existing variations of this ID
          newSet.forEach(id => {
            const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
            if (idNum === itemId) {
              newSet.delete(id);
            }
          });
          if (!allSelected) {
            newSet.add(itemId);
          }
        });
        return newSet;
      });
      } else {
      // If subcategory has no item categories, toggle the subcategory itself
      setSelectedSubcategories(prev => {
        const newSet = new Set(prev);
        // Check if already selected (handle type variations)
        let isSelected = false;
        newSet.forEach(id => {
          const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
          if (idNum === normalizedId) {
            isSelected = true;
          }
        });
        
        // Remove any existing variations of this ID
        newSet.forEach(id => {
          const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
          if (idNum === normalizedId) {
            newSet.delete(id);
      }
        });
        
        // Add if not selected
        if (!isSelected) {
          newSet.add(normalizedId);
        }
        
      return newSet;
    });
    }
  };

  const getCategoryAdCount = (categoryId, categoryName) => {
    if (!ads || ads.length === 0) return 0;
    
    // Filter to only active ads (matching filtering logic)
    const activeAds = ads.filter(ad => ad.status === 'active');
    if (activeAds.length === 0) return 0;
    
    // Priority 1: Check if it's an item category by NAME first (before ID matching)
    // This prevents conflicts where item category ID matches subcategory/main category ID
    let itemCategory = null;
    let itemCategoryFound = false;
    
    if (categoryName) {
      for (const parentCat of categories) {
        if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
          for (const sub of parentCat.subcategories) {
            if (sub.item_categories && Array.isArray(sub.item_categories)) {
              const foundByName = sub.item_categories.find(item => {
                const itemName = (item.item_category || item.name || '').trim();
                const searchName = (categoryName || '').trim();
                return itemName && searchName && itemName === searchName;
              });
              if (foundByName) {
                itemCategory = foundByName;
                itemCategoryFound = true;
                break;
              }
            }
          }
          if (itemCategoryFound) break;
        }
      }
    }
    
    // If item category found by name, count only ads directly linked to this item category
    if (itemCategoryFound && itemCategory) {
      const itemId = typeof itemCategory.id === 'string' ? parseInt(itemCategory.id, 10) : Number(itemCategory.id);
      return activeAds.filter(ad => {
        if (!ad.category_id) return false;
        const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
        return adCategoryId === itemId;
      }).length;
    }
    
    // Priority 2: Check if it's a subcategory by NAME first (before ID matching)
    // This prevents conflicts where subcategory ID matches main category ID
    let subcategory = null;
    let subcategoryFound = false;
    
    if (categoryName && !itemCategoryFound) {
    for (const parentCat of categories) {
      if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
          const foundByName = parentCat.subcategories.find(sub => {
            const subName = (sub.name || '').trim();
            const searchName = (categoryName || '').trim();
            return subName && searchName && subName === searchName;
          });
          if (foundByName) {
            subcategory = foundByName;
            subcategoryFound = true;
          break;
        }
      }
      }
    }
    
    // If subcategory found by name, count ads from all its item categories
    // Subcategories (field categories) contain item_categories array
    if (subcategoryFound && subcategory) {
      // Collect all item category IDs from this subcategory
      const itemCategoryIds = new Set();
      
      // Check if subcategory has item_categories (from transformed structure)
      if (subcategory.item_categories && Array.isArray(subcategory.item_categories)) {
        subcategory.item_categories.forEach(item => {
          if (item && item.id != null) {
            const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
            itemCategoryIds.add(itemId);
          }
        });
      }
      
      // If no item_categories in transformed structure, try to find them from the original structure
      // or count ads directly linked to subcategory ID (fallback)
      if (itemCategoryIds.size === 0) {
        // Fallback: count ads directly linked to subcategory ID
        const subId = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
        return activeAds.filter(ad => {
          if (!ad.category_id) return false;
          const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
          return adCategoryId === subId;
        }).length;
      }
      
      // Count ads that match any of these item category IDs
      return activeAds.filter(ad => {
        if (!ad.category_id) return false;
        const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
        return itemCategoryIds.has(adCategoryId);
      }).length;
    }
    
    // Priority 2: Check if it's a main category by NAME first (before ID matching)
    let category = null;
    
    if (categoryName) {
      category = categories.find(c => {
        const catName = (c.name || '').trim();
        const searchName = (categoryName || '').trim();
        return catName && searchName && catName === searchName;
      });
    }
    
    // If not found by name, check by ID
    if (!category) {
      const searchId = typeof categoryId === 'string' ? parseInt(categoryId, 10) : Number(categoryId);
      category = categories.find(c => {
        const catId = typeof c.id === 'string' ? parseInt(c.id, 10) : Number(c.id);
        return catId === searchId;
      });
    }
    
    // If still not found as main category, check if it's a subcategory by ID
    if (!category && !subcategoryFound && !itemCategoryFound) {
      for (const parentCat of categories) {
        if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
          const searchId = typeof categoryId === 'string' ? parseInt(categoryId, 10) : Number(categoryId);
          const foundById = parentCat.subcategories.find(sub => {
            const subId = typeof sub.id === 'string' ? parseInt(sub.id, 10) : Number(sub.id);
            return subId === searchId;
          });
          if (foundById) {
            subcategory = foundById;
            subcategoryFound = true;
            break;
          }
        }
      }
    }
    
    // Priority 3: Check if it's an item category by ID (last resort)
    if (!itemCategoryFound && !subcategoryFound && !category) {
      for (const parentCat of categories) {
        if (parentCat.subcategories && Array.isArray(parentCat.subcategories)) {
          for (const sub of parentCat.subcategories) {
            if (sub.item_categories && Array.isArray(sub.item_categories)) {
              const searchId = typeof categoryId === 'string' ? parseInt(categoryId, 10) : Number(categoryId);
              const foundById = sub.item_categories.find(item => {
                const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                return itemId === searchId;
              });
              if (foundById) {
                itemCategory = foundById;
                itemCategoryFound = true;
                break;
              }
            }
          }
          if (itemCategoryFound) break;
        }
      }
      
      // If item category found by ID, count only ads directly linked to this item category
      if (itemCategoryFound && itemCategory) {
        const itemId = typeof itemCategory.id === 'string' ? parseInt(itemCategory.id, 10) : Number(itemCategory.id);
        return activeAds.filter(ad => {
          if (!ad.category_id) return false;
          const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
          return adCategoryId === itemId;
      }).length;
    }
    }
    
    // If subcategory found by ID, count ads from all its item categories
    if (subcategoryFound && subcategory) {
      // Collect all item category IDs from this subcategory
      const itemCategoryIds = new Set();
      
      // Check if subcategory has item_categories (from transformed structure)
      if (subcategory.item_categories && Array.isArray(subcategory.item_categories)) {
        subcategory.item_categories.forEach(item => {
          if (item && item.id != null) {
            const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
            itemCategoryIds.add(itemId);
          }
        });
      }
      
      // If no item_categories in transformed structure, try to find them from the original structure
      // or count ads directly linked to subcategory ID (fallback)
      if (itemCategoryIds.size === 0) {
        // Fallback: count ads directly linked to subcategory ID
        const subId = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
        return activeAds.filter(ad => {
          if (!ad.category_id) return false;
          const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
          return adCategoryId === subId;
        }).length;
      }
      
      // Count ads that match any of these item category IDs
      return activeAds.filter(ad => {
        if (!ad.category_id) return false;
        const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
        return itemCategoryIds.has(adCategoryId);
      }).length;
    }
    
    // For main categories, count ads from all item categories under this domain
    // This matches the filtering logic: when a main category is selected, all its subcategories (and their item categories) are also selected
    // IMPORTANT: Ads are only linked to item category IDs, not domain or field category IDs
    if (category) {
      // Collect all item category IDs from all subcategories under this main category
      const allItemCategoryIds = new Set();
      
      // Add all item category IDs from all subcategories (ads are only linked to item category IDs)
      if (category.subcategories && Array.isArray(category.subcategories)) {
        category.subcategories.forEach(sub => {
          // Add all item category IDs from this subcategory
          if (sub && sub.item_categories && Array.isArray(sub.item_categories)) {
            sub.item_categories.forEach(item => {
              if (item && item.id != null) {
                const itemId = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                allItemCategoryIds.add(itemId);
              }
            });
          }
        });
      }
      
      // Count ads that match any of these item category IDs - using Set.has() for efficiency (matching filtering logic)
      if (allItemCategoryIds.size > 0) {
        return activeAds.filter(ad => {
          if (!ad.category_id) return false;
          const adCategoryId = typeof ad.category_id === 'string' ? parseInt(ad.category_id, 10) : Number(ad.category_id);
          return allItemCategoryIds.has(adCategoryId);
    }).length;
      }
      return 0;
    }
    
    return 0;
  };

  const getLocationAdCount = (locationId) => {
    if (!locationId) return 0;
    
    // Check if it's an address ID (format: "wardId-index")
    if (typeof locationId === 'string' && locationId.includes('-')) {
      const parts = locationId.split('-');
      const wardId = parseInt(parts[0], 10);
      const addressIndex = parseInt(parts.slice(1).join('-'), 10);
      
      if (isNaN(wardId) || isNaN(addressIndex)) return 0;
      
      return ads.filter(ad => {
        const adLocationId = ad.location_id || ad.locationId;
        if (!adLocationId) return false;
        
        const adLocationIdNum = typeof adLocationId === 'string' ? parseInt(adLocationId, 10) : Number(adLocationId);
        if (adLocationIdNum !== wardId) return false;
        
        let adAddressIndex = null;
        if (ad.selected_local_address_index !== null && ad.selected_local_address_index !== undefined) {
          const indexValue = Number(ad.selected_local_address_index);
          if (!isNaN(indexValue)) {
            adAddressIndex = indexValue;
          }
        }
        
        // For address index 0: match new ads with index 0 OR old ads with null (backward compatibility)
        if (addressIndex === 0) {
          return adAddressIndex === 0 || adAddressIndex === null;
        }
        
        // For address index > 0: only match new ads with that specific index
        return adAddressIndex === addressIndex;
      }).length;
    }
    
    // For ward-level locations (no address index): count all ads in that ward
    const locationIdNum = typeof locationId === 'string' ? parseInt(locationId, 10) : Number(locationId);
    if (isNaN(locationIdNum)) return 0;
    
    return ads.filter(ad => {
      const adLocationId = ad.location_id || ad.locationId;
      if (!adLocationId) return false;
      
      const adLocationIdNum = typeof adLocationId === 'string' ? parseInt(adLocationId, 10) : Number(adLocationId);
      return adLocationIdNum === locationIdNum;
    }).length;
  };

  const formatDate = (dateStr) => {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    if (Number.isNaN(date.getTime())) return 'N/A';
    return date.toLocaleDateString();
  };

  // Mock subcategories for each category
  const getMockSubcategories = (categoryName) => {
    const subcategoriesMap = {
      'Art & Craft': ['Digital art', 'Painting', 'Sculpture', 'Drawing', 'Handicrafts', 'Pottery'],
      'Bicycle & Accessories': ['Mountain Bikes', 'Road Bikes', 'Electric Bikes', 'Bike Parts', 'Bike Accessories'],
      'Books & Magazine': ['Fiction', 'Non-Fiction', 'Textbooks', 'Comics', 'Magazines', 'E-books'],
      'Building & Construction': ['Construction Materials', 'Tools', 'Hardware', 'Plumbing', 'Electrical Supplies'],
      'Business for Sale': ['Retail Business', 'Restaurant', 'Service Business', 'Manufacturing', 'Online Business'],
      'Clothes & Fashion': ['Men\'s Clothing', 'Women\'s Clothing', 'Kids Clothing', 'Shoes', 'Accessories'],
      'Events/Tickets': ['Concert Tickets', 'Sports Tickets', 'Theater Tickets', 'Event Planning'],
      'Farming & Agriculture': ['Seeds', 'Fertilizers', 'Farm Equipment', 'Livestock', 'Crops'],
      'Furniture': ['Living Room', 'Bedroom', 'Kitchen & Dining', 'Office Furniture', 'Outdoor Furniture'],
      'Health & Beauty': ['Skincare', 'Makeup', 'Hair Care', 'Fitness Equipment', 'Supplements'],
      'Home & Garden': ['Garden Tools', 'Plants', 'Home Decor', 'Kitchenware', 'Cleaning Supplies'],
      'IT & Computers': ['Laptops', 'Desktops', 'Computer Parts', 'Software', 'Networking Equipment'],
      'Jewelers': ['Gold Jewelry', 'Silver Jewelry', 'Diamond Jewelry', 'Watches', 'Gemstones'],
      'Jobs': ['Full-time', 'Part-time', 'Contract', 'Freelance', 'Internship'],
      'Mobile phone & Gadgets': ['Smartphones', 'Tablets', 'Accessories', 'Wearables', 'Cases & Covers'],
      'Music & Musical instrument': ['Guitars', 'Pianos', 'Drums', 'Wind Instruments', 'Audio Equipment'],
      'Office Supply': ['Stationery', 'Office Furniture', 'Printers', 'Office Equipment', 'Supplies'],
      'Pets & Animal': ['Dogs', 'Cats', 'Birds', 'Pet Supplies', 'Pet Food'],
      'Photography': ['Cameras', 'Lenses', 'Accessories', 'Photo Equipment', 'Studio Equipment'],
      'Property': ['Land for Sale', 'House for Sale', 'Apartments', 'Commercial Property', 'Rentals'],
      'Sports & Recreation': ['Sports Equipment', 'Fitness Gear', 'Outdoor Gear', 'Sports Apparel', 'Games'],
      'Travel & Tourism': ['Travel Packages', 'Hotel Bookings', 'Travel Guides', 'Travel Accessories'],
      'Vehicle': ['Cars', 'Motorcycles', 'Trucks', 'Buses', 'Boats', 'RVs']
    };
    return subcategoriesMap[categoryName] || [];
  };

  const fetchCategories = async () => {
    try {
      const response = await window.axios.get('/api/categories');
      
      // Handle different response structures - ensure we get an array
      let categoriesData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        categoriesData = response.data;
      } 
      // Check if response itself is an array (shouldn't happen with axios, but just in case)
      else if (Array.isArray(response)) {
        categoriesData = response;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        categoriesData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        categoriesData = [];
      }
      
      // Transform 3-level structure (domain > field > item) to 2-level structure (category > subcategory)
      // API returns: { id, name, domain_category, field_categories: [...], item_categories: [...] }
      // AdminPanel expects: { id, name, subcategories: [...] }
      const categoriesWithSubcategories = [];
      
      if (Array.isArray(categoriesData)) {
        categoriesData.forEach((domainCategory) => {
          // Domain category becomes main category
          const mainCategory = {
            id: domainCategory.id,
            name: domainCategory.domain_category || domainCategory.name,
            subcategories: []
          };
          
          // Field categories become subcategories
          if (domainCategory.field_categories && Array.isArray(domainCategory.field_categories)) {
            domainCategory.field_categories.forEach((fieldCategory) => {
              mainCategory.subcategories.push({
                id: fieldCategory.id,
                name: fieldCategory.field_category || fieldCategory.name,
                // Store item categories for ad counting/filtering
                item_categories: fieldCategory.item_categories || []
              });
            });
          }
          
          // If domain has direct item categories (no field categories), create a subcategory for them
          if (domainCategory.item_categories && Array.isArray(domainCategory.item_categories) && domainCategory.item_categories.length > 0) {
            if (mainCategory.subcategories.length === 0) {
              // If no field categories, create a single subcategory for direct item categories
              mainCategory.subcategories.push({
                id: domainCategory.item_categories[0].id, // Use first item category ID
                name: domainCategory.domain_category || domainCategory.name, // Use domain name as subcategory name
                item_categories: domainCategory.item_categories
              });
            }
          }
          
          if (mainCategory.subcategories.length > 0 || domainCategory.item_categories?.length > 0) {
            categoriesWithSubcategories.push(mainCategory);
          }
        });
      }
      
      // For forms (Post Ad, Auction): flatten to include both main categories and subcategories
      const flattenedCategoriesForForms = [];
      categoriesWithSubcategories.forEach((category) => {
          // Add main category
          flattenedCategoriesForForms.push({
            id: category.id,
            name: category.name,
          });
          // Add subcategories
          if (category.subcategories && Array.isArray(category.subcategories) && category.subcategories.length > 0) {
            category.subcategories.forEach((subcategory) => {
              flattenedCategoriesForForms.push({
                id: subcategory.id,
                name: `${category.name} - ${subcategory.name}`,
              });
            });
          }
        });
      
      // Set categories for search bar (nested structure with subcategories)
      setCategories(categoriesWithSubcategories);
      // Set flattened categories for forms
      setFlattenedCategories(flattenedCategoriesForForms);
    } catch (error) {
      console.error('Error fetching categories:', error);
      setCategories([]);
      setFlattenedCategories([]);
    } finally {
      setLoading(false);
    }
  };

  // Fetch category management data from admin API
  const fetchCategoryManagement = async () => {
    setCategoryManagementLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getCategories();
      
      // Handle different response structures - ensure we get an array
      let categoriesData = [];
      
      // Check if response.data is an array
      if (Array.isArray(response.data)) {
        categoriesData = response.data;
      } 
      // Check if response itself is an array (shouldn't happen with axios, but just in case)
      else if (Array.isArray(response)) {
        categoriesData = response;
      } 
      // Check if response.data.data exists and is an array
      else if (response.data && response.data.data && Array.isArray(response.data.data)) {
        categoriesData = response.data.data;
      }
      // If response.data exists but is not an array, log it for debugging
      else if (response.data) {
        console.error('Unexpected response format - response.data is not an array:', response.data);
        categoriesData = [];
      }
      // Fallback to empty array
      else {
        console.error('Unexpected response format:', response);
        categoriesData = [];
      }
      
      // Transform to match expected format - only if we have valid data
      const transformedCategories = Array.isArray(categoriesData) 
        ? categoriesData.map(item => {
            // Backend now returns 3-level hierarchy: domainCategoryName, fieldCategoryName, itemCategoryName
            return {
              id: item.id,
              domainCategoryName: item.domainCategoryName || item.domain_category || '',
              fieldCategoryName: item.fieldCategoryName || item.field_category || '',
              itemCategoryName: item.itemCategoryName || item.item_category || '',
            };
          })
        : [];
      
      setCategoryManagementData(transformedCategories);
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to fetch categories: ' + errorMessage);
      console.error('Error fetching categories:', err);
      console.error('Error response:', err.response);
      setCategoryManagementData([]); // Set empty array on error
    } finally {
      setCategoryManagementLoading(false);
    }
  };

  // Handle edit category
  const handleEditCategory = (category) => {
    setEditingCategoryId(category.id);
    setEditingCategoryData({
      domainCategoryName: category.domainCategoryName,
      fieldCategoryName: category.fieldCategoryName,
      itemCategoryName: category.itemCategoryName
    });
  };

  // Handle save category
  const handleSaveCategory = async (categoryId) => {
    try {
      const category = categoryManagementData.find(c => c.id === categoryId);
      
      // Update 3-level category structure
      await adminAPI.updateCategory(categoryId, {
        domainCategoryName: editingCategoryData.domainCategoryName,
        fieldCategoryName: editingCategoryData.fieldCategoryName || null,
        itemCategoryName: editingCategoryData.itemCategoryName || null,
      });
      
      setSuccessMessage('Category updated successfully');
      setEditingCategoryId(null);
      setEditingCategoryData(null);
      fetchCategoryManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update category: ' + (err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle cancel edit category
  const handleCancelEditCategory = () => {
    setEditingCategoryId(null);
    setEditingCategoryData(null);
  };

  // Fetch eBooks
  const fetchEbooks = async () => {
    setEbookLoading(true);
    setError(null);
    try {
      const response = await adminAPI.getEbooks();
      setEbookData(Array.isArray(response.data) ? response.data : []);
    } catch (err) {
      setError('Failed to fetch eBooks: ' + (err.response?.data?.message || err.message));
      setEbookData([]);
    } finally {
      setEbookLoading(false);
    }
  };

  // Helper to append all values including boolean false/0
  const appendFormData = (formData, dataObj) => {
    Object.keys(dataObj).forEach((key) => {
      const value = dataObj[key];
      const isBoolean = typeof value === 'boolean';
      if (value !== null && value !== undefined && (isBoolean || value !== '')) {
        // Laravel boolean rule accepts 1/0 or true/false bool; avoid string "false"
        if (isBoolean) {
          formData.append(key, value ? '1' : '0');
        } else {
          formData.append(key, value);
        }
      }
    });
  };

  // Handle add eBook
  const handleAddEbook = async (e) => {
    e.preventDefault();
    try {
      const formData = new FormData();
      appendFormData(formData, ebookFormData);
      if (ebookFile) formData.append('file', ebookFile);
      if (ebookCoverImage) formData.append('cover_image', ebookCoverImage);

      await adminAPI.createEbook(formData);
      setSuccessMessage('eBook created successfully');
      setShowAddEbookForm(false);
      // Reset E-Book category selection state
      setEbookSelectedCategoryName('');
      setEbookSelectedSubcategoryId('');
      setEbookSelectedItemCategoryId('');
      setEbookFormData({
        user_id: '',
        category_id: '',
        title: '',
        description: '',
        writer: '',
        language: '',
        pages: '',
        book_size: '',
        file_format: '',
        price: '',
        publisher_name: '',
        publisher_address: '',
        publisher_website: '',
        publisher_email: '',
        publisher_phone: '',
        copyright_declared: false,
        book_type: 'ebook',
        shipping_cost: '',
        delivery_time: '',
        status: 'active',
      });
      setEbookFile(null);
      setEbookCoverImage(null);
      fetchEbooks();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to create eBook: ' + (err.response?.data?.error || err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle edit eBook
  const handleEditEbook = (ebook) => {
    setEditingEbookId(ebook.id);
    setEditingEbookData({ ...ebook });
    setEbookFile(null);
    setEbookCoverImage(null);
    
    // Initialize category selection (similar to Edit Ad logic)
    if (ebook.category_id) {
      let foundCategory = null;
      let foundSubcategory = null;
      let foundItemCategory = null;
      const categoryIdNum = typeof ebook.category_id === 'string' ? parseInt(ebook.category_id, 10) : Number(ebook.category_id);
      
      for (const category of categories) {
        // Check if it's the main category
        const catIdNum = typeof category.id === 'string' ? parseInt(category.id, 10) : Number(category.id);
        if (catIdNum === categoryIdNum) {
          foundCategory = category;
          break;
        }
        // Check subcategories and item categories
        if (category.subcategories) {
          for (const subcategory of category.subcategories) {
            const subIdNum = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
            if (subIdNum === categoryIdNum) {
              foundCategory = category;
              foundSubcategory = subcategory;
              break;
            }
            // Check item categories
            if (subcategory.item_categories && Array.isArray(subcategory.item_categories)) {
              const itemCat = subcategory.item_categories.find(item => {
                const itemIdNum = typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                return itemIdNum === categoryIdNum;
              });
              if (itemCat) {
                foundCategory = category;
                foundSubcategory = subcategory;
                foundItemCategory = itemCat;
                break;
              }
            }
          }
          if (foundCategory) break;
        }
      }
      
      if (foundCategory) {
        setEditingEbookSelectedCategoryName(foundCategory.name);
        if (foundItemCategory) {
          setEditingEbookSelectedSubcategoryId(foundSubcategory.id.toString());
          setEditingEbookSelectedItemCategoryId(foundItemCategory.id.toString());
        } else if (foundSubcategory) {
          setEditingEbookSelectedSubcategoryId(foundSubcategory.id.toString());
          setEditingEbookSelectedItemCategoryId('');
        } else {
          setEditingEbookSelectedSubcategoryId('');
          setEditingEbookSelectedItemCategoryId('');
        }
      } else {
        setEditingEbookSelectedCategoryName('');
        setEditingEbookSelectedSubcategoryId('');
        setEditingEbookSelectedItemCategoryId('');
      }
    } else {
      setEditingEbookSelectedCategoryName('');
      setEditingEbookSelectedSubcategoryId('');
      setEditingEbookSelectedItemCategoryId('');
    }
    
    setShowEditEbookModal(true);
  };

  const handleCancelEditEbook = () => {
    setShowEditEbookModal(false);
    setEditingEbookId(null);
    setEditingEbookData(null);
    setEbookFile(null);
    setEbookCoverImage(null);
    // Reset Edit E-Book category selection state
    setEditingEbookSelectedCategoryName('');
    setEditingEbookSelectedSubcategoryId('');
    setEditingEbookSelectedItemCategoryId('');
  };

  // Handle save eBook
  const handleSaveEbook = async () => {
    try {
      const formData = new FormData();
      // Don't send existing cover_image URL back as a regular field;
      // backend derives cover_image from uploaded file when replacing.
      const { cover_image, ...ebookUpdateData } = editingEbookData || {};
      appendFormData(formData, ebookUpdateData);
      if (ebookFile) formData.append('file', ebookFile);
      if (ebookCoverImage) formData.append('cover_image', ebookCoverImage);

      await adminAPI.updateEbook(editingEbookId, formData);
      setSuccessMessage('eBook updated successfully');
      setShowEditEbookModal(false);
      setEditingEbookId(null);
      setEditingEbookData(null);
      setEbookFile(null);
      setEbookCoverImage(null);
      // Reset Edit E-Book category selection state
      setEditingEbookSelectedCategoryName('');
      setEditingEbookSelectedSubcategoryId('');
      setEditingEbookSelectedItemCategoryId('');
      fetchEbooks();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to update eBook: ' + (err.response?.data?.error || err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle delete eBook
  const handleDeleteEbook = async (id) => {
    if (!window.confirm('Are you sure you want to delete this eBook?')) return;
    try {
      await adminAPI.deleteEbook(id);
      setSuccessMessage('eBook deleted successfully');
      fetchEbooks();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      setError('Failed to delete eBook: ' + (err.response?.data?.error || err.response?.data?.message || err.message));
      setTimeout(() => setError(null), 5000);
    }
  };

  // Handle delete category
  const handleDeleteCategory = async (id) => {
    if (!window.confirm('Are you sure you want to delete this category/subcategory?')) {
      return;
    }
    
    try {
      await adminAPI.deleteCategory(id);
      setSuccessMessage('Category deleted successfully');
      fetchCategoryManagement();
      setTimeout(() => setSuccessMessage(null), 3000);
    } catch (err) {
      // Handle both 'error' and 'message' fields from backend
      const errorMsg = err.response?.data?.error || err.response?.data?.message || err.message || 'Unknown error';
      setError('Failed to delete category: ' + errorMsg);
      console.error('Error deleting category:', err.response?.data);
      setTimeout(() => setError(null), 5000);
    }
  };

  useEffect(() => {
    fetchCategories();
    fetchLocationHierarchy();
  }, []);

  // Fetch location hierarchy from database for search bar
  const fetchLocationHierarchy = async () => {
    try {
      const response = await window.axios.get('/api/locations');
      setLocationData(response.data);
    } catch (error) {
      console.error('Error fetching location hierarchy:', error);
    }
  };

  // Close location dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (locationDropdownRef.current && !locationDropdownRef.current.contains(event.target)) {
        setShowLocationDropdown(false);
      }
      if (postAdLocationDropdownRef.current && !postAdLocationDropdownRef.current.contains(event.target)) {
        setPostAdShowLocationDropdown(false);
      }
      if (editingAdLocationDropdownRef.current && !editingAdLocationDropdownRef.current.contains(event.target)) {
        setEditingAdShowLocationDropdown(false);
      }
      if (editingUserLocationDropdownRef.current && !editingUserLocationDropdownRef.current.contains(event.target)) {
        setEditingUserShowLocationDropdown(false);
      }
      if (auctionLocationDropdownRef.current && !auctionLocationDropdownRef.current.contains(event.target)) {
        setAuctionShowLocationDropdown(false);
      }
    };

    if (showLocationDropdown || postAdShowLocationDropdown || editingAdShowLocationDropdown || editingUserShowLocationDropdown || auctionShowLocationDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showLocationDropdown, postAdShowLocationDropdown, editingAdShowLocationDropdown, editingUserShowLocationDropdown, auctionShowLocationDropdown]);

  // Handle click outside category dropdown
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (categoryDropdownRef.current && !categoryDropdownRef.current.contains(event.target)) {
        setShowCategoryDropdown(false);
      }
      if (postAdCategoryDropdownRef.current && !postAdCategoryDropdownRef.current.contains(event.target)) {
        setPostAdShowCategoryDropdown(false);
      }
      if (editingAdCategoryDropdownRef.current && !editingAdCategoryDropdownRef.current.contains(event.target)) {
        setEditingAdShowCategoryDropdown(false);
      }
      if (transactionCategoryDropdownRef.current && !transactionCategoryDropdownRef.current.contains(event.target)) {
        setTransactionShowCategoryDropdown(false);
      }
      if (auctionCategoryDropdownRef.current && !auctionCategoryDropdownRef.current.contains(event.target)) {
        setAuctionShowCategoryDropdown(false);
      }
      if (ebookCategoryDropdownRef.current && !ebookCategoryDropdownRef.current.contains(event.target)) {
        setEbookShowCategoryDropdown(false);
      }
      if (editingEbookCategoryDropdownRef.current && !editingEbookCategoryDropdownRef.current.contains(event.target)) {
        setEditingEbookShowCategoryDropdown(false);
      }
    };

    if (showCategoryDropdown || postAdShowCategoryDropdown || editingAdShowCategoryDropdown || transactionShowCategoryDropdown || auctionShowCategoryDropdown || ebookShowCategoryDropdown || editingEbookShowCategoryDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showCategoryDropdown, postAdShowCategoryDropdown, editingAdShowCategoryDropdown, transactionShowCategoryDropdown, auctionShowCategoryDropdown, ebookShowCategoryDropdown, editingEbookShowCategoryDropdown]);

  // Helper functions for category selection
  const getSelectedCategory = () => {
    if (!selectedCategoryName) return null;
    return categories.find(c => c.name === selectedCategoryName);
  };

  const getSelectedSubcategory = () => {
    const category = getSelectedCategory();
    if (!category || !selectedSubcategoryId || !category.subcategories) return null;
    return category.subcategories.find(s => s.id === parseInt(selectedSubcategoryId));
  };

  const handleCategorySelect = (categoryName) => {
    setSelectedCategoryName(categoryName);
    setSelectedSubcategoryId(''); // Reset subcategory when category changes
    // Update searchCategory to the category name
    setSearchCategory(categoryName);
  };

  const handleSubcategorySelect = (subcategoryId) => {
    setSelectedSubcategoryId(subcategoryId);
    const category = getSelectedCategory();
    if (category) {
      const subcategory = category.subcategories.find(s => s.id === parseInt(subcategoryId));
      if (subcategory) {
        setSearchCategory(`${category.name} > ${subcategory.name}`);
        setShowCategoryDropdown(false);
      }
    }
  };

  const buildCategorySearchString = () => {
    // Count only subcategories (leaf level) - matching UserDashboard logic
    if (selectedSubcategories.size === 0) {
      return 'All Categories';
    }
    if (selectedSubcategories.size === 1) {
      return '1 category selected';
    }
    return `${selectedSubcategories.size} categories selected`;
  };

  const buildCategorySearchStringOld = () => {
    if (selectedSubcategoryId) {
      const category = getSelectedCategory();
      const subcategory = getSelectedSubcategory();
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    if (selectedCategoryName) {
      const category = getSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handleClearCategorySelection = () => {
    setSelectedCategoryName('');
    setSelectedSubcategoryId('');
    setSearchCategory('');
    setShowCategoryDropdown(false);
  };

  // Helper functions for Edit Ad form category selection
  const getEditingAdSelectedCategory = () => {
    if (!editingAdSelectedCategoryName) return null;
    return categories.find(c => c.name === editingAdSelectedCategoryName);
  };

  // Toggle functions for Edit Ad category expansion (matching Post Ad dropdown)
  const toggleEditingAdCategory = (categoryName) => {
    setEditingAdExpandedCategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(categoryName)) {
        newSet.delete(categoryName);
      } else {
        newSet.add(categoryName);
      }
      return newSet;
    });
  };

  const toggleEditingAdSubcategory = (subcategoryName) => {
    setEditingAdExpandedSubcategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(subcategoryName)) {
        newSet.delete(subcategoryName);
      } else {
        newSet.add(subcategoryName);
      }
      return newSet;
    });
  };

  // Handle selection of main category (single selection - closes dropdown)
  const handleEditingAdCategorySelect = (categoryId, categoryName) => {
    setEditingAdSelectedCategoryName(categoryName);
    setEditingAdSelectedSubcategoryId('');
    setEditingAdSelectedItemCategoryId('');
    setEditingAdData({...editingAdData, category_id: categoryId.toString()});
    setEditingAdShowCategoryDropdown(false);
  };

  // Handle selection of subcategory (single selection - closes dropdown)
  const handleEditingAdSubcategorySelect = (subcategoryId, subcategoryName) => {
    const category = getEditingAdSelectedCategory();
    if (category) {
      setEditingAdSelectedSubcategoryId(subcategoryId.toString());
      setEditingAdSelectedItemCategoryId('');
      setEditingAdData({...editingAdData, category_id: subcategoryId.toString()});
        setEditingAdShowCategoryDropdown(false);
      }
  };

  // Handle selection of item category (single selection - closes dropdown)
  const handleEditingAdItemCategorySelect = (itemCategoryId, categoryName, subcategoryId) => {
    if (categoryName) setEditingAdSelectedCategoryName(categoryName);
    if (subcategoryId) setEditingAdSelectedSubcategoryId(subcategoryId.toString());
    setEditingAdSelectedItemCategoryId(itemCategoryId.toString());
    setEditingAdData({...editingAdData, category_id: itemCategoryId.toString()});
    setEditingAdShowCategoryDropdown(false);
  };

  const buildEditingAdCategoryString = () => {
    // If item category is selected, show full path
    if (editingAdSelectedItemCategoryId) {
      const category = getEditingAdSelectedCategory();
      if (category && editingAdSelectedSubcategoryId) {
        const subcategory = category.subcategories.find(s => s.id === parseInt(editingAdSelectedSubcategoryId));
        if (subcategory && subcategory.item_categories) {
          const itemCategory = subcategory.item_categories.find(item => item.id === parseInt(editingAdSelectedItemCategoryId));
          if (itemCategory) {
            const itemName = itemCategory.item_category || itemCategory.name;
            return `${category.name} > ${subcategory.name} > ${itemName}`;
          }
        }
      }
    }
    // If subcategory is selected, show category > subcategory
    if (editingAdSelectedSubcategoryId) {
      const category = getEditingAdSelectedCategory();
      const subcategory = category?.subcategories.find(s => s.id === parseInt(editingAdSelectedSubcategoryId));
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    // If only main category is selected
    if (editingAdSelectedCategoryName) {
      const category = getEditingAdSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handleEditingAdClearCategorySelection = () => {
    setEditingAdSelectedCategoryName('');
    setEditingAdSelectedSubcategoryId('');
    setEditingAdSelectedItemCategoryId('');
    setEditingAdData({...editingAdData, category_id: ''});
    setEditingAdShowCategoryDropdown(false);
  };

  // Helper functions for Edit Ad form location selection
  const handleEditingAdLocationToggle = (locationId) => {
    setEditingAdSelectedLocations(prev => {
      const newSet = new Set(prev);
      if (newSet.has(locationId)) {
        newSet.delete(locationId);
      } else {
        newSet.add(locationId);
      }
      return newSet;
    });
  };

  const handleEditingAdSelectAllLocations = () => {
    setEditingAdSelectedLocations(new Set());
  };

  const buildEditingAdLocationString = () => {
    if (editingAdSelectedLocations.size === 0) {
      return 'Select Location';
    }
    if (editingAdSelectedLocations.size === 1) {
      return '1 location selected';
    }
    return `${editingAdSelectedLocations.size} locations selected`;
  };

  const toggleEditingAdProvince = (provinceId) => {
    setEditingAdExpandedProvinces(prev => {
      const newSet = new Set(prev);
      if (newSet.has(provinceId)) {
        newSet.delete(provinceId);
      } else {
        newSet.add(provinceId);
      }
      return newSet;
    });
  };

  const toggleEditingAdDistrict = (districtKey) => {
    setEditingAdExpandedDistricts(prev => {
      const newSet = new Set(prev);
      if (newSet.has(districtKey)) {
        newSet.delete(districtKey);
      } else {
        newSet.add(districtKey);
      }
      return newSet;
    });
  };

  const toggleEditingAdLocalLevel = (localLevelKey) => {
    setEditingAdExpandedLocalLevels(prev => {
      const newSet = new Set(prev);
      if (newSet.has(localLevelKey)) {
        newSet.delete(localLevelKey);
      } else {
        newSet.add(localLevelKey);
      }
      return newSet;
    });
  };

  // Helper functions for Edit User form location selection
  const handleEditingUserLocationToggle = (locationId) => {
    setEditingUserSelectedLocations(prev => {
      const newSet = new Set(prev);
      if (newSet.has(locationId)) {
        newSet.delete(locationId);
      } else {
        newSet.add(locationId);
      }
      return newSet;
    });
  };

  const handleEditingUserSelectAllLocations = () => {
    setEditingUserSelectedLocations(new Set());
  };

  const buildEditingUserLocationString = () => {
    if (editingUserSelectedLocations.size === 0) {
      return 'Select Location';
    }
    
    // Check if a specific local address is selected
    const localAddressIds = Array.from(editingUserSelectedLocations).filter(locId => 
      typeof locId === 'string' && locId.includes('-')
    );
    
    if (localAddressIds.length > 0) {
      // A specific local address is selected
      const localAddressId = localAddressIds[0];
      const [wardIdStr, addressIndexStr] = localAddressId.split('-');
      const wardId = parseInt(wardIdStr);
      const addressIndex = parseInt(addressIndexStr);
      
      if (!isNaN(wardId) && !isNaN(addressIndex) && locationData?.provinces) {
        // Find the address name
        for (const province of locationData.provinces) {
          for (const district of province.districts || []) {
            for (const localLevel of district.localLevels || []) {
              for (const ward of localLevel.wards || []) {
                if (ward.id === wardId && ward.local_addresses && ward.local_addresses[addressIndex]) {
                  const address = ward.local_addresses[addressIndex];
                  const addressName = typeof address === 'string' ? address : address.name || address;
                  const currentUser = userManagementData.find(u => u.id === editingUserId);
                  if (currentUser && currentUser.location) {
                    // Return the full location string if available
                    return currentUser.location;
                  }
                  // Build location string
                  return `${province.name} > ${district.name} > ${localLevel.name} > Ward ${ward.ward_number} > ${addressName}`;
                }
              }
            }
          }
        }
      }
    }
    
    // Check ward IDs
    const wardIds = Array.from(editingUserSelectedLocations).filter(locId => {
      if (typeof locId === 'string' && locId.includes('-')) return false;
      return true;
    });
    
    if (wardIds.length === 1) {
      const currentUser = userManagementData.find(u => u.id === editingUserId);
      if (currentUser && currentUser.location) {
        return currentUser.location;
      }
      return '1 location selected';
    }
    
    if (wardIds.length > 1) {
      return `${wardIds.length} locations selected`;
    }
    
    return 'Select Location';
  };

  const toggleEditingUserProvince = (provinceId) => {
    setEditingUserExpandedProvinces(prev => {
      const newSet = new Set(prev);
      if (newSet.has(provinceId)) {
        newSet.delete(provinceId);
      } else {
        newSet.add(provinceId);
      }
      return newSet;
    });
  };

  const toggleEditingUserDistrict = (districtKey) => {
    setEditingUserExpandedDistricts(prev => {
      const newSet = new Set(prev);
      if (newSet.has(districtKey)) {
        newSet.delete(districtKey);
      } else {
        newSet.add(districtKey);
      }
      return newSet;
    });
  };

  const toggleEditingUserLocalLevel = (localLevelKey) => {
    setEditingUserExpandedLocalLevels(prev => {
      const newSet = new Set(prev);
      if (newSet.has(localLevelKey)) {
        newSet.delete(localLevelKey);
      } else {
        newSet.add(localLevelKey);
      }
      return newSet;
    });
  };


  // Helper functions for Transaction form category selection
  const getTransactionSelectedCategory = () => {
    if (!transactionSelectedCategoryName) return null;
    return categories.find(c => c.name === transactionSelectedCategoryName);
  };

  const handleTransactionCategorySelect = (categoryName) => {
    setTransactionSelectedCategoryName(categoryName);
    setTransactionSelectedSubcategoryId(''); // Reset subcategory when category changes
    const category = categories.find(c => c.name === categoryName);
    if (category) {
      setPostAdTransactionFormData({...postAdTransactionFormData, category_id: category.id.toString()});
    }
  };

  const handleTransactionSubcategorySelect = (subcategoryId) => {
    setTransactionSelectedSubcategoryId(subcategoryId);
    const category = getTransactionSelectedCategory();
    if (category) {
      const subcategory = category.subcategories.find(s => s.id === parseInt(subcategoryId));
      if (subcategory) {
        setPostAdTransactionFormData({...postAdTransactionFormData, category_id: subcategory.id.toString()});
        setTransactionShowCategoryDropdown(false);
      }
    }
  };

  const buildTransactionCategoryString = () => {
    if (transactionSelectedSubcategoryId) {
      const category = getTransactionSelectedCategory();
      const subcategory = category?.subcategories.find(s => s.id === parseInt(transactionSelectedSubcategoryId));
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    if (transactionSelectedCategoryName) {
      const category = getTransactionSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handleTransactionClearCategorySelection = () => {
    setTransactionSelectedCategoryName('');
    setTransactionSelectedSubcategoryId('');
    setPostAdTransactionFormData({...postAdTransactionFormData, category_id: ''});
    setTransactionShowCategoryDropdown(false);
  };

  // Helper functions for Post Ad form category selection
  const getPostAdSelectedCategory = () => {
    if (!postAdSelectedCategoryName) return null;
    return categories.find(c => c.name === postAdSelectedCategoryName);
  };

  // Toggle functions for Post Ad category expansion (matching search category dropdown)
  const togglePostAdCategory = (categoryName) => {
    setPostAdExpandedCategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(categoryName)) {
        newSet.delete(categoryName);
      } else {
        newSet.add(categoryName);
      }
      return newSet;
    });
  };

  const togglePostAdSubcategory = (subcategoryName) => {
    setPostAdExpandedSubcategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(subcategoryName)) {
        newSet.delete(subcategoryName);
      } else {
        newSet.add(subcategoryName);
      }
      return newSet;
    });
  };

  // Handle selection of main category (single selection - closes dropdown)
  const handlePostAdCategorySelect = (categoryId, categoryName) => {
    setPostAdSelectedCategoryName(categoryName);
    setPostAdSelectedSubcategoryId('');
    setPostAdSelectedItemCategoryId('');
    setPostAdFormData({...postAdFormData, category_id: categoryId.toString()});
    setPostAdShowCategoryDropdown(false);
  };

  // Handle selection of subcategory (single selection - closes dropdown)
  const handlePostAdSubcategorySelect = (subcategoryId, subcategoryName) => {
    const category = getPostAdSelectedCategory();
    if (category) {
      setPostAdSelectedSubcategoryId(subcategoryId.toString());
      setPostAdSelectedItemCategoryId('');
      setPostAdFormData({...postAdFormData, category_id: subcategoryId.toString()});
        setPostAdShowCategoryDropdown(false);
      }
  };

  // Handle selection of item category (single selection - closes dropdown)
  const handlePostAdItemCategorySelect = (itemCategoryId, categoryName, subcategoryId) => {
    if (categoryName) setPostAdSelectedCategoryName(categoryName);
    if (subcategoryId) setPostAdSelectedSubcategoryId(subcategoryId.toString());
    setPostAdSelectedItemCategoryId(itemCategoryId.toString());
    setPostAdFormData({...postAdFormData, category_id: itemCategoryId.toString()});
    setPostAdShowCategoryDropdown(false);
  };

  const buildPostAdCategoryString = () => {
    // If item category is selected, show full path
    if (postAdSelectedItemCategoryId) {
      const category = getPostAdSelectedCategory();
      if (category && postAdSelectedSubcategoryId) {
        const subcategory = category.subcategories.find(s => s.id === parseInt(postAdSelectedSubcategoryId));
        if (subcategory && subcategory.item_categories) {
          const itemCategory = subcategory.item_categories.find(item => item.id === parseInt(postAdSelectedItemCategoryId));
          if (itemCategory) {
            const itemName = itemCategory.item_category || itemCategory.name;
            return `${category.name} > ${subcategory.name} > ${itemName}`;
          }
        }
      }
    }
    // If subcategory is selected, show category > subcategory
    if (postAdSelectedSubcategoryId) {
      const category = getPostAdSelectedCategory();
      const subcategory = category?.subcategories.find(s => s.id === parseInt(postAdSelectedSubcategoryId));
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    // If only main category is selected
    if (postAdSelectedCategoryName) {
      const category = getPostAdSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handlePostAdClearCategorySelection = () => {
    setPostAdSelectedCategoryName('');
    setPostAdSelectedSubcategoryId('');
    setPostAdSelectedItemCategoryId('');
    setPostAdFormData({...postAdFormData, category_id: ''});
    setPostAdShowCategoryDropdown(false);
  };

  // Helper functions for Auction form category selection
  const getAuctionSelectedCategory = () => {
    if (!auctionSelectedCategoryName) return null;
    return categories.find(c => c.name === auctionSelectedCategoryName);
  };

  // Toggle functions for Auction category expansion (matching Post Ad dropdown)
  const toggleAuctionCategory = (categoryName) => {
    setAuctionExpandedCategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(categoryName)) {
        newSet.delete(categoryName);
      } else {
        newSet.add(categoryName);
      }
      return newSet;
    });
  };

  const toggleAuctionSubcategory = (subcategoryName) => {
    setAuctionExpandedSubcategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(subcategoryName)) {
        newSet.delete(subcategoryName);
      } else {
        newSet.add(subcategoryName);
      }
      return newSet;
    });
  };

  // Handle selection of main category (single selection - closes dropdown)
  const handleAuctionCategorySelect = (categoryId, categoryName) => {
    setAuctionSelectedCategoryName(categoryName);
    setAuctionSelectedSubcategoryId('');
    setAuctionSelectedItemCategoryId('');
    setAuctionFormData({...auctionFormData, category_id: categoryId.toString()});
    setAuctionShowCategoryDropdown(false);
  };

  // Handle selection of subcategory (single selection - closes dropdown)
  const handleAuctionSubcategorySelect = (subcategoryId, subcategoryName) => {
    const category = getAuctionSelectedCategory();
    if (category) {
      setAuctionSelectedSubcategoryId(subcategoryId.toString());
      setAuctionSelectedItemCategoryId('');
      setAuctionFormData({...auctionFormData, category_id: subcategoryId.toString()});
      setAuctionShowCategoryDropdown(false);
    }
  };

  // Handle selection of item category (single selection - closes dropdown)
  const handleAuctionItemCategorySelect = (itemCategoryId, categoryName, subcategoryId) => {
    if (categoryName) setAuctionSelectedCategoryName(categoryName);
    if (subcategoryId) setAuctionSelectedSubcategoryId(subcategoryId.toString());
    setAuctionSelectedItemCategoryId(itemCategoryId.toString());
    setAuctionFormData({...auctionFormData, category_id: itemCategoryId.toString()});
    setAuctionShowCategoryDropdown(false);
  };

  const buildAuctionCategoryString = () => {
    // If item category is selected, show full path
    if (auctionSelectedItemCategoryId) {
      const category = getAuctionSelectedCategory();
      if (category && auctionSelectedSubcategoryId) {
        const subcategory = category.subcategories.find(s => s.id === parseInt(auctionSelectedSubcategoryId));
        if (subcategory && subcategory.item_categories) {
          const itemCategory = subcategory.item_categories.find(item => item.id === parseInt(auctionSelectedItemCategoryId));
          if (itemCategory) {
            const itemName = itemCategory.item_category || itemCategory.name;
            return `${category.name} > ${subcategory.name} > ${itemName}`;
          }
        }
      }
    }
    // If subcategory is selected, show category > subcategory
    if (auctionSelectedSubcategoryId) {
      const category = getAuctionSelectedCategory();
      const subcategory = category?.subcategories.find(s => s.id === parseInt(auctionSelectedSubcategoryId));
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    // If only main category is selected
    if (auctionSelectedCategoryName) {
      const category = getAuctionSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handleAuctionClearCategorySelection = () => {
    setAuctionSelectedCategoryName('');
    setAuctionSelectedSubcategoryId('');
    setAuctionSelectedItemCategoryId('');
    setAuctionFormData({...auctionFormData, category_id: ''});
    setAuctionShowCategoryDropdown(false);
  };

  // Helper functions for E-Book form category selection
  const getEbookSelectedCategory = () => {
    if (!ebookSelectedCategoryName) return null;
    return categories.find(c => c.name === ebookSelectedCategoryName);
  };

  // Toggle functions for E-Book category expansion (matching Post Ad dropdown)
  const toggleEbookCategory = (categoryName) => {
    setEbookExpandedCategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(categoryName)) {
        newSet.delete(categoryName);
      } else {
        newSet.add(categoryName);
      }
      return newSet;
    });
  };

  const toggleEbookSubcategory = (subcategoryName) => {
    setEbookExpandedSubcategories(prev => {
      const newSet = new Set(prev);
      if (newSet.has(subcategoryName)) {
        newSet.delete(subcategoryName);
      } else {
        newSet.add(subcategoryName);
      }
      return newSet;
    });
  };

  // Handle selection of main category (single selection - closes dropdown)
  const handleEbookCategorySelect = (categoryId, categoryName) => {
    setEbookSelectedCategoryName(categoryName);
    setEbookSelectedSubcategoryId('');
    setEbookSelectedItemCategoryId('');
    setEbookFormData({...ebookFormData, category_id: categoryId.toString()});
    setEbookShowCategoryDropdown(false);
  };

  // Handle selection of subcategory (single selection - closes dropdown)
  const handleEbookSubcategorySelect = (subcategoryId, subcategoryName) => {
    const category = getEbookSelectedCategory();
    if (category) {
      setEbookSelectedSubcategoryId(subcategoryId.toString());
      setEbookSelectedItemCategoryId('');
      setEbookFormData({...ebookFormData, category_id: subcategoryId.toString()});
      setEbookShowCategoryDropdown(false);
    }
  };

  // Handle selection of item category (single selection - closes dropdown)
  const handleEbookItemCategorySelect = (itemCategoryId, categoryName, subcategoryId) => {
    if (categoryName) setEbookSelectedCategoryName(categoryName);
    if (subcategoryId) setEbookSelectedSubcategoryId(subcategoryId.toString());
    setEbookSelectedItemCategoryId(itemCategoryId.toString());
    setEbookFormData({...ebookFormData, category_id: itemCategoryId.toString()});
    setEbookShowCategoryDropdown(false);
  };

  const buildEbookCategoryString = () => {
    // If item category is selected, show full path
    if (ebookSelectedItemCategoryId) {
      const category = getEbookSelectedCategory();
      if (category && ebookSelectedSubcategoryId) {
        const subcategory = category.subcategories.find(s => s.id === parseInt(ebookSelectedSubcategoryId));
        if (subcategory && subcategory.item_categories) {
          const itemCategory = subcategory.item_categories.find(item => item.id === parseInt(ebookSelectedItemCategoryId));
          if (itemCategory) {
            const itemName = itemCategory.item_category || itemCategory.name;
            return `${category.name} > ${subcategory.name} > ${itemName}`;
          }
        }
      }
    }
    // If subcategory is selected, show category > subcategory
    if (ebookSelectedSubcategoryId) {
      const category = getEbookSelectedCategory();
      const subcategory = category?.subcategories.find(s => s.id === parseInt(ebookSelectedSubcategoryId));
      if (category && subcategory) {
        return `${category.name} > ${subcategory.name}`;
      }
    }
    // If only main category is selected
    if (ebookSelectedCategoryName) {
      const category = getEbookSelectedCategory();
      if (category) {
        return category.name;
      }
    }
    return '';
  };

  const handleEbookClearCategorySelection = () => {
    setEbookSelectedCategoryName('');
    setEbookSelectedSubcategoryId('');
    setEbookSelectedItemCategoryId('');
    setEbookFormData({...ebookFormData, category_id: ''});
    setEbookShowCategoryDropdown(false);
  };

  // Helper functions for Post Ad form location selection
  const handlePostAdLocationToggle = (locationId) => {
    // Ensure locationId is converted to string for consistent comparison
    const locationIdStr = locationId.toString();
    setPostAdSelectedLocations(prev => {
      const newSet = new Set(prev);
      if (newSet.has(locationIdStr)) {
        newSet.delete(locationIdStr);
      } else {
        newSet.add(locationIdStr);
      }
      return newSet;
    });
  };

  const handlePostAdSelectAllLocations = () => {
    setPostAdSelectedLocations(new Set());
  };

  const buildPostAdLocationString = () => {
    if (postAdSelectedLocations.size === 0) {
      return 'Select Location';
    }
    if (postAdSelectedLocations.size === 1) {
      return '1 location selected';
    }
    return `${postAdSelectedLocations.size} locations selected`;
  };

  const togglePostAdProvince = (provinceId) => {
    setPostAdExpandedProvinces(prev => {
      const newSet = new Set(prev);
      if (newSet.has(provinceId)) {
        newSet.delete(provinceId);
      } else {
        newSet.add(provinceId);
      }
      return newSet;
    });
  };

  const togglePostAdDistrict = (districtKey) => {
    setPostAdExpandedDistricts(prev => {
      const newSet = new Set(prev);
      if (newSet.has(districtKey)) {
        newSet.delete(districtKey);
      } else {
        newSet.add(districtKey);
      }
      return newSet;
    });
  };

  const togglePostAdLocalLevel = (localLevelKey) => {
    setPostAdExpandedLocalLevels(prev => {
      const newSet = new Set(prev);
      if (newSet.has(localLevelKey)) {
        newSet.delete(localLevelKey);
      } else {
        newSet.add(localLevelKey);
      }
      return newSet;
    });
  };

  // Helper functions for Auction form location selection (single selection)
  // Note: This is used for local address checkboxes. For ward checkboxes, use handleAuctionWardToggle.
  // When a local address is clicked, toggle just that individual address (not the entire ward)
  const handleAuctionLocationToggle = (locationId) => {
    // Set flag to prevent useEffect from resetting selection
    isAuctionIndividualAddressToggle.current = true;
    
    // Convert locationId to string for consistent comparison
    const locationIdStr = locationId.toString();
    
    // Extract ward ID from locationId (handle both ward.id and `${ward.id}-${idx}` format)
    // For local addresses (format: `${ward.id}-${idx}`), extract just the ward.id part
    let wardId = locationId;
    if (typeof locationId === 'string' && locationId.includes('-')) {
      wardId = locationId.split('-')[0];
    }
    const wardIdStr = wardId.toString();
    
    // Toggle just this individual address
    setAuctionSelectedLocations(prev => {
      const newSet = new Set(prev);
      if (newSet.has(locationIdStr)) {
        newSet.delete(locationIdStr);
      } else {
        newSet.add(locationIdStr);
      }
      
      // Check if any addresses from this ward are selected after toggling
      const hasAnyAddressFromWard = Array.from(newSet).some(id => {
        const idStr = id.toString();
        // Check if this ID belongs to the same ward (either the ward ID itself or an address with this ward prefix)
        return idStr === wardIdStr || (idStr.includes('-') && idStr.startsWith(wardIdStr + '-'));
      });
      
      // Update location_id based on whether any addresses from this ward are selected
      // Use setTimeout to update location_id after state update completes
      setTimeout(() => {
        if (hasAnyAddressFromWard) {
          setAuctionFormData(prev => ({ ...prev, location_id: wardIdStr }));
        } else if (newSet.size === 0) {
          setAuctionFormData(prev => ({ ...prev, location_id: '' }));
        }
        // If newSet.size > 0 but no addresses from this ward, keep current location_id
        
        // Reset flag after state updates complete
        setTimeout(() => {
          isAuctionIndividualAddressToggle.current = false;
        }, 100);
      }, 0);
      
      return newSet;
    });
  };

  // Helper function to handle ward checkbox click (selects ward + all local addresses)
  const handleAuctionWardToggle = (ward) => {
    // Collect all IDs: ward.id and all local_addresses IDs (all as strings)
    const allIds = [ward.id.toString()];
    if (ward.local_addresses && ward.local_addresses.length > 0) {
      ward.local_addresses.forEach((_, idx) => {
        allIds.push(`${ward.id}-${idx}`);
      });
    }
    
    // Check if all are selected (ensure consistent string comparison)
    const allSelected = allIds.every(id => {
      const idStr = id.toString();
      return auctionSelectedLocations.has(idStr);
    });
    
    if (allSelected) {
      // Deselect all
      setAuctionSelectedLocations(new Set());
      setAuctionFormData(prev => ({...prev, location_id: ''}));
    } else {
      // Select all (ward + all local addresses)
      setAuctionSelectedLocations(new Set(allIds));
      // Save ward ID to location_id
      setAuctionFormData(prev => ({...prev, location_id: ward.id.toString()}));
    }
  };

  const handleAuctionSelectAllLocations = () => {
    setAuctionSelectedLocations(new Set());
    setAuctionFormData(prev => ({...prev, location_id: ''}));
  };

  // Helper function to handle parent checkbox click (province, district, local level)
  // For single selection: selects ALL children (all wards and all their local addresses)
  // Note: We don't update location_id here to avoid triggering resets - it will be set on form submit
  const handleAuctionParentToggle = (allLocationIds) => {
    if (allLocationIds.length === 0) return;
    
    // Set flag to prevent useEffect from resetting selection
    isAuctionParentToggleInProgress.current = true;
    
    // Convert all IDs to strings for consistent comparison
    const allLocationIdsStr = allLocationIds.map(id => id.toString());
    
    // Check if ALL children are already selected
    const allSelected = allLocationIdsStr.length > 0 && allLocationIdsStr.every(idStr => {
      return auctionSelectedLocations.has(idStr);
    });
    
    if (allSelected) {
      // Deselect all
      setAuctionSelectedLocations(new Set());
      setAuctionFormData(prev => ({...prev, location_id: ''}));
      // Reset flag after state updates
      setTimeout(() => {
        isAuctionParentToggleInProgress.current = false;
      }, 100);
    } else {
      // Select ALL children (all wards + all local addresses)
      // Don't update location_id here - it will be extracted from selection on form submit
      const selectedIds = new Set(allLocationIdsStr);
      setAuctionSelectedLocations(selectedIds);
      // Reset flag after state update completes
      setTimeout(() => {
        isAuctionParentToggleInProgress.current = false;
      }, 100);
    }
  };

  const buildAuctionLocationString = () => {
    if (auctionSelectedLocations.size === 0) {
      return 'Select Location';
    }
    
    // Count only addresses (leaf level) - addresses are stored as "wardId-index" format (string with hyphen)
    // Also count wards that don't have addresses (numeric IDs without corresponding addresses)
    const selectedIds = Array.from(auctionSelectedLocations);
    const addressIds = selectedIds.filter(id => {
      const idStr = id.toString();
      return idStr.includes('-');
    });
    
    // Count wards without addresses (numeric IDs that don't have corresponding addresses selected)
    const wardIdsWithoutAddresses = selectedIds.filter(id => {
      const idStr = id.toString();
      if (!idStr.includes('-')) {
        // Check if this ward has any addresses selected
        const wardId = idStr;
        const hasAddresses = selectedIds.some(selectedId => {
          const selectedIdStr = selectedId.toString();
          return selectedIdStr.startsWith(`${wardId}-`);
        });
        return !hasAddresses;
      }
      return false;
    });
    
    const totalCount = addressIds.length + wardIdsWithoutAddresses.length;
    
    // If only one location is selected, show the full path
    if (totalCount === 1) {
      const locationId = selectedIds[0];
      // Find the location path from locationData
      if (locationData?.provinces) {
        for (const province of locationData.provinces) {
          for (const district of province.districts || []) {
            for (const localLevel of district.localLevels || []) {
              for (const ward of localLevel.wards || []) {
                if (ward.id.toString() === locationId.toString()) {
                  return `${province.name} > ${district.name} > ${localLevel.name} > Ward ${ward.ward_number}`;
                }
                // Check local addresses
                if (ward.local_addresses) {
                  for (let idx = 0; idx < ward.local_addresses.length; idx++) {
                    const addressId = `${ward.id}-${idx}`;
                    if (addressId === locationId.toString()) {
                      return `${province.name} > ${district.name} > ${localLevel.name} > Ward ${ward.ward_number} > ${ward.local_addresses[idx]}`;
                    }
                  }
                }
              }
            }
          }
        }
      }
      return '1 location selected';
    }
    
    // Multiple locations selected - show count
    return `${totalCount} locations selected`;
  };

  const toggleAuctionProvince = (provinceId) => {
    setAuctionExpandedProvinces(prev => {
      const newSet = new Set(prev);
      if (newSet.has(provinceId)) {
        newSet.delete(provinceId);
      } else {
        newSet.add(provinceId);
      }
      return newSet;
    });
  };

  const toggleAuctionDistrict = (districtKey) => {
    setAuctionExpandedDistricts(prev => {
      const newSet = new Set(prev);
      if (newSet.has(districtKey)) {
        newSet.delete(districtKey);
      } else {
        newSet.add(districtKey);
      }
      return newSet;
    });
  };

  const toggleAuctionLocalLevel = (localLevelKey) => {
    setAuctionExpandedLocalLevels(prev => {
      const newSet = new Set(prev);
      if (newSet.has(localLevelKey)) {
        newSet.delete(localLevelKey);
      } else {
        newSet.add(localLevelKey);
      }
      return newSet;
    });
  };

  const menuItems = [
    { id: 'ads-management', label: 'Ads Management' },
    { id: 'auction-management', label: 'Auction Management' },
    { id: 'category-management', label: 'Category Management' },
    ...(isSuperAdmin ? [{ id: 'change-password', label: 'Change Password' }] : []), // Only show for super_admin
    { id: 'delivery-management', label: 'Delivery Management' },
    { id: 'ebook-management', label: 'E-Book Management' },
    { id: 'nepali-products', label: 'Nepali Products Review' },
    { id: 'order-management', label: 'Order Management' },
    { id: 'email-subscriber', label: 'Email Subscriber List' },
    { id: 'job-management', label: 'Job Management' },
    { id: 'live-chat', label: 'Live Chat' },
    { id: 'location-address', label: 'Location/Address' },
    { id: 'offer-discount', label: 'Offer/Discount' },
    { id: 'rating-review', label: 'Rating/Review' },
    { id: 'sales-report', label: 'Sales Report' },
    { id: 'stock-management', label: 'Stock Management' },
    { id: 'support-management', label: 'Support Management' },
    { id: 'transaction-management', label: 'Transaction Management' },
    { id: 'user-management', label: 'User Management' },
  ];

  return (
    <Layout showFooter={false}>
      <div className="flex gap-6 mx-auto">
        {/* Left Sidebar - Admin Navigation */}
        <aside className="w-64 flex-shrink-0 hidden lg:block">
          <Card>
            <CardContent className="p-4">
              <h2 className="text-lg font-bold text-[hsl(var(--foreground))] mb-4">Admin Dashboard</h2>
              
              {/* Role Selection - Only show interactive switch for roles the user actually has */}
              {!isSuperAdmin ? (
                <div className="mb-4 space-y-1">
                  {/* Non-super admins can see that Super Admin exists, but it is not clickable */}
                  <div
                    className="w-full text-left px-3 py-2 text-sm text-[hsl(var(--muted-foreground))] cursor-default select-none"
                    title="Only super admins can access this section"
                  >
                    Super Admin
                  </div>
                  <button
                    onClick={() => {
                      setSelectedRole('admin');
                      navigate('/admin');
                    }}
                    className={`w-full text-left px-3 py-2 text-sm rounded transition-colors ${
                      selectedRole === 'admin'
                        ? 'bg-[hsl(var(--accent))] text-[hsl(var(--foreground))] font-medium'
                        : 'text-[hsl(var(--muted-foreground))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--foreground))]'
                    }`}
                  >
                    Admin
                  </button>
                </div>
              ) : (
                <div className="mb-4">
                  <div className="w-full text-left px-3 py-2 text-sm rounded bg-[hsl(var(--accent))] text-[hsl(var(--foreground))] font-medium">
                    Super Admin
                  </div>
                </div>
              )}

              <nav className="space-y-1">
                {menuItems.map((item) => {
                  const basePath = isSuperAdmin ? '/super_admin' : '/admin';
                  return (
                    <Link
                      key={item.id}
                      to={`${basePath}/${item.id}`}
                      className={`block w-full text-left px-3 py-2 text-sm rounded transition-colors ${
                        activeSection === item.id
                          ? 'bg-[hsl(var(--accent))] text-[hsl(var(--foreground))] font-medium'
                          : 'text-[hsl(var(--muted-foreground))] hover:bg-[hsl(var(--accent))] hover:text-[hsl(var(--foreground))]'
                      }`}
                    >
                      <span className="flex items-center justify-between">
                        <span>{item.label}</span>
                        {item.id === 'live-chat' && liveChatUnreadCount > 0 && (
                          <span className="ml-2 inline-flex items-center justify-center rounded-full bg-[hsl(var(--primary))] text-[hsl(var(--primary-foreground))] text-[11px] min-w-[18px] h-[18px] px-1">
                            {liveChatUnreadCount}
                          </span>
                        )}
                      </span>
                    </Link>
                  );
                })}
              </nav>
            </CardContent>
          </Card>
        </aside>

        {/* Main Content Area */}
        <main className="flex-1">
          {/* Search and Filter Section */}
          <section className="mb-6">
            <Card>
              <CardContent className="p-4">
                <div className="flex gap-2 flex-wrap items-center">
                  <Input
                    type="text"
                    placeholder="Enter keyword"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="flex-1 min-w-[200px] bg-[hsl(var(--background))]"
                  />
                  {/* Category Selection - Matching sidebar filter design */}
                  <div className="relative min-w-[150px]" ref={categoryDropdownRef}>
                    <div className="relative">
                      <button
                        type="button"
                        onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}
                        className="w-full px-3 py-2 text-left border-0 rounded-md bg-[hsl(var(--accent))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center"
                      >
                        <span>{buildCategorySearchString() || 'All Categories'}</span>
                      </button>
                      
                      {/* Category Menu - Matching sidebar filter design */}
                      {showCategoryDropdown && (
                        <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                          <div className="p-3">
                            <div className="space-y-1">
                              {getTopLevelCategories().map((category) => {
                                const subcategories = getSubcategories(category.id);
                                const hasSubcategories = subcategories.length > 0;
                                // Use category name as key for expansion (matching Homepage behavior to avoid ID collisions)
                                const categoryName = (category.name || '').trim();
                                const isExpanded = categoryName ? expandedCategories.has(categoryName) : false;
                                const adCount = getCategoryAdCount(category.id, category.name);
                                
                                return (
                                  <div key={category.id} className="space-y-1">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center space-x-2 flex-1">
                                        {hasSubcategories ? (
                              <button
                                            onClick={(e) => {
                                              // Only toggle expansion if clicking the button/span, not the checkbox
                                              if (e.target.type !== 'checkbox') {
                                                toggleCategory(category.id);
                                              }
                                            }}
                                            className="flex items-center space-x-2 flex-1 text-left"
                                          >
                                            <input
                                              type="checkbox"
                                              checked={(() => {
                                                // For categories with subcategories, check if ALL item categories are selected (matching Homepage logic)
                                                if (hasSubcategories && subcategories.length > 0) {
                                                  // Collect all item category IDs from all subcategories
                                                  const allItemCategoryIds = [];
                                                  subcategories.forEach(sub => {
                                                    if (sub.item_categories && Array.isArray(sub.item_categories) && sub.item_categories.length > 0) {
                                                      sub.item_categories.forEach(item => {
                                                        if (item && item.id != null) {
                                                          allItemCategoryIds.push(typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id));
                                                        }
                                                      });
                                                    }
                                                  });
                                                  // Only check if all are selected if there are item categories
                                                  if (allItemCategoryIds.length > 0) {
                                                    return allItemCategoryIds.every(itemId => {
                                                      return Array.from(selectedSubcategories).some(id => {
                                                        const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                        return idNum === itemId;
                                                      });
                                                    });
                                                  }
                                                  // If no item categories exist, return false (can't be selected)
                                                  return false;
                                                }
                                                // For categories without subcategories, check if category is selected
                                                const catId = typeof category.id === 'string' ? parseInt(category.id, 10) : Number(category.id);
                                                return Array.from(selectedCategories).some(id => {
                                                  const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                  return idNum === catId;
                                                });
                                              })()}
                                              onChange={(e) => {
                                                e.stopPropagation();
                                                handleCategoryToggle(category.id);
                                              }}
                                              onClick={(e) => e.stopPropagation()}
                                              className="w-4 h-4"
                                            />
                                            <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                              {category.name}
                                            </span>
                                </button>
                                        ) : (
                                          <label className="flex items-center space-x-2 flex-1 cursor-pointer">
                                            <input
                                              type="checkbox"
                                              checked={(() => {
                                                // For categories with subcategories, check if ALL item categories are selected (matching Homepage logic)
                                                if (hasSubcategories && subcategories.length > 0) {
                                                  // Collect all item category IDs from all subcategories
                                                  const allItemCategoryIds = [];
                                                  subcategories.forEach(sub => {
                                                    if (sub.item_categories && Array.isArray(sub.item_categories) && sub.item_categories.length > 0) {
                                                      sub.item_categories.forEach(item => {
                                                        if (item && item.id != null) {
                                                          allItemCategoryIds.push(typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id));
                                                        }
                                                      });
                                                    }
                                                  });
                                                  // Only check if all are selected if there are item categories
                                                  if (allItemCategoryIds.length > 0) {
                                                    return allItemCategoryIds.every(itemId => {
                                                      return Array.from(selectedSubcategories).some(id => {
                                                        const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                        return idNum === itemId;
                                                      });
                                                    });
                                                  }
                                                  // If no item categories exist, return false (can't be selected)
                                                  return false;
                                                }
                                                // For categories without subcategories, check if category is selected
                                                const catId = typeof category.id === 'string' ? parseInt(category.id, 10) : Number(category.id);
                                                return Array.from(selectedCategories).some(id => {
                                                  const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                  return idNum === catId;
                                                });
                                              })()}
                                              onChange={(e) => {
                                                e.stopPropagation();
                                                handleCategoryToggle(category.id);
                                              }}
                                              onClick={(e) => e.stopPropagation()}
                                              className="w-4 h-4"
                                            />
                                            <span className="text-sm text-[hsl(var(--foreground))]">
                                              {category.name}
                                            </span>
                                          </label>
                                        )}
                            </div>
                                      <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                        ({adCount})
                                      </span>
                          </div>
                          
                                    {/* Show subcategories when expanded */}
                                    {hasSubcategories && isExpanded && (
                                      <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                        {subcategories.map((subcategory) => {
                                          const subAdCount = getCategoryAdCount(subcategory.id, subcategory.name);
                                          const itemCategories = subcategory.item_categories || [];
                                          const hasItemCategories = itemCategories && itemCategories.length > 0;
                                          // Use subcategory name as key for expansion (matching Homepage behavior to avoid ID collisions)
                                          const subcategoryName = (subcategory.name || '').trim();
                                          const isSubcategoryExpanded = subcategoryName ? expandedSubcategories.has(subcategoryName) : false;
                                          
                                          return (
                                            <div key={subcategory.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasItemCategories ? (
                                                    <button
                                                      onClick={() => {
                                                        // Use subcategory name as key (matching Homepage behavior)
                                                        const subcategoryName = (subcategory.name || '').trim();
                                                        if (subcategoryName) {
                                                          setExpandedSubcategories(prev => {
                                                            const newSet = new Set(prev);
                                                            if (newSet.has(subcategoryName)) {
                                                              newSet.delete(subcategoryName);
                                                            } else {
                                                              newSet.add(subcategoryName);
                                                            }
                                                            return newSet;
                                                          });
                                                        }
                                                      }}
                                                      className="flex items-center space-x-2 flex-1 text-left"
                                                    >
                                                      <input
                                                        type="checkbox"
                                                        checked={(() => {
                                                          // Check if ALL item categories under this subcategory are selected
                                                          if (itemCategories.length > 0) {
                                                            const allItemCategoryIds = itemCategories.map(item => {
                                                              if (item && item.id != null) {
                                                                return typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                                                              }
                                                              return null;
                                                            }).filter(id => id !== null);
                                                            
                                                            if (allItemCategoryIds.length > 0) {
                                                              return allItemCategoryIds.every(itemId => {
                                                                return Array.from(selectedSubcategories).some(id => {
                                                                  const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                                  return idNum === itemId;
                                                                });
                                                              });
                                                            }
                                                          }
                                                          // If no item categories exist, return false (can't be selected)
                                                          return false;
                                                        })()}
                                                        onChange={(e) => {
                                                          e.stopPropagation();
                                                          // Collect all item category IDs - matching Homepage field category logic exactly
                                                          const allItemCategoryIds = itemCategories.map(item => {
                                                            if (item && item.id != null) {
                                                              return typeof item.id === 'string' ? parseInt(item.id, 10) : Number(item.id);
                                                            }
                                                            return null;
                                                          }).filter(id => id !== null);
                                                          
                                                          if (allItemCategoryIds.length === 0) {
                                                            return;
                                                          }
                                                          
                                                          // Toggle all - matching Homepage logic exactly
                                                          setSelectedSubcategories(prev => {
                                                            const newSet = new Set(prev);
                                                            const allSelected = allItemCategoryIds.every(itemId => {
                                                              return Array.from(newSet).some(id => {
                                                                const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                                return idNum === itemId;
                                                              });
                                                            });
                                                            
                                                            allItemCategoryIds.forEach(itemId => {
                                                              // Remove any existing variations of this ID
                                                              newSet.forEach(id => {
                                                                const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                                if (idNum === itemId) {
                                                                  newSet.delete(id);
                                                                }
                                                              });
                                                              if (!allSelected) {
                                                                newSet.add(itemId);
                                                              }
                                                            });
                                                            return newSet;
                                                          });
                                                          
                                                          // Don't auto-expand - user must click the name/button to expand (matching Homepage behavior)
                                                        }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="w-4 h-4"
                                                      />
                                                      <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                                        {subcategory.name}
                                                      </span>
                                                    </button>
                                                  ) : (
                                              <label className="flex items-center space-x-2 cursor-pointer flex-1">
                                                <input
                                                  type="checkbox"
                                                        checked={(() => {
                                                          const subcategoryIdNum = typeof subcategory.id === 'string' ? parseInt(subcategory.id, 10) : Number(subcategory.id);
                                                          return Array.from(selectedSubcategories).some(id => {
                                                            const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                            return idNum === subcategoryIdNum;
                                                          });
                                                        })()}
                                                  onChange={(e) => {
                                                    e.stopPropagation();
                                                    handleSubcategoryToggle(subcategory.id);
                                                  }}
                                                  onClick={(e) => e.stopPropagation()}
                                                  className="w-4 h-4"
                                                />
                                                <span className="text-sm text-[hsl(var(--muted-foreground))]">{subcategory.name}</span>
                                              </label>
                                                  )}
                                                </div>
                                              <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                ({subAdCount})
                                                </span>
                                              </div>
                                              
                                              {/* Show item categories when subcategory is expanded */}
                                              {hasItemCategories && isSubcategoryExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {itemCategories.map((itemCategory) => {
                                                    const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                    const itemAdCount = getCategoryAdCount(itemCategory.id, itemCategoryName);
                                                    const itemIdNum = typeof itemCategory.id === 'string' ? parseInt(itemCategory.id, 10) : Number(itemCategory.id);
                                                    return (
                                                      <div key={itemCategory.id} className="flex items-center justify-between">
                                                        <label className="flex items-center space-x-2 cursor-pointer flex-1">
                                                          <input
                                                            type="checkbox"
                                                            checked={Array.from(selectedSubcategories).some(id => {
                                                              const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                              return idNum === itemIdNum;
                                                            })}
                                                            onChange={(e) => {
                                                              e.stopPropagation();
                                                              // Toggle individual item category
                                                              setSelectedSubcategories(prev => {
                                                                const newSet = new Set(prev);
                                                                const isSelected = Array.from(newSet).some(id => {
                                                                  const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                                  return idNum === itemIdNum;
                                                                });
                                                                // Remove any existing variations
                                                                newSet.forEach(id => {
                                                                  const idNum = typeof id === 'string' ? parseInt(id, 10) : Number(id);
                                                                  if (idNum === itemIdNum) {
                                                                    newSet.delete(id);
                                                                  }
                                                                });
                                                                if (!isSelected) {
                                                                  newSet.add(itemIdNum);
                                                                }
                                                                return newSet;
                                                              });
                                                            }}
                                                            onClick={(e) => e.stopPropagation()}
                                                            className="w-4 h-4"
                                                          />
                                                          <span className="text-xs text-[hsl(var(--muted-foreground))]">{itemCategoryName}</span>
                                                        </label>
                                                        <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                          ({itemAdCount})
                                              </span>
                              </div>
                                          );
                                        })}
                            </div>
                          )}
                                  </div>
                                );
                              })}
                            </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  {/* Location Selection - Matching sidebar filter design */}
                  <div className="relative min-w-[150px]" ref={locationDropdownRef}>
                    <div className="relative">
                      <button
                        type="button"
                        onClick={() => setShowLocationDropdown(!showLocationDropdown)}
                        className="w-full px-3 py-2 text-left border-0 rounded-md bg-[hsl(var(--accent))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center"
                      >
                        <span>{buildSearchLocationString()}</span>
                      </button>
                      
                      {/* Location Menu - Matching sidebar filter design */}
                      {showLocationDropdown && (
                        <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[350px] max-h-[500px] overflow-y-auto">
                          <div className="p-3">
                            <div className="space-y-1">
                              {locationData.provinces.map((province) => {
                                const hasDistricts = province.districts && province.districts.length > 0;
                                const isProvinceExpanded = expandedProvinces.has(province.id);
                                const provinceAdCount = (() => {
                                  let count = 0;
                                  province.districts.forEach(d => {
                                    d.localLevels.forEach(ll => {
                                      if (ll.wards) {
                                        ll.wards.forEach(w => {
                                          // Only count ward-level ads, not address-level (addresses are subsets of wards)
                                          count += getLocationAdCount(w.id);
                                        });
                                      }
                                    });
                                  });
                                  return count;
                                })();
                                
                                return (
                                  <div key={province.id} className="space-y-1">
                                    <div className="flex items-center justify-between">
                                      <div className="flex items-center space-x-2 flex-1">
                                        {hasDistricts ? (
                                    <button
                                      onClick={() => toggleProvince(province.id)}
                                            className="flex items-center space-x-2 flex-1 text-left"
                                          >
                                            <input
                                              type="checkbox"
                                              checked={(() => {
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id);
                                                        if (w.local_addresses) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                              })()}
                                              onChange={(e) => {
                                                e.stopPropagation();
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id);
                                                        if (w.local_addresses) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                setSelectedLocations(prev => {
                                                  const newSet = new Set(prev);
                                                  const allSelected = allLocationIds.every(id => newSet.has(id));
                                                  allLocationIds.forEach(id => {
                                                    if (allSelected) {
                                                      newSet.delete(id);
                                                    } else {
                                                      newSet.add(id);
                                                    }
                                                  });
                                                  return newSet;
                                                });
                                              }}
                                              onClick={(e) => e.stopPropagation()}
                                              className="w-4 h-4"
                                            />
                                            <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                              {province.name}
                                            </span>
                                    </button>
                                        ) : (
                                          <label className="flex items-center space-x-2 flex-1 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={(() => {
                                        const allLocationIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                allLocationIds.push(w.id);
                                                if (w.local_addresses) {
                                                  w.local_addresses.forEach((_, idx) => {
                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                  });
                                                }
                                              });
                                            }
                                          });
                                        });
                                        return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                      })()}
                                              onChange={(e) => {
                                                e.stopPropagation();
                                        const allLocationIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                allLocationIds.push(w.id);
                                                if (w.local_addresses) {
                                                  w.local_addresses.forEach((_, idx) => {
                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                  });
                                                }
                                              });
                                            }
                                          });
                                        });
                                        setSelectedLocations(prev => {
                                          const newSet = new Set(prev);
                                          const allSelected = allLocationIds.every(id => newSet.has(id));
                                          allLocationIds.forEach(id => {
                                            if (allSelected) {
                                              newSet.delete(id);
                                            } else {
                                              newSet.add(id);
                                            }
                                          });
                                          return newSet;
                                        });
                                      }}
                                              onClick={(e) => e.stopPropagation()}
                                              className="w-4 h-4"
                                            />
                                            <span className="text-sm text-[hsl(var(--foreground))]">
                                              {province.name}
                                            </span>
                                          </label>
                                        )}
                                      </div>
                                      <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                        ({provinceAdCount})
                                      </span>
                                  </div>
                                  
                                    {/* Show districts when expanded */}
                                    {hasDistricts && isProvinceExpanded && (
                                      <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                        {province.districts.map((district) => {
                                          const districtKey = `${province.id}-${district.id}`;
                                          const hasLocalLevels = district.localLevels && district.localLevels.length > 0;
                                          const isDistrictExpanded = expandedDistricts.has(districtKey);
                                          const districtAdCount = (() => {
                                            let count = 0;
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  // Only count ward-level ads, not address-level (addresses are subsets of wards)
                                                  count += getLocationAdCount(w.id);
                                                });
                                              }
                                            });
                                            return count;
                                          })();
                                          
                                          return (
                                            <div key={district.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasLocalLevels ? (
                                        <button
                                                      onClick={() => toggleDistrict(districtKey)}
                                                      className="flex items-center space-x-2 flex-1 text-left"
                                                    >
                                                      <input
                                                        type="checkbox"
                                                        checked={(() => {
                                                          const allLocationIds = [];
                                                          district.localLevels.forEach(ll => {
                                                            if (ll.wards) {
                                                              ll.wards.forEach(w => {
                                                                allLocationIds.push(w.id);
                                                                if (w.local_addresses) {
                                                                  w.local_addresses.forEach((_, idx) => {
                                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                                  });
                                                                }
                                                              });
                                                            }
                                                          });
                                                          return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                                        })()}
                                                        onChange={(e) => {
                                                          e.stopPropagation();
                                                          const allLocationIds = [];
                                                          district.localLevels.forEach(ll => {
                                                            if (ll.wards) {
                                                              ll.wards.forEach(w => {
                                                                allLocationIds.push(w.id);
                                                                if (w.local_addresses) {
                                                                  w.local_addresses.forEach((_, idx) => {
                                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                                  });
                                                                }
                                                              });
                                                            }
                                                          });
                                                          setSelectedLocations(prev => {
                                                            const newSet = new Set(prev);
                                                            const allSelected = allLocationIds.every(id => newSet.has(id));
                                                            allLocationIds.forEach(id => {
                                                              if (allSelected) {
                                                                newSet.delete(id);
                                                              } else {
                                                                newSet.add(id);
                                                              }
                                                            });
                                                            return newSet;
                                                          });
                                                        }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="w-4 h-4"
                                                      />
                                                      <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                                        {district.name}
                                                      </span>
                                        </button>
                                                  ) : (
                                                    <label className="flex items-center space-x-2 flex-1 cursor-pointer">
                                        <input
                                          type="checkbox"
                                          checked={(() => {
                                            const allLocationIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  allLocationIds.push(w.id);
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                              }
                                            });
                                            return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                          })()}
                                                        onChange={(e) => {
                                                          e.stopPropagation();
                                            const allLocationIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  allLocationIds.push(w.id);
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                              }
                                            });
                                            setSelectedLocations(prev => {
                                              const newSet = new Set(prev);
                                              const allSelected = allLocationIds.every(id => newSet.has(id));
                                              allLocationIds.forEach(id => {
                                                if (allSelected) {
                                                  newSet.delete(id);
                                                } else {
                                                  newSet.add(id);
                                                }
                                              });
                                              return newSet;
                                            });
                                          }}
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="w-4 h-4"
                                                      />
                                                      <span className="text-sm text-[hsl(var(--foreground))]">
                                                        {district.name}
                                                      </span>
                                                    </label>
                                                  )}
                                                </div>
                                                <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                  ({districtAdCount})
                                                </span>
                                      </div>
                                      
                                              {/* Show local levels when expanded */}
                                              {hasLocalLevels && isDistrictExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {district.localLevels.map((localLevel) => {
                                                    const localLevelKey = `${districtKey}-${localLevel.id}`;
                                                    const hasWards = localLevel.wards && localLevel.wards.length > 0;
                                                    const isLocalLevelExpanded = expandedLocalLevels.has(localLevelKey);
                                                    const localLevelAdCount = (() => {
                                                      if (!localLevel.wards) return 0;
                                                      let count = 0;
                                                      localLevel.wards.forEach(w => {
                                                        // Only count ward-level ads, not address-level (addresses are subsets of wards)
                                                        count += getLocationAdCount(w.id);
                                                      });
                                                      return count;
                                                    })();
                                                    
                                                    return (
                                                      <div key={localLevel.id} className="space-y-1">
                                                        <div className="flex items-center justify-between">
                                                          <div className="flex items-center space-x-2 flex-1">
                                                            {hasWards ? (
                                            <button
                                                                onClick={() => toggleLocalLevel(localLevelKey)}
                                                                className="flex items-center space-x-2 flex-1 text-left"
                                                              >
                                                                <input
                                                                  type="checkbox"
                                                                  checked={(() => {
                                                                    if (!localLevel.wards) return false;
                                                                    const allLocationIds = [];
                                                                    localLevel.wards.forEach(w => {
                                                                      allLocationIds.push(w.id);
                                                                      if (w.local_addresses) {
                                                                        w.local_addresses.forEach((_, idx) => {
                                                                          allLocationIds.push(`${w.id}-${idx}`);
                                                                        });
                                                                      }
                                                                    });
                                                                    return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                                                  })()}
                                                                  onChange={(e) => {
                                                                    e.stopPropagation();
                                                                    if (localLevel.wards) {
                                                                      const allLocationIds = [];
                                                                      localLevel.wards.forEach(w => {
                                                                        allLocationIds.push(w.id);
                                                                        if (w.local_addresses) {
                                                                          w.local_addresses.forEach((_, idx) => {
                                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                                          });
                                                                        }
                                                                      });
                                                                      setSelectedLocations(prev => {
                                                                        const newSet = new Set(prev);
                                                                        const allSelected = allLocationIds.every(id => newSet.has(id));
                                                                        allLocationIds.forEach(id => {
                                                                          if (allSelected) {
                                                                            newSet.delete(id);
                                                                          } else {
                                                                            newSet.add(id);
                                                                          }
                                                                        });
                                                                        return newSet;
                                                                      });
                                                                    }
                                                                  }}
                                                                  onClick={(e) => e.stopPropagation()}
                                                                  className="w-4 h-4"
                                                                />
                                                                <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                                                  {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                                </span>
                                            </button>
                                                            ) : (
                                                              <label className="flex items-center space-x-2 flex-1 cursor-pointer">
                                            <input
                                              type="checkbox"
                                              checked={(() => {
                                                if (!localLevel.wards) return false;
                                                const allLocationIds = [];
                                                localLevel.wards.forEach(w => {
                                                  allLocationIds.push(w.id);
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                                return allLocationIds.length > 0 && allLocationIds.every(id => selectedLocations.has(id));
                                              })()}
                                                                  onChange={(e) => {
                                                                    e.stopPropagation();
                                                if (localLevel.wards) {
                                                  const allLocationIds = [];
                                                  localLevel.wards.forEach(w => {
                                                    allLocationIds.push(w.id);
                                                    if (w.local_addresses) {
                                                      w.local_addresses.forEach((_, idx) => {
                                                        allLocationIds.push(`${w.id}-${idx}`);
                                                      });
                                                    }
                                                  });
                                                  setSelectedLocations(prev => {
                                                    const newSet = new Set(prev);
                                                    const allSelected = allLocationIds.every(id => newSet.has(id));
                                                    allLocationIds.forEach(id => {
                                                      if (allSelected) {
                                                        newSet.delete(id);
                                                      } else {
                                                        newSet.add(id);
                                                      }
                                                    });
                                                    return newSet;
                                                  });
                                                }
                                              }}
                                                                  onClick={(e) => e.stopPropagation()}
                                                                  className="w-4 h-4"
                                            />
                                            <span className="text-sm text-[hsl(var(--foreground))]">
                                              {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                                </span>
                                                              </label>
                                                            )}
                                                          </div>
                                                          <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                            ({localLevelAdCount})
                                            </span>
                                          </div>
                                          
                                                        {/* Show wards when expanded */}
                                                        {hasWards && isLocalLevelExpanded && (
                                                          <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                            {localLevel.wards.map((ward) => {
                                                              const wardAdCount = getLocationAdCount(ward.id);
                                                              const hasAddresses = ward.local_addresses && ward.local_addresses.length > 0;
                                                              const wardKey = `${localLevelKey}-${ward.id}`;
                                                              const isWardExpanded = expandedWards.has(wardKey);
                                                              
                                                              return (
                                                                <div key={ward.id} className="space-y-1">
                                                                  <div className="flex items-center justify-between">
                                                                    <div className="flex items-center space-x-2 flex-1">
                                                                      {hasAddresses ? (
                                                                        <button
                                                                          onClick={() => {
                                                                            setExpandedWards(prev => {
                                                                              const newSet = new Set(prev);
                                                                              if (newSet.has(wardKey)) {
                                                                                newSet.delete(wardKey);
                                                                              } else {
                                                                                newSet.add(wardKey);
                                                                              }
                                                                              return newSet;
                                                                            });
                                                                          }}
                                                                          className="flex items-center space-x-2 flex-1 text-left"
                                                                        >
                                                <input
                                                  type="checkbox"
                                                  checked={(() => {
                                                                              // Check if ward.id is selected OR all addresses are selected
                                                                              const wardSelected = selectedLocations.has(ward.id);
                                                                              if (wardSelected) return true;
                                                                              
                                                                              // Check if all addresses are selected
                                                                              if (ward.local_addresses && ward.local_addresses.length > 0) {
                                                                                const addressIds = ward.local_addresses.map((_, idx) => `${ward.id}-${idx}`);
                                                                                return addressIds.length > 0 && addressIds.every(id => selectedLocations.has(id));
                                                                              }
                                                                              
                                                                              return false;
                                                  })()}
                                                                            onChange={(e) => {
                                                                              e.stopPropagation();
                                                    const allIds = [ward.id];
                                                    if (ward.local_addresses) {
                                                      ward.local_addresses.forEach((_, idx) => {
                                                        allIds.push(`${ward.id}-${idx}`);
                                                      });
                                                    }
                                                    const allSelected = allIds.every(id => selectedLocations.has(id));
                                                    setSelectedLocations(prev => {
                                                      const newSet = new Set(prev);
                                                      allIds.forEach(id => {
                                                        if (allSelected) {
                                                          newSet.delete(id);
                                                        } else {
                                                          newSet.add(id);
                                                        }
                                                      });
                                                      return newSet;
                                                    });
                                                  }}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                            className="w-4 h-4"
                                                                          />
                                                                          <span className="text-sm text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))] cursor-pointer">
                                                                            Ward {ward.ward_number}
                                                                          </span>
                                                                        </button>
                                                                      ) : (
                                                                        <label className="flex items-center space-x-2 flex-1 cursor-pointer">
                                                                          <input
                                                                            type="checkbox"
                                                                            checked={selectedLocations.has(ward.id)}
                                                                            onChange={(e) => {
                                                                              e.stopPropagation();
                                                                              handleLocationToggle(ward.id);
                                                                            }}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                            className="w-4 h-4"
                                                />
                                                <span className="text-sm text-[hsl(var(--foreground))]">
                                                  Ward {ward.ward_number}
                                                                          </span>
                                                                        </label>
                                                                      )}
                                                                    </div>
                                                                    <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                                      ({wardAdCount})
                                                </span>
                                              </div>
                                              
                                                                  {/* Local Addresses - Only show when ward is expanded */}
                                                                  {hasAddresses && isWardExpanded && (
                                                                    <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {ward.local_addresses.map((address, idx) => {
                                                    const addressId = `${ward.id}-${idx}`;
                                                                        const addressAdCount = getLocationAdCount(addressId);
                                                    return (
                                                                          <div key={addressId} className="flex items-center justify-between">
                                                                            <label className="flex items-center space-x-2 cursor-pointer flex-1">
                                                        <input
                                                          type="checkbox"
                                                          checked={selectedLocations.has(addressId)}
                                                                                onChange={(e) => {
                                                                                  e.stopPropagation();
                                                                                  handleLocationToggle(addressId);
                                                                                }}
                                                                                onClick={(e) => e.stopPropagation()}
                                                                                className="w-4 h-4"
                                                        />
                                                        <span className="text-xs text-[hsl(var(--muted-foreground))]">{address}</span>
                                                                            </label>
                                                                            <span className="text-xs text-[hsl(var(--muted-foreground))] ml-2">
                                                                              ({addressAdCount})
                                                                            </span>
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                                              );
                                                            })}
                                        </div>
                                                        )}
                                    </div>
                                                    );
                                                  })}
                                </div>
                                              )}
                            </div>
                                          );
                                        })}
                                      </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  <Button className="min-w-[100px]">Search</Button>
                </div>
              </CardContent>
            </Card>
          </section>

          {/* Default view when no section is selected */}
          {!activeSection && (
            <section>
              <div className="flex justify-end mb-6">
                <Button onClick={() => setShowPostAdForm(!showPostAdForm)}>Post Ad</Button>
              </div>

              {/* Post Ad Form - appears when Post Ad is clicked */}
              <div
                className={`mb-6 transition-all duration-400 ease-in-out ${
                  showPostAdForm 
                    ? 'opacity-100 translate-y-0' 
                    : 'opacity-0 -translate-y-4 pointer-events-none'
                }`}
                style={{
                  transition: 'opacity 0.4s ease-in-out, transform 0.4s ease-in-out'
                }}
              >
                {showPostAdForm && (
                  <Card>
                    <CardContent className="p-6">
                      <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Create New Ad</h3>
                      <form onSubmit={handlePostAdSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Title * (Max 90 characters)</label>
                            <Input
                              value={postAdFormData.title}
                              onChange={(e) => {
                                const value = e.target.value;
                                if (value.length <= 90) {
                                  setPostAdFormData({...postAdFormData, title: value});
                                }
                              }}
                              className="w-full"
                              maxLength={90}
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {postAdFormData.title.length}/90 characters
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Price *</label>
                            <Input
                              type="number"
                              value={postAdFormData.price}
                              onChange={(e) => setPostAdFormData({...postAdFormData, price: e.target.value})}
                              className="w-full"
                              min="0"
                              step="0.01"
                              required
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Description * (Max 300 words)</label>
                          <textarea
                            value={postAdFormData.description}
                            onChange={(e) => {
                              const value = e.target.value;
                              const wordCount = value.trim() ? value.trim().split(/\s+/).length : 0;
                              if (wordCount <= 300) {
                                setPostAdFormData({...postAdFormData, description: value});
                              }
                            }}
                            className="w-full min-h-[100px] px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                            required
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Category *</label>
                            <div className="relative" ref={postAdCategoryDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setPostAdShowCategoryDropdown(!postAdShowCategoryDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                              >
                                <span>{buildPostAdCategoryString() || 'Select Category'}</span>
                                <span className="ml-2">{postAdShowCategoryDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Cascading Category Menu */}
                              {postAdShowCategoryDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 flex">
                                  {/* Category Column */}
                                  <div className="min-w-[200px] max-h-96 overflow-y-auto border-r border-[hsl(var(--border))]">
                                    <div className="p-2 font-semibold text-xs text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                      Category
                                    </div>
                                    <div className="py-1">
                                      <button
                                        type="button"
                                        onClick={() => {
                                          handlePostAdClearCategorySelection();
                                        }}
                                        className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                          !postAdSelectedCategoryName ? 'bg-[hsl(var(--accent))]' : ''
                                        }`}
                                      >
                                        All Categories
                                      </button>
                                      {categories.map((category, index) => (
                                        <button
                                          key={category.id || `category-${index}`}
                                          type="button"
                                          onClick={() => handlePostAdCategorySelect(category.name)}
                                          onMouseEnter={() => {
                                            if (postAdSelectedCategoryName !== category.name) {
                                              handlePostAdCategorySelect(category.name);
                                            }
                                          }}
                                          className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] flex items-center justify-between ${
                                            postAdSelectedCategoryName === category.name ? 'bg-[hsl(var(--accent))]' : ''
                                          }`}
                                        >
                                          <span>{category.name}</span>
                                          {category.subcategories && category.subcategories.length > 0 && <span></span>}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                  
                                  {/* Subcategory Column - appears when category is selected */}
                                  {postAdSelectedCategoryName && getPostAdSelectedCategory() && getPostAdSelectedCategory().subcategories && getPostAdSelectedCategory().subcategories.length > 0 && (
                                    <div className="min-w-[200px] max-h-96 overflow-y-auto">
                                      <div className="p-2 font-semibold text-xs text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                        Subcategory
                                      </div>
                                      <div className="py-1">
                                        <button
                                          type="button"
                                          onClick={() => {
                                            setPostAdSelectedSubcategoryId('');
                                            const category = getPostAdSelectedCategory();
                                            if (category) {
                                              setPostAdFormData({...postAdFormData, category_id: category.id.toString()});
                                            }
                                            setPostAdShowCategoryDropdown(false);
                                          }}
                                          className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                            !postAdSelectedSubcategoryId ? 'bg-[hsl(var(--accent))]' : ''
                                          }`}
                                        >
                                          All Subcategories
                                        </button>
                                        {getPostAdSelectedCategory().subcategories.map((subcategory) => (
                                          <button
                                            key={subcategory.id}
                                            type="button"
                                            onClick={() => handlePostAdSubcategorySelect(subcategory.id.toString())}
                                            className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                              postAdSelectedSubcategoryId === subcategory.id.toString() ? 'bg-[hsl(var(--accent))]' : ''
                                            }`}
                                          >
                                            {subcategory.name}
                                          </button>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">User *</label>
                            <select
                              value={postAdFormData.user_id}
                              onChange={(e) => setPostAdFormData({...postAdFormData, user_id: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            >
                              <option value="">Select User</option>
                              {Array.isArray(users) && users.map((user) => (
                                <option key={user.id} value={user.id}>
                                  {user.name} ({user.email})
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                        
                        {/* Location Selection */}
                        <div>
                          <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Location *</label>
                          <div className="relative" ref={postAdLocationDropdownRef}>
                            <button
                              type="button"
                              onClick={() => setPostAdShowLocationDropdown(!postAdShowLocationDropdown)}
                              className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                            >
                              <span>{buildPostAdLocationString()}</span>
                              <span className="ml-2">{postAdShowLocationDropdown ? '' : ''}</span>
                            </button>
                            
                            {/* Hierarchical Checkbox Menu */}
                            {postAdShowLocationDropdown && (
                              <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[600px] max-h-[500px] overflow-y-auto">
                                <div className="p-3">
                                  <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                    <span className="font-semibold text-sm text-[hsl(var(--foreground))]">Select Locations</span>
                                    <button
                                      type="button"
                                      onClick={handlePostAdSelectAllLocations}
                                      className="text-xs text-[hsl(var(--primary))] hover:underline"
                                    >
                                      {postAdSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                    </button>
                                  </div>
                                  
                                  {/* Hierarchical Location Tree */}
                                  <div className="space-y-1">
                                    {locationData?.provinces && locationData.provinces.length > 0 ? (
                                      locationData.provinces.map((province) => (
                                      <div key={province.id} className="border-b border-[hsl(var(--border))] pb-1 mb-1">
                                        {/* Province Level */}
                                        <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                          <button
                                            type="button"
                                            onClick={() => togglePostAdProvince(province.id)}
                                            className="mr-2 text-xs"
                                          >
                                            {postAdExpandedProvinces.has(province.id) ? '' : ''}
                                          </button>
                                          <input
                                            type="checkbox"
                                            className="mr-2"
                                            checked={(() => {
                                              const allLocationIds = [];
                                              province.districts.forEach(d => {
                                                d.localLevels.forEach(ll => {
                                                  if (ll.wards) {
                                                    ll.wards.forEach(w => {
                                                      allLocationIds.push(w.id.toString());
                                                      if (w.local_addresses && w.local_addresses.length > 0) {
                                                        w.local_addresses.forEach((_, idx) => {
                                                          allLocationIds.push(`${w.id}-${idx}`);
                                                        });
                                                      }
                                                    });
                                                  }
                                                });
                                              });
                                              // Ensure all IDs are strings for consistent comparison
                                              return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                const idStr = id.toString();
                                                return postAdSelectedLocations.has(idStr);
                                              });
                                            })()}
                                            onChange={() => {
                                              const allLocationIds = [];
                                              province.districts.forEach(d => {
                                                d.localLevels.forEach(ll => {
                                                  if (ll.wards) {
                                                    ll.wards.forEach(w => {
                                                      allLocationIds.push(w.id.toString());
                                                      if (w.local_addresses && w.local_addresses.length > 0) {
                                                        w.local_addresses.forEach((_, idx) => {
                                                          allLocationIds.push(`${w.id}-${idx}`);
                                                        });
                                                      }
                                                    });
                                                  }
                                                });
                                              });
                                              setPostAdSelectedLocations(prev => {
                                                const newSet = new Set(prev);
                                                // Ensure all IDs are strings for consistent comparison
                                                const allSelected = allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return newSet.has(idStr);
                                                });
                                                allLocationIds.forEach(id => {
                                                  const idStr = id.toString();
                                                  if (allSelected) {
                                                    newSet.delete(idStr);
                                                  } else {
                                                    newSet.add(idStr);
                                                  }
                                                });
                                                return newSet;
                                              });
                                            }}
                                          />
                                          <span className="text-sm font-medium text-[hsl(var(--foreground))]">{province.name}</span>
                                        </div>
                                        
                                        {/* Districts */}
                                        {postAdExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                          <div key={district.id} className="ml-6 mt-1">
                                            <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                              <button
                                                type="button"
                                                onClick={() => togglePostAdDistrict(`${province.id}-${district.id}`)}
                                                className="mr-2 text-xs"
                                              >
                                                {postAdExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                              </button>
                                              <input
                                                type="checkbox"
                                                className="mr-2"
                                                checked={(() => {
                                                  const allLocationIds = [];
                                                  district.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                  // Ensure all IDs are strings for consistent comparison
                                                  return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                    const idStr = id.toString();
                                                    return postAdSelectedLocations.has(idStr);
                                                  });
                                                })()}
                                                onChange={() => {
                                                  const allLocationIds = [];
                                                  district.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                  setPostAdSelectedLocations(prev => {
                                                    const newSet = new Set(prev);
                                                    // Ensure all IDs are strings for consistent comparison
                                                    const allSelected = allLocationIds.every(id => {
                                                      const idStr = id.toString();
                                                      return newSet.has(idStr);
                                                    });
                                                    allLocationIds.forEach(id => {
                                                      const idStr = id.toString();
                                                      if (allSelected) {
                                                        newSet.delete(idStr);
                                                      } else {
                                                        newSet.add(idStr);
                                                      }
                                                    });
                                                    return newSet;
                                                  });
                                                }}
                                              />
                                              <span className="text-sm text-[hsl(var(--foreground))]">{district.name}</span>
                                            </div>
                                            
                                            {/* Local Levels */}
                                            {postAdExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                              <div key={localLevel.id} className="ml-6 mt-1">
                                                <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                  <button
                                                    type="button"
                                                    onClick={() => togglePostAdLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                                    className="mr-2 text-xs"
                                                  >
                                                    {postAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                                  </button>
                                                  <input
                                                    type="checkbox"
                                                    className="mr-2"
                                                    checked={(() => {
                                                      if (!localLevel.wards) return false;
                                                      const allLocationIds = [];
                                                      localLevel.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                      // Ensure all IDs are strings for consistent comparison
                                                      return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                        const idStr = id.toString();
                                                        return postAdSelectedLocations.has(idStr);
                                                      });
                                                    })()}
                                                    onChange={() => {
                                                      if (localLevel.wards) {
                                                        const allLocationIds = [];
                                                        localLevel.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                        setPostAdSelectedLocations(prev => {
                                                          const newSet = new Set(prev);
                                                          // Ensure all IDs are strings for consistent comparison
                                                          const allSelected = allLocationIds.every(id => {
                                                            const idStr = id.toString();
                                                            return newSet.has(idStr);
                                                          });
                                                          allLocationIds.forEach(id => {
                                                            const idStr = id.toString();
                                                            if (allSelected) {
                                                              newSet.delete(idStr);
                                                            } else {
                                                              newSet.add(idStr);
                                                            }
                                                          });
                                                          return newSet;
                                                        });
                                                      }
                                                    }}
                                                  />
                                                  <span className="text-sm text-[hsl(var(--foreground))]">
                                                    {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                  </span>
                                                </div>
                                                
                                                {/* Wards and Local Addresses */}
                                                {postAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                                  <div key={ward.id} className="ml-6 mt-1">
                                                    <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                      <input
                                                        type="checkbox"
                                                        className="mr-2"
                                                        checked={(() => {
                                                          const allIds = [ward.id.toString()];
                                                          if (ward.local_addresses && ward.local_addresses.length > 0) {
                                                            ward.local_addresses.forEach((_, idx) => {
                                                              allIds.push(`${ward.id}-${idx}`);
                                                            });
                                                          }
                                                          // Ensure all IDs are strings for consistent comparison
                                                          return allIds.every(id => {
                                                            const idStr = id.toString();
                                                            return postAdSelectedLocations.has(idStr);
                                                          });
                                                        })()}
                                                        onChange={() => {
                                                          const allIds = [ward.id.toString()];
                                                          if (ward.local_addresses && ward.local_addresses.length > 0) {
                                                            ward.local_addresses.forEach((_, idx) => {
                                                              allIds.push(`${ward.id}-${idx}`);
                                                            });
                                                          }
                                                          // Ensure all IDs are strings for consistent comparison
                                                          const allSelected = allIds.every(id => {
                                                            const idStr = id.toString();
                                                            return postAdSelectedLocations.has(idStr);
                                                          });
                                                          setPostAdSelectedLocations(prev => {
                                                            const newSet = new Set(prev);
                                                            allIds.forEach(id => {
                                                              const idStr = id.toString();
                                                              if (allSelected) {
                                                                newSet.delete(idStr);
                                                              } else {
                                                                newSet.add(idStr);
                                                              }
                                                            });
                                                            return newSet;
                                                          });
                                                        }}
                                                      />
                                                      <span className="text-sm text-[hsl(var(--foreground))]">
                                                        Ward {ward.ward_number}
                                                      </span>
                                                    </div>
                                                    
                                                    {/* Local Addresses */}
                                                    {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                      <div className="ml-6 mt-1 space-y-1">
                                                        {ward.local_addresses.map((address, idx) => {
                                                          const addressId = `${ward.id}-${idx}`;
                                                          return (
                                                            <div key={addressId} className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                              <input
                                                                type="checkbox"
                                                                className="mr-2"
                                                                checked={postAdSelectedLocations.has(addressId.toString())}
                                                                onChange={() => handlePostAdLocationToggle(addressId)}
                                                              />
                                                              <span className="text-xs text-[hsl(var(--muted-foreground))]">{address}</span>
                                                            </div>
                                                          );
                                                        })}
                                                      </div>
                                                    )}
                                                  </div>
                                                ))}
                                              </div>
                                            ))}
                                          </div>
                                        ))}
                                      </div>
                                    ))
                                    ) : (
                                      <div className="p-4 text-center text-sm text-[hsl(var(--muted-foreground))]">
                                        No locations available. Please add locations first.
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Image Upload Section - 4 images */}
                        <div>
                          <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-2">Images (Up to 4 images) *</label>
                          <div className="grid grid-cols-2 gap-4">
                            {[0, 1, 2, 3].map((index) => (
                              <div key={index} className="space-y-2">
                                <label className="block text-xs text-[hsl(var(--muted-foreground))]">
                                  Image {index + 1} {index === 0 && '(Primary)'}
                                </label>
                                {postAdImages[index] ? (
                                  <div className="relative">
                                    <img
                                      src={URL.createObjectURL(postAdImages[index])}
                                      alt={`Preview ${index + 1}`}
                                      className="w-full h-32 object-cover rounded-md border border-[hsl(var(--border))]"
                                    />
                                    <button
                                      type="button"
                                      onClick={() => handleImageRemove(index)}
                                      className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                    >
                                      
                                    </button>
                                  </div>
                                ) : (
                                  <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-[hsl(var(--border))] rounded-md cursor-pointer hover:bg-[hsl(var(--accent))] transition-colors">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                      <svg className="w-8 h-8 mb-2 text-[hsl(var(--muted-foreground))]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                      </svg>
                                      <p className="mb-2 text-xs text-[hsl(var(--muted-foreground))]">Click to upload</p>
                                    </div>
                                    <input
                                      type="file"
                                      accept="image/*"
                                      className="hidden"
                                      onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) handleImageChange(index, file);
                                      }}
                                    />
                                  </label>
                                )}
                              </div>
                            ))}
                          </div>
                          <p className="mt-2 text-xs text-[hsl(var(--muted-foreground))]">
                            At least one image is required. Supported formats: JPEG, PNG, JPG, GIF (Max 2MB per image)
                          </p>
                        </div>
                        
                        <div className="flex justify-end gap-2 mt-6">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={() => {
                              setShowPostAdForm(false);
                              setPostAdFormData({
                                title: '',
                                description: '',
                                price: '',
                                category_id: '',
                                user_id: '',
                              });
                              setPostAdImages([null, null, null, null]); // Reset images
                              setPostAdSelectedCategoryName('');
                              setPostAdSelectedSubcategoryId('');
                              setPostAdSelectedLocations(new Set());
                            }}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">Create Ad</Button>
                        </div>
                      </form>
                    </CardContent>
                  </Card>
                )}
              </div>

              {/* Display filtered ads in grid format */}
              {adsLoading ? (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading ads...
                </div>
              ) : (
                <>
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-[hsl(var(--muted-foreground))]">
                      Showing {startResult}-{endResult} of {filteredAndSortedAds.length} results
                    </p>
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-[hsl(var(--foreground))]">Sorting option:</label>
                      <select
                        value={adSort}
                        onChange={(e) => {
                          setAdSort(e.target.value);
                          setCurrentPage(1); // Reset to first page when sorting changes
                        }}
                        className="px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                      >
                        <option value="most relevant">most relevant</option>
                        <option value="lowest price">lowest price</option>
                        <option value="highest price">highest price</option>
                        <option value="ascending order">ascending order</option>
                        <option value="descending order">descending order</option>
                        <option value="latest listing">latest listing</option>
                        <option value="top review">top review</option>
                      </select>
                    </div>
                  </div>

                  {/* Display ads in grid (4 per row) */}
                  {filteredAndSortedAds.length === 0 ? (
                    <div className="text-center py-12 text-[hsl(var(--muted-foreground))]">
                      <p>No ads found matching your search criteria.</p>
                    </div>
                  ) : (
                    <>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        {displayedAds.map((ad) => (
                        <Card 
                          key={ad.id} 
                          className="hover:shadow-lg transition-shadow cursor-pointer"
                          onClick={() => {
                            navigate(getAdUrl(ad));
                          }}
                        >
                          <CardContent className="p-0">
                            <img
                              src={ad.image1_url || '/placeholder-image.jpg'}
                              alt={ad.title}
                              className="w-full h-48 object-cover"
                              onError={(e) => {
                                e.target.src = '/placeholder-image.jpg';
                              }}
                            />
                            <div className="p-3">
                              <h3 className="font-semibold text-sm text-[hsl(var(--foreground))] mb-1 line-clamp-2">
                                {ad.title}
                              </h3>
                              <p className="text-xs text-[hsl(var(--muted-foreground))] mb-2 line-clamp-2">
                                {ad.description}
                              </p>
                              <p className="text-lg font-bold text-[hsl(var(--primary))] mb-2">
                                Rs. {ad.price.toLocaleString()}
                              </p>
                              {ad.location && (
                                <p className="text-xs text-[hsl(var(--muted-foreground))] mb-1">
                                   {ad.location.length > 30 ? `${ad.location.substring(0, 30)}...` : ad.location}
                                </p>
                              )}
                            </div>
                          </CardContent>
                        </Card>
                        ))}
                      </div>

                      {/* Pagination */}
                      {totalPages > 1 && (
                        <div className="flex justify-center items-center gap-2 mt-6">
                          <Button
                            variant="outline"
                            onClick={() => handlePageChange(currentPage - 1)}
                            disabled={currentPage === 1}
                          >
                            Previous
                          </Button>
                          
                          <div className="flex gap-1">
                            {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => {
                              // Show first page, last page, current page, and pages around current
                              if (
                                page === 1 ||
                                page === totalPages ||
                                (page >= currentPage - 2 && page <= currentPage + 2)
                              ) {
                                return (
                                  <Button
                                    key={page}
                                    variant={currentPage === page ? 'default' : 'outline'}
                                    onClick={() => handlePageChange(page)}
                                    className="min-w-[40px]"
                                  >
                                    {page}
                                  </Button>
                                );
                              } else if (
                                page === currentPage - 3 ||
                                page === currentPage + 3
                              ) {
                                return <span key={page} className="px-2">...</span>;
                              }
                              return null;
                            })}
                          </div>

                          <Button
                            variant="outline"
                            onClick={() => handlePageChange(currentPage + 1)}
                            disabled={currentPage === totalPages}
                          >
                            Next
                          </Button>
                        </div>
                      )}
                    </>
                  )}
                </>
              )}
            </section>
          )}

          {/* Error and Success Messages */}
          {error && (
            <div className="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
              {error}
            </div>
          )}
          {successMessage && (
            <div className="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
              {successMessage}
            </div>
          )}

          {/* Section-specific content */}
          {activeSection === 'ads-management' && !activeSubsection && (
            <>
              {adsLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading ads...
                </div>
              )}
              {/* Ad Totals Summary and Post Ad Button */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <div className="flex items-start justify-between">
                      <div className="space-y-2 flex-1">
                        <p 
                          className="text-sm text-[hsl(var(--foreground))] cursor-pointer hover:text-[hsl(var(--primary))] transition-colors"
                          onClick={() => navigate(`${isSuperAdmin ? '/super_admin' : '/admin'}/ads-management/user-posted-ads`)}
                        >
                          User posted ad total: <span className="font-semibold">{adTotals.userPosted}</span>
                        </p>
                        <p 
                          className="text-sm text-[hsl(var(--foreground))] cursor-pointer hover:text-[hsl(var(--primary))] transition-colors"
                          onClick={() => navigate(`${isSuperAdmin ? '/super_admin' : '/admin'}/ads-management/vendor-posted-ads`)}
                        >
                          Vendor posted ad total: <span className="font-semibold">{adTotals.vendorPosted}</span>
                        </p>
                        <p 
                          className="text-sm text-[hsl(var(--foreground))] cursor-pointer hover:text-[hsl(var(--primary))] transition-colors"
                          onClick={() => navigate(`${isSuperAdmin ? '/super_admin' : '/admin'}/ads-management/admin-posted-ads`)}
                        >
                          Admin posted ad total: <span className="font-semibold">{adTotals.adminPosted}</span>
                        </p>
                        <p className="text-sm text-[hsl(var(--foreground))]">
                          Total All ads: <span className="font-semibold">{adTotals.total}</span>
                        </p>
                      </div>
                      <div className="ml-4">
                        <Button onClick={() => setShowPostAdForm(!showPostAdForm)}>Post Ad</Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </section>

              {/* Post Ad Form - appears when Post Ad is clicked */}
              <div
                className={`mb-6 transition-all duration-400 ease-in-out ${
                  showPostAdForm 
                    ? 'opacity-100 translate-y-0' 
                    : 'opacity-0 -translate-y-4 pointer-events-none'
                }`}
                style={{
                  transition: 'opacity 0.4s ease-in-out, transform 0.4s ease-in-out'
                }}
              >
                {showPostAdForm && (
                  <section>
                    <Card>
                      <CardContent className="p-6">
                        <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Create New Ad</h3>
                        <form onSubmit={handlePostAdSubmit} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Title *</label>
                              <Input
                                value={postAdFormData.title}
                                onChange={(e) => setPostAdFormData({...postAdFormData, title: e.target.value})}
                                className="w-full"
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Price *</label>
                              <Input
                                type="number"
                                value={postAdFormData.price}
                                onChange={(e) => setPostAdFormData({...postAdFormData, price: e.target.value})}
                                className="w-full"
                                min="0"
                                step="0.01"
                                required
                              />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Description *</label>
                            <textarea
                              value={postAdFormData.description}
                              onChange={(e) => setPostAdFormData({...postAdFormData, description: e.target.value})}
                              className="w-full min-h-[100px] px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Category *</label>
                              <div className="relative" ref={postAdCategoryDropdownRef}>
                                <button
                                  type="button"
                                  onClick={() => setPostAdShowCategoryDropdown(!postAdShowCategoryDropdown)}
                                  className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                                >
                                  <span>{buildPostAdCategoryString() || 'Select Category'}</span>
                                  <span className="ml-2">{postAdShowCategoryDropdown ? '' : ''}</span>
                                </button>
                                
                                {/* Hierarchical Category Menu - Matching search category dropdown design */}
                                {postAdShowCategoryDropdown && (
                                  <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                    <div className="p-3">
                                      <div className="space-y-1">
                                        {categories.map((category) => {
                                          const subcategories = category.subcategories || [];
                                          const hasSubcategories = subcategories.length > 0;
                                          // Use category name as key for expansion (matching search category dropdown behavior)
                                          const categoryName = (category.name || '').trim();
                                          const isCategoryExpanded = categoryName ? postAdExpandedCategories.has(categoryName) : false;
                                          
                                          // Check if this category is selected
                                          const isCategorySelected = postAdSelectedCategoryName === categoryName && !postAdSelectedSubcategoryId && !postAdSelectedItemCategoryId;
                                          
                                          return (
                                            <div key={category.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasSubcategories ? (
                                                    <div className="flex items-center space-x-2 flex-1">
                                        <button
                                          type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          togglePostAdCategory(categoryName);
                                                        }}
                                                        className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                      >
                                                        {isCategoryExpanded ? '' : ''}
                                                      </button>
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          handlePostAdCategorySelect(category.id, categoryName);
                                          }}
                                                        className={`flex-1 text-left text-sm ${
                                                          isCategorySelected
                                                            ? 'text-[hsl(var(--primary))] font-medium'
                                                            : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                          }`}
                                        >
                                                        {category.name}
                                        </button>
                                                    </div>
                                                  ) : (
                                          <button
                                            type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handlePostAdCategorySelect(category.id, categoryName);
                                            }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                            }`}
                                          >
                                                      {category.name}
                                          </button>
                                                  )}
                                      </div>
                                    </div>
                                    
                                              {/* Show subcategories when expanded */}
                                              {hasSubcategories && isCategoryExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {subcategories.map((subcategory) => {
                                                    const itemCategories = subcategory.item_categories || [];
                                                    const hasItemCategories = itemCategories.length > 0;
                                                    const subcategoryName = (subcategory.name || '').trim();
                                                    const isSubcategoryExpanded = subcategoryName ? postAdExpandedSubcategories.has(subcategoryName) : false;
                                                    
                                                    // Check if this subcategory is selected
                                                    const subcategoryIdStr = subcategory.id.toString();
                                                    const isSubcategorySelected = postAdSelectedSubcategoryId === subcategoryIdStr && !postAdSelectedItemCategoryId;
                                                    
                                                    return (
                                                      <div key={subcategory.id} className="space-y-1">
                                                        <div className="flex items-center justify-between">
                                                          <div className="flex items-center space-x-2 flex-1">
                                                            {hasItemCategories ? (
                                                              <div className="flex items-center space-x-2 flex-1">
                                          <button
                                            type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    togglePostAdSubcategory(subcategoryName);
                                                                  }}
                                                                  className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                                >
                                                                  {isSubcategoryExpanded ? '' : ''}
                                                                </button>
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handlePostAdSubcategorySelect(subcategory.id, subcategoryName);
                                            }}
                                                                  className={`flex-1 text-left text-sm ${
                                                                    isSubcategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                            }`}
                                          >
                                                                  {subcategory.name}
                                          </button>
                                                              </div>
                                                            ) : (
                                            <button
                                              type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handlePostAdSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                              }`}
                                            >
                                              {subcategory.name}
                                            </button>
                                                            )}
                                        </div>
                                                        </div>
                                                        
                                                        {/* Show item categories when subcategory is expanded */}
                                                        {hasItemCategories && isSubcategoryExpanded && (
                                                          <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                            {itemCategories.map((itemCategory) => {
                                                              const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                              const itemCategoryIdStr = itemCategory.id.toString();
                                                              const isItemCategorySelected = postAdSelectedItemCategoryId === itemCategoryIdStr;
                                                              
                                                              return (
                                                                <div key={itemCategory.id} className="flex items-center justify-between">
                                                                  <button
                                                                    type="button"
                                                                    onClick={(e) => {
                                                                      e.stopPropagation();
                                                                      handlePostAdItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                    }}
                                                                    className={`flex-1 text-left text-xs ${
                                                                      isItemCategorySelected
                                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                                        : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                    }`}
                                                                  >
                                                                    {itemCategoryName}
                                                                  </button>
                                                                </div>
                                                              );
                                                            })}
                                      </div>
                                    )}
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">User *</label>
                              <select
                                value={postAdFormData.user_id}
                                onChange={(e) => setPostAdFormData({...postAdFormData, user_id: e.target.value})}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                required
                              >
                                <option value="">Select User</option>
                                {Array.isArray(users) && users.map((user) => (
                                  <option key={user.id} value={user.id}>
                                    {user.name} ({user.email})
                                  </option>
                                ))}
                              </select>
                            </div>
                          </div>
                          
                          {/* Location Selection */}
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Location *</label>
                            <div className="relative" ref={postAdLocationDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setPostAdShowLocationDropdown(!postAdShowLocationDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                              >
                                <span>{buildPostAdLocationString()}</span>
                                <span className="ml-2">{postAdShowLocationDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Hierarchical Checkbox Menu */}
                              {postAdShowLocationDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[600px] max-h-[500px] overflow-y-auto">
                                  <div className="p-3">
                                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                      <span className="font-semibold text-sm text-[hsl(var(--foreground))]">Select Locations</span>
                                      <button
                                        type="button"
                                        onClick={handlePostAdSelectAllLocations}
                                        className="text-xs text-[hsl(var(--primary))] hover:underline"
                                      >
                                        {postAdSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                      </button>
                                    </div>
                                    
                                    {/* Hierarchical Location Tree */}
                                    <div className="space-y-1">
                                      {locationData?.provinces && locationData.provinces.length > 0 ? (
                                        locationData.provinces.map((province) => (
                                        <div key={province.id} className="border-b border-[hsl(var(--border))] pb-1 mb-1">
                                          {/* Province Level */}
                                          <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                            <button
                                              type="button"
                                              onClick={() => togglePostAdProvince(province.id)}
                                              className="mr-2 text-xs"
                                            >
                                              {postAdExpandedProvinces.has(province.id) ? '' : ''}
                                            </button>
                                            <input
                                              type="checkbox"
                                              className="mr-2"
                                              checked={(() => {
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id);
                                                        if (w.local_addresses) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                return allLocationIds.length > 0 && allLocationIds.every(id => postAdSelectedLocations.has(id));
                                              })()}
                                              onChange={() => {
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id);
                                                        if (w.local_addresses) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                setPostAdSelectedLocations(prev => {
                                                  const newSet = new Set(prev);
                                                  const allSelected = allLocationIds.every(id => newSet.has(id));
                                                  allLocationIds.forEach(id => {
                                                    if (allSelected) {
                                                      newSet.delete(id);
                                                    } else {
                                                      newSet.add(id);
                                                    }
                                                  });
                                                  return newSet;
                                                });
                                              }}
                                            />
                                            <span className="text-sm font-medium text-[hsl(var(--foreground))]">{province.name}</span>
                                          </div>
                                          
                                          {/* Districts */}
                                          {postAdExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                            <div key={district.id} className="ml-6 mt-1">
                                              <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                <button
                                                  type="button"
                                                  onClick={() => togglePostAdDistrict(`${province.id}-${district.id}`)}
                                                  className="mr-2 text-xs"
                                                >
                                                  {postAdExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                                </button>
                                                <input
                                                  type="checkbox"
                                                  className="mr-2"
                                                  checked={(() => {
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id);
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    return allLocationIds.length > 0 && allLocationIds.every(id => postAdSelectedLocations.has(id));
                                                  })()}
                                                  onChange={() => {
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id);
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    setPostAdSelectedLocations(prev => {
                                                      const newSet = new Set(prev);
                                                      const allSelected = allLocationIds.every(id => newSet.has(id));
                                                      allLocationIds.forEach(id => {
                                                        if (allSelected) {
                                                          newSet.delete(id);
                                                        } else {
                                                          newSet.add(id);
                                                        }
                                                      });
                                                      return newSet;
                                                    });
                                                  }}
                                                />
                                                <span className="text-sm text-[hsl(var(--foreground))]">{district.name}</span>
                                              </div>
                                              
                                              {/* Local Levels */}
                                              {postAdExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                                <div key={localLevel.id} className="ml-6 mt-1">
                                                  <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                    <button
                                                      type="button"
                                                      onClick={() => togglePostAdLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                                      className="mr-2 text-xs"
                                                    >
                                                      {postAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                                    </button>
                                                    <input
                                                      type="checkbox"
                                                      className="mr-2"
                                                      checked={(() => {
                                                        if (!localLevel.wards) return false;
                                                        const allLocationIds = [];
                                                        localLevel.wards.forEach(w => {
                                                          allLocationIds.push(w.id);
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                        return allLocationIds.length > 0 && allLocationIds.every(id => postAdSelectedLocations.has(id));
                                                      })()}
                                                      onChange={() => {
                                                        if (localLevel.wards) {
                                                          const allLocationIds = [];
                                                          localLevel.wards.forEach(w => {
                                                            allLocationIds.push(w.id.toString());
                                                            if (w.local_addresses && w.local_addresses.length > 0) {
                                                              w.local_addresses.forEach((_, idx) => {
                                                                allLocationIds.push(`${w.id}-${idx}`);
                                                              });
                                                            }
                                                          });
                                                          setPostAdSelectedLocations(prev => {
                                                            const newSet = new Set(prev);
                                                            const allSelected = allLocationIds.every(id => newSet.has(id));
                                                            allLocationIds.forEach(id => {
                                                              if (allSelected) {
                                                                newSet.delete(id);
                                                              } else {
                                                                newSet.add(id);
                                                              }
                                                            });
                                                            return newSet;
                                                          });
                                                        }
                                                      }}
                                                    />
                                                    <span className="text-sm text-[hsl(var(--foreground))]">
                                                      {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                    </span>
                                                  </div>
                                                  
                                                  {/* Wards and Local Addresses */}
                                                  {postAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                                    <div key={ward.id} className="ml-6 mt-1">
                                                      <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                        <input
                                                          type="checkbox"
                                                          className="mr-2"
                                                          checked={(() => {
                                                            const allIds = [ward.id];
                                                            if (ward.local_addresses) {
                                                              ward.local_addresses.forEach((_, idx) => {
                                                                allIds.push(`${ward.id}-${idx}`);
                                                              });
                                                            }
                                                            return allIds.every(id => postAdSelectedLocations.has(id));
                                                          })()}
                                                          onChange={() => {
                                                            const allIds = [ward.id];
                                                            if (ward.local_addresses) {
                                                              ward.local_addresses.forEach((_, idx) => {
                                                                allIds.push(`${ward.id}-${idx}`);
                                                              });
                                                            }
                                                            const allSelected = allIds.every(id => postAdSelectedLocations.has(id));
                                                            setPostAdSelectedLocations(prev => {
                                                              const newSet = new Set(prev);
                                                              allIds.forEach(id => {
                                                                if (allSelected) {
                                                                  newSet.delete(id);
                                                                } else {
                                                                  newSet.add(id);
                                                                }
                                                              });
                                                              return newSet;
                                                            });
                                                          }}
                                                        />
                                                        <span className="text-sm text-[hsl(var(--foreground))]">
                                                          Ward {ward.ward_number}
                                                        </span>
                                                      </div>
                                                      
                                                      {/* Local Addresses */}
                                                      {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                        <div className="ml-6 mt-1 space-y-1">
                                                          {ward.local_addresses.map((address, idx) => {
                                                            const addressId = `${ward.id}-${idx}`;
                                                            return (
                                                              <div key={addressId} className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                                <input
                                                                  type="checkbox"
                                                                  className="mr-2"
                                                                  checked={postAdSelectedLocations.has(addressId.toString())}
                                                                  onChange={() => handlePostAdLocationToggle(addressId)}
                                                                />
                                                                <span className="text-xs text-[hsl(var(--muted-foreground))]">{address}</span>
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                      )}
                                                    </div>
                                                  ))}
                                                </div>
                                              ))}
                                            </div>
                                          ))}
                                        </div>
                                        ))
                                      ) : (
                                        <div className="p-4 text-center text-sm text-[hsl(var(--muted-foreground))]">
                                          No locations available. Please add locations first.
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* Image Upload Section - 4 images */}
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-2">Images (Up to 4 images) *</label>
                            <div className="grid grid-cols-2 gap-4">
                              {[0, 1, 2, 3].map((index) => (
                                <div key={index} className="space-y-2">
                                  <label className="block text-xs text-[hsl(var(--muted-foreground))]">
                                    Image {index + 1} {index === 0 && '(Primary)'}
                                  </label>
                                  {postAdImages[index] ? (
                                    <div className="relative">
                                      <img
                                        src={URL.createObjectURL(postAdImages[index])}
                                        alt={`Preview ${index + 1}`}
                                        className="w-full h-32 object-cover rounded-md border border-[hsl(var(--border))]"
                                      />
                                      <button
                                        type="button"
                                        onClick={() => handleImageRemove(index)}
                                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                      >
                                        
                                      </button>
                                    </div>
                                  ) : (
                                    <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-[hsl(var(--border))] rounded-md cursor-pointer hover:bg-[hsl(var(--accent))] transition-colors">
                                      <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg className="w-8 h-8 mb-2 text-[hsl(var(--muted-foreground))]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                        <p className="mb-2 text-xs text-[hsl(var(--muted-foreground))]">Click to upload</p>
                                      </div>
                                      <input
                                        type="file"
                                        accept="image/*"
                                        className="hidden"
                                        onChange={(e) => {
                                          const file = e.target.files[0];
                                          if (file) handleImageChange(index, file, 'ad');
                                        }}
                                      />
                                    </label>
                                  )}
                                </div>
                              ))}
                            </div>
                            <p className="mt-2 text-xs text-[hsl(var(--muted-foreground))]">
                              At least one image is required. Supported formats: JPEG, PNG, JPG, GIF (Max 2MB per image)
                            </p>
                          </div>
                          
                          <div className="flex justify-end gap-2 mt-6">
                            <Button
                              type="button"
                              variant="ghost"
                              onClick={() => {
                                setShowPostAdForm(false);
                                setPostAdFormData({
                                  title: '',
                                  description: '',
                                  price: '',
                                  category_id: '',
                                  user_id: '',
                                });
                                setPostAdImages([null, null, null, null]); // Reset images
                                setPostAdSelectedCategoryName('');
                                setPostAdSelectedSubcategoryId('');
                                setPostAdSelectedLocations(new Set());
                              }}
                            >
                              Cancel
                            </Button>
                            <Button type="submit">Create Ad</Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  </section>
                )}
              </div>

              {/* Ad Management Table */}
              <section>
                <Card>
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between mb-4">
                      <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">Ad Management</h2>
                      <div className="flex items-center gap-2">
                        
                        <select
                          value={adSort}
                          onChange={(e) => setAdSort(e.target.value)}
                          className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                        >
                          <option value="">Ad sort</option>
                          <option value="price">Price</option>
                          <option value="date">Posted date</option>
                          <option value="alphabetical">Alphabetical</option>
                        </select>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Title</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Location</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">View</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Data</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredAndSortedAds.map((ad, index) => (
                            <tr key={ad.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))]/30 transition-colors">
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm max-w-[200px]">
                                <span className="font-medium text-[hsl(var(--foreground))] line-clamp-2" title={ad.title}>
                                  {ad.title && ad.title.length > 60 ? `${ad.title.substring(0, 60)}...` : ad.title}
                                </span>
                              </td>
                              <td className="p-3 text-sm">
                                  <span className="text-[hsl(var(--foreground))]">{ad.category}</span>
                              </td>
                              <td className="p-3 text-sm max-w-[180px]">
                                <span className="text-[hsl(var(--muted-foreground))] text-xs truncate block" title={ad.location || '-'}>
                                  {ad.location && ad.location.length > 40 ? `${ad.location.substring(0, 40)}...` : (ad.location || '-')}
                                                          </span>
                              </td>
                              <td className="p-3 text-sm max-w-[200px]">
                                <span className="text-[hsl(var(--muted-foreground))] text-xs truncate block" title={ad.description}>
                                  {ad.description && ad.description.length > 50 ? `${ad.description.substring(0, 50)}...` : ad.description}
                                                              </span>
                              </td>
                              <td className="p-3 text-sm">
                                  <span className="font-semibold">Rs. {ad.price.toLocaleString()}</span>
                              </td>
                              <td className="p-3 text-sm">
                                <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                  ad.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                                  ad.status === 'sold' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                  ad.status === 'draft' ? 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200' :
                                  ad.status === 'expired' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                }`}>
                                  {ad.status ? ad.status.charAt(0).toUpperCase() + ad.status.slice(1) : 'Active'}
                                </span>
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.views}</td>
                              <td className="p-3 text-sm text-[hsl(var(--muted-foreground))]">{new Date(ad.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditAd(ad)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteAd(ad.id)}
                                      >
                                        Delete
                                      </Button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>
            </>
          )}

          {/* Admin Posted Ads Subsection */}
          {activeSection === 'ads-management' && activeSubsection === 'admin-posted-ads' && (
            <section>
              <Card>
                <CardContent className="p-4">
                  <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Admin Posted ads</h2>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Ad title</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Posted date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Total view</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item sold</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {adsLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              Loading ads...
                            </td>
                          </tr>
                        ) : ads.filter(ad => ad.postedBy === 'admin').length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              No admin posted ads found.
                            </td>
                          </tr>
                        ) : (
                          ads
                            .filter(ad => ad.postedBy === 'admin')
                            .map((ad, index) => (
                              <tr key={ad.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))]/30 transition-colors">
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                                <td className="p-3 text-sm">
                                    <span className="font-medium">{ad.title}</span>
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.category}</td>
                                <td className="p-3 text-sm max-w-xs">
                                    <span className="text-[hsl(var(--muted-foreground))] truncate block" title={ad.location || '-'}>
                                      {ad.location && ad.location.length > 40 ? `${ad.location.substring(0, 40)}...` : (ad.location || 'N/A')}
                                    </span>
                                </td>
                                <td className="p-3 text-sm max-w-xs">
                                    <span className="text-[hsl(var(--muted-foreground))] truncate block">{ad.description}</span>
                                </td>
                                <td className="p-3 text-sm">
                                    <span className="text-[hsl(var(--foreground))]">Rs. {ad.price.toLocaleString()}</span>
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                  {ad.date ? new Date(ad.date).toLocaleDateString() : 'N/A'}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.views || 0}</td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">No</td>
                                <td className="p-3 text-sm">
                                    <div className="flex gap-2">
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditAd(ad)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteAd(ad.id)}
                                      >
                                        Delete
                                      </Button>
                                    </div>
                                </td>
                              </tr>
                            ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {/* User Posted Ads Subsection */}
          {activeSection === 'ads-management' && activeSubsection === 'user-posted-ads' && (
            <section>
              <Card>
                <CardContent className="p-4">
                  <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">User Posted ads</h2>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Ad title</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Posted date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Total view</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item sold</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {adsLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              Loading ads...
                            </td>
                          </tr>
                        ) : ads.filter(ad => ad.postedBy === 'user').length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              No user posted ads found.
                            </td>
                          </tr>
                        ) : (
                          ads
                            .filter(ad => ad.postedBy === 'user')
                            .map((ad, index) => (
                              <tr key={ad.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingAdId === ad.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                                <td className="p-3 text-sm">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      value={editingAdData.title}
                                      onChange={(e) => setEditingAdData({...editingAdData, title: e.target.value})}
                                      className="w-full text-sm"
                                    />
                                  ) : (
                                    <span className="font-medium">{ad.title}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.category}</td>
                                <td className="p-3 text-sm max-w-xs">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      value={editingAdData.description}
                                      onChange={(e) => setEditingAdData({...editingAdData, description: e.target.value})}
                                      className="w-full text-sm"
                                    />
                                  ) : (
                                    <span className="text-[hsl(var(--muted-foreground))] truncate block">{ad.description}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      type="number"
                                      value={editingAdData.price}
                                      onChange={(e) => setEditingAdData({...editingAdData, price: e.target.value})}
                                      className="w-full text-sm"
                                      step="0.01"
                                    />
                                  ) : (
                                    <span className="text-[hsl(var(--foreground))]">Rs. {ad.price.toLocaleString()}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                  {ad.date ? new Date(ad.date).toLocaleDateString() : 'N/A'}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.views || 0}</td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">No</td>
                                <td className="p-3 text-sm">
                                    <div className="flex gap-2">
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditAd(ad)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteAd(ad.id)}
                                      >
                                        Delete
                                      </Button>
                                    </div>
                                </td>
                              </tr>
                            ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {/* Vendor Posted Ads Subsection */}
          {activeSection === 'ads-management' && activeSubsection === 'vendor-posted-ads' && (
            <section>
              <Card>
                <CardContent className="p-4">
                  <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Vendor Posted ads</h2>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Ad title</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Posted date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Total view</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item sold</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {adsLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              Loading ads...
                            </td>
                          </tr>
                        ) : ads.filter(ad => ad.postedBy === 'vendor').length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">
                              No vendor posted ads found.
                            </td>
                          </tr>
                        ) : (
                          ads
                            .filter(ad => ad.postedBy === 'vendor')
                            .map((ad, index) => (
                              <tr key={ad.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingAdId === ad.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                                <td className="p-3 text-sm">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      value={editingAdData.title}
                                      onChange={(e) => setEditingAdData({...editingAdData, title: e.target.value})}
                                      className="w-full text-sm"
                                    />
                                  ) : (
                                    <span className="font-medium">{ad.title}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.category}</td>
                                <td className="p-3 text-sm max-w-xs">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      value={editingAdData.description}
                                      onChange={(e) => setEditingAdData({...editingAdData, description: e.target.value})}
                                      className="w-full text-sm"
                                    />
                                  ) : (
                                    <span className="text-[hsl(var(--muted-foreground))] truncate block">{ad.description}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm">
                                  {editingAdId === ad.id ? (
                                    <Input
                                      type="number"
                                      value={editingAdData.price}
                                      onChange={(e) => setEditingAdData({...editingAdData, price: e.target.value})}
                                      className="w-full text-sm"
                                      step="0.01"
                                    />
                                  ) : (
                                    <span className="text-[hsl(var(--foreground))]">Rs. {ad.price.toLocaleString()}</span>
                                  )}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                  {ad.date ? new Date(ad.date).toLocaleDateString() : 'N/A'}
                                </td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">{ad.views || 0}</td>
                                <td className="p-3 text-sm text-[hsl(var(--foreground))]">No</td>
                                <td className="p-3 text-sm">
                                  {editingAdId === ad.id ? (
                                    <div className="flex gap-2">
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveAd(ad.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditAd}
                                      >
                                        Cancel
                                      </Button>
                                    </div>
                                  ) : (
                                    <div className="flex gap-2">
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditAd(ad)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteAd(ad.id)}
                                      >
                                        Delete
                                      </Button>
                                    </div>
                                  )}
                                </td>
                              </tr>
                            ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {/* Edit Ad Modal */}
          {showEditAdModal && editingAdData && editingAdId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-3xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit Ad</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditAd}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveAd(editingAdId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-ad-title">Title *</Label>
                      <Input
                        id="edit-ad-title"
                        value={editingAdData.title}
                        onChange={(e) => setEditingAdData({...editingAdData, title: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-ad-description">Description *</Label>
                      <textarea
                        id="edit-ad-description"
                        value={editingAdData.description}
                        onChange={(e) => setEditingAdData({...editingAdData, description: e.target.value})}
                        required
                        rows={4}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] mt-1"
                      />
                  </div>
                          <div>
                      <Label htmlFor="edit-ad-price">Price *</Label>
                      <Input
                        id="edit-ad-price"
                        type="number"
                        step="0.01"
                        value={editingAdData.price}
                        onChange={(e) => setEditingAdData({...editingAdData, price: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-ad-status">Status *</Label>
                      <select
                        id="edit-ad-status"
                        value={editingAdData.status || 'active'}
                        onChange={(e) => setEditingAdData({...editingAdData, status: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] mt-1"
                        required
                      >
                        <option value="draft">Draft</option>
                        <option value="active">Active</option>
                        <option value="sold">Sold</option>
                        <option value="expired">Expired</option>
                        <option value="removed">Removed</option>
                      </select>
                    </div>
                    <div>
                      <Label>Category *</Label>
                      <div className="relative mt-1" ref={editingAdCategoryDropdownRef}>
                              <button
                                type="button"
                          onClick={() => setEditingAdShowCategoryDropdown(!editingAdShowCategoryDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                              >
                          <span>{buildEditingAdCategoryString() || 'Select Category'}</span>
                          <span>{editingAdShowCategoryDropdown ? '' : ''}</span>
                              </button>
                        {editingAdShowCategoryDropdown && (
                                  <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                    <div className="p-3">
                                      <div className="space-y-1">
                                        {categories.map((category) => {
                                          const subcategories = category.subcategories || [];
                                          const hasSubcategories = subcategories.length > 0;
                                          // Use category name as key for expansion (matching Post Ad dropdown behavior)
                                          const categoryName = (category.name || '').trim();
                                          const isCategoryExpanded = categoryName ? editingAdExpandedCategories.has(categoryName) : false;
                                          
                                          // Check if this category is selected
                                          const isCategorySelected = editingAdSelectedCategoryName === categoryName && !editingAdSelectedSubcategoryId && !editingAdSelectedItemCategoryId;
                                          
                                          return (
                                            <div key={category.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasSubcategories ? (
                                                    <div className="flex items-center space-x-2 flex-1">
                                      <button
                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          toggleEditingAdCategory(categoryName);
                                                        }}
                                                        className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                      >
                                                        {isCategoryExpanded ? '' : ''}
                                      </button>
                                        <button
                                          type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          handleEditingAdCategorySelect(category.id, categoryName);
                                                        }}
                                                        className={`flex-1 text-left text-sm ${
                                                          isCategorySelected
                                                            ? 'text-[hsl(var(--primary))] font-medium'
                                                            : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                          }`}
                                        >
                                                        {category.name}
                                        </button>
                                    </div>
                                                  ) : (
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleEditingAdCategorySelect(category.id, categoryName);
                                                      }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                      }`}
                                                    >
                                                      {category.name}
                                                    </button>
                                                  )}
                                  </div>
                                              </div>
                                              
                                              {/* Show subcategories when expanded */}
                                              {hasSubcategories && isCategoryExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {subcategories.map((subcategory) => {
                                                    const itemCategories = subcategory.item_categories || [];
                                                    const hasItemCategories = itemCategories.length > 0;
                                                    const subcategoryName = (subcategory.name || '').trim();
                                                    const isSubcategoryExpanded = subcategoryName ? editingAdExpandedSubcategories.has(subcategoryName) : false;
                                                    
                                                    // Check if this subcategory is selected
                                                    const subcategoryIdStr = subcategory.id.toString();
                                                    const isSubcategorySelected = editingAdSelectedSubcategoryId === subcategoryIdStr && !editingAdSelectedItemCategoryId;
                                                    
                                                    return (
                                                      <div key={subcategory.id} className="space-y-1">
                                                        <div className="flex items-center justify-between">
                                                          <div className="flex items-center space-x-2 flex-1">
                                                            {hasItemCategories ? (
                                                              <div className="flex items-center space-x-2 flex-1">
                                        <button
                                          type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    toggleEditingAdSubcategory(subcategoryName);
                                          }}
                                                                  className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                        >
                                                                  {isSubcategoryExpanded ? '' : ''}
                                        </button>
                                          <button
                                            type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleEditingAdSubcategorySelect(subcategory.id, subcategoryName);
                                                                  }}
                                                                  className={`flex-1 text-left text-sm ${
                                                                    isSubcategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                            }`}
                                          >
                                            {subcategory.name}
                                          </button>
                                      </div>
                                                            ) : (
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handleEditingAdSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                }`}
                                                              >
                                                                {subcategory.name}
                                                              </button>
                                                            )}
                                                          </div>
                                                        </div>
                                                        
                                                        {/* Show item categories when subcategory is expanded */}
                                                        {hasItemCategories && isSubcategoryExpanded && (
                                                          <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                            {itemCategories.map((itemCategory) => {
                                                              const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                              const itemCategoryIdStr = itemCategory.id.toString();
                                                              const isItemCategorySelected = editingAdSelectedItemCategoryId === itemCategoryIdStr;
                                                              
                                                              return (
                                                                <div key={itemCategory.id} className="flex items-center justify-between">
                                                                  <button
                                                                    type="button"
                                                                    onClick={(e) => {
                                                                      e.stopPropagation();
                                                                      handleEditingAdItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                    }}
                                                                    className={`flex-1 text-left text-xs ${
                                                                      isItemCategorySelected
                                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                                        : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                    }`}
                                                                  >
                                                                    {itemCategoryName}
                                                                  </button>
                                                                </div>
                                                              );
                                                            })}
                                    </div>
                                  )}
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                      <Label>Location *</Label>
                      <div className="relative mt-1" ref={editingAdLocationDropdownRef}>
                        <button
                          type="button"
                          onClick={() => setEditingAdShowLocationDropdown(!editingAdShowLocationDropdown)}
                          className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                        >
                          <span>{buildEditingAdLocationString()}</span>
                          <span>{editingAdShowLocationDropdown ? '' : ''}</span>
                        </button>
                        {editingAdShowLocationDropdown && locationData?.provinces && (
                          <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[500px] max-h-[400px] overflow-y-auto">
                            <div className="p-3">
                              <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                <span className="font-semibold text-xs text-[hsl(var(--foreground))]">Select Location</span>
                                <button
                                  type="button"
                                  onClick={handleEditingAdSelectAllLocations}
                                  className="text-xs text-[hsl(var(--primary))] hover:underline"
                                >
                                  {editingAdSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                </button>
                              </div>
                              {locationData.provinces.map((province) => (
                                <div key={province.id} className="mb-2">
                                  <div className="flex items-center py-1">
                                    <input
                                      type="checkbox"
                                      className="mr-2"
                                      checked={(() => {
                                        const allLocationIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                allLocationIds.push(w.id.toString());
                                                if (w.local_addresses) {
                                                  w.local_addresses.forEach((_, idx) => {
                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                  });
                                                }
                                              });
                                            }
                                          });
                                        });
                                        return allLocationIds.length > 0 && allLocationIds.every(id => editingAdSelectedLocations.has(id));
                                      })()}
                                      onChange={() => {
                                        const allLocationIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                allLocationIds.push(w.id.toString());
                                                if (w.local_addresses) {
                                                  w.local_addresses.forEach((_, idx) => {
                                                    allLocationIds.push(`${w.id}-${idx}`);
                                                  });
                                                }
                                              });
                                            }
                                          });
                                        });
                                        setEditingAdSelectedLocations(prev => {
                                          const newSet = new Set(prev);
                                          const allSelected = allLocationIds.every(id => newSet.has(id));
                                          allLocationIds.forEach(id => {
                                            if (allSelected) {
                                              newSet.delete(id);
                                            } else {
                                              newSet.add(id);
                                            }
                                          });
                                          return newSet;
                                        });
                                      }}
                                    />
                                    <button
                                      type="button"
                                      onClick={() => toggleEditingAdProvince(province.id)}
                                      className="mr-2 text-xs"
                                    >
                                      {editingAdExpandedProvinces.has(province.id) ? '' : ''}
                                    </button>
                                    <span className="text-xs font-medium">{province.name}</span>
                                  </div>
                                  {editingAdExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                    <div key={district.id} className="ml-4 mt-1">
                                      <div className="flex items-center py-1">
                                        <input
                                          type="checkbox"
                                          className="mr-2"
                                          checked={(() => {
                                            const allLocationIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  allLocationIds.push(w.id.toString());
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                              }
                                            });
                                            return allLocationIds.length > 0 && allLocationIds.every(id => editingAdSelectedLocations.has(id));
                                          })()}
                                          onChange={() => {
                                            const allLocationIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  allLocationIds.push(w.id.toString());
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                              }
                                            });
                                            setEditingAdSelectedLocations(prev => {
                                              const newSet = new Set(prev);
                                              const allSelected = allLocationIds.every(id => newSet.has(id));
                                              allLocationIds.forEach(id => {
                                                if (allSelected) {
                                                  newSet.delete(id);
                                                } else {
                                                  newSet.add(id);
                                                }
                                              });
                                              return newSet;
                                            });
                                          }}
                                        />
                                        <button
                                          type="button"
                                          onClick={() => toggleEditingAdDistrict(`${province.id}-${district.id}`)}
                                          className="mr-2 text-xs"
                                        >
                                          {editingAdExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                        </button>
                                        <span className="text-xs">{district.name}</span>
                                      </div>
                                      {editingAdExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                        <div key={localLevel.id} className="ml-4 mt-1">
                                          <div className="flex items-center py-1">
                                            <input
                                              type="checkbox"
                                              className="mr-2"
                                              checked={(() => {
                                                if (!localLevel.wards) return false;
                                                const allLocationIds = [];
                                                localLevel.wards.forEach(w => {
                                                  allLocationIds.push(w.id.toString());
                                                  if (w.local_addresses) {
                                                    w.local_addresses.forEach((_, idx) => {
                                                      allLocationIds.push(`${w.id}-${idx}`);
                                                    });
                                                  }
                                                });
                                                return allLocationIds.length > 0 && allLocationIds.every(id => editingAdSelectedLocations.has(id));
                                              })()}
                                              onChange={() => {
                                                if (localLevel.wards) {
                                                  const allLocationIds = [];
                                                  localLevel.wards.forEach(w => {
                                                    allLocationIds.push(w.id.toString());
                                                    if (w.local_addresses) {
                                                      w.local_addresses.forEach((_, idx) => {
                                                        allLocationIds.push(`${w.id}-${idx}`);
                                                      });
                                                    }
                                                  });
                                                  setEditingAdSelectedLocations(prev => {
                                                    const newSet = new Set(prev);
                                                    const allSelected = allLocationIds.every(id => newSet.has(id));
                                                    allLocationIds.forEach(id => {
                                                      if (allSelected) {
                                                        newSet.delete(id);
                                                      } else {
                                                        newSet.add(id);
                                                      }
                                                    });
                                                    return newSet;
                                                  });
                                                }
                                              }}
                                            />
                                            <button
                                              type="button"
                                              onClick={() => toggleEditingAdLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                              className="mr-2 text-xs"
                                            >
                                              {editingAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                            </button>
                                            <span className="text-xs">{localLevel.name}</span>
                                          </div>
                                          {editingAdExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                            <div key={ward.id} className="ml-4 mt-1">
                                              <div className="flex items-center py-1">
                                                <input
                                                  type="checkbox"
                                                  className="mr-2"
                                                  checked={(() => {
                                                    const allIds = [ward.id.toString()];
                                                    if (ward.local_addresses) {
                                                      ward.local_addresses.forEach((_, idx) => {
                                                        allIds.push(`${ward.id}-${idx}`);
                                                      });
                                                    }
                                                    return allIds.every(id => editingAdSelectedLocations.has(id));
                                                  })()}
                                                  onChange={() => {
                                                    const allIds = [ward.id.toString()];
                                                    if (ward.local_addresses) {
                                                      ward.local_addresses.forEach((_, idx) => {
                                                        allIds.push(`${ward.id}-${idx}`);
                                                      });
                                                    }
                                                    const allSelected = allIds.every(id => editingAdSelectedLocations.has(id));
                                                    setEditingAdSelectedLocations(prev => {
                                                      const newSet = new Set(prev);
                                                      allIds.forEach(id => {
                                                        if (allSelected) {
                                                          newSet.delete(id);
                                                        } else {
                                                          newSet.add(id);
                                                        }
                                                      });
                                                      return newSet;
                                                    });
                                                  }}
                                                />
                                                <span className="text-xs">Ward {ward.ward_number}</span>
                                              </div>
                                              {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                <div className="ml-4 mt-1 space-y-1">
                                                  {ward.local_addresses.map((address, idx) => {
                                                    const addressId = `${ward.id}-${idx}`;
                                                    return (
                                                      <div key={addressId} className="flex items-center py-1">
                                                        <input
                                                          type="checkbox"
                                                          className="mr-2"
                                                          checked={editingAdSelectedLocations.has(addressId)}
                                                          onChange={() => handleEditingAdLocationToggle(addressId)}
                                                        />
                                                        <span className="text-xs">{address}</span>
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      ))}
                                    </div>
                                  ))}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditAd}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {activeSection === 'job-management' && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Job Categories</h3>
                      <p className="text-sm text-[hsl(var(--muted-foreground))]">Manage available job categories.</p>
                    </div>
                    <Button onClick={() => setShowAddJobCategoryForm(!showAddJobCategoryForm)}>
                      {showAddJobCategoryForm ? 'Close Job Category Form' : 'Add Job Category'}
                    </Button>
                  </div>

                  {showAddJobCategoryForm && (
                    <div className="border border-[hsl(var(--border))] rounded-md p-4 bg-[hsl(var(--secondary))]/20">
                      <form onSubmit={handleAddJobCategorySubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Category *</label>
                            <Input
                              type="text"
                              value={jobCategoryFormData.job_category_name}
                              onChange={(e) => setJobCategoryFormData({ ...jobCategoryFormData, job_category_name: e.target.value })}
                              placeholder="Enter job category name"
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Status *</label>
                            <select
                              value={jobCategoryFormData.job_status}
                              onChange={(e) => setJobCategoryFormData({ ...jobCategoryFormData, job_status: e.target.value })}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            >
                              <option value="draft">Draft</option>
                              <option value="active">Active</option>
                              <option value="closed">Closed</option>
                            </select>
                          </div>
                        </div>
                        <div className="flex justify-end gap-2">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={() => {
                              setShowAddJobCategoryForm(false);
                              setJobCategoryFormData({
                                job_category_name: '',
                                posted_job: 0,
                                job_status: 'draft',
                              });
                            }}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">Save</Button>
                        </div>
                      </form>
                    </div>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Job Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Posted Jobs</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {jobCategoriesLoading ? (
                          <tr>
                            <td colSpan="5" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading job categories...</td>
                          </tr>
                        ) : jobCategories.length === 0 ? (
                          <tr>
                            <td colSpan="5" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No job categories found.</td>
                          </tr>
                        ) : (
                          jobCategories.map((category, index) => (
                            <tr key={category.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingJobCategoryId === category.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingJobCategoryId === category.id ? (
                                  <Input
                                    type="text"
                                    value={editingJobCategoryData.job_category_name || ''}
                                    onChange={(e) => setEditingJobCategoryData({ ...editingJobCategoryData, job_category_name: e.target.value })}
                                    placeholder="Enter job category name"
                                    className="w-full text-xs"
                                  />
                                ) : (
                                  <span className="font-medium">{category.job_category_name || '-'}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                {category.posted_job || 0}
                              </td>
                              <td className="p-3 text-sm">
                                {editingJobCategoryId === category.id ? (
                                  <select
                                    value={editingJobCategoryData.job_status}
                                    onChange={(e) => setEditingJobCategoryData({ ...editingJobCategoryData, job_status: e.target.value })}
                                    className="w-full px-2 py-1 text-xs border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                                  >
                                    <option value="draft">Draft</option>
                                    <option value="active">Active</option>
                                    <option value="closed">Closed</option>
                                  </select>
                                ) : (
                                  <span className="capitalize">{category.job_status}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingJobCategoryId === category.id ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveJobCategory(category.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditJobCategory}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditJobCategory(category)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteJobCategory(category.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="p-4 space-y-6">
                  <div className="flex flex-col gap-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Job Applicants</h3>
                        <p className="text-sm text-[hsl(var(--muted-foreground))]">Post new openings or apply on behalf of candidates.</p>
                      </div>
                      <div className="flex gap-2 flex-wrap">
                        <Button variant="outline" onClick={() => setShowPostJobApplicantForm(!showPostJobApplicantForm)}>
                          {showPostJobApplicantForm ? 'Close Post Job Form' : 'Post Job'}
                        </Button>
                        <Button onClick={() => setShowApplyJobForm(!showApplyJobForm)}>
                          {showApplyJobForm ? 'Close Apply Form' : 'Apply Job'}
                        </Button>
                      </div>
                    </div>

                    {showPostJobApplicantForm && (
                      <div className="border border-[hsl(var(--border))] rounded-md p-4 bg-[hsl(var(--secondary))]/20">
                        <h4 className="text-sm font-semibold mb-3 text-[hsl(var(--foreground))]">Post New Job</h4>
                        <form onSubmit={handlePostJobApplicantSubmit} className="space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Category *</label>
                              <select
                                value={jobApplicantFormData.job_category_id}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, job_category_id: e.target.value })}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                required
                              >
                                <option value="">Select Job Category</option>
                                {jobCategories
                                  .filter(cat => cat.job_status === 'active')
                                  .map(category => (
                                    <option key={category.id} value={category.id}>
                                      {category.job_category_name}
                                    </option>
                                  ))}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Title *</label>
                              <Input
                                value={jobApplicantFormData.job_title}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, job_title: e.target.value })}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Applicant Name *</label>
                              <Input
                                value={jobApplicantFormData.applicant_name}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, applicant_name: e.target.value })}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Posted Date</label>
                              <Input
                                type="date"
                                value={jobApplicantFormData.posted_date}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, posted_date: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Expected Salary</label>
                              <Input
                                type="number"
                                min="0"
                                step="0.01"
                                value={jobApplicantFormData.expected_salary}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, expected_salary: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Interview Date</label>
                              <Input
                                type="date"
                                value={jobApplicantFormData.interview_date}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, interview_date: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Progress *</label>
                              <select
                                value={jobApplicantFormData.job_progress}
                                onChange={(e) => setJobApplicantFormData({ ...jobApplicantFormData, job_progress: e.target.value })}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                required
                              >
                                <option value="applied">Applied</option>
                                <option value="screening">Screening</option>
                                <option value="interview">Interview</option>
                                <option value="offer">Offer</option>
                                <option value="hired">Hired</option>
                                <option value="rejected">Rejected</option>
                              </select>
                            </div>
                          </div>
                          <div className="space-y-4">
                            <h5 className="text-sm font-semibold text-[hsl(var(--foreground))]">Documents (Optional)</h5>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">CV/Resume</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setJobApplicantFiles({ ...jobApplicantFiles, cv_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {jobApplicantFiles.cv_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{jobApplicantFiles.cv_file.name}</p>
                                )}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Cover Letter</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setJobApplicantFiles({ ...jobApplicantFiles, cover_letter_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {jobApplicantFiles.cover_letter_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{jobApplicantFiles.cover_letter_file.name}</p>
                                )}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Reference Letter</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setJobApplicantFiles({ ...jobApplicantFiles, reference_letter_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {jobApplicantFiles.reference_letter_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{jobApplicantFiles.reference_letter_file.name}</p>
                                )}
                              </div>
                            </div>
                            <p className="text-xs text-[hsl(var(--muted-foreground))]">Accepted formats: PDF, DOC, DOCX (Max 10MB each)</p>
                          </div>
                          <div className="flex justify-end gap-2">
                            <Button
                              type="button"
                              variant="ghost"
                              onClick={() => {
                                setShowPostJobApplicantForm(false);
                                setJobApplicantFormData({
                                  job_title: '',
                                  posted_date: '',
                                  expected_salary: '',
                                  applicant_name: '',
                                  interview_date: '',
                                  job_progress: 'applied',
                                });
                                setJobApplicantFiles({
                                  cv_file: null,
                                  cover_letter_file: null,
                                  reference_letter_file: null,
                                });
                              }}
                            >
                              Cancel
                            </Button>
                            <Button type="submit">Submit</Button>
                          </div>
                        </form>
                      </div>
                    )}

                    {showApplyJobForm && (
                      <div className="border border-[hsl(var(--border))] rounded-md p-4 bg-[hsl(var(--secondary))]/20">
                        <h4 className="text-sm font-semibold mb-3 text-[hsl(var(--foreground))]">Apply for Job (Admin)</h4>
                        <form onSubmit={handleApplyJobSubmit} className="space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Title *</label>
                              <Input
                                value={applyJobFormData.job_title}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, job_title: e.target.value })}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Applicant Name *</label>
                              <Input
                                value={applyJobFormData.applicant_name}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, applicant_name: e.target.value })}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Expected Salary</label>
                              <Input
                                type="number"
                                min="0"
                                step="0.01"
                                value={applyJobFormData.expected_salary}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, expected_salary: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Application Date</label>
                              <Input
                                type="date"
                                value={applyJobFormData.posted_date}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, posted_date: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Interview Date</label>
                              <Input
                                type="date"
                                value={applyJobFormData.interview_date}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, interview_date: e.target.value })}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Job Progress *</label>
                              <select
                                value={applyJobFormData.job_progress}
                                onChange={(e) => setApplyJobFormData({ ...applyJobFormData, job_progress: e.target.value })}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                required
                              >
                                <option value="applied">Applied</option>
                                <option value="screening">Screening</option>
                                <option value="interview">Interview</option>
                                <option value="offer">Offer</option>
                                <option value="hired">Hired</option>
                                <option value="rejected">Rejected</option>
                              </select>
                            </div>
                          </div>
                          <div className="space-y-4">
                            <h5 className="text-sm font-semibold text-[hsl(var(--foreground))]">Documents (Optional)</h5>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">CV/Resume</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setApplyJobFiles({ ...applyJobFiles, cv_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {applyJobFiles.cv_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{applyJobFiles.cv_file.name}</p>
                                )}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Cover Letter</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setApplyJobFiles({ ...applyJobFiles, cover_letter_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {applyJobFiles.cover_letter_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{applyJobFiles.cover_letter_file.name}</p>
                                )}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Reference Letter</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx"
                                  onChange={(e) => setApplyJobFiles({ ...applyJobFiles, reference_letter_file: e.target.files[0] || null })}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                />
                                {applyJobFiles.reference_letter_file && (
                                  <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">{applyJobFiles.reference_letter_file.name}</p>
                                )}
                              </div>
                            </div>
                            <p className="text-xs text-[hsl(var(--muted-foreground))]">Accepted formats: PDF, DOC, DOCX (Max 10MB each)</p>
                          </div>
                          <div className="flex justify-end gap-2">
                            <Button
                              type="button"
                              variant="ghost"
                              onClick={() => {
                                setShowApplyJobForm(false);
                                setApplyJobFormData({
                                  job_title: '',
                                  applicant_name: '',
                                  expected_salary: '',
                                  posted_date: '',
                                  interview_date: '',
                                  job_progress: 'applied',
                                });
                                setApplyJobFiles({
                                  cv_file: null,
                                  cover_letter_file: null,
                                  reference_letter_file: null,
                                });
                              }}
                            >
                              Cancel
                            </Button>
                            <Button type="submit">Apply</Button>
                          </div>
                        </form>
                      </div>
                    )}
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Job Title</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Applicant</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Posted Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Expected Salary</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Interview Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Progress</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Documents</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {jobApplicantsLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading job applicants...</td>
                          </tr>
                        ) : jobApplicants.length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No job applicants found.</td>
                          </tr>
                        ) : (
                          jobApplicants.map((applicant, index) => (
                            <tr key={applicant.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))]">
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm">
                                  <span className="font-medium">{applicant.job_title}</span>
                              </td>
                              <td className="p-3 text-sm">
                                  <span className="text-[hsl(var(--muted-foreground))]">{applicant.applicant_name}</span>
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                {applicant.posted_date ? new Date(applicant.posted_date).toLocaleDateString() : 'N/A'}
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                {applicant.expected_salary ? `Rs. ${Number(applicant.expected_salary).toLocaleString()}` : '-'}
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                {applicant.interview_date ? new Date(applicant.interview_date).toLocaleDateString() : '-'}
                              </td>
                              <td className="p-3 text-sm">
                                  <span className="capitalize">{applicant.job_progress}</span>
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex flex-col gap-1">
                                  {applicant.cv_file_url && (
                                    <a href={applicant.cv_file_url} target="_blank" rel="noopener noreferrer" className="text-xs text-[hsl(var(--primary))] hover:underline">
                                       CV
                                    </a>
                                  )}
                                  {applicant.cover_letter_file_url && (
                                    <a href={applicant.cover_letter_file_url} target="_blank" rel="noopener noreferrer" className="text-xs text-[hsl(var(--primary))] hover:underline">
                                       Cover Letter
                                    </a>
                                  )}
                                  {applicant.reference_letter_file_url && (
                                    <a href={applicant.reference_letter_file_url} target="_blank" rel="noopener noreferrer" className="text-xs text-[hsl(var(--primary))] hover:underline">
                                       Reference
                                    </a>
                                  )}
                                  {!applicant.cv_file_url && !applicant.cover_letter_file_url && !applicant.reference_letter_file_url && (
                                    <span className="text-xs text-[hsl(var(--muted-foreground))]">No documents</span>
                                  )}
                                </div>
                              </td>
                              <td className="p-3 text-sm">
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditJobApplicant(applicant)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteJobApplicant(applicant.id)}>Delete</Button>
                                  </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'live-chat' && (
            <section className="space-y-4">
              <Card>
                <CardContent className="p-4">
                  <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Live Chat</h2>
                  <div className="flex flex-wrap items-center gap-2 mb-4">
                    <select
                      className="border rounded px-3 py-2 text-sm w-64"
                      value={openChatSelectedUserId}
                      onChange={(e) => setOpenChatSelectedUserId(e.target.value)}
                    >
                      <option value="">Select user</option>
                      {users.slice(0, 200).map((u) => (
                        <option key={u.id} value={u.id}>
                          {u.name || 'Unknown'} {u.email ? `(${u.email})` : ''}
                        </option>
                      ))}
                    </select>
                    <Button variant="default" size="sm" onClick={handleOpenLiveChat} disabled={!openChatSelectedUserId}>
                      Start Chat
                    </Button>
                    {liveChatError && (
                      <span className="text-sm text-red-500">{liveChatError}</span>
                    )}
                  </div>
                  <div className="grid md:grid-cols-2 gap-4 min-h-[620px]">
                    <div className="flex flex-col h-full">
                      <div className="flex items-center justify-between mb-2">
                        <h3 className="text-md font-semibold text-[hsl(var(--foreground))]">Users</h3>
                        <Button variant="ghost" size="sm" onClick={fetchLiveChats}>Refresh</Button>
                      </div>
                      <div className="border border-[hsl(var(--border))] rounded-md h-[560px] overflow-y-auto">
                        <table className="w-full">
                          <thead className="bg-[hsl(var(--secondary))]">
                            <tr>
                              <th className="text-left px-3 py-2 text-sm font-semibold text-[hsl(var(--foreground))]">User</th>
                            </tr>
                          </thead>
                          <tbody>
                            {liveChatsLoading ? (
                              <tr>
                                <td className="px-3 py-4 text-center text-[hsl(var(--muted-foreground))]">Loading chats...</td>
                              </tr>
                            ) : liveChats.length === 0 ? (
                              <tr>
                                <td className="px-3 py-4 text-center text-[hsl(var(--muted-foreground))]">No live chats found.</td>
                              </tr>
                            ) : (
                              liveChats.map((chat) => {
                                const isActive = selectedLiveChat && selectedLiveChat.id === chat.id;
                                return (
                                  <tr
                                    key={chat.id}
                                    data-chat-id={chat.id}
                                    className={`cursor-pointer border-b border-[hsl(var(--border))] ${
                                      isActive ? 'bg-[hsl(var(--accent))] border-l-4 border-l-[hsl(var(--primary))]' : 'hover:bg-[hsl(var(--accent))]/40'
                                    }`}
                                    onClick={() => handleSelectLiveChat(chat)}
                                  >
                                    <td className="px-3 py-3 text-sm text-[hsl(var(--foreground))] flex items-center justify-between">
                                      <div>
                                        <p className="font-semibold">
                                          {chat.is_guest 
                                            ? `${chat.guest_name || 'Guest'} (${chat.guest_email})`
                                            : (chat.user?.name || 'Unknown User')
                                          }
                                        </p>
                                        <p className="text-[hsl(var(--muted-foreground))] text-xs">
                                          {chat.last_message_at ? new Date(chat.last_message_at).toLocaleString() : 'No messages yet'}
                                        </p>
                                      </div>
                                      {chat.unread_admin_count > 0 && (
                                        <span className="inline-flex items-center justify-center px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded-full">
                                          {chat.unread_admin_count}
                                        </span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div className="flex flex-col h-full">
                      <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-2">Chat</h3>
                      <div className="flex-1 border border-[hsl(var(--border))] rounded-md p-4 flex flex-col h-[420px] bg-[hsl(var(--background))]">
                        {selectedLiveChat ? (
                          <>
                            <div className="mb-3">
                              <p className="font-semibold text-[hsl(var(--foreground))]">
                                {selectedLiveChat.is_guest
                                  ? `${selectedLiveChat.guest_name || 'Guest'} (Guest User)`
                                  : (selectedLiveChat.user?.name || 'Unknown User')
                                }
                              </p>
                              <p className="text-sm text-[hsl(var(--muted-foreground))]">
                                {selectedLiveChat.is_guest
                                  ? selectedLiveChat.guest_email
                                  : selectedLiveChat.user?.email
                                }
                              </p>
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                              {chatMessagesLoading ? (
                                <p className="text-center text-[hsl(var(--muted-foreground))]">Loading messages...</p>
                              ) : chatMessages.length === 0 ? (
                                <p className="text-center text-[hsl(var(--muted-foreground))]">No messages yet.</p>
                              ) : (
                                chatMessages.map((message) => (
                                  <div
                                    key={message.id}
                                    className={`flex ${message.sender_type === 'admin' ? 'justify-end' : 'justify-start'}`}
                                  >
                                    <div
                                      className={`max-w-[80%] rounded-lg px-3 py-2 text-sm ${
                                        message.sender_type === 'admin'
                                          ? 'bg-[hsl(var(--primary))] text-white'
                                          : 'bg-[hsl(var(--muted))] text-[hsl(var(--foreground))]'
                                      }`}
                                    >
                                      <p>{message.message}</p>
                                      <span className="block text-[10px] mt-1 opacity-80">
                                        {message.sent_at ? new Date(message.sent_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                                      </span>
                                    </div>
                                  </div>
                                ))
                              )}
                            </div>
                            <form className="mt-3 pt-3 border-t border-[hsl(var(--border))]" onSubmit={handleSendChatMessage}>
                              <div className="flex gap-2">
                                <Input
                                  value={newChatMessage}
                                  onChange={(e) => setNewChatMessage(e.target.value)}
                                  placeholder="Type your message..."
                                />
                                <Button type="submit" disabled={!newChatMessage.trim()}>
                                  Send
                                </Button>
                              </div>
                            </form>
                          </>
                        ) : (
                          <div className="flex-1 flex items-center justify-center text-[hsl(var(--muted-foreground))]">
                            Select a user to view the conversation.
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {/* Edit Job Applicant Modal */}
          {showEditJobApplicantModal && editingJobApplicantData && editingJobApplicantId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit Job Applicant</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditJobApplicant}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveJobApplicant(editingJobApplicantId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-job-category">Job Category *</Label>
                      <select
                        id="edit-job-category"
                        value={editingJobApplicantData.job_category_id || ''}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, job_category_id: e.target.value })}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        <option value="">Select Job Category</option>
                        {jobCategories
                          .filter(cat => cat.job_status === 'active')
                          .map(category => (
                            <option key={category.id} value={category.id}>
                              {category.job_category_name}
                            </option>
                          ))}
                      </select>
                    </div>
                    <div>
                      <Label htmlFor="edit-job-title">Job Title *</Label>
                      <Input
                        id="edit-job-title"
                        value={editingJobApplicantData.job_title}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, job_title: e.target.value })}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-applicant-name">Applicant Name *</Label>
                      <Input
                        id="edit-applicant-name"
                        value={editingJobApplicantData.applicant_name}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, applicant_name: e.target.value })}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-posted-date">Posted Date</Label>
                      <Input
                        id="edit-posted-date"
                        type="date"
                        value={editingJobApplicantData.posted_date || ''}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, posted_date: e.target.value })}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-expected-salary">Expected Salary</Label>
                      <Input
                        id="edit-expected-salary"
                        type="number"
                        min="0"
                        step="0.01"
                        value={editingJobApplicantData.expected_salary ?? ''}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, expected_salary: e.target.value })}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-interview-date">Interview Date</Label>
                      <Input
                        id="edit-interview-date"
                        type="date"
                        value={editingJobApplicantData.interview_date || ''}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, interview_date: e.target.value })}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-job-progress">Job Progress *</Label>
                      <select
                        id="edit-job-progress"
                        value={editingJobApplicantData.job_progress}
                        onChange={(e) => setEditingJobApplicantData({ ...editingJobApplicantData, job_progress: e.target.value })}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        <option value="applied">Applied</option>
                        <option value="screening">Screening</option>
                        <option value="interview">Interview</option>
                        <option value="offer">Offer</option>
                        <option value="hired">Hired</option>
                        <option value="rejected">Rejected</option>
                      </select>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditJobApplicant}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {activeSection === 'offer-discount' && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Offer/Discount Management</h3>
                    </div>
                    <Button 
                      variant="outline" 
                      onClick={() => setShowPostDiscountForm(!showPostDiscountForm)}
                      className="border-black"
                    >
                      Post discount/coupon
                    </Button>
                  </div>

                  {/* Post Discount/Coupon Form */}
                  {showPostDiscountForm && (
                    <div className="border border-[hsl(var(--border))] rounded-md p-4 bg-[hsl(var(--secondary))]/20">
                      <h4 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Post Discount/Coupon</h4>
                      <form onSubmit={handlePostDiscountSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Item Name *</label>
                            <Input
                              value={offerFormData.item_name}
                              onChange={(e) => setOfferFormData({...offerFormData, item_name: e.target.value})}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Vendor *</label>
                            <select
                              value={offerFormData.vendor_id}
                              onChange={(e) => setOfferFormData({...offerFormData, vendor_id: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              required
                            >
                              <option value="">Select Vendor</option>
                              {users.filter(u => u.role === 'user' || u.role === 'vendor').map((user) => (
                                <option key={user.id} value={user.id}>{user.name} ({user.email})</option>
                              ))}
                            </select>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Offer % *</label>
                            <Input
                              type="number"
                              step="0.01"
                              min="0"
                              max="100"
                              value={offerFormData.offer_percentage}
                              onChange={(e) => setOfferFormData({...offerFormData, offer_percentage: e.target.value})}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Created Date *</label>
                            <Input
                              type="date"
                              value={offerFormData.created_date}
                              onChange={(e) => setOfferFormData({...offerFormData, created_date: e.target.value})}
                              className="w-full"
                              required
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Valid Until *</label>
                            <Input
                              type="date"
                              value={offerFormData.valid_until}
                              onChange={(e) => setOfferFormData({...offerFormData, valid_until: e.target.value})}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Status</label>
                            <select
                              value={offerFormData.status}
                              onChange={(e) => setOfferFormData({...offerFormData, status: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                            >
                              <option value="pending">Pending</option>
                              <option value="approved">Approved</option>
                            </select>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <Button type="submit">Submit</Button>
                          <Button type="button" variant="outline" onClick={() => {
                            setShowPostDiscountForm(false);
                            setOfferFormData({
                              item_name: '',
                              vendor_id: '',
                              offer_percentage: '',
                              created_date: '',
                              valid_until: '',
                              status: 'pending',
                            });
                          }}>Cancel</Button>
                        </div>
                      </form>
                    </div>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item Name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Vendor</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Offer %</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Created Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Valid until</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete/Approve</th>
                        </tr>
                      </thead>
                      <tbody>
                        {offersLoading ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading offers...</td>
                          </tr>
                        ) : offers.length === 0 ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No offers found.</td>
                          </tr>
                        ) : (
                          offers.map((offer, index) => (
                            <tr key={offer.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">{offer.item_name}</td>
                              <td className="p-3 text-sm">{offer.vendor?.name || 'N/A'}</td>
                              <td className="p-3 text-sm">{`${offer.offer_percentage}%`}</td>
                              <td className="p-3 text-sm">{offer.created_date ? new Date(offer.created_date).toLocaleDateString() : 'N/A'}</td>
                              <td className="p-3 text-sm">{offer.valid_until ? new Date(offer.valid_until).toLocaleDateString() : 'N/A'}</td>
                              <td className="p-3 text-sm">
                                  <span className={`px-2 py-1 rounded text-xs ${
                                    offer.status === 'approved' 
                                      ? 'bg-green-100 text-green-800' 
                                      : 'bg-yellow-100 text-yellow-800'
                                  }`}>
                                    {offer.status === 'approved' ? 'Approved' : 'Pending'}
                                  </span>
                              </td>
                              <td className="p-3 text-sm">
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditOffer(offer)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteOffer(offer.id)}>Delete</Button>
                                    {offer.status === 'pending' && (
                                      <Button variant="default" size="sm" className="h-7 px-2 text-xs bg-green-600 hover:bg-green-700" onClick={() => handleApproveOffer(offer.id)}>Approve</Button>
                                    )}
                                  </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-4">
                    <a href="#" className="text-sm text-[hsl(var(--primary))] hover:underline">Download report</a>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'rating-review' && (
            <section className="space-y-6">
              {/* Rating Criteria Management */}
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Service Standards (Rating Criteria)</h3>
                      <p className="text-sm text-[hsl(var(--muted-foreground))]">Manage the criteria used for rating products and services</p>
                    </div>
                    <Button onClick={() => setShowAddCriteriaForm(!showAddCriteriaForm)}>
                      {showAddCriteriaForm ? 'Close Form' : 'Add Criteria'}
                    </Button>
                  </div>

                  {showAddCriteriaForm && (
                    <div className="border border-[hsl(var(--border))] rounded-md p-4 bg-[hsl(var(--secondary))]/20">
                      <h4 className="text-sm font-semibold mb-3 text-[hsl(var(--foreground))]">Add New Rating Criteria</h4>
                      <form onSubmit={handleAddCriteriaSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Name *</label>
                            <Input
                              value={criteriaFormData.name}
                              onChange={(e) => setCriteriaFormData({ ...criteriaFormData, name: e.target.value })}
                              placeholder="e.g., Delivery on Time"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Sort Order</label>
                            <Input
                              type="number"
                              min="0"
                              value={criteriaFormData.sort_order}
                              onChange={(e) => setCriteriaFormData({ ...criteriaFormData, sort_order: parseInt(e.target.value) || 0 })}
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Description</label>
                          <Input
                            value={criteriaFormData.description}
                            onChange={(e) => setCriteriaFormData({ ...criteriaFormData, description: e.target.value })}
                            placeholder="Brief description of this criteria"
                          />
                        </div>
                        <div className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            id="criteria_active"
                            checked={criteriaFormData.is_active}
                            onChange={(e) => setCriteriaFormData({ ...criteriaFormData, is_active: e.target.checked })}
                            className="rounded"
                          />
                          <label htmlFor="criteria_active" className="text-sm text-[hsl(var(--foreground))]">Active</label>
                        </div>
                        <div className="flex justify-end gap-2">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={() => {
                              setShowAddCriteriaForm(false);
                              setCriteriaFormData({
                                name: '',
                                description: '',
                                sort_order: 0,
                                is_active: true,
                              });
                            }}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">Add Criteria</Button>
                        </div>
                      </form>
                    </div>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Sort Order</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {ratingCriteriaLoading ? (
                          <tr>
                            <td colSpan="6" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading criteria...</td>
                          </tr>
                        ) : ratingCriteria.length === 0 ? (
                          <tr>
                            <td colSpan="6" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No rating criteria found.</td>
                          </tr>
                        ) : (
                          ratingCriteria.map((criteria, index) => (
                            <tr key={criteria.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingCriteriaId === criteria.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingCriteriaId === criteria.id ? (
                                  <Input
                                    value={editingCriteriaData.name}
                                    onChange={(e) => setEditingCriteriaData({ ...editingCriteriaData, name: e.target.value })}
                                  />
                                ) : (
                                  <span className="font-medium">{criteria.name}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingCriteriaId === criteria.id ? (
                                  <Input
                                    value={editingCriteriaData.description || ''}
                                    onChange={(e) => setEditingCriteriaData({ ...editingCriteriaData, description: e.target.value })}
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{criteria.description || '-'}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingCriteriaId === criteria.id ? (
                                  <Input
                                    type="number"
                                    min="0"
                                    value={editingCriteriaData.sort_order}
                                    onChange={(e) => setEditingCriteriaData({ ...editingCriteriaData, sort_order: parseInt(e.target.value) || 0 })}
                                  />
                                ) : (
                                  criteria.sort_order
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingCriteriaId === criteria.id ? (
                                  <input
                                    type="checkbox"
                                    checked={editingCriteriaData.is_active}
                                    onChange={(e) => setEditingCriteriaData({ ...editingCriteriaData, is_active: e.target.checked })}
                                    className="rounded"
                                  />
                                ) : (
                                  <span className={`capitalize ${criteria.is_active ? 'text-green-600' : 'text-red-600'}`}>
                                    {criteria.is_active ? 'Active' : 'Inactive'}
                                  </span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingCriteriaId === criteria.id ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveCriteria(criteria.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditCriteria}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditCriteria(criteria)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteCriteria(criteria.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>

              {/* Ratings Table */}
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Rating Review Management</h3>
                    </div>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Rating</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Rating as Seller</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Rating as Buyer</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Overall rating</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Criteria Scores</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {ratingsLoading ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading ratings...</td>
                          </tr>
                        ) : ratings.length === 0 ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No ratings found.</td>
                          </tr>
                        ) : (
                          ratings.map((rating, index) => (
                            <tr key={rating.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingRatingId === rating.id ? (
                                  <select
                                    value={editingRatingData.user_id}
                                    onChange={(e) => setEditingRatingData({...editingRatingData, user_id: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                                ) : (
                                  rating.user_name || 'N/A'
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingRatingId === rating.id ? (
                                  <select
                                    value={editingRatingData.rating}
                                    onChange={(e) => setEditingRatingData({...editingRatingData, rating: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    <option value="1">1 Star</option>
                                    <option value="2">2 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="5">5 Stars</option>
                                  </select>
                                ) : (
                                  <div className="flex items-center gap-1">
                                    <span>{rating.rating}</span>
                                    <span className="text-yellow-500"></span>
                                  </div>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingRatingId === rating.id ? (
                                  <select
                                    value={editingRatingData.seller_id}
                                    onChange={(e) => setEditingRatingData({...editingRatingData, seller_id: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                                ) : (
                                  <div className="flex items-center gap-1">
                                    <span>{rating.rating_as_seller}</span>
                                    <span className="text-yellow-500"></span>
                                    <span className="text-xs text-[hsl(var(--muted-foreground))] ml-1">({rating.seller_name})</span>
                                  </div>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex items-center gap-1">
                                  <span>{rating.rating_as_buyer}</span>
                                  <span className="text-yellow-500"></span>
                                </div>
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex items-center gap-1">
                                  <span className="font-semibold">{rating.overall_rating}</span>
                                  <span className="text-yellow-500"></span>
                                </div>
                              </td>
                              <td className="p-3 text-sm">
                                {rating.criteria_scores && rating.criteria_scores.length > 0 ? (
                                  <div className="flex flex-col gap-1">
                                    {rating.criteria_scores.map((score, idx) => (
                                      <div key={idx} className="text-xs">
                                        <span className="text-[hsl(var(--muted-foreground))]">{score.criteria_name}:</span>
                                        <span className="ml-1 font-medium">{score.score}</span>
                                        <span className="text-yellow-500 ml-1"></span>
                                      </div>
                                    ))}
                                  </div>
                                ) : (
                                  <span className="text-xs text-[hsl(var(--muted-foreground))]">No criteria scores</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingRatingId === rating.id ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveRating(rating.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditRating}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditRating(rating)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteRating(rating.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'sales-report' && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Sales report</h3>
                    </div>
                  </div>

                  {/* Earnings Summary */}
                  <div className="space-y-2 mb-4">
                    <div className="text-sm text-[hsl(var(--foreground))]">
                      Vendor wise total earning: Rs {salesReport?.vendor_wise_total_earning?.toLocaleString() || '0.00'}
                    </div>
                    <div className="text-sm text-[hsl(var(--foreground))]">
                      User wise total earning: Rs {salesReport?.user_wise_total_earning?.toLocaleString() || '0.00'}
                    </div>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Vendor/User name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Listed Item</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Sold Item</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Earning</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Email</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Total Earning</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {salesReportLoading ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading sales report...</td>
                          </tr>
                        ) : !salesReport?.sales_report || salesReport.sales_report.length === 0 ? (
                          <tr>
                            <td colSpan="8" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No sales data found.</td>
                          </tr>
                        ) : (
                          salesReport.sales_report.map((item, index) => (
                            <tr key={item.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <select
                                    value={editingSalesReportData.user_id}
                                    onChange={(e) => setEditingSalesReportData({...editingSalesReportData, user_id: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                                ) : (
                                  item.name || 'N/A'
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <Input
                                    type="number"
                                    min="0"
                                    value={editingSalesReportData.listed_items}
                                    onChange={(e) => setEditingSalesReportData({...editingSalesReportData, listed_items: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  item.listed_items || 0
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <Input
                                    type="number"
                                    min="0"
                                    value={editingSalesReportData.sold_items}
                                    onChange={(e) => setEditingSalesReportData({...editingSalesReportData, sold_items: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  item.sold_items || 0
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={editingSalesReportData.earning}
                                    onChange={(e) => setEditingSalesReportData({...editingSalesReportData, earning: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  `Rs ${item.earning?.toLocaleString() || '0.00'}`
                                )}
                              </td>
                              <td className="p-3 text-sm">{item.email || 'N/A'}</td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={editingSalesReportData.total_earning}
                                    onChange={(e) => setEditingSalesReportData({...editingSalesReportData, total_earning: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs {item.total_earning?.toLocaleString() || '0.00'}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSalesReportId === item.id ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveSalesReport(item.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditSalesReport}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditSalesReport(item)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteSalesReport(item.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-4">
                    <a href="#" className="text-sm text-[hsl(var(--primary))] hover:underline">Download report</a>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'stock-management' && (
            <section className="space-y-6">
              {/* Low Stock Alert Banner */}
              {showStockAlert && lowStockAlerts.length > 0 && (
                <Card className="border-orange-500 bg-orange-50 dark:bg-orange-900/20">
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="text-2xl"></div>
                        <div>
                          <h3 className="font-semibold text-orange-800 dark:text-orange-200">Low Stock Alert!</h3>
                          <p className="text-sm text-orange-700 dark:text-orange-300">
                            {lowStockAlerts.length} item{lowStockAlerts.length > 1 ? 's' : ''} {lowStockAlerts.length > 1 ? 'are' : 'is'} running low on stock.
                          </p>
                          <ul className="mt-2 text-sm text-orange-700 dark:text-orange-300">
                            {lowStockAlerts.map((alert) => (
                              <li key={alert.id}>
                                 {alert.item_name} (Vendor: {alert.vendor_seller_name}) - Only {alert.quantity} left (Threshold: {alert.threshold})
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={handleDismissAllAlerts}
                          className="text-orange-800 border-orange-300 hover:bg-orange-100 dark:text-orange-200 dark:border-orange-700 dark:hover:bg-orange-900/40"
                        >
                          Dismiss All
                        </Button>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setShowStockAlert(false)}
                          className="text-orange-800 hover:bg-orange-100 dark:text-orange-200 dark:hover:bg-orange-900/40"
                        >
                          
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              )}

              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Stock Management</h3>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item Name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Vendor/Seller</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category/Subcategory</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Quantity</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Sold Item Qty</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {stockManagementLoading ? (
                          <tr>
                            <td colSpan="7" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading stock management...</td>
                          </tr>
                        ) : stockManagement.length === 0 ? (
                          <tr>
                            <td colSpan="7" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No stock items found.</td>
                          </tr>
                        ) : (
                          stockManagement.map((stock, index) => (
                            <tr 
                              key={stock.id} 
                              className={`border-b border-[hsl(var(--border))] ${
                                stock.is_low_stock ? 'bg-orange-50 dark:bg-orange-900/10' : ''
                              }`}
                            >
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">
                                  <span className={stock.is_low_stock ? 'font-semibold text-orange-600 dark:text-orange-400' : ''}>
                                    {stock.item_name}
                                    {stock.is_low_stock && ' '}
                                  </span>
                              </td>
                              <td className="p-3 text-sm">
                                {stock.vendor_seller_name || 'N/A'}
                              </td>
                              <td className="p-3 text-sm">
                                {`${stock.category_name || 'N/A'}${stock.subcategory_name ? ` / ${stock.subcategory_name}` : ''}`}
                              </td>
                              <td className="p-3 text-sm">
                                  <span className={stock.is_low_stock ? 'font-semibold text-orange-600 dark:text-orange-400' : ''}>
                                    {stock.quantity}
                                  </span>
                              </td>
                              <td className="p-3 text-sm">
                                {stock.sold_item_qty || 0}
                              </td>
                              <td className="p-3 text-sm">
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditStock(stock)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteStock(stock.id)}>Delete</Button>
                                  </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'email-subscriber' && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Subscription Management</h3>
                    <Button variant="outline" onClick={() => setShowAddEmailSubscriberForm(!showAddEmailSubscriberForm)}>
                      {showAddEmailSubscriberForm ? 'Close Form' : 'Add Subscriber'}
                    </Button>
                  </div>

                  {/* Add Subscriber Form */}
                  {showAddEmailSubscriberForm && (
                    <Card className="bg-[hsl(var(--accent))]/50">
                      <CardContent className="p-6">
                        <h4 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Add Subscriber</h4>
                        <form onSubmit={handleAddEmailSubscriberSubmit} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Select User (Optional)</label>
                              <select
                                value={addEmailSubscriberFormData.user_id}
                                onChange={(e) => handleAddEmailSubscriberUserChange(e.target.value)}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              >
                                <option value="">Choose user</option>
                                {users.map((user) => (
                                  <option key={user.id} value={user.id}>{user.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Username *</label>
                              <Input
                                value={addEmailSubscriberFormData.username}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, username: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Email</label>
                              <Input
                                type="email"
                                value={addEmailSubscriberFormData.email}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, email: e.target.value})}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Subscription Type</label>
                              <Input
                                value={addEmailSubscriberFormData.subscription_type}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, subscription_type: e.target.value})}
                                placeholder="e.g., Premium"
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Subscribe Volume *</label>
                              <Input
                                type="number"
                                min="0"
                                value={addEmailSubscriberFormData.subscribe_volume}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, subscribe_volume: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Amount (Rs) *</label>
                              <Input
                                type="number"
                                min="0"
                                step="0.01"
                                value={addEmailSubscriberFormData.amount}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, amount: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Start Date *</label>
                              <Input
                                type="date"
                                value={addEmailSubscriberFormData.start_date}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, start_date: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">End Date</label>
                              <Input
                                type="date"
                                value={addEmailSubscriberFormData.end_date}
                                onChange={(e) => setAddEmailSubscriberFormData({...addEmailSubscriberFormData, end_date: e.target.value})}
                              />
                            </div>
                          </div>
                          <div className="flex justify-end gap-2">
                            <Button type="button" variant="ghost" onClick={() => setShowAddEmailSubscriberForm(false)}>Cancel</Button>
                            <Button type="submit">Save Subscriber</Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Username</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Subscribe volume</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Amount</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">End Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {emailSubscribersLoading ? (
                          <tr>
                            <td colSpan="7" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading subscribers...</td>
                          </tr>
                        ) : emailSubscribers.length === 0 ? (
                          <tr>
                            <td colSpan="7" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No subscribers found.</td>
                          </tr>
                        ) : (
                          emailSubscribers.map((subscriber, index) => (
                            <tr key={subscriber.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <div className="space-y-2">
                                    <select
                                      value={editingEmailSubscriberData.user_id || ''}
                                      onChange={(e) => {
                                        const selectedUser = users.find((user) => user.id.toString() === e.target.value);
                                        setEditingEmailSubscriberData({
                                          ...editingEmailSubscriberData,
                                          user_id: e.target.value,
                                          username: selectedUser ? selectedUser.name : editingEmailSubscriberData.username,
                                          email: selectedUser ? selectedUser.email : editingEmailSubscriberData.email,
                                        });
                                      }}
                                      className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                    >
                                      <option value="">Select User</option>
                                      {users.map((user) => (
                                        <option key={user.id} value={user.id}>{user.name}</option>
                                      ))}
                                    </select>
                                    <Input
                                      value={editingEmailSubscriberData.username}
                                      onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, username: e.target.value})}
                                      placeholder="Username"
                                    />
                                    <Input
                                      type="email"
                                      value={editingEmailSubscriberData.email}
                                      onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, email: e.target.value})}
                                      placeholder="Email"
                                    />
                                  </div>
                                ) : (
                                  <div className="space-y-1">
                                    <div className="font-medium text-[hsl(var(--foreground))]">{subscriber.username || 'N/A'}</div>
                                    <div className="text-xs text-[hsl(var(--muted-foreground))]">{subscriber.email || 'No email'}</div>
                                  </div>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <Input
                                    type="number"
                                    min="0"
                                    value={editingEmailSubscriberData.subscribe_volume}
                                    onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, subscribe_volume: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  subscriber.subscribe_volume || 0
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <Input
                                    type="number"
                                    min="0"
                                    step="0.01"
                                    value={editingEmailSubscriberData.amount}
                                    onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, amount: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  `Rs ${Number(subscriber.amount || 0).toLocaleString()}`
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <Input
                                    type="date"
                                    value={editingEmailSubscriberData.start_date}
                                    onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, start_date: e.target.value})}
                                  />
                                ) : (
                                  formatDate(subscriber.start_date)
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <Input
                                    type="date"
                                    value={editingEmailSubscriberData.end_date}
                                    onChange={(e) => setEditingEmailSubscriberData({...editingEmailSubscriberData, end_date: e.target.value})}
                                  />
                                ) : (
                                  formatDate(subscriber.end_date)
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingEmailSubscriberId === subscriber.id && editingEmailSubscriberData ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveEmailSubscriber(subscriber.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditEmailSubscriber}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditEmailSubscriber(subscriber)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteEmailSubscriber(subscriber.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'support-management' && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Report or support Management</h3>
                    <Button variant="outline" onClick={() => setShowAddSupportForm(!showAddSupportForm)}>
                      {showAddSupportForm ? 'Close Form' : 'Add Error/Issue'}
                    </Button>
                  </div>

                  {/* Add Support Form */}
                  {showAddSupportForm && (
                    <Card className="bg-[hsl(var(--accent))]/50">
                      <CardContent className="p-6">
                        <h4 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Add Error/Issue</h4>
                        <form onSubmit={handleAddSupportSubmit} className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Issue/Error *</label>
                            <Input
                              value={addSupportFormData.issue_error}
                              onChange={(e) => setAddSupportFormData({...addSupportFormData, issue_error: e.target.value})}
                              required
                              placeholder="Enter issue or error description"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Issue Reporter (Optional)</label>
                              <select
                                value={addSupportFormData.issue_reporter_id}
                                onChange={(e) => setAddSupportFormData({...addSupportFormData, issue_reporter_id: e.target.value})}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              >
                                <option value="">Select User</option>
                                {users.map((user) => (
                                  <option key={user.id} value={user.id}>{user.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Date *</label>
                              <Input
                                type="date"
                                value={addSupportFormData.date}
                                onChange={(e) => setAddSupportFormData({...addSupportFormData, date: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Assign To (Optional)</label>
                              <select
                                value={addSupportFormData.assign_to_id}
                                onChange={(e) => setAddSupportFormData({...addSupportFormData, assign_to_id: e.target.value})}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              >
                                <option value="">Select User</option>
                                {users.map((user) => (
                                  <option key={user.id} value={user.id}>{user.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Assign Date (Optional)</label>
                              <Input
                                type="date"
                                value={addSupportFormData.assign_date}
                                onChange={(e) => setAddSupportFormData({...addSupportFormData, assign_date: e.target.value})}
                              />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Error Status</label>
                            <select
                              value={addSupportFormData.error_status}
                              onChange={(e) => setAddSupportFormData({...addSupportFormData, error_status: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                            >
                              <option value="pending">Pending</option>
                              <option value="in_progress">In Progress</option>
                              <option value="resolved">Resolved</option>
                              <option value="closed">Closed</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Note Solution (Optional)</label>
                            <textarea
                              value={addSupportFormData.note_solution}
                              onChange={(e) => setAddSupportFormData({...addSupportFormData, note_solution: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] min-h-[100px]"
                              placeholder="Enter solution notes"
                            />
                          </div>
                          <div className="flex justify-end gap-2 mt-6">
                            <Button
                              type="button"
                              variant="ghost"
                              onClick={() => {
                                setShowAddSupportForm(false);
                                setAddSupportFormData({
                                  issue_error: '',
                                  issue_reporter_id: '',
                                  date: '',
                                  assign_to_id: '',
                                  assign_date: '',
                                  error_status: 'pending',
                                  note_solution: '',
                                });
                              }}
                            >
                              Cancel
                            </Button>
                            <Button type="submit">Add Issue</Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Issue/Error</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Issue reporter</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Assign to</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Assign date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Error status</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Note Solution</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit</th>
                        </tr>
                      </thead>
                      <tbody>
                        {supportManagementLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading support issues...</td>
                          </tr>
                        ) : supportManagement.length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No support issues found.</td>
                          </tr>
                        ) : (
                          supportManagement.map((support, index) => (
                            <tr key={support.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <Input
                                    value={editingSupportData.issue_error}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, issue_error: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  support.issue_error
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <select
                                    value={editingSupportData.issue_reporter_id}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, issue_reporter_id: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    <option value="">Select User</option>
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                                ) : (
                                  support.issue_reporter_name || 'N/A'
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <Input
                                    type="date"
                                    value={editingSupportData.date}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, date: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  formatDate(support.date)
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <select
                                    value={editingSupportData.assign_to_id}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, assign_to_id: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    <option value="">Select User</option>
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                                ) : (
                                  support.assign_to_name || 'N/A'
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <Input
                                    type="date"
                                    value={editingSupportData.assign_date || ''}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, assign_date: e.target.value})}
                                    className="w-full"
                                  />
                                ) : (
                                  support.assign_date ? formatDate(support.assign_date) : 'N/A'
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <select
                                    value={editingSupportData.error_status}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, error_status: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm"
                                  >
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="closed">Closed</option>
                                  </select>
                                ) : (
                                  <span className={`px-2 py-1 rounded text-xs ${
                                    support.error_status === 'resolved' || support.error_status === 'closed' 
                                      ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
                                      : support.error_status === 'in_progress'
                                      ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400'
                                      : 'bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400'
                                  }`}>
                                    {support.error_status?.replace('_', ' ').toUpperCase() || 'PENDING'}
                                  </span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <textarea
                                    value={editingSupportData.note_solution || ''}
                                    onChange={(e) => setEditingSupportData({...editingSupportData, note_solution: e.target.value})}
                                    className="w-full px-2 py-1 border border-[hsl(var(--border))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] text-sm min-h-[60px]"
                                  />
                                ) : (
                                  <div className="max-w-xs truncate" title={support.note_solution || 'N/A'}>
                                    {support.note_solution || 'N/A'}
                                  </div>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingSupportId === support.id && editingSupportData ? (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleSaveSupport(support.id)}>Save</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={handleCancelEditSupport}>Cancel</Button>
                                  </div>
                                ) : (
                                  <div className="flex gap-2">
                                    <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditSupport(support)}>Edit</Button>
                                    <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteSupport(support.id)}>Delete</Button>
                                  </div>
                                )}
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>

              {/* List of Unsolved Issues */}
              <Card>
                <CardContent className="p-4 space-y-4">
                  <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">List of unsolved issues</h3>
                  {unsolvedIssues.length === 0 ? (
                    <p className="text-sm text-[hsl(var(--muted-foreground))]">No unsolved issues.</p>
                  ) : (
                    <div className="space-y-2">
                      {unsolvedIssues.map((issue, index) => (
                        <div key={issue.id} className="p-3 border border-dashed border-[hsl(var(--border))] rounded-md">
                          <div className="flex items-start gap-2">
                            <span className="font-semibold text-[hsl(var(--foreground))]">{index + 1}.</span>
                            <div className="flex-1">
                              <div className="font-medium text-[hsl(var(--foreground))]">{issue.issue_error}</div>
                              <div className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                                Reported by: {issue.issue_reporter_name} | Date: {formatDate(issue.date)}
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'transaction-management' && (
            <section className="space-y-6">
              {/* Earning Summary */}
              <Card>
                <CardContent className="p-4 space-y-2">
                  <h3 className="text-lg font-semibold mb-4" style={{ color: '#000000' }}>Earning Summary</h3>
                  <div className="space-y-1 text-sm" style={{ color: '#000000' }}>
                    <div>
                      Total earning from Ad post: Rs {earningSummary?.total?.toLocaleString() || '0.00'}
                    </div>
                    <div>
                      Total earning from Ad post Weekly: Rs {earningSummary?.weekly?.toLocaleString() || '0.00'}
                    </div>
                    <div>
                      Total earning from Ad post Monthly: Rs {earningSummary?.monthly?.toLocaleString() || '0.00'}
                    </div>
                    <div>
                      Total earning from Ad post Yearly: Rs {earningSummary?.yearly?.toLocaleString() || '0.00'}
                    </div>
                    <div>
                      <div 
                        className="cursor-pointer flex items-center gap-2 hover:underline"
                        onClick={() => setShowCategoryWiseDropdown(!showCategoryWiseDropdown)}
                        style={{ color: '#000000' }}
                      >
                        <span>Total earning from Ad post major category wise:</span>
                        <span className="text-xs">{showCategoryWiseDropdown ? '' : ''}</span>
                      </div>
                      {showCategoryWiseDropdown && earningSummary?.category_wise && earningSummary.category_wise.length > 0 && (
                        <ul className="ml-4 mt-1 list-disc" style={{ color: '#000000' }}>
                          {earningSummary.category_wise.map((cat, idx) => (
                            <li key={idx} style={{ color: '#000000' }}>
                              {cat.category}: Rs {Number(cat.total).toLocaleString()}
                            </li>
                          ))}
                        </ul>
                      )}
                      {showCategoryWiseDropdown && (!earningSummary?.category_wise || earningSummary.category_wise.length === 0) && (
                        <span className="ml-2" style={{ color: '#000000' }}>No category data</span>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardContent className="p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h3 className="text-lg font-semibold text-[hsl(var(--foreground))]">Transaction Management</h3>
                    {transactionManagementTab === 'ad-post' && (
                    <Button variant="outline" onClick={() => setShowPostAdTransactionForm(!showPostAdTransactionForm)}>
                      {showPostAdTransactionForm ? 'Close Form' : 'Post Ad'}
                    </Button>
                    )}
                  </div>

                  {/* Tabs for Ad Post vs Wallet Transactions */}
                  <div className="flex gap-2 border-b border-[hsl(var(--border))] mb-4">
                    <button
                      onClick={() => setTransactionManagementTab('ad-post')}
                      className={`px-4 py-2 text-sm font-medium transition-colors ${
                        transactionManagementTab === 'ad-post'
                          ? 'border-b-2 border-[hsl(var(--primary))] text-[hsl(var(--primary))]'
                          : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--foreground))]'
                      }`}
                    >
                      Ad Post Transactions
                    </button>
                    <button
                      onClick={() => setTransactionManagementTab('wallet')}
                      className={`px-4 py-2 text-sm font-medium transition-colors ${
                        transactionManagementTab === 'wallet'
                          ? 'border-b-2 border-[hsl(var(--primary))] text-[hsl(var(--primary))]'
                          : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--foreground))]'
                      }`}
                    >
                      Wallet Transactions
                    </button>
                  </div>

                  {/* Ad Post Transactions Tab */}
                  {transactionManagementTab === 'ad-post' && (
                    <>
                  {/* Post Ad Form */}
                  {showPostAdTransactionForm && (
                    <Card className="bg-[hsl(var(--accent))]/50">
                      <CardContent className="p-6">
                        <h4 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Post Ad Transaction</h4>
                        <form onSubmit={handlePostAdTransactionSubmit} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Vendor *</label>
                              <select
                                value={postAdTransactionFormData.vendor_id}
                                onChange={(e) => {
                                  const selectedUser = users.find(u => u.id.toString() === e.target.value);
                                  setPostAdTransactionFormData({
                                    ...postAdTransactionFormData,
                                    vendor_id: e.target.value,
                                    email: selectedUser?.email || '',
                                  });
                                }}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                                required
                              >
                                <option value="">Select Vendor</option>
                                {users.map((user) => (
                                  <option key={user.id} value={user.id}>{user.name}</option>
                                ))}
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Num. of Posted Ad *</label>
                              <Input
                                type="number"
                                min="0"
                                value={postAdTransactionFormData.num_of_posted_ad}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, num_of_posted_ad: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Category/Subcategory (Optional)</label>
                              <div className="relative" ref={transactionCategoryDropdownRef}>
                                <button
                                  type="button"
                                  onClick={() => setTransactionShowCategoryDropdown(!transactionShowCategoryDropdown)}
                                  className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                                >
                                  <span>{buildTransactionCategoryString() || 'Select Category'}</span>
                                  <span className="ml-2">{transactionShowCategoryDropdown ? '' : ''}</span>
                                </button>
                                
                                {/* Cascading Category Menu */}
                                {transactionShowCategoryDropdown && (
                                  <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 flex">
                                    {/* Category Column */}
                                    <div className="min-w-[200px] max-h-96 overflow-y-auto border-r border-[hsl(var(--border))]">
                                      <div className="p-2 font-semibold text-xs text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                        Category
                                      </div>
                                      <div className="py-1">
                                        <button
                                          type="button"
                                          onClick={() => {
                                            handleTransactionClearCategorySelection();
                                          }}
                                          className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                            !transactionSelectedCategoryName ? 'bg-[hsl(var(--accent))]' : ''
                                          }`}
                                        >
                                          All Categories
                                        </button>
                                        {categories.map((category, index) => (
                                          <button
                                            key={category.id || `category-${index}`}
                                            type="button"
                                            onClick={() => handleTransactionCategorySelect(category.name)}
                                            onMouseEnter={() => {
                                              if (transactionSelectedCategoryName !== category.name) {
                                                handleTransactionCategorySelect(category.name);
                                              }
                                            }}
                                            className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] flex items-center justify-between ${
                                              transactionSelectedCategoryName === category.name ? 'bg-[hsl(var(--accent))]' : ''
                                            }`}
                                          >
                                            <span>{category.name}</span>
                                            {category.subcategories && category.subcategories.length > 0 && <span></span>}
                                          </button>
                                        ))}
                                      </div>
                                    </div>
                                    
                                    {/* Subcategory Column - appears when category is selected */}
                                    {transactionSelectedCategoryName && getTransactionSelectedCategory() && getTransactionSelectedCategory().subcategories && getTransactionSelectedCategory().subcategories.length > 0 && (
                                      <div className="min-w-[200px] max-h-96 overflow-y-auto">
                                        <div className="p-2 font-semibold text-xs text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                          Subcategory
                                        </div>
                                        <div className="py-1">
                                          <button
                                            type="button"
                                            onClick={() => {
                                              setTransactionSelectedSubcategoryId('');
                                              const category = getTransactionSelectedCategory();
                                              if (category) {
                                                setPostAdTransactionFormData({...postAdTransactionFormData, category_id: category.id.toString()});
                                              }
                                              setTransactionShowCategoryDropdown(false);
                                            }}
                                            className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                              !transactionSelectedSubcategoryId ? 'bg-[hsl(var(--accent))]' : ''
                                            }`}
                                          >
                                            All Subcategories
                                          </button>
                                          {getTransactionSelectedCategory().subcategories.map((subcategory) => (
                                            <button
                                              key={subcategory.id}
                                              type="button"
                                              onClick={() => handleTransactionSubcategorySelect(subcategory.id.toString())}
                                              className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                                transactionSelectedSubcategoryId === subcategory.id.toString() ? 'bg-[hsl(var(--accent))]' : ''
                                              }`}
                                            >
                                              {subcategory.name}
                                            </button>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Amount *</label>
                              <Input
                                type="number"
                                step="0.01"
                                min="0"
                                value={postAdTransactionFormData.amount}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, amount: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Payment Method *</label>
                              <select
                                value={postAdTransactionFormData.payment_method}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, payment_method: e.target.value})}
                                className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                                required
                              >
                                <option value="Credit Card">Credit Card</option>
                                <option value="PayPal">PayPal</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Stripe">Stripe</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Email</label>
                              <Input
                                type="email"
                                value={postAdTransactionFormData.email}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, email: e.target.value})}
                                placeholder="Email address"
                              />
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Start Date *</label>
                              <Input
                                type="date"
                                value={postAdTransactionFormData.start_date}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, start_date: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">End Date *</label>
                              <Input
                                type="date"
                                value={postAdTransactionFormData.end_date}
                                onChange={(e) => setPostAdTransactionFormData({...postAdTransactionFormData, end_date: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div className="flex justify-end gap-2 mt-6">
                            <Button
                              type="button"
                              variant="ghost"
                              onClick={() => {
                                setShowPostAdTransactionForm(false);
                                setPostAdTransactionFormData({
                                  vendor_id: '',
                                  num_of_posted_ad: '',
                                  category_id: '',
                                  amount: '',
                                  payment_method: 'Credit Card',
                                  start_date: '',
                                  end_date: '',
                                  email: '',
                                  status: 'active',
                                });
                                setTransactionSelectedCategoryName('');
                                setTransactionSelectedSubcategoryId('');
                              }}
                            >
                              Cancel
                            </Button>
                            <Button type="submit">Post Ad</Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Vendor name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Num. of posted ad</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Category/Subcategory</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Amount</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment method</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Start</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">End</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Email</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {transactionManagementLoading ? (
                          <tr>
                            <td colSpan="10" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading transactions...</td>
                          </tr>
                        ) : transactionManagement.length === 0 ? (
                          <tr>
                            <td colSpan="10" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No transactions found.</td>
                          </tr>
                        ) : (
                          transactionManagement.map((transaction, index) => (
                            <tr key={transaction.id} className="border-b border-[hsl(var(--border))]">
                              <td className="p-3 text-sm">{index + 1}</td>
                              <td className="p-3 text-sm">{transaction.vendor_name || 'N/A'}</td>
                              <td className="p-3 text-sm">{transaction.num_of_posted_ad || 0}</td>
                              <td className="p-3 text-sm">
                                {`${transaction.category_name || 'N/A'}${transaction.subcategory_name ? ` / ${transaction.subcategory_name}` : ''}`}
                              </td>
                              <td className="p-3 text-sm">Rs {Number(transaction.amount || 0).toLocaleString()}</td>
                              <td className="p-3 text-sm">{transaction.payment_method || 'N/A'}</td>
                              <td className="p-3 text-sm">{formatDate(transaction.start_date)}</td>
                              <td className="p-3 text-sm">{formatDate(transaction.end_date)}</td>
                              <td className="p-3 text-sm">{transaction.email || 'N/A'}</td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditTransaction(transaction)}>Edit</Button>
                                  <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteTransaction(transaction.id)}>Delete</Button>
                                </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                    </>
                  )}

                  {/* Wallet Transactions Tab */}
                  {transactionManagementTab === 'wallet' && (
                    <>
                      {/* Filters */}
                      <div className="flex gap-4 mb-4">
                        <div>
                          <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Type</label>
                          <select
                            value={walletTransactionTypeFilter}
                            onChange={(e) => setWalletTransactionTypeFilter(e.target.value)}
                            className="px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                          >
                            <option value="all">All Types</option>
                            <option value="deposit">Deposits</option>
                            <option value="withdraw">Withdrawals</option>
                            <option value="seller_verification">Seller Verification</option>
                            <option value="ebook_purchase">eBook Purchases</option>
                            <option value="auction_deposit">Auction Deposits</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Status</label>
                          <select
                            value={walletTransactionStatusFilter}
                            onChange={(e) => setWalletTransactionStatusFilter(e.target.value)}
                            className="px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                          >
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                          </select>
                        </div>
                      </div>

                      {/* Wallet Transactions Table */}
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                          <thead>
                            <tr className="border-b border-[hsl(var(--border))]">
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Type</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Amount</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment Method</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment ID</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">PayPal Email</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Description</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Date</th>
                            </tr>
                          </thead>
                          <tbody>
                            {walletTransactionsLoading ? (
                              <tr>
                                <td colSpan="10" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading wallet transactions...</td>
                              </tr>
                            ) : walletTransactions.length === 0 ? (
                              <tr>
                                <td colSpan="10" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No wallet transactions found.</td>
                              </tr>
                            ) : (
                              walletTransactions.map((transaction, index) => (
                                <tr key={transaction.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))]">
                                  <td className="p-3 text-sm">{index + 1}</td>
                                  <td className="p-3 text-sm">
                                    <div>
                                      <div className="font-medium">{transaction.user_name || 'Unknown'}</div>
                                      <div className="text-xs text-[hsl(var(--muted-foreground))]">{transaction.user_email || ''}</div>
                                    </div>
                                  </td>
                                  <td className="p-3 text-sm">
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      transaction.type === 'deposit' ? 'bg-green-100 text-green-800' :
                                      transaction.type === 'withdraw' ? 'bg-red-100 text-red-800' :
                                      transaction.type === 'seller_verification' ? 'bg-blue-100 text-blue-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {transaction.type?.replace('_', ' ').toUpperCase() || 'N/A'}
                                    </span>
                                  </td>
                                  <td className="p-3 text-sm font-semibold">
                                    {transaction.type === 'deposit' ? '+' : '-'}${Number(transaction.amount || 0).toFixed(2)}
                                  </td>
                                  <td className="p-3 text-sm">
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      transaction.status === 'completed' ? 'bg-green-100 text-green-800' :
                                      transaction.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                      transaction.status === 'failed' ? 'bg-red-100 text-red-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {transaction.status?.toUpperCase() || 'N/A'}
                                    </span>
                                  </td>
                                  <td className="p-3 text-sm">{transaction.payment_method || 'N/A'}</td>
                                  <td className="p-3 text-sm">
                                    <span className="text-xs font-mono">{transaction.payment_id || '-'}</span>
                                  </td>
                                  <td className="p-3 text-sm">
                                    {transaction.paypal_email ? (
                                      <span className="text-xs">{transaction.paypal_email}</span>
                                    ) : (
                                      <span className="text-[hsl(var(--muted-foreground))]">-</span>
                                    )}
                                  </td>
                                  <td className="p-3 text-sm">
                                    <span className="text-xs">{transaction.description || '-'}</span>
                                  </td>
                                  <td className="p-3 text-sm">
                                    {transaction.created_at ? new Date(transaction.created_at).toLocaleDateString() : '-'}
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </>
                  )}
                </CardContent>
              </Card>

              {/* Edit Transaction Modal */}
              {showEditTransactionModal && editingTransactionData && editingTransactionId && (
                <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
                  <Card className="w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                    <CardHeader className="flex flex-row items-center justify-between">
                      <CardTitle>Edit Transaction</CardTitle>
                      <Button variant="ghost" size="sm" onClick={handleCancelEditTransaction}></Button>
                    </CardHeader>
                    <CardContent className="p-6">
                      <form onSubmit={(e) => { e.preventDefault(); handleSaveTransaction(editingTransactionId); }} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Vendor *</label>
                                  <select
                                    value={editingTransactionData.vendor_id}
                                    onChange={(e) => {
                                      const selectedUser = users.find(u => u.id.toString() === e.target.value);
                                      setEditingTransactionData({
                                        ...editingTransactionData,
                                        vendor_id: e.target.value,
                                        email: selectedUser?.email || editingTransactionData.email,
                                      });
                                    }}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              required
                                  >
                              <option value="">Select Vendor</option>
                                    {users.map((user) => (
                                      <option key={user.id} value={user.id}>{user.name}</option>
                                    ))}
                                  </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Num. of Posted Ad *</label>
                                  <Input
                                    type="number"
                                    min="0"
                                    value={editingTransactionData.num_of_posted_ad}
                                    onChange={(e) => setEditingTransactionData({...editingTransactionData, num_of_posted_ad: e.target.value})}
                              required
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Category/Subcategory (Optional)</label>
                                  <div className="relative" ref={transactionCategoryDropdownRef}>
                                    <button
                                      type="button"
                                      onClick={() => setTransactionShowCategoryDropdown(!transactionShowCategoryDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                                    >
                                      <span>{buildTransactionCategoryString() || 'Select Category'}</span>
                                <span className="ml-1">{transactionShowCategoryDropdown ? '' : ''}</span>
                                    </button>
                                    
                                    {transactionShowCategoryDropdown && (
                                      <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 flex">
                                  <div className="min-w-[200px] max-h-96 overflow-y-auto border-r border-[hsl(var(--border))]">
                                    <div className="p-2 font-semibold text-sm text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                            Category
                                          </div>
                                          <div className="py-1">
                                            <button
                                              type="button"
                                              onClick={() => handleTransactionClearCategorySelection()}
                                        className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                                !transactionSelectedCategoryName ? 'bg-[hsl(var(--accent))]' : ''
                                              }`}
                                            >
                                              All Categories
                                            </button>
                                            {categories.map((category, index) => (
                                              <button
                                                key={category.id || `category-${index}`}
                                                type="button"
                                                onClick={() => handleTransactionCategorySelect(category.name)}
                                                onMouseEnter={() => {
                                                  if (transactionSelectedCategoryName !== category.name) {
                                                    handleTransactionCategorySelect(category.name);
                                                  }
                                                }}
                                          className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] flex items-center justify-between ${
                                                  transactionSelectedCategoryName === category.name ? 'bg-[hsl(var(--accent))]' : ''
                                                }`}
                                              >
                                                <span>{category.name}</span>
                                                {category.subcategories && category.subcategories.length > 0 && <span></span>}
                                              </button>
                                            ))}
                                          </div>
                                        </div>
                                        
                                        {transactionSelectedCategoryName && getTransactionSelectedCategory() && getTransactionSelectedCategory().subcategories && getTransactionSelectedCategory().subcategories.length > 0 && (
                                    <div className="min-w-[200px] max-h-96 overflow-y-auto">
                                      <div className="p-2 font-semibold text-sm text-[hsl(var(--muted-foreground))] border-b border-[hsl(var(--border))]">
                                              Subcategory
                                            </div>
                                            <div className="py-1">
                                              <button
                                                type="button"
                                                onClick={() => {
                                                  setTransactionSelectedSubcategoryId('');
                                                  const category = getTransactionSelectedCategory();
                                                  if (category) {
                                                    setEditingTransactionData({...editingTransactionData, category_id: category.id.toString()});
                                                  }
                                                  setTransactionShowCategoryDropdown(false);
                                                }}
                                          className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                                  !transactionSelectedSubcategoryId ? 'bg-[hsl(var(--accent))]' : ''
                                                }`}
                                              >
                                                All Subcategories
                                              </button>
                                              {getTransactionSelectedCategory().subcategories.map((subcategory) => (
                                                <button
                                                  key={subcategory.id}
                                                  type="button"
                                                  onClick={() => {
                                                    handleTransactionSubcategorySelect(subcategory.id.toString());
                                                    setEditingTransactionData({...editingTransactionData, category_id: subcategory.id.toString()});
                                                  }}
                                            className={`w-full text-left px-3 py-2 text-sm hover:bg-[hsl(var(--accent))] ${
                                                    transactionSelectedSubcategoryId === subcategory.id.toString() ? 'bg-[hsl(var(--accent))]' : ''
                                                  }`}
                                                >
                                                  {subcategory.name}
                                                </button>
                                              ))}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Amount *</label>
                                  <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={editingTransactionData.amount}
                                    onChange={(e) => setEditingTransactionData({...editingTransactionData, amount: e.target.value})}
                              required
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Payment Method *</label>
                                  <select
                                    value={editingTransactionData.payment_method}
                                    onChange={(e) => setEditingTransactionData({...editingTransactionData, payment_method: e.target.value})}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                              required
                                  >
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="PayPal">PayPal</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Wallet">Wallet</option>
                                    <option value="Stripe">Stripe</option>
                                  </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Email</label>
                            <Input
                              type="email"
                              value={editingTransactionData.email}
                              onChange={(e) => setEditingTransactionData({...editingTransactionData, email: e.target.value})}
                              placeholder="Email address"
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Start Date *</label>
                                  <Input
                                    type="date"
                                    value={editingTransactionData.start_date}
                                    onChange={(e) => setEditingTransactionData({...editingTransactionData, start_date: e.target.value})}
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">End Date *</label>
                                  <Input
                                    type="date"
                                    value={editingTransactionData.end_date}
                                    onChange={(e) => setEditingTransactionData({...editingTransactionData, end_date: e.target.value})}
                              required
                            />
                                  </div>
                                  </div>
                        <div className="flex justify-end gap-2 mt-6">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={handleCancelEditTransaction}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">Save Changes</Button>
                  </div>
                      </form>
                </CardContent>
              </Card>
                </div>
              )}
            </section>
          )}

          {activeSection === 'user-management' && (
            <section className="space-y-6">
              {userManagementLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading users...
                </div>
              )}

              {/* Summary Statistics */}
              <Card>
                <CardContent className="p-4">
                  <div className="flex gap-6">
                    <div>
                      <span className="text-sm font-medium text-[hsl(var(--foreground))]">Total user: </span>
                      <span className="text-sm font-semibold text-[hsl(var(--foreground))]">{totalUsers}</span>
                    </div>
                    <div>
                      <span className="text-sm font-medium text-[hsl(var(--foreground))]">Total vendor: </span>
                      <span className="text-sm font-semibold text-[hsl(var(--foreground))]">{totalVendors}</span>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* User Management Table */}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">User management</h2>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Joined Date</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Email</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Address</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User/Vendor</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Status</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Comment</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {userManagementLoading ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">Loading users...</td>
                          </tr>
                        ) : userManagementData.length === 0 ? (
                          <tr>
                            <td colSpan="9" className="p-4 text-center text-[hsl(var(--muted-foreground))]">No users found</td>
                          </tr>
                        ) : (
                          userManagementData.map((user, index) => (
                            <tr key={user.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingUserId === user.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm">
                                  <span>{user.name}</span>
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">
                                {new Date(user.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                              </td>
                              <td className="p-3 text-sm">
                                  <span>{user.email}</span>
                              </td>
                              <td className="p-3 text-sm max-w-xs">
                                  <span className="text-[hsl(var(--muted-foreground))] text-xs truncate block">
                                    {user.location || '-'}
                                  </span>
                              </td>
                              <td className="p-3 text-sm">
                                  <span className="capitalize">{user.role === 'super_admin' ? 'Super Admin' : user.role}</span>
                              </td>
                              <td className="p-3 text-sm">
                                <span className="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                  Active
                                </span>
                              </td>
                              <td className="p-3 text-sm">
                                {commentingUserId === user.id ? (
                                  <div className="space-y-2">
                                    <textarea
                                      value={userComment}
                                      onChange={(e) => setUserComment(e.target.value)}
                                      className="w-full text-sm p-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                      rows="2"
                                      placeholder="Enter comment..."
                                    />
                                    <div className="flex gap-2">
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveComment(user.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelComment}
                                      >
                                        Cancel
                                      </Button>
                                    </div>
                                  </div>
                                ) : (
                                  <div className="space-y-1">
                                    <span className="text-[hsl(var(--foreground))]">{user.comment || '-'}</span>
                                    {/* Only super_admin can add comments to admin accounts */}
                                    {((user.role !== 'admin' && user.role !== 'super_admin') || isSuperAdmin) && (
                                    <Button
                                      variant="ghost"
                                      size="sm"
                                      className="h-6 px-2 text-xs"
                                      onClick={() => handleAddComment(user.id)}
                                    >
                                      {user.comment ? 'Edit Comment' : 'Add Comment'}
                                    </Button>
                                    )}
                                  </div>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {/* Only super_admin can edit/delete admin accounts. Regular admins can only manage users, vendors */}
                                  {user.role !== 'super_admin' && (user.role !== 'admin' || isSuperAdmin) && (
                                        <Button
                                          variant="outline"
                                          size="sm"
                                          className="h-7 px-2 text-xs"
                                          onClick={() => handleEditUser(user)}
                                        >
                                          Edit
                                        </Button>
                                      )}
                                  {user.role !== 'super_admin' && (user.role !== 'admin' || isSuperAdmin) && (
                                        <Button
                                          variant="destructive"
                                          size="sm"
                                          className="h-7 px-2 text-xs"
                                          onClick={() => handleDeleteUser(user.id)}
                                        >
                                          Delete
                                        </Button>
                                      )}
                                  {(user.role === 'super_admin' || (user.role === 'admin' && !isSuperAdmin)) && (
                                        <span className="text-xs text-[hsl(var(--muted-foreground))] italic">
                                          Protected
                                        </span>
                                  )}
                                </div>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'location-address' && (
            <section>
              {locationsLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading locations...
                </div>
              )}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">Location/address Management</h2>
                    <Button variant="outline" onClick={() => setShowAddLocationForm(!showAddLocationForm)}>Add Location</Button>
                  </div>

                  {/* Add Location Form - appears when Add Location is clicked */}
                  <div
                    className={`mb-4 transition-all duration-400 ease-in-out ${
                      showAddLocationForm 
                        ? 'opacity-100 translate-y-0' 
                        : 'opacity-0 -translate-y-4 pointer-events-none'
                    }`}
                    style={{
                      transition: 'opacity 0.4s ease-in-out, transform 0.4s ease-in-out'
                    }}
                  >
                    {showAddLocationForm && (
                      <Card className="mb-4">
                        <CardContent className="p-6">
                          <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Add New Location</h3>
                          <form onSubmit={handleAddLocationSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Province *</label>
                                <Input
                                  value={addLocationFormData.province}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, province: e.target.value})}
                                  className="w-full"
                                  required
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">District *</label>
                                <Input
                                  value={addLocationFormData.district}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, district: e.target.value})}
                                  className="w-full"
                                  required
                                />
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Local Level *</label>
                                <Input
                                  value={addLocationFormData.localLevel}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, localLevel: e.target.value})}
                                  className="w-full"
                                  required
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Local Level Type *</label>
                                <select
                                  value={addLocationFormData.localLevelType}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, localLevelType: e.target.value})}
                                  className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  required
                                >
                                  <option value="Metropolitan City">Metropolitan City</option>
                                  <option value="Sub-Metropolitan City">Sub-Metropolitan City</option>
                                  <option value="Municipality">Municipality</option>
                                  <option value="Rural Municipality">Rural Municipality</option>
                                </select>
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mt-4">
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Ward Number</label>
                                <Input
                                  type="number"
                                  min="1"
                                  value={addLocationFormData.wardNumber}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, wardNumber: e.target.value})}
                                  className="w-full"
                                  placeholder="Enter ward number (optional)"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Local Address</label>
                                <Input
                                  value={addLocationFormData.localAddress}
                                  onChange={(e) => setAddLocationFormData({...addLocationFormData, localAddress: e.target.value})}
                                  className="w-full"
                                  placeholder="Enter local address (optional)"
                                />
                              </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                              <Button
                                type="button"
                                variant="ghost"
                                onClick={() => {
                                  setShowAddLocationForm(false);
                                  setAddLocationFormData({
                                    province: '',
                                    district: '',
                                    localLevel: '',
                                    localLevelType: 'Municipality',
                                    wardNumber: '',
                                    localAddress: '',
                                  });
                                }}
                              >
                                Cancel
                              </Button>
                              <Button type="submit">Add Location</Button>
                            </div>
                          </form>
                        </CardContent>
                      </Card>
                    )}
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Province</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">District</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Local level (Municipality or Rural Municipality)</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Ward Number</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Local Address</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                        </tr>
                      </thead>
                      <tbody>
                        {locations.map((location, index) => (
                          <tr key={location.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingLocationId === location.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                            <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                            <td className="p-3 text-sm">
                              {editingLocationId === location.id ? (
                                <Input
                                  value={editingLocationData.province}
                                  onChange={(e) => setEditingLocationData({...editingLocationData, province: e.target.value})}
                                  className="w-full text-sm"
                                />
                              ) : (
                                <span>{location.province}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingLocationId === location.id ? (
                                <Input
                                  value={editingLocationData.district}
                                  onChange={(e) => setEditingLocationData({...editingLocationData, district: e.target.value})}
                                  className="w-full text-sm"
                                />
                              ) : (
                                <span>{location.district}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingLocationId === location.id ? (
                                <div className="flex gap-2">
                                  <Input
                                    value={editingLocationData.localLevel}
                                    onChange={(e) => setEditingLocationData({...editingLocationData, localLevel: e.target.value})}
                                    className="flex-1 text-sm"
                                    placeholder="Local Level"
                                  />
                                  <select
                                    value={editingLocationData.localLevelType}
                                    onChange={(e) => setEditingLocationData({...editingLocationData, localLevelType: e.target.value})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Metropolitan City">Metropolitan City</option>
                                    <option value="Sub-Metropolitan City">Sub-Metropolitan City</option>
                                    <option value="Municipality">Municipality</option>
                                    <option value="Rural Municipality">Rural Municipality</option>
                                  </select>
                                </div>
                              ) : (
                                <span>{location.localLevel} ({location.localLevelType === 'Municipality' ? 'M' : location.localLevelType === 'Rural Municipality' ? 'RM' : location.localLevelType === 'Metropolitan City' ? 'MC' : 'SMC'})</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingLocationId === location.id ? (
                                <Input
                                  type="number"
                                  min="1"
                                  value={editingLocationData.wardNumber}
                                  onChange={(e) => setEditingLocationData({...editingLocationData, wardNumber: e.target.value})}
                                  className="w-full text-sm"
                                  placeholder="Ward Number"
                                />
                              ) : (
                                <span>{location.wardNumber || 'N/A'}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingLocationId === location.id ? (
                                <Input
                                  value={editingLocationData.localAddress}
                                  onChange={(e) => setEditingLocationData({...editingLocationData, localAddress: e.target.value})}
                                  className="w-full text-sm"
                                  placeholder="Local Address"
                                />
                              ) : (
                                <span>{location.localAddress || 'N/A'}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              <div className="flex gap-2">
                                {editingLocationId === location.id ? (
                                  <>
                                    <Button 
                                      variant="outline" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleSaveLocation(location.id)}
                                    >
                                      Save
                                    </Button>
                                    <Button 
                                      variant="ghost" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={handleCancelEditLocation}
                                    >
                                      Cancel
                                    </Button>
                                  </>
                                ) : (
                                  <>
                                    <Button 
                                      variant="outline" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleEditLocation(location)}
                                    >
                                      Edit
                                    </Button>
                                    <Button 
                                      variant="destructive" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleDeleteLocation(location.id)}
                                    >
                                      Delete
                                    </Button>
                                  </>
                                )}
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'auction-management' && (
            <>
              {/* Auction Management */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <div className="flex items-start justify-between mb-4">
                      <div>
                        <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-2">Auction Management</h2>
                        <p className="text-sm text-[hsl(var(--muted-foreground))]">The form of auction is submitted by super admin</p>
                      </div>
                      <Button onClick={() => {
                        if (editingAuction) {
                          // If editing, open modal instead
                          setShowEditAuctionModal(true);
                        } else {
                          setShowAuctionForm(!showAuctionForm);
                          if (!showAuctionForm) {
                            setEditingAuction(null);
                            setAuctionFormData({
                              user_id: '',
                              category_id: '',
                              location_id: '',
                              title: '',
                              description: '',
                              starting_price: '',
                              reserve_price: '',
                              buy_now_price: '',
                              bid_increment: '1.00',
                              start_time: '',
                              end_time: '',
                            });
                            setAuctionImages([null, null, null, null]);
                          }
                        }
                      }}>
                        {showAuctionForm ? 'Cancel' : 'Start Auction'}
                      </Button>
                    </div>

                    {/* Auction Form - appears when Start Auction is clicked (NOT for editing) */}
                    {showAuctionForm && !editingAuction && (
                      <div className="mt-6 pt-6 border-t border-[hsl(var(--border))]">
                        <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">
                          Create New Auction
                        </h3>
                      <form 
                        className="grid grid-cols-2 gap-4"
                        onSubmit={handleStartAuctionSubmit}
                      >
                        {/* Left Column */}
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">User *</label>
                            <select
                              value={auctionFormData.user_id}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, user_id: e.target.value}))}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            >
                              <option value="">Select User</option>
                              {Array.isArray(users) && users.map((user) => (
                                <option key={user.id} value={user.id}>
                                  {user.name} ({user.email})
                                </option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction Item Name (Title) * (Max 90 characters)</label>
                            <Input
                              value={auctionFormData.title}
                              onChange={(e) => {
                                const value = e.target.value;
                                if (value.length <= 90) {
                                  setAuctionFormData(prev => ({...prev, title: value}));
                                }
                              }}
                              className="w-full"
                              maxLength={90}
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {auctionFormData.title.length}/90 characters
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Description * (Max 300 words)</label>
                            <textarea
                              value={auctionFormData.description}
                              onChange={(e) => {
                                const value = e.target.value;
                                const wordCount = value.trim() ? value.trim().split(/\s+/).length : 0;
                                if (wordCount <= 300) {
                                  setAuctionFormData(prev => ({...prev, description: value}));
                                }
                              }}
                              className="w-full min-h-[100px] px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {auctionFormData.description.trim() ? auctionFormData.description.trim().split(/\s+/).length : 0}/300 words
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Starting Price *</label>
                            <Input
                              type="number"
                              value={auctionFormData.starting_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, starting_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                              required
                            />
                          </div>
                        </div>

                        {/* Right Column */}
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Category/Subcategory *</label>
                            <div className="relative" ref={auctionCategoryDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setAuctionShowCategoryDropdown(!auctionShowCategoryDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                            >
                                <span>{buildAuctionCategoryString() || 'Select Category'}</span>
                                <span className="ml-2">{auctionShowCategoryDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Hierarchical Category Menu - Matching Post Ad dropdown design */}
                              {auctionShowCategoryDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                  <div className="p-3">
                                    <div className="space-y-1">
                                      {categories.map((category) => {
                                        const subcategories = category.subcategories || [];
                                        const hasSubcategories = subcategories.length > 0;
                                        // Use category name as key for expansion (matching Post Ad dropdown behavior)
                                        const categoryName = (category.name || '').trim();
                                        const isCategoryExpanded = categoryName ? auctionExpandedCategories.has(categoryName) : false;
                                        
                                        // Check if this category is selected
                                        const isCategorySelected = auctionSelectedCategoryName === categoryName && !auctionSelectedSubcategoryId && !auctionSelectedItemCategoryId;
                                        
                                        return (
                                          <div key={category.id} className="space-y-1">
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center space-x-2 flex-1">
                                                {hasSubcategories ? (
                                                  <div className="flex items-center space-x-2 flex-1">
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        toggleAuctionCategory(categoryName);
                                                      }}
                                                      className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                    >
                                                      {isCategoryExpanded ? '' : ''}
                                                    </button>
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleAuctionCategorySelect(category.id, categoryName);
                                                      }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                      }`}
                                                    >
                                  {category.name}
                                                    </button>
                                                  </div>
                                                ) : (
                                                  <button
                                                    type="button"
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      handleAuctionCategorySelect(category.id, categoryName);
                                                    }}
                                                    className={`flex-1 text-left text-sm ${
                                                      isCategorySelected
                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                        : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                    }`}
                                                  >
                                                    {category.name}
                                                  </button>
                                                )}
                                              </div>
                                            </div>
                                            
                                            {/* Show subcategories when expanded */}
                                            {hasSubcategories && isCategoryExpanded && (
                                              <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                {subcategories.map((subcategory) => {
                                                  const itemCategories = subcategory.item_categories || [];
                                                  const hasItemCategories = itemCategories.length > 0;
                                                  const subcategoryName = (subcategory.name || '').trim();
                                                  const isSubcategoryExpanded = subcategoryName ? auctionExpandedSubcategories.has(subcategoryName) : false;
                                                  
                                                  // Check if this subcategory is selected
                                                  const subcategoryIdStr = subcategory.id.toString();
                                                  const isSubcategorySelected = auctionSelectedSubcategoryId === subcategoryIdStr && !auctionSelectedItemCategoryId;
                                                  
                                                  return (
                                                    <div key={subcategory.id} className="space-y-1">
                                                      <div className="flex items-center justify-between">
                                                        <div className="flex items-center space-x-2 flex-1">
                                                          {hasItemCategories ? (
                                                            <div className="flex items-center space-x-2 flex-1">
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  toggleAuctionSubcategory(subcategoryName);
                                                                }}
                                                                className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                              >
                                                                {isSubcategoryExpanded ? '' : ''}
                                                              </button>
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handleAuctionSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                }`}
                                                              >
                                                                {subcategory.name}
                                                              </button>
                                                            </div>
                                                          ) : (
                                                            <button
                                                              type="button"
                                                              onClick={(e) => {
                                                                e.stopPropagation();
                                                                handleAuctionSubcategorySelect(subcategory.id, subcategoryName);
                                                              }}
                                                              className={`flex-1 text-left text-sm ${
                                                                isSubcategorySelected
                                                                  ? 'text-[hsl(var(--primary))] font-medium'
                                                                  : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                              }`}
                                                            >
                                                              {subcategory.name}
                                                            </button>
                                                          )}
                                                        </div>
                                                      </div>
                                                      
                                                      {/* Show item categories when subcategory is expanded */}
                                                      {hasItemCategories && isSubcategoryExpanded && (
                                                        <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                          {itemCategories.map((itemCategory) => {
                                                            const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                            const itemCategoryIdStr = itemCategory.id.toString();
                                                            const isItemCategorySelected = auctionSelectedItemCategoryId === itemCategoryIdStr;
                                                            
                                                            return (
                                                              <div key={itemCategory.id} className="flex items-center justify-between">
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleAuctionItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                  }}
                                                                  className={`flex-1 text-left text-xs ${
                                                                    isItemCategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                  }`}
                                                                >
                                                                  {itemCategoryName}
                                                                </button>
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                      )}
                                                    </div>
                                                  );
                                                })}
                                              </div>
                                            )}
                                          </div>
                                        );
                                      })}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Location (Optional)</label>
                            <div className="relative" ref={auctionLocationDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setAuctionShowLocationDropdown(!auctionShowLocationDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                            >
                                <span>{buildAuctionLocationString()}</span>
                                <span className="ml-2">{auctionShowLocationDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Hierarchical Checkbox Menu - Same design as Post Ad */}
                              {auctionShowLocationDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[600px] max-h-[500px] overflow-y-auto">
                                  <div className="p-3">
                                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                      <span className="font-semibold text-sm text-[hsl(var(--foreground))]">Select Location</span>
                                      <button
                                        type="button"
                                        onClick={handleAuctionSelectAllLocations}
                                        className="text-xs text-[hsl(var(--primary))] hover:underline"
                                      >
                                        {auctionSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                      </button>
                                    </div>
                                    
                                    {/* Hierarchical Location Tree */}
                                    <div className="space-y-1">
                                      {locationData?.provinces && locationData.provinces.length > 0 ? (
                                        locationData.provinces.map((province) => (
                                        <div key={province.id} className="border-b border-[hsl(var(--border))] pb-1 mb-1">
                                          {/* Province Level */}
                                          <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                            <button
                                              type="button"
                                              onClick={() => toggleAuctionProvince(province.id)}
                                              className="mr-2 text-xs"
                                            >
                                              {auctionExpandedProvinces.has(province.id) ? '' : ''}
                                            </button>
                                            <input
                                              type="checkbox"
                                              className="mr-2"
                                              checked={(() => {
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                              })()}
                                              onChange={() => {
                                                // Single selection: collect all location IDs and select first ward
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                handleAuctionParentToggle(allLocationIds);
                                              }}
                                            />
                                            <span className="text-sm font-medium text-[hsl(var(--foreground))]">{province.name}</span>
                                          </div>
                                          
                                          {/* Districts */}
                                          {auctionExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                            <div key={district.id} className="ml-6 mt-1">
                                              <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                <button
                                                  type="button"
                                                  onClick={() => toggleAuctionDistrict(`${province.id}-${district.id}`)}
                                                  className="mr-2 text-xs"
                                                >
                                                  {auctionExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                                </button>
                                                <input
                                                  type="checkbox"
                                                  className="mr-2"
                                                  checked={(() => {
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                                  })()}
                                                  onChange={() => {
                                                    // Single selection: collect all location IDs and select first ward
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    handleAuctionParentToggle(allLocationIds);
                                                  }}
                                                />
                                                <span className="text-sm text-[hsl(var(--foreground))]">{district.name}</span>
                                              </div>
                                              
                                              {/* Local Levels */}
                                              {auctionExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                                <div key={localLevel.id} className="ml-6 mt-1">
                                                  <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                    <button
                                                      type="button"
                                                      onClick={() => toggleAuctionLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                                      className="mr-2 text-xs"
                                                    >
                                                      {auctionExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                                    </button>
                                                    <input
                                                      type="checkbox"
                                                      className="mr-2"
                                                      checked={(() => {
                                                        if (!localLevel.wards) return false;
                                                        const allLocationIds = [];
                                                        localLevel.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                        // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                                      })()}
                                                      onChange={() => {
                                                        if (localLevel.wards) {
                                                          // Single selection: collect all location IDs and select first ward
                                                          const allLocationIds = [];
                                                          localLevel.wards.forEach(w => {
                                                            allLocationIds.push(w.id.toString());
                                                            if (w.local_addresses && w.local_addresses.length > 0) {
                                                              w.local_addresses.forEach((_, idx) => {
                                                                allLocationIds.push(`${w.id}-${idx}`);
                                                              });
                                                            }
                                                          });
                                                          handleAuctionParentToggle(allLocationIds);
                                                        }
                                                      }}
                                                    />
                                                    <span className="text-sm text-[hsl(var(--foreground))]">
                                                      {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                    </span>
                                                  </div>
                                                  
                                                  {/* Wards and Local Addresses */}
                                                  {auctionExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                                    <div key={ward.id} className="ml-6 mt-1">
                                                      <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                        <input
                                                          type="checkbox"
                                                          className="mr-2"
                                                          checked={(() => {
                                                            // Check if ward ID and ALL local addresses are selected
                                                            const allIds = [ward.id.toString()];
                                                            if (ward.local_addresses && ward.local_addresses.length > 0) {
                                                              ward.local_addresses.forEach((_, idx) => {
                                                                allIds.push(`${ward.id}-${idx}`);
                                                              });
                                                            }
                                                            // Ensure all IDs are strings for consistent comparison
                                                            return allIds.length > 0 && allIds.every(id => {
                                                              const idStr = id.toString();
                                                              return auctionSelectedLocations.has(idStr);
                                                            });
                                                          })()}
                                                          onChange={() => {
                                                            handleAuctionWardToggle(ward);
                                                          }}
                                                        />
                                                        <span className="text-sm text-[hsl(var(--foreground))]">
                                                          Ward {ward.ward_number}
                                                        </span>
                                                      </div>
                                                      
                                                      {/* Local Addresses */}
                                                      {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                        <div className="ml-6 mt-1 space-y-1">
                                                          {ward.local_addresses.map((address, idx) => {
                                                            const addressId = `${ward.id}-${idx}`;
                                                            return (
                                                              <div key={addressId} className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                                <input
                                                                  type="checkbox"
                                                                  className="mr-2"
                                                                  checked={auctionSelectedLocations.has(addressId.toString())}
                                                                  onChange={() => handleAuctionLocationToggle(addressId)}
                                                                />
                                                                <span className="text-xs text-[hsl(var(--muted-foreground))]">{address}</span>
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                      )}
                                                    </div>
                                                  ))}
                                                </div>
                                              ))}
                                            </div>
                                          ))}
                                        </div>
                                      ))
                                      ) : (
                                        <div className="p-4 text-center text-sm text-[hsl(var(--muted-foreground))]">
                                          No locations available. Please add locations first.
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Reserve Price (Optional)</label>
                            <Input
                              type="number"
                              value={auctionFormData.reserve_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, reserve_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Buy Now Price (Optional)</label>
                            <Input
                              type="number"
                              value={auctionFormData.buy_now_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, buy_now_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Bid Increment *</label>
                            <Input
                              type="number"
                              value={auctionFormData.bid_increment}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, bid_increment: e.target.value}))}
                              className="w-full"
                              min="0.01"
                              step="0.01"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction Start Date and Time *</label>
                            <Input
                              type="datetime-local"
                              value={auctionFormData.start_time}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, start_time: e.target.value}))}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction End Date and Time *</label>
                            <Input
                              type="datetime-local"
                              value={auctionFormData.end_time}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, end_time: e.target.value}))}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Images (Up to 4)</label>
                            <div className="grid grid-cols-2 gap-2">
                              {[0, 1, 2, 3].map((index) => (
                                <div key={index}>
                                  <Input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => {
                                      const file = e.target.files[0];
                                      if (file) {
                                        handleImageChange(index, file, 'auction');
                                      }
                                      e.target.value = ''; // Clear input to allow re-selecting same file
                                    }}
                                    className="w-full text-sm"
                                  />
                                  {auctionImages[index] && (
                                    <p className="text-xs text-gray-500 mt-1">
                                      {auctionImages[index].name} 
                                      {auctionImages[index].size && ` (${(auctionImages[index].size / 1024 / 1024).toFixed(2)}MB)`}
                                    </p>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                        <div className="col-span-2 flex justify-end gap-2 mt-6">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={() => {
                              setShowAuctionForm(false);
                              setEditingAuction(null);
                              setAuctionSelectedCategoryName('');
                              setAuctionSelectedSubcategoryId('');
                              setAuctionSelectedItemCategoryId('');
                              setAuctionSelectedLocations(new Set());
                              setAuctionExpandedProvinces(new Set());
                              setAuctionExpandedDistricts(new Set());
                              setAuctionExpandedLocalLevels(new Set());
                              setAuctionFormData({
                                user_id: '',
                                category_id: '',
                                location_id: '',
                                title: '',
                                description: '',
                                starting_price: '',
                                reserve_price: '',
                                buy_now_price: '',
                                bid_increment: '1.00',
                                start_time: '',
                                end_time: '',
                              });
                              setAuctionImages([null, null, null, null]);
                            }}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">{editingAuction ? 'Update Auction' : 'Create Auction'}</Button>
                        </div>
                      </form>
                      </div>
                    )}
                    </CardContent>
                  </Card>
                  </section>

              {/* Auctions List Table */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">All Auctions</h2>
                    {auctionsLoading ? (
                      <div className="text-center py-8">Loading auctions...</div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                          <thead>
                            <tr className="border-b border-[hsl(var(--border))]">
                              <th className="text-left p-3 text-sm font-semibold">S.N.</th>
                              <th className="text-left p-3 text-sm font-semibold">Title</th>
                              <th className="text-left p-3 text-sm font-semibold">User</th>
                              <th className="text-left p-3 text-sm font-semibold">Current Bid</th>
                              <th className="text-left p-3 text-sm font-semibold">Bids</th>
                              <th className="text-left p-3 text-sm font-semibold">Status</th>
                              <th className="text-left p-3 text-sm font-semibold">End Time</th>
                              <th className="text-left p-3 text-sm font-semibold">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {auctions.length === 0 ? (
                              <tr>
                                <td colSpan="8" className="p-8 text-center text-gray-500">
                                  No auctions found
                                </td>
                              </tr>
                            ) : (
                              auctions.map((auction, index) => (
                                <tr key={auction.id} className="border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))]/30 transition-colors">
                                  <td className="p-3 text-sm">{index + 1}</td>
                                  <td className="p-3 text-sm">
                                    <div className="max-w-xs truncate" title={auction.title}>
                                      {auction.title}
                                    </div>
                                  </td>
                                  <td className="p-3 text-sm">{auction.user?.name || 'N/A'}</td>
                                  <td className="p-3 text-sm">Rs. {auction.current_bid_price?.toLocaleString() || auction.starting_price?.toLocaleString()}</td>
                                  <td className="p-3 text-sm">{auction.bid_count || 0}</td>
                                  <td className="p-3 text-sm">
                                    <span className={`px-2 py-1 rounded text-xs ${
                                      auction.status === 'active' ? 'bg-green-100 text-green-800' :
                                      auction.status === 'ended' ? 'bg-gray-100 text-gray-800' :
                                      auction.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                                      'bg-yellow-100 text-yellow-800'
                                    }`}>
                                      {auction.status}
                                    </span>
                                  </td>
                                  <td className="p-3 text-sm">
                                    {auction.end_time ? (
                                      <>
                                        {new Date(auction.end_time).toLocaleString()}
                                        <span className="text-xs text-gray-500 ml-2">
                                          ({getUserTimezone()})
                                        </span>
                                      </>
                                    ) : 'N/A'}
                                  </td>
                                  <td className="p-3 text-sm">
                                    <div className="flex gap-2">
                                      {auction.status === 'pending' || auction.status === 'active' ? (
                                        <Button
                                          variant="outline"
                                          size="sm"
                                          onClick={() => handleEditAuction(auction)}
                                          title={auction.status === 'active' ? 'Edit end time only' : 'Edit auction'}
                                        >
                                          Edit
                                        </Button>
                                      ) : (
                                        <Button
                                          variant="outline"
                                          size="sm"
                                          disabled
                                          title={`Cannot edit auction with status: ${auction.status}. Only pending or active auctions can be edited.`}
                                        >
                                          Edit
                                        </Button>
                                      )}
                                      {(auction.status === 'pending' || auction.status === 'active') && (
                                        <Button
                                          variant="outline"
                                          size="sm"
                                          onClick={() => handleCancelAuction(auction.id)}
                                          className="bg-orange-50 hover:bg-orange-100 text-orange-700 border-orange-300"
                                        >
                                          Cancel
                                        </Button>
                                      )}
                                      {auction.status === 'active' && (
                                        <Button
                                          variant="outline"
                                          size="sm"
                                          onClick={() => handleEndAuction(auction.id)}
                                        >
                                          End
                                        </Button>
                                      )}
                                      <Button
                                        variant="destructive"
                                        size="sm"
                                        onClick={() => handleDeleteAuction(auction.id)}
                                      >
                                        Delete
                                      </Button>
              </div>
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </section>

              {biddingHistoryLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading bidding history...
                </div>
              )}

              {/* Edit Auction Modal */}
              {showEditAuctionModal && editingAuction && (
                <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
                  <Card className="w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <CardHeader className="flex flex-row items-center justify-between">
                      <CardTitle>Edit Auction</CardTitle>
                      <Button variant="ghost" size="sm" onClick={() => {
                        setShowEditAuctionModal(false);
                        setEditingAuction(null);
                        // Reset auction category selection state
                        setAuctionSelectedCategoryName('');
                        setAuctionSelectedSubcategoryId('');
                        setAuctionSelectedItemCategoryId('');
                        setAuctionFormData({
                          user_id: '',
                          category_id: '',
                          location_id: '',
                          title: '',
                          description: '',
                          starting_price: '',
                          reserve_price: '',
                          buy_now_price: '',
                          bid_increment: '1.00',
                          start_time: '',
                          end_time: '',
                        });
                        setAuctionImages([null, null, null, null]);
                      }}></Button>
                    </CardHeader>
                    <CardContent className="p-6">
                      {editingAuction?.status === 'active' ? (
                        // For active auctions, only show end_time field
                        <form onSubmit={handleStartAuctionSubmit}>
                          <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <p className="text-sm text-yellow-800">
                              <strong>Note:</strong> For active auctions, only the end time can be modified. You can extend or shorten the auction duration.
                            </p>
                          </div>
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction End Date and Time *</label>
                              <Input
                                type="datetime-local"
                                value={auctionFormData.end_time}
                                onChange={(e) => setAuctionFormData(prev => ({...prev, end_time: e.target.value}))}
                                className="w-full"
                                required
                              />
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                              <Button
                                type="button"
                                variant="ghost"
                                onClick={() => {
                                  setShowEditAuctionModal(false);
                                  setEditingAuction(null);
                                  setAuctionFormData({
                                    user_id: '',
                                    category_id: '',
                                    location_id: '',
                                    title: '',
                                    description: '',
                                    starting_price: '',
                                    reserve_price: '',
                                    buy_now_price: '',
                                    bid_increment: '1.00',
                                    start_time: '',
                                    end_time: '',
                                  });
                                  setAuctionImages([null, null, null, null]);
                                }}
                              >
                                Cancel
                              </Button>
                              <Button type="submit">Update End Time</Button>
                            </div>
                          </div>
                        </form>
                      ) : (
                        // For pending auctions, show full form
                        <form 
                          className="grid grid-cols-2 gap-4"
                          onSubmit={handleStartAuctionSubmit}
                        >
                          {/* Left Column */}
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">User *</label>
                            <select
                              value={auctionFormData.user_id}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, user_id: e.target.value}))}
                              className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            >
                              <option value="">Select User</option>
                              {Array.isArray(users) && users.map((user) => (
                                <option key={user.id} value={user.id}>
                                  {user.name} ({user.email})
                                </option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction Item Name (Title) * (Max 90 characters)</label>
                            <Input
                              value={auctionFormData.title}
                              onChange={(e) => {
                                const value = e.target.value;
                                if (value.length <= 90) {
                                  setAuctionFormData(prev => ({...prev, title: value}));
                                }
                              }}
                              className="w-full"
                              maxLength={90}
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {auctionFormData.title.length}/90 characters
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Description * (Max 300 words)</label>
                            <textarea
                              value={auctionFormData.description}
                              onChange={(e) => {
                                const value = e.target.value;
                                const wordCount = value.trim() ? value.trim().split(/\s+/).length : 0;
                                if (wordCount <= 300) {
                                  setAuctionFormData(prev => ({...prev, description: value}));
                                }
                              }}
                              className="w-full min-h-[100px] px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {auctionFormData.description.trim() ? auctionFormData.description.trim().split(/\s+/).length : 0}/300 words
                            </p>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Starting Price *</label>
                            <Input
                              type="number"
                              value={auctionFormData.starting_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, starting_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                              required
                            />
                          </div>
                        </div>

                        {/* Right Column */}
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Category/Subcategory *</label>
                            <div className="relative" ref={auctionCategoryDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setAuctionShowCategoryDropdown(!auctionShowCategoryDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                            >
                                <span>{buildAuctionCategoryString() || 'Select Category'}</span>
                                <span className="ml-2">{auctionShowCategoryDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Hierarchical Category Menu - Matching Post Ad dropdown design */}
                              {auctionShowCategoryDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                  <div className="p-3">
                                    <div className="space-y-1">
                                      {categories.map((category) => {
                                        const subcategories = category.subcategories || [];
                                        const hasSubcategories = subcategories.length > 0;
                                        // Use category name as key for expansion (matching Post Ad dropdown behavior)
                                        const categoryName = (category.name || '').trim();
                                        const isCategoryExpanded = categoryName ? auctionExpandedCategories.has(categoryName) : false;
                                        
                                        // Check if this category is selected
                                        const isCategorySelected = auctionSelectedCategoryName === categoryName && !auctionSelectedSubcategoryId && !auctionSelectedItemCategoryId;
                                        
                                        return (
                                          <div key={category.id} className="space-y-1">
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center space-x-2 flex-1">
                                                {hasSubcategories ? (
                                                  <div className="flex items-center space-x-2 flex-1">
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        toggleAuctionCategory(categoryName);
                                                      }}
                                                      className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                    >
                                                      {isCategoryExpanded ? '' : ''}
                                                    </button>
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleAuctionCategorySelect(category.id, categoryName);
                                                      }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                      }`}
                                                    >
                                  {category.name}
                                                    </button>
                                                  </div>
                                                ) : (
                                                  <button
                                                    type="button"
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      handleAuctionCategorySelect(category.id, categoryName);
                                                    }}
                                                    className={`flex-1 text-left text-sm ${
                                                      isCategorySelected
                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                        : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                    }`}
                                                  >
                                                    {category.name}
                                                  </button>
                                                )}
                                              </div>
                                            </div>
                                            
                                            {/* Show subcategories when expanded */}
                                            {hasSubcategories && isCategoryExpanded && (
                                              <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                {subcategories.map((subcategory) => {
                                                  const itemCategories = subcategory.item_categories || [];
                                                  const hasItemCategories = itemCategories.length > 0;
                                                  const subcategoryName = (subcategory.name || '').trim();
                                                  const isSubcategoryExpanded = subcategoryName ? auctionExpandedSubcategories.has(subcategoryName) : false;
                                                  
                                                  // Check if this subcategory is selected
                                                  const subcategoryIdStr = subcategory.id.toString();
                                                  const isSubcategorySelected = auctionSelectedSubcategoryId === subcategoryIdStr && !auctionSelectedItemCategoryId;
                                                  
                                                  return (
                                                    <div key={subcategory.id} className="space-y-1">
                                                      <div className="flex items-center justify-between">
                                                        <div className="flex items-center space-x-2 flex-1">
                                                          {hasItemCategories ? (
                                                            <div className="flex items-center space-x-2 flex-1">
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  toggleAuctionSubcategory(subcategoryName);
                                                                }}
                                                                className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                              >
                                                                {isSubcategoryExpanded ? '' : ''}
                                                              </button>
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handleAuctionSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                }`}
                                                              >
                                                                {subcategory.name}
                                                              </button>
                                                            </div>
                                                          ) : (
                                                            <button
                                                              type="button"
                                                              onClick={(e) => {
                                                                e.stopPropagation();
                                                                handleAuctionSubcategorySelect(subcategory.id, subcategoryName);
                                                              }}
                                                              className={`flex-1 text-left text-sm ${
                                                                isSubcategorySelected
                                                                  ? 'text-[hsl(var(--primary))] font-medium'
                                                                  : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                              }`}
                                                            >
                                                              {subcategory.name}
                                                            </button>
                                                          )}
                                                        </div>
                                                      </div>
                                                      
                                                      {/* Show item categories when subcategory is expanded */}
                                                      {hasItemCategories && isSubcategoryExpanded && (
                                                        <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                          {itemCategories.map((itemCategory) => {
                                                            const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                            const itemCategoryIdStr = itemCategory.id.toString();
                                                            const isItemCategorySelected = auctionSelectedItemCategoryId === itemCategoryIdStr;
                                                            
                                                            return (
                                                              <div key={itemCategory.id} className="flex items-center justify-between">
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleAuctionItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                  }}
                                                                  className={`flex-1 text-left text-xs ${
                                                                    isItemCategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                  }`}
                                                                >
                                                                  {itemCategoryName}
                                                                </button>
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                      )}
                                                    </div>
                                                  );
                                                })}
                                              </div>
                                            )}
                                          </div>
                                        );
                                      })}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Location (Optional)</label>
                            <div className="relative" ref={auctionLocationDropdownRef}>
                              <button
                                type="button"
                                onClick={() => setAuctionShowLocationDropdown(!auctionShowLocationDropdown)}
                                className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                            >
                                <span>{buildAuctionLocationString()}</span>
                                <span className="ml-2">{auctionShowLocationDropdown ? '' : ''}</span>
                              </button>
                              
                              {/* Hierarchical Checkbox Menu - Same design as Post Ad */}
                              {auctionShowLocationDropdown && (
                                <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[600px] max-h-[500px] overflow-y-auto">
                                  <div className="p-3">
                                    <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                      <span className="font-semibold text-sm text-[hsl(var(--foreground))]">Select Location</span>
                                      <button
                                        type="button"
                                        onClick={handleAuctionSelectAllLocations}
                                        className="text-xs text-[hsl(var(--primary))] hover:underline"
                                      >
                                        {auctionSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                      </button>
                                    </div>
                                    
                                    {/* Hierarchical Location Tree */}
                                    <div className="space-y-1">
                                      {locationData?.provinces && locationData.provinces.length > 0 ? (
                                        locationData.provinces.map((province) => (
                                        <div key={province.id} className="border-b border-[hsl(var(--border))] pb-1 mb-1">
                                          {/* Province Level */}
                                          <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                            <button
                                              type="button"
                                              onClick={() => toggleAuctionProvince(province.id)}
                                              className="mr-2 text-xs"
                                            >
                                              {auctionExpandedProvinces.has(province.id) ? '' : ''}
                                            </button>
                                            <input
                                              type="checkbox"
                                              className="mr-2"
                                              checked={(() => {
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                              })()}
                                              onChange={() => {
                                                // Single selection: collect all location IDs and select first ward
                                                const allLocationIds = [];
                                                province.districts.forEach(d => {
                                                  d.localLevels.forEach(ll => {
                                                    if (ll.wards) {
                                                      ll.wards.forEach(w => {
                                                        allLocationIds.push(w.id.toString());
                                                        if (w.local_addresses && w.local_addresses.length > 0) {
                                                          w.local_addresses.forEach((_, idx) => {
                                                            allLocationIds.push(`${w.id}-${idx}`);
                                                          });
                                                        }
                                                      });
                                                    }
                                                  });
                                                });
                                                handleAuctionParentToggle(allLocationIds);
                                              }}
                                            />
                                            <span className="text-sm font-medium text-[hsl(var(--foreground))]">{province.name}</span>
                                          </div>
                                          
                                          {/* Districts */}
                                          {auctionExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                            <div key={district.id} className="ml-6 mt-1">
                                              <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                <button
                                                  type="button"
                                                  onClick={() => toggleAuctionDistrict(`${province.id}-${district.id}`)}
                                                  className="mr-2 text-xs"
                                                >
                                                  {auctionExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                                </button>
                                                <input
                                                  type="checkbox"
                                                  className="mr-2"
                                                  checked={(() => {
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                                  })()}
                                                  onChange={() => {
                                                    // Single selection: collect all location IDs and select first ward
                                                    const allLocationIds = [];
                                                    district.localLevels.forEach(ll => {
                                                      if (ll.wards) {
                                                        ll.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                      }
                                                    });
                                                    handleAuctionParentToggle(allLocationIds);
                                                  }}
                                                />
                                                <span className="text-sm text-[hsl(var(--foreground))]">{district.name}</span>
                                              </div>
                                              
                                              {/* Local Levels */}
                                              {auctionExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                                <div key={localLevel.id} className="ml-6 mt-1">
                                                  <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                    <button
                                                      type="button"
                                                      onClick={() => toggleAuctionLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                                      className="mr-2 text-xs"
                                                    >
                                                      {auctionExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                                    </button>
                                                    <input
                                                      type="checkbox"
                                                      className="mr-2"
                                                      checked={(() => {
                                                        if (!localLevel.wards) return false;
                                                        const allLocationIds = [];
                                                        localLevel.wards.forEach(w => {
                                                          allLocationIds.push(w.id.toString());
                                                          if (w.local_addresses && w.local_addresses.length > 0) {
                                                            w.local_addresses.forEach((_, idx) => {
                                                              allLocationIds.push(`${w.id}-${idx}`);
                                                            });
                                                          }
                                                        });
                                                        // For single selection: parent is checked only if ALL children are selected
                                                // Ensure all IDs are strings for consistent comparison
                                                return allLocationIds.length > 0 && allLocationIds.every(id => {
                                                  const idStr = id.toString();
                                                  return auctionSelectedLocations.has(idStr);
                                                });
                                                      })()}
                                                      onChange={() => {
                                                        if (localLevel.wards) {
                                                          // Single selection: collect all location IDs and select first ward
                                                          const allLocationIds = [];
                                                          localLevel.wards.forEach(w => {
                                                            allLocationIds.push(w.id.toString());
                                                            if (w.local_addresses && w.local_addresses.length > 0) {
                                                              w.local_addresses.forEach((_, idx) => {
                                                                allLocationIds.push(`${w.id}-${idx}`);
                                                              });
                                                            }
                                                          });
                                                          handleAuctionParentToggle(allLocationIds);
                                                        }
                                                      }}
                                                    />
                                                    <span className="text-sm text-[hsl(var(--foreground))]">
                                                      {localLevel.name} ({localLevel.type === 'municipality' ? 'M' : 'RM'})
                                                    </span>
                                                  </div>
                                                  
                                                  {/* Wards and Local Addresses */}
                                                  {auctionExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                                    <div key={ward.id} className="ml-6 mt-1">
                                                      <div className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                        <input
                                                          type="checkbox"
                                                          className="mr-2"
                                                          checked={(() => {
                                                            // Check if ward ID and ALL local addresses are selected
                                                            const allIds = [ward.id.toString()];
                                                            if (ward.local_addresses && ward.local_addresses.length > 0) {
                                                              ward.local_addresses.forEach((_, idx) => {
                                                                allIds.push(`${ward.id}-${idx}`);
                                                              });
                                                            }
                                                            // Ensure all IDs are strings for consistent comparison
                                                            return allIds.length > 0 && allIds.every(id => {
                                                              const idStr = id.toString();
                                                              return auctionSelectedLocations.has(idStr);
                                                            });
                                                          })()}
                                                          onChange={() => {
                                                            handleAuctionWardToggle(ward);
                                                          }}
                                                        />
                                                        <span className="text-sm text-[hsl(var(--foreground))]">
                                                          Ward {ward.ward_number}
                                                        </span>
                                                      </div>
                                                      
                                                      {/* Local Addresses */}
                                                      {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                        <div className="ml-6 mt-1 space-y-1">
                                                          {ward.local_addresses.map((address, idx) => {
                                                            const addressId = `${ward.id}-${idx}`;
                                                            return (
                                                              <div key={addressId} className="flex items-center py-1 hover:bg-[hsl(var(--accent))] rounded px-2">
                                                                <input
                                                                  type="checkbox"
                                                                  className="mr-2"
                                                                  checked={auctionSelectedLocations.has(addressId.toString())}
                                                                  onChange={() => handleAuctionLocationToggle(addressId)}
                                                                />
                                                                <span className="text-xs text-[hsl(var(--muted-foreground))]">{address}</span>
                                                              </div>
                                                            );
                                                          })}
                                                        </div>
                                                      )}
                                                    </div>
                                                  ))}
                                                </div>
                                              ))}
                                            </div>
                                          ))}
                                        </div>
                                      ))
                                      ) : (
                                        <div className="p-4 text-center text-sm text-[hsl(var(--muted-foreground))]">
                                          No locations available. Please add locations first.
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Reserve Price (Optional)</label>
                            <Input
                              type="number"
                              value={auctionFormData.reserve_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, reserve_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Buy Now Price (Optional)</label>
                            <Input
                              type="number"
                              value={auctionFormData.buy_now_price}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, buy_now_price: e.target.value}))}
                              className="w-full"
                              min="0"
                              step="0.01"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Bid Increment *</label>
                            <Input
                              type="number"
                              value={auctionFormData.bid_increment}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, bid_increment: e.target.value}))}
                              className="w-full"
                              min="0.01"
                              step="0.01"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction Start Date and Time *</label>
                            <Input
                              type="datetime-local"
                              value={auctionFormData.start_time}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, start_time: e.target.value}))}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Auction End Date and Time *</label>
                            <Input
                              type="datetime-local"
                              value={auctionFormData.end_time}
                              onChange={(e) => setAuctionFormData(prev => ({...prev, end_time: e.target.value}))}
                              className="w-full"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Images (Up to 4)</label>
                            <div className="grid grid-cols-2 gap-2">
                              {[0, 1, 2, 3].map((index) => (
                                <div key={index}>
                                  <Input
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => {
                                      const file = e.target.files[0];
                                      if (file) {
                                        handleImageChange(index, file, 'auction');
                                      }
                                      e.target.value = ''; // Clear input to allow re-selecting same file
                                    }}
                                    className="w-full text-sm"
                                  />
                                  {auctionImages[index] && (
                                    <p className="text-xs text-gray-500 mt-1">
                                      {auctionImages[index].name} 
                                      {auctionImages[index].size && ` (${(auctionImages[index].size / 1024 / 1024).toFixed(2)}MB)`}
                                    </p>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                        <div className="col-span-2 flex justify-end gap-2 mt-6">
                          <Button
                            type="button"
                            variant="ghost"
                            onClick={() => {
                              setShowEditAuctionModal(false);
                              setEditingAuction(null);
                              setAuctionFormData({
                                user_id: '',
                                category_id: '',
                                location_id: '',
                                title: '',
                                description: '',
                                starting_price: '',
                                reserve_price: '',
                                buy_now_price: '',
                                bid_increment: '1.00',
                                start_time: '',
                                end_time: '',
                              });
                              setAuctionImages([null, null, null, null]);
                            }}
                          >
                            Cancel
                          </Button>
                          <Button type="submit">Update Auction</Button>
                        </div>
                      </form>
                      )}
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* Bidding history tracking Table */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Bidding history tracking:</h2>
                    
                    {/* Auction Selection Filter */}
                    {availableAuctions.length > 0 && (
                      <div className="mb-4 flex items-center gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-1 text-[hsl(var(--foreground))]">Auction</label>
                          <select
                            value={selectedAuctionIds.length > 0 ? selectedAuctionIds[0] : 'all'}
                            onChange={(e) => {
                              if (e.target.value === 'all') {
                                setSelectedAuctionIds(availableAuctions.map(a => a.id));
                              } else {
                                setSelectedAuctionIds([parseInt(e.target.value)]);
                              }
                            }}
                            className="px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                          >
                            <option value="all">All Auctions</option>
                            {availableAuctions.map(auction => (
                              <option key={auction.id} value={auction.id}>
                                {auction.title} ({auction.bidCount || 0} bids)
                              </option>
                            ))}
                          </select>
                        </div>
                      </div>
                    )}
                    
                    {biddingHistoryGrouped.length > 0 ? (
                      // Filter and display selected auctions in a single table
                      (() => {
                        // Filter grouped data by selected auction IDs
                        // If "all" is selected or all auctions are selected, show all
                        const filteredGroups = (selectedAuctionIds.length === 0 || selectedAuctionIds.length === availableAuctions.length)
                          ? biddingHistoryGrouped
                          : biddingHistoryGrouped.filter(group => selectedAuctionIds.includes(group.auctionId));
                        
                        // Flatten all bidding history from selected auctions
                        const allBids = filteredGroups.flatMap(group => 
                          group.biddingHistory.map(bid => ({
                            ...bid,
                            auctionTitle: group.auctionTitle,
                            auctionId: group.auctionId
                          }))
                        );
                        
                        return (
                          <div className="overflow-x-auto">
                            <table className="w-full border-collapse">
                              <thead>
                                <tr className="border-b border-[hsl(var(--border))] bg-[hsl(var(--muted))]">
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Auction</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bid Amount</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Reserve Price</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Buy Now Price</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment Method</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Start Date Time</th>
                                  <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                                </tr>
                              </thead>
                              <tbody>
                                {allBids.length === 0 ? (
                                  <tr>
                                    <td colSpan="9" className="p-8 text-center text-[hsl(var(--muted-foreground))]">
                                      No bidding history found for selected auctions
                                    </td>
                                  </tr>
                                ) : (
                                  allBids.map((bid, index) => (
                            <tr key={bid.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingBiddingHistoryId === bid.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{bid.auctionTitle || 'N/A'}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{bid.userName}</td>
                              <td className="p-3 text-sm">
                                {bid.bidAmount !== null && bid.bidAmount !== undefined ? (
                                  <span className="font-semibold text-[hsl(var(--primary))]">Rs. {bid.bidAmount.toLocaleString()}</span>
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">N/A</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingHistoryId === bid.id ? (
                                  <Input
                                    type="number"
                                    value={editingBiddingHistoryData.reservePrice}
                                    onChange={(e) => setEditingBiddingHistoryData({...editingBiddingHistoryData, reservePrice: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs. {bid.reservePrice.toLocaleString()}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingHistoryId === bid.id ? (
                                  <Input
                                    type="number"
                                    value={editingBiddingHistoryData.buyNowPrice}
                                    onChange={(e) => setEditingBiddingHistoryData({...editingBiddingHistoryData, buyNowPrice: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs. {bid.buyNowPrice.toLocaleString()}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingHistoryId === bid.id ? (
                                  <Input
                                    value={editingBiddingHistoryData.paymentMethod}
                                    onChange={(e) => setEditingBiddingHistoryData({...editingBiddingHistoryData, paymentMethod: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{bid.paymentMethod}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingHistoryId === bid.id ? (
                                  <Input
                                    type="datetime-local"
                                    value={editingBiddingHistoryData.startDateTime}
                                    onChange={(e) => setEditingBiddingHistoryData({...editingBiddingHistoryData, startDateTime: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(bid.startDateTime).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingBiddingHistoryId === bid.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveBiddingHistory(bid.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditBiddingHistory}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditBiddingHistory(bid)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteBiddingHistory(bid.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                                  ))
                                )}
                              </tbody>
                            </table>
                          </div>
                        );
                      })()
                    ) : (
                      // Fallback to flat view if no grouped data
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                          <thead>
                            <tr className="border-b border-[hsl(var(--border))]">
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item Name</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Reserve Price</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Buy Now Price</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment Method</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Start Date Time</th>
                              <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                            </tr>
                          </thead>
                          <tbody>
                            {biddingHistoryData.length === 0 ? (
                              <tr>
                                <td colSpan="8" className="p-8 text-center text-[hsl(var(--muted-foreground))]">
                                  No bidding history found
                                </td>
                              </tr>
                            ) : (
                              biddingHistoryData.map((bid, index) => (
                                <tr key={bid.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingBiddingHistoryId === bid.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                                  <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                                  <td className="p-3 text-sm text-[hsl(var(--foreground))]">{bid.userName}</td>
                                  <td className="p-3 text-sm">
                                    {bid.bidAmount !== null && bid.bidAmount !== undefined ? (
                                      <span className="font-semibold text-[hsl(var(--primary))]">Rs. {bid.bidAmount.toLocaleString()}</span>
                                    ) : (
                                      <span className="text-[hsl(var(--muted-foreground))]">N/A</span>
                                    )}
                                  </td>
                                  <td className="p-3 text-sm"><span className="font-semibold">Rs. {bid.reservePrice.toLocaleString()}</span></td>
                                  <td className="p-3 text-sm"><span className="font-semibold">Rs. {bid.buyNowPrice.toLocaleString()}</span></td>
                                  <td className="p-3 text-sm">{bid.paymentMethod}</td>
                                  <td className="p-3 text-sm"><span className="text-[hsl(var(--muted-foreground))]">{new Date(bid.startDateTime).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></td>
                                  <td className="p-3 text-sm">
                                    <div className="flex gap-2">
                                      <Button variant="outline" size="sm" className="h-7 px-2 text-xs" onClick={() => handleEditBiddingHistory(bid)}>Edit</Button>
                                      <Button variant="destructive" size="sm" className="h-7 px-2 text-xs" onClick={() => handleDeleteBiddingHistory(bid.id)}>Delete</Button>
                                    </div>
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </CardContent>
                </Card>
              </section>

              {bidWinnerLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading bid winners...
                </div>
              )}
              {/* Bid winner tracking Table */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Bid winner tracking</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bidding Item</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bid Start Date</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bid Won Date</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment Proceed Date</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Total Payment</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Seller Name</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Congratulation email send to the winner</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {bidWinnerData.length === 0 && !bidWinnerLoading ? (
                            <tr>
                              <td colSpan="10" className="p-8 text-center text-[hsl(var(--muted-foreground))]">
                                No bid winners found. Bid winners are created when auctions end and winners are determined.
                              </td>
                            </tr>
                          ) : (
                            bidWinnerData.map((winner, index) => (
                            <tr key={winner.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingBidWinnerId === winner.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{winner.userName}</td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <Input
                                    value={editingBidWinnerData.biddingItem}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, biddingItem: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{winner.biddingItem}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <Input
                                    type="date"
                                    value={editingBidWinnerData.bidStartDate}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, bidStartDate: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(winner.bidStartDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <Input
                                    type="date"
                                    value={editingBidWinnerData.bidWonDate}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, bidWonDate: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(winner.bidWonDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <Input
                                    type="date"
                                    value={editingBidWinnerData.paymentProceedDate}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, paymentProceedDate: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(winner.paymentProceedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <Input
                                    type="number"
                                    value={editingBidWinnerData.totalPayment}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, totalPayment: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs. {winner.totalPayment.toLocaleString()}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{winner.sellerName}</td>
                              <td className="p-3 text-sm">
                                {editingBidWinnerId === winner.id ? (
                                  <select
                                    value={editingBidWinnerData.emailSent ? 'Yes' : 'No'}
                                    onChange={(e) => setEditingBidWinnerData({...editingBidWinnerData, emailSent: e.target.value === 'Yes'})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                  </select>
                                ) : (
                                  <span>{winner.emailSent}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingBidWinnerId === winner.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveBidWinner(winner.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditBidWinner}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditBidWinner(winner)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteBidWinner(winner.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>

              {blockedUserLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading blocked users...
                </div>
              )}
              {/* Block or backlist user Table */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Block or backlist user who violate the rule:</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">User Name</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Email</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Address</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Date to block</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Reason to block</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {blockedUserData.length === 0 && !blockedUserLoading ? (
                            <tr>
                              <td colSpan="7" className="p-8 text-center text-[hsl(var(--muted-foreground))]">
                                No blocked users found. Block users who violate the rules using the User Management section.
                              </td>
                            </tr>
                          ) : (
                            blockedUserData.map((user, index) => (
                            <tr key={user.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingBlockedUserId === user.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{user.userName}</td>
                              <td className="p-3 text-sm">
                                {editingBlockedUserId === user.id ? (
                                  <Input
                                    type="email"
                                    value={editingBlockedUserData.email}
                                    onChange={(e) => setEditingBlockedUserData({...editingBlockedUserData, email: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{user.email}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBlockedUserId === user.id ? (
                                  <Input
                                    value={editingBlockedUserData.address}
                                    onChange={(e) => setEditingBlockedUserData({...editingBlockedUserData, address: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{user.address}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBlockedUserId === user.id ? (
                                  <Input
                                    type="date"
                                    value={editingBlockedUserData.dateToBlock}
                                    onChange={(e) => setEditingBlockedUserData({...editingBlockedUserData, dateToBlock: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(user.dateToBlock).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBlockedUserId === user.id ? (
                                  <Input
                                    value={editingBlockedUserData.reasonToBlock}
                                    onChange={(e) => setEditingBlockedUserData({...editingBlockedUserData, reasonToBlock: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{user.reasonToBlock}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingBlockedUserId === user.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveBlockedUser(user.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditBlockedUser}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditBlockedUser(user)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteBlockedUser(user.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>

              {biddingTrackingLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading bidding tracking...
                </div>
              )}
              {/* Bidding Tracking Table */}
              <section>
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Bidding Tracking:</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bid Winner Name</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Bid Won Item Name</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Payment Status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Pickup Status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Complete the Process(date time)</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Send alert to bid winner in case of pending status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {biddingTrackingData.length === 0 && !biddingTrackingLoading ? (
                            <tr>
                              <td colSpan="8" className="p-8 text-center text-[hsl(var(--muted-foreground))]">
                                No bidding tracking records found. Bidding tracking records are created when bid winners are processed.
                              </td>
                            </tr>
                          ) : (
                            biddingTrackingData.map((tracking, index) => (
                            <tr key={tracking.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingBiddingTrackingId === tracking.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <Input
                                    value={editingBiddingTrackingData.bidWinnerName}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, bidWinnerName: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{tracking.bidWinnerName}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <Input
                                    value={editingBiddingTrackingData.bidWonItemName}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, bidWonItemName: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{tracking.bidWonItemName}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <select
                                    value={editingBiddingTrackingData.paymentStatus}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, paymentStatus: e.target.value})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Pending">Pending</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Failed">Failed</option>
                                  </select>
                                ) : (
                                  <span>{tracking.paymentStatus}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <select
                                    value={editingBiddingTrackingData.pickupStatus}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, pickupStatus: e.target.value})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Not Started">Not Started</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Picked Up">Picked Up</option>
                                  </select>
                                ) : (
                                  <span>{tracking.pickupStatus}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <Input
                                    type="datetime-local"
                                    value={editingBiddingTrackingData.completeProcessDateTime || ''}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, completeProcessDateTime: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">
                                    {tracking.completeProcessDateTime 
                                      ? new Date(tracking.completeProcessDateTime).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                                      : '-'}
                                  </span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingBiddingTrackingId === tracking.id ? (
                                  <select
                                    value={editingBiddingTrackingData.alertSent ? 'Yes' : 'No'}
                                    onChange={(e) => setEditingBiddingTrackingData({...editingBiddingTrackingData, alertSent: e.target.value === 'Yes'})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                  </select>
                                ) : (
                                  <span>{tracking.alertSent}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingBiddingTrackingId === tracking.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveBiddingTracking(tracking.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditBiddingTracking}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditBiddingTracking(tracking)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteBiddingTracking(tracking.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>
            </>
          )}

          {activeSection === 'category-management' && (
            <section>
              {categoryManagementLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading categories...
                </div>
              )}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">Category Management</h2>
                    <Button variant="outline" onClick={() => setShowAddCategoryForm(!showAddCategoryForm)}>Add Category/subcategory</Button>
                  </div>

                  {/* Add Category Form - appears when Add Category/subcategory is clicked */}
                  <div
                    className={`mb-4 transition-all duration-400 ease-in-out ${
                      showAddCategoryForm 
                        ? 'opacity-100 translate-y-0' 
                        : 'opacity-0 -translate-y-4 pointer-events-none'
                    }`}
                    style={{
                      transition: 'opacity 0.4s ease-in-out, transform 0.4s ease-in-out'
                    }}
                  >
                    {showAddCategoryForm && (
                      <Card className="mb-4">
                        <CardContent className="p-6">
                          <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Add New Category (3-Level Hierarchy)</h3>
                          <form onSubmit={handleAddCategorySubmit} className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Domain Category *</label>
                              <Input
                                value={addCategoryFormData.domainCategoryName}
                                onChange={(e) => setAddCategoryFormData({...addCategoryFormData, domainCategoryName: e.target.value})}
                                className="w-full"
                                required
                                placeholder="e.g., Art & Craft"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Field Category (Optional)</label>
                              <Input
                                value={addCategoryFormData.fieldCategoryName}
                                onChange={(e) => setAddCategoryFormData({...addCategoryFormData, fieldCategoryName: e.target.value})}
                                className="w-full"
                                placeholder="e.g., Painting"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">Item Category (Optional)</label>
                              <Input
                                value={addCategoryFormData.itemCategoryName}
                                onChange={(e) => setAddCategoryFormData({...addCategoryFormData, itemCategoryName: e.target.value})}
                                className="w-full"
                                placeholder="e.g., Oil Painting"
                              />
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                              <Button
                                type="button"
                                variant="ghost"
                                onClick={() => {
                                  setShowAddCategoryForm(false);
                                  setAddCategoryFormData({
                                    domainCategoryName: '',
                                    fieldCategoryName: '',
                                    itemCategoryName: '',
                                  });
                                }}
                              >
                                Cancel
                              </Button>
                              <Button type="submit">Add Category</Button>
                            </div>
                          </form>
                        </CardContent>
                      </Card>
                    )}
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b border-[hsl(var(--border))]">
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Domain Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Field Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item Category</th>
                          <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {categoryManagementData.map((category, index) => (
                          <tr key={category.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingCategoryId === category.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                            <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                            <td className="p-3 text-sm">
                              {editingCategoryId === category.id ? (
                                <Input
                                  value={editingCategoryData.domainCategoryName}
                                  onChange={(e) => setEditingCategoryData({...editingCategoryData, domainCategoryName: e.target.value})}
                                  className="w-full text-sm"
                                />
                              ) : (
                                <span>{category.domainCategoryName}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingCategoryId === category.id ? (
                                <Input
                                  value={editingCategoryData.fieldCategoryName || ''}
                                  onChange={(e) => setEditingCategoryData({...editingCategoryData, fieldCategoryName: e.target.value})}
                                  className="w-full text-sm"
                                  placeholder="Field Category (optional)"
                                />
                              ) : (
                                <span>{category.fieldCategoryName || '-'}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              {editingCategoryId === category.id ? (
                                <Input
                                  value={editingCategoryData.itemCategoryName || ''}
                                  onChange={(e) => setEditingCategoryData({...editingCategoryData, itemCategoryName: e.target.value})}
                                  className="w-full text-sm"
                                  placeholder="Item Category (optional)"
                                />
                              ) : (
                                <span>{category.itemCategoryName || '-'}</span>
                              )}
                            </td>
                            <td className="p-3 text-sm">
                              <div className="flex gap-2">
                                {editingCategoryId === category.id ? (
                                  <>
                                    <Button 
                                      variant="outline" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleSaveCategory(category.id)}
                                    >
                                      Save
                                    </Button>
                                    <Button 
                                      variant="ghost" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={handleCancelEditCategory}
                                    >
                                      Cancel
                                    </Button>
                                  </>
                                ) : (
                                  <>
                                    <Button 
                                      variant="outline" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleEditCategory(category)}
                                    >
                                      Edit
                                    </Button>
                                    <Button 
                                      variant="destructive" 
                                      size="sm" 
                                      className="h-7 px-2 text-xs"
                                      onClick={() => handleDeleteCategory(category.id)}
                                    >
                                      Delete
                                    </Button>
                                  </>
                                )}
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'ebook-management' && (
            <section>
              {ebookLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading eBooks...
                </div>
              )}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">E-Book Management</h2>
                    <Button variant="outline" onClick={() => setShowAddEbookForm(!showAddEbookForm)}>Add eBook</Button>
                  </div>

                  {showAddEbookForm && (
                    <Card className="mb-4">
                      <CardContent className="p-6">
                        <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Add New eBook</h3>
                        <form onSubmit={handleAddEbook} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label>User (Seller) *</Label>
                              <select
                                value={ebookFormData.user_id}
                                onChange={(e) => setEbookFormData({...ebookFormData, user_id: e.target.value})}
                                className="w-full px-3 py-2 border rounded-md"
                                required
                              >
                                <option value="">Select User</option>
                                {users.filter(u => u.role === 'super_admin' || (u.role !== 'admin' && u.seller_verified)).map(u => (
                                  <option key={u.id} value={u.id}>
                                    {u.name} ({u.email}) {u.role === 'super_admin' ? ' Super Admin' : ' Verified'}
                                  </option>
                                ))}
                              </select>
                              {users.filter(u => u.role === 'super_admin' || (u.role !== 'admin' && u.seller_verified)).length === 0 && (
                                <p className="text-sm text-red-500 mt-1">No users available. Please create a user first.</p>
                              )}
                            </div>
                            <div>
                              <Label>Category</Label>
                              <div className="relative" ref={ebookCategoryDropdownRef}>
                                <button
                                  type="button"
                                  onClick={() => setEbookShowCategoryDropdown(!ebookShowCategoryDropdown)}
                                  className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                                >
                                  <span>{buildEbookCategoryString() || 'Select Category'}</span>
                                  <span className="ml-2">{ebookShowCategoryDropdown ? '' : ''}</span>
                                </button>
                                
                                {/* Hierarchical Category Menu - Matching Post Ad dropdown design */}
                                {ebookShowCategoryDropdown && (
                                  <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                    <div className="p-3">
                                      <div className="space-y-1">
                                        {categories.map((category) => {
                                          const subcategories = category.subcategories || [];
                                          const hasSubcategories = subcategories.length > 0;
                                          // Use category name as key for expansion (matching Post Ad dropdown behavior)
                                          const categoryName = (category.name || '').trim();
                                          const isCategoryExpanded = categoryName ? ebookExpandedCategories.has(categoryName) : false;
                                          
                                          // Check if this category is selected
                                          const isCategorySelected = ebookSelectedCategoryName === categoryName && !ebookSelectedSubcategoryId && !ebookSelectedItemCategoryId;
                                          
                                          return (
                                            <div key={category.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasSubcategories ? (
                                                    <div className="flex items-center space-x-2 flex-1">
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          toggleEbookCategory(categoryName);
                                                        }}
                                                        className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                      >
                                                        {isCategoryExpanded ? '' : ''}
                                                      </button>
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          handleEbookCategorySelect(category.id, categoryName);
                                                        }}
                                                        className={`flex-1 text-left text-sm ${
                                                          isCategorySelected
                                                            ? 'text-[hsl(var(--primary))] font-medium'
                                                            : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                        }`}
                                                      >
                                                        {category.name}
                                                      </button>
                                                    </div>
                                                  ) : (
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleEbookCategorySelect(category.id, categoryName);
                                                      }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                      }`}
                                                    >
                                                      {category.name}
                                                    </button>
                                                  )}
                                                </div>
                                              </div>
                                              
                                              {/* Show subcategories when expanded */}
                                              {hasSubcategories && isCategoryExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {subcategories.map((subcategory) => {
                                                    const itemCategories = subcategory.item_categories || [];
                                                    const hasItemCategories = itemCategories.length > 0;
                                                    const subcategoryName = (subcategory.name || '').trim();
                                                    const isSubcategoryExpanded = subcategoryName ? ebookExpandedSubcategories.has(subcategoryName) : false;
                                                    
                                                    // Check if this subcategory is selected
                                                    const subcategoryIdStr = subcategory.id.toString();
                                                    const isSubcategorySelected = ebookSelectedSubcategoryId === subcategoryIdStr && !ebookSelectedItemCategoryId;
                                                    
                                                    return (
                                                      <div key={subcategory.id} className="space-y-1">
                                                        <div className="flex items-center justify-between">
                                                          <div className="flex items-center space-x-2 flex-1">
                                                            {hasItemCategories ? (
                                                              <div className="flex items-center space-x-2 flex-1">
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    toggleEbookSubcategory(subcategoryName);
                                                                  }}
                                                                  className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                                >
                                                                  {isSubcategoryExpanded ? '' : ''}
                                                                </button>
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleEbookSubcategorySelect(subcategory.id, subcategoryName);
                                                                  }}
                                                                  className={`flex-1 text-left text-sm ${
                                                                    isSubcategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                  }`}
                                                                >
                                                                  {subcategory.name}
                                                                </button>
                                                              </div>
                                                            ) : (
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handleEbookSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                }`}
                                                              >
                                                                {subcategory.name}
                                                              </button>
                                                            )}
                                                          </div>
                                                        </div>
                                                        
                                                        {/* Show item categories when subcategory is expanded */}
                                                        {hasItemCategories && isSubcategoryExpanded && (
                                                          <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                            {itemCategories.map((itemCategory) => {
                                                              const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                              const itemCategoryIdStr = itemCategory.id.toString();
                                                              const isItemCategorySelected = ebookSelectedItemCategoryId === itemCategoryIdStr;
                                                              
                                                              return (
                                                                <div key={itemCategory.id} className="flex items-center justify-between">
                                                                  <button
                                                                    type="button"
                                                                    onClick={(e) => {
                                                                      e.stopPropagation();
                                                                      handleEbookItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                    }}
                                                                    className={`flex-1 text-left text-xs ${
                                                                      isItemCategorySelected
                                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                                        : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                    }`}
                                                                  >
                                                                    {itemCategoryName}
                                                                  </button>
                                                                </div>
                                                              );
                                                            })}
                                                          </div>
                                                        )}
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                          <div>
                            <Label>Title *</Label>
                            <Input 
                              value={ebookFormData.title} 
                              onChange={(e) => {
                                const value = e.target.value;
                                if (value.length <= 90) {
                                  setEbookFormData({...ebookFormData, title: value});
                                }
                              }}
                              maxLength={90}
                              required 
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {ebookFormData.title.length}/90 characters
                            </p>
                          </div>
                          <div>
                            <Label>Description (Max 300 words)</Label>
                            <textarea 
                              value={ebookFormData.description} 
                              onChange={(e) => {
                                const value = e.target.value;
                                const wordCount = value.trim() ? value.trim().split(/\s+/).length : 0;
                                if (wordCount <= 300) {
                                  setEbookFormData({...ebookFormData, description: value});
                                }
                              }}
                              className="w-full px-3 py-2 border rounded-md" 
                              rows="3" 
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {ebookFormData.description.trim() ? ebookFormData.description.trim().split(/\s+/).length : 0}/300 words
                            </p>
                          </div>
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <Label>Writer</Label>
                              <Input value={ebookFormData.writer} onChange={(e) => setEbookFormData({...ebookFormData, writer: e.target.value})} />
                            </div>
                            <div>
                              <Label>Language</Label>
                              <Input value={ebookFormData.language} onChange={(e) => setEbookFormData({...ebookFormData, language: e.target.value})} />
                            </div>
                            <div>
                              <Label>Pages</Label>
                              <Input type="number" value={ebookFormData.pages} onChange={(e) => setEbookFormData({...ebookFormData, pages: e.target.value})} />
                            </div>
                          </div>
                          <div className="mt-4 space-y-2">
                            <p className="text-sm font-semibold text-[hsl(var(--foreground))]">Publisher Information (optional)</p>
                            <div className="grid grid-cols-2 gap-4">
                              <div className="col-span-2">
                                <Label>Publisher Name (Company or Person)</Label>
                                <Input
                                  value={ebookFormData.publisher_name}
                                  onChange={(e) => setEbookFormData({ ...ebookFormData, publisher_name: e.target.value })}
                                />
                              </div>
                              <div className="col-span-2">
                                <Label>Publisher Address</Label>
                                <textarea
                                  value={ebookFormData.publisher_address}
                                  onChange={(e) => setEbookFormData({ ...ebookFormData, publisher_address: e.target.value })}
                                  className="w-full px-3 py-2 border rounded-md"
                                  rows="2"
                                />
                              </div>
                              <div>
                                <Label>Publisher Email</Label>
                                <Input
                                  type="email"
                                  value={ebookFormData.publisher_email}
                                  onChange={(e) => setEbookFormData({ ...ebookFormData, publisher_email: e.target.value })}
                                />
                              </div>
                              <div>
                                <Label>Publisher Phone</Label>
                                <Input
                                  value={ebookFormData.publisher_phone}
                                  onChange={(e) => setEbookFormData({ ...ebookFormData, publisher_phone: e.target.value })}
                                />
                              </div>
                              <div className="col-span-2">
                                <Label>Publisher Website</Label>
                                <Input
                                  type="url"
                                  placeholder="https://example.com"
                                  value={ebookFormData.publisher_website}
                                  onChange={(e) => setEbookFormData({ ...ebookFormData, publisher_website: e.target.value })}
                                />
                              </div>
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label>Price *</Label>
                              <Input type="number" step="0.01" min="0" value={ebookFormData.price} onChange={(e) => setEbookFormData({...ebookFormData, price: e.target.value})} required />
                            </div>
                            <div>
                              <Label>Book Type *</Label>
                              <select value={ebookFormData.book_type} onChange={(e) => setEbookFormData({...ebookFormData, book_type: e.target.value})} className="w-full px-3 py-2 border rounded-md" required>
                                <option value="ebook">eBook</option>
                                <option value="hard_copy">Hard Copy</option>
                                <option value="both">Both</option>
                              </select>
                            </div>
                          </div>
                          <div>
                            <Label>eBook File * (PDF, EPUB, MOBI, DOC, DOCX)</Label>
                            <Input type="file" accept=".pdf,.epub,.mobi,.doc,.docx" onChange={(e) => setEbookFile(e.target.files[0])} required />
                          </div>
                          <div>
                            <Label>Cover Image</Label>
                            <Input 
                              type="file" 
                              accept="image/*" 
                              onChange={(e) => {
                                const file = e.target.files[0];
                                if (file) {
                                  // Validate file size (max 10MB before crop)
                                  if (file.size > 10 * 1024 * 1024) {
                                    setError('Image size must be less than 10MB');
                                    setTimeout(() => setError(null), 3000);
                                    return;
                                  }
                                  // Open crop modal for eBook cover
                                  setCropImageIndex('ebook-cover');
                                  setCropImageFile(file);
                                  setCropImageType('ebook-cover');
                                }
                                e.target.value = ''; // Clear input
                              }} 
                            />
                          </div>
                          <div>
                            <Label>
                              <input type="checkbox" checked={ebookFormData.copyright_declared} onChange={(e) => setEbookFormData({...ebookFormData, copyright_declared: e.target.checked})} />
                              {' '}Copyright Declared
                            </Label>
                          </div>
                          <div className="flex justify-end gap-2">
                            <Button type="button" variant="ghost" onClick={() => setShowAddEbookForm(false)}>Cancel</Button>
                            <Button type="submit">Add eBook</Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {editingEbookId && editingEbookData && (
                    <Card className="mb-4">
                      <CardContent className="p-6">
                        <h3 className="text-md font-semibold text-[hsl(var(--foreground))] mb-4">Edit eBook</h3>
                        <form
                          onSubmit={(e) => {
                            e.preventDefault();
                            handleSaveEbook();
                          }}
                          className="space-y-4"
                        >
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label>User (Seller) *</Label>
                              <select
                                value={editingEbookData.user_id || ''}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, user_id: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md"
                                required
                              >
                                <option value="">Select User</option>
                                {users
                                  .filter(u => u.role === 'super_admin' || (u.role !== 'admin' && u.seller_verified))
                                  .map(u => (
                                    <option key={u.id} value={u.id}>
                                      {u.name} ({u.email}) {u.role === 'super_admin' ? ' Super Admin' : ' Verified'}
                                    </option>
                                  ))}
                              </select>
                            </div>
                            <div>
                              <Label>Category</Label>
                              <div className="relative" ref={editingEbookCategoryDropdownRef}>
                                <button
                                  type="button"
                                  onClick={() => setEditingEbookShowCategoryDropdown(!editingEbookShowCategoryDropdown)}
                                  className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                                >
                                  <span>{buildEditingEbookCategoryString() || 'Select Category'}</span>
                                  <span className="ml-2">{editingEbookShowCategoryDropdown ? '' : ''}</span>
                                </button>
                                
                                {/* Hierarchical Category Menu - Matching Post Ad dropdown design */}
                                {editingEbookShowCategoryDropdown && (
                                  <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[325px] max-h-[500px] overflow-y-auto">
                                    <div className="p-3">
                                      <div className="space-y-1">
                                        {categories.map((category) => {
                                          const subcategories = category.subcategories || [];
                                          const hasSubcategories = subcategories.length > 0;
                                          // Use category name as key for expansion (matching Post Ad dropdown behavior)
                                          const categoryName = (category.name || '').trim();
                                          const isCategoryExpanded = categoryName ? editingEbookExpandedCategories.has(categoryName) : false;
                                          
                                          // Check if this category is selected
                                          const isCategorySelected = editingEbookSelectedCategoryName === categoryName && !editingEbookSelectedSubcategoryId && !editingEbookSelectedItemCategoryId;
                                          
                                          return (
                                            <div key={category.id} className="space-y-1">
                                              <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-2 flex-1">
                                                  {hasSubcategories ? (
                                                    <div className="flex items-center space-x-2 flex-1">
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          toggleEditingEbookCategory(categoryName);
                                                        }}
                                                        className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                      >
                                                        {isCategoryExpanded ? '' : ''}
                                                      </button>
                                                      <button
                                                        type="button"
                                                        onClick={(e) => {
                                                          e.stopPropagation();
                                                          handleEditingEbookCategorySelect(category.id, categoryName);
                                                        }}
                                                        className={`flex-1 text-left text-sm ${
                                                          isCategorySelected
                                                            ? 'text-[hsl(var(--primary))] font-medium'
                                                            : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                        }`}
                                                      >
                                                        {category.name}
                                                      </button>
                                                    </div>
                                                  ) : (
                                                    <button
                                                      type="button"
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleEditingEbookCategorySelect(category.id, categoryName);
                                                      }}
                                                      className={`flex-1 text-left text-sm ${
                                                        isCategorySelected
                                                          ? 'text-[hsl(var(--primary))] font-medium'
                                                          : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                      }`}
                                                    >
                                                      {category.name}
                                                    </button>
                                                  )}
                                                </div>
                                              </div>
                                              
                                              {/* Show subcategories when expanded */}
                                              {hasSubcategories && isCategoryExpanded && (
                                                <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                  {subcategories.map((subcategory) => {
                                                    const itemCategories = subcategory.item_categories || [];
                                                    const hasItemCategories = itemCategories.length > 0;
                                                    const subcategoryName = (subcategory.name || '').trim();
                                                    const isSubcategoryExpanded = subcategoryName ? editingEbookExpandedSubcategories.has(subcategoryName) : false;
                                                    
                                                    // Check if this subcategory is selected
                                                    const subcategoryIdStr = subcategory.id.toString();
                                                    const isSubcategorySelected = editingEbookSelectedSubcategoryId === subcategoryIdStr && !editingEbookSelectedItemCategoryId;
                                                    
                                                    return (
                                                      <div key={subcategory.id} className="space-y-1">
                                                        <div className="flex items-center justify-between">
                                                          <div className="flex items-center space-x-2 flex-1">
                                                            {hasItemCategories ? (
                                                              <div className="flex items-center space-x-2 flex-1">
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    toggleEditingEbookSubcategory(subcategoryName);
                                                                  }}
                                                                  className="text-xs text-[hsl(var(--muted-foreground))] px-1"
                                                                >
                                                                  {isSubcategoryExpanded ? '' : ''}
                                                                </button>
                                                                <button
                                                                  type="button"
                                                                  onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleEditingEbookSubcategorySelect(subcategory.id, subcategoryName);
                                                                  }}
                                                                  className={`flex-1 text-left text-sm ${
                                                                    isSubcategorySelected
                                                                      ? 'text-[hsl(var(--primary))] font-medium'
                                                                      : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                  }`}
                                                                >
                                                                  {subcategory.name}
                                                                </button>
                                                              </div>
                                                            ) : (
                                                              <button
                                                                type="button"
                                                                onClick={(e) => {
                                                                  e.stopPropagation();
                                                                  handleEditingEbookSubcategorySelect(subcategory.id, subcategoryName);
                                                                }}
                                                                className={`flex-1 text-left text-sm ${
                                                                  isSubcategorySelected
                                                                    ? 'text-[hsl(var(--primary))] font-medium'
                                                                    : 'text-[hsl(var(--foreground))] hover:text-[hsl(var(--primary))]'
                                                                }`}
                                                              >
                                                                {subcategory.name}
                                                              </button>
                                                            )}
                                                          </div>
                                                        </div>
                                                        
                                                        {/* Show item categories when subcategory is expanded */}
                                                        {hasItemCategories && isSubcategoryExpanded && (
                                                          <div className="ml-5 pl-2 border-l-2 border-[hsl(var(--border))] space-y-1 mt-1">
                                                            {itemCategories.map((itemCategory) => {
                                                              const itemCategoryName = itemCategory.item_category || itemCategory.name;
                                                              const itemCategoryIdStr = itemCategory.id.toString();
                                                              const isItemCategorySelected = editingEbookSelectedItemCategoryId === itemCategoryIdStr;
                                                              
                                                              return (
                                                                <div key={itemCategory.id} className="flex items-center justify-between">
                                                                  <button
                                                                    type="button"
                                                                    onClick={(e) => {
                                                                      e.stopPropagation();
                                                                      handleEditingEbookItemCategorySelect(itemCategory.id, categoryName, subcategory.id);
                                                                    }}
                                                                    className={`flex-1 text-left text-xs ${
                                                                      isItemCategorySelected
                                                                        ? 'text-[hsl(var(--primary))] font-medium'
                                                                        : 'text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))]'
                                                                    }`}
                                                                  >
                                                                    {itemCategoryName}
                                                                  </button>
                                                                </div>
                                                              );
                                                            })}
                                                          </div>
                                                        )}
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                          <div>
                            <Label>Title *</Label>
                            <Input
                              value={editingEbookData.title || ''}
                              onChange={(e) => {
                                const value = e.target.value;
                                if (value.length <= 90) {
                                  setEditingEbookData({ ...editingEbookData, title: value });
                                }
                              }}
                              maxLength={90}
                              required
                            />
                            <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                              {(editingEbookData.title || '').length}/90 characters
                            </p>
                          </div>
                          <div>
                            <Label>Description (Max 300 words)</Label>
                            <textarea
                              value={editingEbookData.description || ''}
                              onChange={(e) => {
                                const value = e.target.value;
                                const wordCount = value.trim() ? value.trim().split(/\s+/).length : 0;
                                if (wordCount <= 300) {
                                  setEditingEbookData({ ...editingEbookData, description: value });
                                }
                              }}
                              className="w-full px-3 py-2 border rounded-md"
                              rows="3"
                            />
                          </div>
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <Label>Writer</Label>
                              <Input
                                value={editingEbookData.writer || ''}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, writer: e.target.value })}
                              />
                            </div>
                            <div>
                              <Label>Language</Label>
                              <Input
                                value={editingEbookData.language || ''}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, language: e.target.value })}
                              />
                            </div>
                            <div>
                              <Label>Pages</Label>
                              <Input
                                type="number"
                                value={editingEbookData.pages || ''}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, pages: e.target.value })}
                              />
                            </div>
                          </div>
                          <div className="mt-4 space-y-2">
                            <p className="text-sm font-semibold text-[hsl(var(--foreground))]">Publisher Information (optional)</p>
                            <div className="grid grid-cols-2 gap-4">
                              <div className="col-span-2">
                                <Label>Publisher Name (Company or Person)</Label>
                                <Input
                                  value={editingEbookData.publisher_name || ''}
                                  onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_name: e.target.value })}
                                />
                              </div>
                              <div className="col-span-2">
                                <Label>Publisher Address</Label>
                                <textarea
                                  value={editingEbookData.publisher_address || ''}
                                  onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_address: e.target.value })}
                                  className="w-full px-3 py-2 border rounded-md"
                                  rows="2"
                                />
                              </div>
                              <div>
                                <Label>Publisher Email</Label>
                                <Input
                                  type="email"
                                  value={editingEbookData.publisher_email || ''}
                                  onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_email: e.target.value })}
                                />
                              </div>
                              <div>
                                <Label>Publisher Phone</Label>
                                <Input
                                  value={editingEbookData.publisher_phone || ''}
                                  onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_phone: e.target.value })}
                                />
                              </div>
                              <div className="col-span-2">
                                <Label>Publisher Website</Label>
                                <Input
                                  type="url"
                                  placeholder="https://example.com"
                                  value={editingEbookData.publisher_website || ''}
                                  onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_website: e.target.value })}
                                />
                              </div>
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label>Price *</Label>
                              <Input
                                type="number"
                                step="0.01"
                                min="0"
                                value={editingEbookData.price || ''}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, price: e.target.value })}
                                required
                              />
                            </div>
                            <div>
                              <Label>Book Type *</Label>
                              <select
                                value={editingEbookData.book_type || 'ebook'}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, book_type: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md"
                                required
                              >
                                <option value="ebook">eBook</option>
                                <option value="hard_copy">Hard Copy</option>
                                <option value="both">Both</option>
                              </select>
                            </div>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label>Replace eBook File (optional)</Label>
                              <Input
                                type="file"
                                accept=".pdf,.epub,.mobi,.doc,.docx"
                                onChange={(e) => setEbookFile(e.target.files[0])}
                              />
                            </div>
                            <div>
                              <Label>Replace Cover Image (optional) - 400x400px</Label>
                              <Input
                                type="file"
                                accept="image/*"
                                onChange={(e) => {
                                  const file = e.target.files[0];
                                  if (file) {
                                    // Validate file size (max 10MB before crop)
                                    if (file.size > 10 * 1024 * 1024) {
                                      setError('Image size must be less than 10MB');
                                      setTimeout(() => setError(null), 3000);
                                      return;
                                    }
                                    // Open crop modal for eBook cover
                                    setCropImageIndex('ebook-cover');
                                    setCropImageFile(file);
                                    setCropImageType('ebook-cover');
                                  }
                                  e.target.value = ''; // Clear input
                                }}
                              />
                            </div>
                          </div>
                          <div>
                            <Label>
                              <input
                                type="checkbox"
                                checked={!!editingEbookData.copyright_declared}
                                onChange={(e) => setEditingEbookData({ ...editingEbookData, copyright_declared: e.target.checked })}
                              />
                              {' '}Copyright Declared
                            </Label>
                          </div>
                          <div className="flex justify-end gap-2">
                            <Button type="button" variant="ghost" onClick={handleCancelEditEbook}>
                              Cancel
                            </Button>
                            <Button type="submit">
                              Save Changes
                            </Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="border-b">
                          <th className="text-left p-3 text-sm font-semibold">S.N.</th>
                          <th className="text-left p-3 text-sm font-semibold">Title</th>
                          <th className="text-left p-3 text-sm font-semibold">Writer</th>
                          <th className="text-left p-3 text-sm font-semibold">Price</th>
                          <th className="text-left p-3 text-sm font-semibold">Status</th>
                          <th className="text-left p-3 text-sm font-semibold">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {ebookData.map((ebook, index) => (
                          <tr key={ebook.id} className="border-b hover:bg-[hsl(var(--accent))]">
                            <td className="p-3 text-sm">{index + 1}</td>
                            <td className="p-3 text-sm">{ebook.title}</td>
                            <td className="p-3 text-sm">{ebook.writer || '-'}</td>
                            <td className="p-3 text-sm">Rs {parseFloat(ebook.price || 0).toFixed(2)}</td>
                            <td className="p-3 text-sm capitalize">{ebook.status}</td>
                            <td className="p-3 text-sm">
                              <div className="flex gap-2">
                                <Button variant="outline" size="sm" onClick={() => handleEditEbook(ebook)}>Edit</Button>
                                <Button variant="destructive" size="sm" onClick={() => handleDeleteEbook(ebook.id)}>Delete</Button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'change-password' && isSuperAdmin && (
            <section className="space-y-6">
              <Card>
                <CardContent className="p-6">
                  <div className="max-w-2xl mx-auto">
                    <h3 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-2">Change User Password</h3>
                    <p className="text-sm text-[hsl(var(--muted-foreground))] mb-6">
                      As super admin, you can change passwords for admin, user, and super admin accounts.
                    </p>
                    
                    <form onSubmit={handleChangePassword} className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">
                          Select User *
                        </label>
                        <select
                          value={changePasswordData.user_id}
                          onChange={(e) => setChangePasswordData({ ...changePasswordData, user_id: e.target.value })}
                          className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                          required
                        >
                          <option value="">-- Select a user --</option>
                          {users
                            .sort((a, b) => {
                              // Sort order: super_admin first, then admin, then others
                              const roleOrder = { 'super_admin': 1, 'admin': 2, 'user': 3 };
                              const aOrder = roleOrder[a.role] || 99;
                              const bOrder = roleOrder[b.role] || 99;
                              if (aOrder !== bOrder) {
                                return aOrder - bOrder;
                              }
                              // If same role, sort alphabetically by name
                              return a.name.localeCompare(b.name);
                            })
                            .map((user) => (
                              <option key={user.id} value={user.id}>
                                {user.name} ({user.email}) - {user.role}
                              </option>
                            ))}
                        </select>
                        <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                          You can change passwords for admin, user, and super admin accounts.
                        </p>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">
                          New Password *
                        </label>
                        <Input
                          type="password"
                          value={changePasswordData.new_password}
                          onChange={(e) => setChangePasswordData({ ...changePasswordData, new_password: e.target.value })}
                          placeholder="Enter new password (min 8 characters)"
                          required
                          minLength={8}
                          className="w-full"
                        />
                        <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">
                          Password must be at least 8 characters long
                        </p>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-[hsl(var(--foreground))] mb-1">
                          Confirm New Password *
                        </label>
                        <Input
                          type="password"
                          value={changePasswordData.new_password_confirmation}
                          onChange={(e) => setChangePasswordData({ ...changePasswordData, new_password_confirmation: e.target.value })}
                          placeholder="Confirm the new password"
                          required
                          minLength={8}
                          className="w-full"
                        />
                      </div>

                      <div className="flex justify-end gap-2 pt-4">
                        <Button
                          type="button"
                          variant="ghost"
                          onClick={() => {
                            setChangePasswordData({
                              user_id: '',
                              new_password: '',
                              new_password_confirmation: '',
                            });
                            setError(null);
                          }}
                          disabled={changingPassword}
                        >
                          Clear
                        </Button>
                        <Button type="submit" disabled={changingPassword || !changePasswordData.user_id}>
                          {changingPassword ? 'Changing Password...' : 'Change Password'}
                        </Button>
                      </div>
                    </form>
                  </div>
                </CardContent>
              </Card>
            </section>
          )}

          {activeSection === 'delivery-management' && (
            <>
              {deliveryLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading deliveries...
                </div>
              )}
              {/* Delivery Management Table */}
              <section className="mb-6">
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Delivery Management</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Seller/Vendor</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Delivery Status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Pick up date</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {deliveryData.map((delivery, index) => (
                            <tr key={delivery.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingDeliveryId === delivery.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{delivery.sellerVendor}</td>
                              <td className="p-3 text-sm">
                                {editingDeliveryId === delivery.id ? (
                                  <Input
                                    value={editingDeliveryData.item}
                                    onChange={(e) => setEditingDeliveryData({...editingDeliveryData, item: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{delivery.item}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingDeliveryId === delivery.id ? (
                                  <Input
                                    type="number"
                                    value={editingDeliveryData.price}
                                    onChange={(e) => setEditingDeliveryData({...editingDeliveryData, price: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs. {delivery.price.toLocaleString()}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingDeliveryId === delivery.id ? (
                                  <select
                                    value={editingDeliveryData.deliveryStatus}
                                    onChange={(e) => setEditingDeliveryData({...editingDeliveryData, deliveryStatus: e.target.value})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Pending">Pending</option>
                                    <option value="In Transit">In Transit</option>
                                    <option value="Delivered">Delivered</option>
                                  </select>
                                ) : (
                                  <span>{delivery.deliveryStatus}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingDeliveryId === delivery.id ? (
                                  <Input
                                    type="date"
                                    value={editingDeliveryData.pickupDate}
                                    onChange={(e) => setEditingDeliveryData({...editingDeliveryData, pickupDate: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(delivery.pickupDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingDeliveryId === delivery.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSaveDelivery(delivery.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditDelivery}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditDelivery(delivery)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeleteDelivery(delivery.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>

              {purchaseVerificationLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading purchase verifications...
                </div>
              )}
              {/* Purchase Verification info Table */}
              <section>
                <Card>
                  <CardContent className="p-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))] mb-4">Purchase Verification info:</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b border-[hsl(var(--border))]">
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">S.N.</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Buyer/User</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Item</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Price</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Purchase Date</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Purchase verification code</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Delivery Status</th>
                            <th className="text-left p-3 text-sm font-semibold text-[hsl(var(--foreground))]">Edit/Delete</th>
                          </tr>
                        </thead>
                        <tbody>
                          {purchaseVerificationData.map((purchase, index) => (
                            <tr key={purchase.id} className={`border-b border-[hsl(var(--border))] hover:bg-[hsl(var(--accent))] ${editingPurchaseVerificationId === purchase.id ? 'bg-[hsl(var(--accent))]' : ''}`}>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{index + 1}</td>
                              <td className="p-3 text-sm text-[hsl(var(--foreground))]">{purchase.buyerUser}</td>
                              <td className="p-3 text-sm">
                                {editingPurchaseVerificationId === purchase.id ? (
                                  <Input
                                    value={editingPurchaseVerificationData.item}
                                    onChange={(e) => setEditingPurchaseVerificationData({...editingPurchaseVerificationData, item: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span>{purchase.item}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingPurchaseVerificationId === purchase.id ? (
                                  <Input
                                    type="number"
                                    value={editingPurchaseVerificationData.price}
                                    onChange={(e) => setEditingPurchaseVerificationData({...editingPurchaseVerificationData, price: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="font-semibold">Rs. {purchase.price.toLocaleString()}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingPurchaseVerificationId === purchase.id ? (
                                  <Input
                                    type="date"
                                    value={editingPurchaseVerificationData.purchaseDate}
                                    onChange={(e) => setEditingPurchaseVerificationData({...editingPurchaseVerificationData, purchaseDate: e.target.value})}
                                    className="w-full text-sm"
                                  />
                                ) : (
                                  <span className="text-[hsl(var(--muted-foreground))]">{new Date(purchase.purchaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingPurchaseVerificationId === purchase.id ? (
                                  <Input
                                    value={editingPurchaseVerificationData.verificationCode}
                                    onChange={(e) => setEditingPurchaseVerificationData({...editingPurchaseVerificationData, verificationCode: e.target.value})}
                                    className="w-full text-sm font-mono"
                                  />
                                ) : (
                                  <span className="font-mono">{purchase.verificationCode}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                {editingPurchaseVerificationId === purchase.id ? (
                                  <select
                                    value={editingPurchaseVerificationData.deliveryStatus}
                                    onChange={(e) => setEditingPurchaseVerificationData({...editingPurchaseVerificationData, deliveryStatus: e.target.value})}
                                    className="px-2 py-1 text-sm border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))]"
                                  >
                                    <option value="Pending">Pending</option>
                                    <option value="In Transit">In Transit</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Failed">Failed</option>
                                  </select>
                                ) : (
                                  <span>{purchase.deliveryStatus}</span>
                                )}
                              </td>
                              <td className="p-3 text-sm">
                                <div className="flex gap-2">
                                  {editingPurchaseVerificationId === purchase.id ? (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleSavePurchaseVerification(purchase.id)}
                                      >
                                        Save
                                      </Button>
                                      <Button 
                                        variant="ghost" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={handleCancelEditPurchaseVerification}
                                      >
                                        Cancel
                                      </Button>
                                    </>
                                  ) : (
                                    <>
                                      <Button 
                                        variant="outline" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleEditPurchaseVerification(purchase)}
                                      >
                                        Edit
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        size="sm" 
                                        className="h-7 px-2 text-xs"
                                        onClick={() => handleDeletePurchaseVerification(purchase.id)}
                                      >
                                        Delete
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>
              </section>
            </>
          )}

          {/* Edit Offer Modal */}
          {showEditOfferModal && editingOfferData && editingOfferId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit Offer/Discount</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditOffer}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveOffer(editingOfferId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-item-name">Item Name *</Label>
                      <Input
                        id="edit-item-name"
                        value={editingOfferData.item_name}
                        onChange={(e) => setEditingOfferData({...editingOfferData, item_name: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-vendor-id">Vendor *</Label>
                      <select
                        id="edit-vendor-id"
                        value={editingOfferData.vendor_id}
                        onChange={(e) => setEditingOfferData({...editingOfferData, vendor_id: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        {users.filter(u => u.role === 'user' || u.role === 'vendor').map((user) => (
                          <option key={user.id} value={user.id}>{user.name}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <Label htmlFor="edit-offer-percentage">Offer Percentage *</Label>
                      <Input
                        id="edit-offer-percentage"
                        type="number"
                        step="0.01"
                        min="0"
                        max="100"
                        value={editingOfferData.offer_percentage}
                        onChange={(e) => setEditingOfferData({...editingOfferData, offer_percentage: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-created-date">Created Date</Label>
                      <Input
                        id="edit-created-date"
                        type="date"
                        value={editingOfferData.created_date}
                        onChange={(e) => setEditingOfferData({...editingOfferData, created_date: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-valid-until">Valid Until</Label>
                      <Input
                        id="edit-valid-until"
                        type="date"
                        value={editingOfferData.valid_until}
                        onChange={(e) => setEditingOfferData({...editingOfferData, valid_until: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-status">Status *</Label>
                      <select
                        id="edit-status"
                        value={editingOfferData.status}
                        onChange={(e) => setEditingOfferData({...editingOfferData, status: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                      </select>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditOffer}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Edit Stock Modal */}
          {showEditStockModal && editingStockData && editingStockId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit Stock Item</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditStock}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveStock(editingStockId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-stock-item-name">Item Name *</Label>
                      <Input
                        id="edit-stock-item-name"
                        value={editingStockData.item_name || ''}
                        onChange={(e) => setEditingStockData({...editingStockData, item_name: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-vendor-seller-id">Vendor/Seller *</Label>
                      <select
                        id="edit-vendor-seller-id"
                        value={editingStockData.vendor_seller_id || ''}
                        onChange={(e) => setEditingStockData({...editingStockData, vendor_seller_id: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        <option value="">Select Vendor/Seller</option>
                        {users.map((user) => (
                          <option key={user.id} value={user.id}>{user.name}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <Label>Category *</Label>
                      <div className="flex gap-2 mt-1">
                        <select
                          value={editingStockData.main_category_id || ''}
                          onChange={(e) => handleMainCategoryChange(e.target.value)}
                          className="flex-1 px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                          required
                        >
                          <option value="">Select Category</option>
                          {stockManagementMainCategories.map((cat) => (
                            <option key={cat.id} value={cat.id}>
                              {cat.name}
                            </option>
                          ))}
                        </select>
                        <select
                          value={editingStockData.category_id === editingStockData.main_category_id ? '' : (editingStockData.category_id || '')}
                          onChange={(e) => handleSubcategoryChange(e.target.value)}
                          className="flex-1 px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))]"
                          disabled={!editingStockData.main_category_id}
                        >
                          <option value="">Select Subcategory (Optional)</option>
                          {editingStockData.main_category_id && (() => {
                            const selectedMainCategory = stockManagementMainCategories.find(
                              c => c.id.toString() === editingStockData.main_category_id
                            );
                            if (!selectedMainCategory) return null;
                            const subcategories = stockManagementCategories.get(selectedMainCategory.name) || [];
                            return subcategories.length > 0 ? (
                              subcategories.map((subcat) => (
                                <option key={subcat.id} value={subcat.id}>
                                  {subcat.name}
                                </option>
                              ))
                            ) : null;
                          })()}
                        </select>
                      </div>
                    </div>
                    <div>
                      <Label htmlFor="edit-quantity">Quantity *</Label>
                      <Input
                        id="edit-quantity"
                        type="number"
                        min="0"
                        value={editingStockData.quantity || ''}
                        onChange={(e) => setEditingStockData({...editingStockData, quantity: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-sold-item-qty">Sold Item Quantity *</Label>
                      <Input
                        id="edit-sold-item-qty"
                        type="number"
                        min="0"
                        value={editingStockData.sold_item_qty || ''}
                        onChange={(e) => setEditingStockData({...editingStockData, sold_item_qty: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-low-stock-threshold">Low Stock Threshold *</Label>
                      <Input
                        id="edit-low-stock-threshold"
                        type="number"
                        min="0"
                        value={editingStockData.low_stock_threshold || ''}
                        onChange={(e) => setEditingStockData({...editingStockData, low_stock_threshold: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditStock}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Edit Support Modal */}
          {showEditSupportModal && editingSupportData && editingSupportId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit Support Issue</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditSupport}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveSupport(editingSupportId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-issue-error">Issue/Error *</Label>
                      <Input
                        id="edit-issue-error"
                        value={editingSupportData.issue_error || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, issue_error: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-issue-reporter-id">Issue Reporter ID</Label>
                      <Input
                        id="edit-issue-reporter-id"
                        type="number"
                        value={editingSupportData.issue_reporter_id || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, issue_reporter_id: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-date">Date</Label>
                      <Input
                        id="edit-date"
                        type="date"
                        value={editingSupportData.date || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, date: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-assign-to-id">Assign To ID</Label>
                      <Input
                        id="edit-assign-to-id"
                        type="number"
                        value={editingSupportData.assign_to_id || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, assign_to_id: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-assign-date">Assign Date</Label>
                      <Input
                        id="edit-assign-date"
                        type="date"
                        value={editingSupportData.assign_date || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, assign_date: e.target.value})}
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-error-status">Error Status *</Label>
                      <select
                        id="edit-error-status"
                        value={editingSupportData.error_status || 'pending'}
                        onChange={(e) => setEditingSupportData({...editingSupportData, error_status: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                      >
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                      </select>
                    </div>
                    <div>
                      <Label htmlFor="edit-note-solution">Note/Solution</Label>
                      <textarea
                        id="edit-note-solution"
                        value={editingSupportData.note_solution || ''}
                        onChange={(e) => setEditingSupportData({...editingSupportData, note_solution: e.target.value})}
                        rows={4}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] mt-1"
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditSupport}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Edit User Modal */}
          {showEditUserModal && editingUserData && editingUserId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-3xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit User</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditUser}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveUser(editingUserId); }} className="space-y-4">
                    <div>
                      <Label htmlFor="edit-user-name">Name *</Label>
                      <Input
                        id="edit-user-name"
                        value={editingUserData.name || ''}
                        onChange={(e) => setEditingUserData({...editingUserData, name: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-user-email">Email *</Label>
                      <Input
                        id="edit-user-email"
                        type="email"
                        value={editingUserData.email || ''}
                        onChange={(e) => setEditingUserData({...editingUserData, email: e.target.value})}
                        required
                        className="mt-1"
                      />
                    </div>
                    <div>
                      <Label htmlFor="edit-user-role">Role *</Label>
                      <select
                        id="edit-user-role"
                        value={editingUserData.role || 'user'}
                        onChange={(e) => setEditingUserData({...editingUserData, role: e.target.value})}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] mt-1"
                        required
                        disabled={editingUserData.role === 'super_admin'}
                      >
                        <option value="user">User</option>
                        <option value="vendor">Vendor</option>
                        {isSuperAdmin && <option value="admin">Admin</option>}
                      </select>
                      {editingUserData.role === 'super_admin' && (
                        <p className="text-xs text-[hsl(var(--muted-foreground))] mt-1">Super admin role cannot be changed</p>
                      )}
                    </div>
                    <div>
                      <Label>Location *</Label>
                      <div className="relative mt-1" ref={editingUserLocationDropdownRef}>
                        <button
                          type="button"
                          onClick={() => setEditingUserShowLocationDropdown(!editingUserShowLocationDropdown)}
                          className="w-full px-3 py-2 text-left border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] flex items-center justify-between"
                        >
                          <span>{buildEditingUserLocationString()}</span>
                          <span>{editingUserShowLocationDropdown ? '' : ''}</span>
                        </button>
                        {editingUserShowLocationDropdown && locationData?.provinces && (
                          <div className="absolute top-full left-0 mt-1 bg-[hsl(var(--background))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50 w-[500px] max-h-[400px] overflow-y-auto">
                            <div className="p-3">
                              <div className="flex items-center justify-between mb-3 pb-2 border-b border-[hsl(var(--border))]">
                                <span className="font-semibold text-xs text-[hsl(var(--foreground))]">Select Location</span>
                                <button
                                  type="button"
                                  onClick={handleEditingUserSelectAllLocations}
                                  className="text-xs text-[hsl(var(--primary))] hover:underline"
                                >
                                  {editingUserSelectedLocations.size > 0 ? 'Clear All' : 'Select All'}
                                </button>
                              </div>
                              {locationData.provinces.map((province) => (
                                <div key={province.id} className="mb-2">
                                  <div className="flex items-center py-1">
                                    <button
                                      type="button"
                                      onClick={() => toggleEditingUserProvince(province.id)}
                                      className="mr-2 text-xs"
                                    >
                                      {editingUserExpandedProvinces.has(province.id) ? '' : ''}
                                    </button>
                                    <input
                                      type="checkbox"
                                      className="mr-2"
                                      checked={(() => {
                                        const wardIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                wardIds.push(w.id.toString());
                                              });
                                            }
                                          });
                                        });
                                        return wardIds.length > 0 && wardIds.every(id => editingUserSelectedLocations.has(id));
                                      })()}
                                      onChange={() => {
                                        const wardIds = [];
                                        province.districts.forEach(d => {
                                          d.localLevels.forEach(ll => {
                                            if (ll.wards) {
                                              ll.wards.forEach(w => {
                                                wardIds.push(w.id.toString());
                                              });
                                            }
                                          });
                                        });
                                        setEditingUserSelectedLocations(prev => {
                                          const newSet = new Set(prev);
                                          const allSelected = wardIds.every(id => newSet.has(id));
                                          wardIds.forEach(id => {
                                            if (allSelected) {
                                              newSet.delete(id);
                                            } else {
                                              newSet.add(id);
                                            }
                                          });
                                          return newSet;
                                        });
                                      }}
                                    />
                                    <span className="text-xs font-medium">{province.name}</span>
                                  </div>
                                  {editingUserExpandedProvinces.has(province.id) && province.districts.map((district) => (
                                    <div key={district.id} className="ml-4 mt-1">
                                      <div className="flex items-center py-1">
                                        <button
                                          type="button"
                                          onClick={() => toggleEditingUserDistrict(`${province.id}-${district.id}`)}
                                          className="mr-2 text-xs"
                                        >
                                          {editingUserExpandedDistricts.has(`${province.id}-${district.id}`) ? '' : ''}
                                        </button>
                                        <input
                                          type="checkbox"
                                          className="mr-2"
                                          checked={(() => {
                                            const wardIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  wardIds.push(w.id.toString());
                                                });
                                              }
                                            });
                                            return wardIds.length > 0 && wardIds.every(id => editingUserSelectedLocations.has(id));
                                          })()}
                                          onChange={() => {
                                            const wardIds = [];
                                            district.localLevels.forEach(ll => {
                                              if (ll.wards) {
                                                ll.wards.forEach(w => {
                                                  wardIds.push(w.id.toString());
                                                });
                                              }
                                            });
                                            setEditingUserSelectedLocations(prev => {
                                              const newSet = new Set(prev);
                                              const allSelected = wardIds.every(id => newSet.has(id));
                                              wardIds.forEach(id => {
                                                if (allSelected) {
                                                  newSet.delete(id);
                                                } else {
                                                  newSet.add(id);
                                                }
                                              });
                                              return newSet;
                                            });
                                          }}
                                        />
                                        <span className="text-xs">{district.name}</span>
                                      </div>
                                      {editingUserExpandedDistricts.has(`${province.id}-${district.id}`) && district.localLevels.map((localLevel) => (
                                        <div key={localLevel.id} className="ml-4 mt-1">
                                          <div className="flex items-center py-1">
                                            <button
                                              type="button"
                                              onClick={() => toggleEditingUserLocalLevel(`${province.id}-${district.id}-${localLevel.id}`)}
                                              className="mr-2 text-xs"
                                            >
                                              {editingUserExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) ? '' : ''}
                                            </button>
                                            <input
                                              type="checkbox"
                                              className="mr-2"
                                              checked={(() => {
                                                if (!localLevel.wards) return false;
                                                const wardIds = localLevel.wards.map(w => w.id.toString());
                                                return wardIds.length > 0 && wardIds.every(id => editingUserSelectedLocations.has(id));
                                              })()}
                                              onChange={() => {
                                                if (localLevel.wards) {
                                                  const wardIds = localLevel.wards.map(w => w.id.toString());
                                                  setEditingUserSelectedLocations(prev => {
                                                    const newSet = new Set(prev);
                                                    const allSelected = wardIds.every(id => newSet.has(id));
                                                    wardIds.forEach(id => {
                                                      if (allSelected) {
                                                        newSet.delete(id);
                                                      } else {
                                                        newSet.add(id);
                                                      }
                                                    });
                                                    return newSet;
                                                  });
                                                }
                                              }}
                                            />
                                            <span className="text-xs">{localLevel.name}</span>
                                          </div>
                                          {editingUserExpandedLocalLevels.has(`${province.id}-${district.id}-${localLevel.id}`) && localLevel.wards && localLevel.wards.map((ward) => (
                                            <div key={ward.id} className="ml-4 mt-1">
                                              <div className="flex items-center py-1">
                                                <input
                                                  type="checkbox"
                                                  className="mr-2"
                                                  checked={(() => {
                                                    const wardIdStr = ward.id.toString();
                                                    const hasWard = editingUserSelectedLocations.has(wardIdStr);
                                                    if (ward.local_addresses) {
                                                      const hasLocalAddress = ward.local_addresses.some((_, idx) => 
                                                        editingUserSelectedLocations.has(`${ward.id}-${idx}`)
                                                      );
                                                      return hasWard || hasLocalAddress;
                                                    }
                                                    return hasWard;
                                                  })()}
                                                  onChange={() => {
                                                    setEditingUserSelectedLocations(prev => {
                                                      const newSet = new Set(prev);
                                                      const wardIdStr = ward.id.toString();
                                                      const hasWard = newSet.has(wardIdStr);
                                                      const hasLocalAddresses = ward.local_addresses && ward.local_addresses.some((_, idx) => 
                                                        newSet.has(`${ward.id}-${idx}`)
                                                      );
                                                      const isSelected = hasWard || hasLocalAddresses;
                                                      
                                                      if (isSelected) {
                                                        newSet.delete(wardIdStr);
                                                        if (ward.local_addresses) {
                                                          ward.local_addresses.forEach((_, idx) => {
                                                            newSet.delete(`${ward.id}-${idx}`);
                                                          });
                                                        }
                                                      } else {
                                                        newSet.add(wardIdStr);
                                                      }
                                                      return newSet;
                                                    });
                                                  }}
                                                />
                                                <span className="text-xs">Ward {ward.ward_number}</span>
                                              </div>
                                              {ward.local_addresses && ward.local_addresses.length > 0 && (
                                                <div className="ml-4 mt-1 space-y-1">
                                                  {ward.local_addresses.map((address, idx) => {
                                                    const addressId = `${ward.id}-${idx}`;
                                                    const addressName = typeof address === 'string' ? address : address.name || address;
                                                    return (
                                                      <div key={addressId} className="flex items-center py-1">
                                                        <input
                                                          type="checkbox"
                                                          className="mr-2"
                                                          checked={editingUserSelectedLocations.has(addressId)}
                                                          onChange={() => {
                                                            setEditingUserSelectedLocations(prev => {
                                                              const newSet = new Set(prev);
                                                              const wardIdStr = ward.id.toString();
                                                              
                                                              if (newSet.has(addressId)) {
                                                                newSet.delete(addressId);
                                                                newSet.delete(wardIdStr);
                                                              } else {
                                                                newSet.add(addressId);
                                                                newSet.add(wardIdStr);
                                                              }
                                                              return newSet;
                                                            });
                                                          }}
                                                        />
                                                        <span className="text-xs">{addressName}</span>
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      ))}
                                    </div>
                                  ))}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                    <div>
                      <Label htmlFor="edit-user-comment">Comment</Label>
                      <textarea
                        id="edit-user-comment"
                        value={editingUserData.comment || ''}
                        onChange={(e) => setEditingUserData({...editingUserData, comment: e.target.value})}
                        rows={3}
                        className="w-full px-3 py-2 border border-[hsl(var(--input))] rounded-md bg-[hsl(var(--background))] text-[hsl(var(--foreground))] focus:outline-none focus:ring-2 focus:ring-[hsl(var(--ring))] mt-1"
                        placeholder="Enter comment about this user..."
                      />
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                      <Button type="button" variant="ghost" onClick={handleCancelEditUser}>Cancel</Button>
                      <Button type="submit">Save Changes</Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Edit eBook Modal */}
          {showEditEbookModal && editingEbookData && editingEbookId && (
            <div className="fixed inset-0 flex items-center justify-center z-50" style={{ backgroundColor: 'rgba(0, 0, 0, 0.4)' }}>
              <Card className="w-full max-w-3xl max-h-[90vh] overflow-y-auto px-4 mx-auto">
                <CardHeader className="flex flex-row items-center justify-between">
                  <CardTitle>Edit eBook</CardTitle>
                  <Button variant="ghost" size="sm" onClick={handleCancelEditEbook}></Button>
                </CardHeader>
                <CardContent className="p-6">
                  <form
                    onSubmit={(e) => {
                      e.preventDefault();
                      handleSaveEbook();
                    }}
                    className="space-y-4"
                  >
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label>User (Seller) *</Label>
                        <select
                          value={editingEbookData.user_id || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, user_id: e.target.value })}
                          className="w-full px-3 py-2 border rounded-md"
                          required
                        >
                          <option value="">Select User</option>
                          {users
                            .filter(u => u.role === 'super_admin' || (u.role !== 'admin' && u.seller_verified))
                            .map(u => (
                              <option key={u.id} value={u.id}>
                                {u.name} ({u.email}) {u.role === 'super_admin' ? ' Super Admin' : ' Verified'}
                              </option>
                            ))}
                        </select>
                      </div>
                      <div>
                        <Label>Category</Label>
                        <select
                          value={editingEbookData.category_id || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, category_id: e.target.value })}
                          className="w-full px-3 py-2 border rounded-md"
                        >
                          <option value="">Select Category</option>
                          {flattenedCategories.map((cat, idx) => (
                            <option key={`${cat.id}-${idx}`} value={cat.id}>{cat.name}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div>
                      <Label>Title *</Label>
                      <Input
                        value={editingEbookData.title || ''}
                        onChange={(e) => setEditingEbookData({ ...editingEbookData, title: e.target.value })}
                        required
                      />
                    </div>
                    <div>
                      <Label>Description</Label>
                      <textarea
                        value={editingEbookData.description || ''}
                        onChange={(e) => setEditingEbookData({ ...editingEbookData, description: e.target.value })}
                        className="w-full px-3 py-2 border rounded-md"
                        rows="3"
                      />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <Label>Writer</Label>
                        <Input
                          value={editingEbookData.writer || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, writer: e.target.value })}
                        />
                      </div>
                      <div>
                        <Label>Language</Label>
                        <Input
                          value={editingEbookData.language || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, language: e.target.value })}
                        />
                      </div>
                      <div>
                        <Label>Pages</Label>
                        <Input
                          type="number"
                          value={editingEbookData.pages || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, pages: e.target.value })}
                        />
                      </div>
                    </div>
                    <div className="mt-4 space-y-2">
                      <p className="text-sm font-semibold text-[hsl(var(--foreground))]">Publisher Information (optional)</p>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="col-span-2">
                          <Label>Publisher Name (Company or Person)</Label>
                          <Input
                            value={editingEbookData.publisher_name || ''}
                            onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_name: e.target.value })}
                          />
                        </div>
                        <div className="col-span-2">
                          <Label>Publisher Address</Label>
                          <textarea
                            value={editingEbookData.publisher_address || ''}
                            onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_address: e.target.value })}
                            className="w-full px-3 py-2 border rounded-md"
                            rows="2"
                          />
                        </div>
                        <div>
                          <Label>Publisher Email</Label>
                          <Input
                            type="email"
                            value={editingEbookData.publisher_email || ''}
                            onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_email: e.target.value })}
                          />
                        </div>
                        <div>
                          <Label>Publisher Phone</Label>
                          <Input
                            value={editingEbookData.publisher_phone || ''}
                            onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_phone: e.target.value })}
                          />
                        </div>
                        <div className="col-span-2">
                          <Label>Publisher Website</Label>
                          <Input
                            type="url"
                            placeholder="https://example.com"
                            value={editingEbookData.publisher_website || ''}
                            onChange={(e) => setEditingEbookData({ ...editingEbookData, publisher_website: e.target.value })}
                          />
                        </div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label>Price *</Label>
                        <Input
                          type="number"
                          step="0.01"
                          min="0"
                          value={editingEbookData.price || ''}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, price: e.target.value })}
                          required
                        />
                      </div>
                      <div>
                        <Label>Book Type *</Label>
                        <select
                          value={editingEbookData.book_type || 'ebook'}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, book_type: e.target.value })}
                          className="w-full px-3 py-2 border rounded-md"
                          required
                        >
                          <option value="ebook">eBook</option>
                          <option value="hard_copy">Hard Copy</option>
                          <option value="both">Both</option>
                        </select>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label>Replace eBook File (optional)</Label>
                        <Input
                          type="file"
                          accept=".pdf,.epub,.mobi,.doc,.docx"
                          onChange={(e) => setEbookFile(e.target.files[0])}
                        />
                      </div>
                      <div>
                        <Label>Replace Cover Image (optional) - 400x400px</Label>
                        <Input
                          type="file"
                          accept="image/*"
                          onChange={(e) => {
                            const file = e.target.files[0];
                            if (file) {
                              // Validate file size (max 10MB before crop)
                              if (file.size > 10 * 1024 * 1024) {
                                setError('Image size must be less than 10MB');
                                setTimeout(() => setError(null), 3000);
                                return;
                              }
                              // Open crop modal for eBook cover
                              setCropImageIndex('ebook-cover');
                              setCropImageFile(file);
                              setCropImageType('ebook-cover');
                            }
                            e.target.value = ''; // Clear input
                          }}
                        />
                      </div>
                    </div>
                    <div>
                      <Label>
                        <input
                          type="checkbox"
                          checked={!!editingEbookData.copyright_declared}
                          onChange={(e) => setEditingEbookData({ ...editingEbookData, copyright_declared: e.target.checked })}
                        />
                        {' '}Copyright Declared
                      </Label>
                    </div>
                    <div className="flex justify-end gap-2">
                      <Button type="button" variant="ghost" onClick={handleCancelEditEbook}>
                        Cancel
                      </Button>
                      <Button type="submit">
                        Save Changes
                      </Button>
                    </div>
                  </form>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Photo Crop Modal */}
          {cropImageFile && (
            <PhotoCropModal
              imageFile={cropImageFile}
              onCropComplete={handleCropComplete}
              onCancel={handleCropCancel}
              aspectRatio={1}
              minWidth={400}
              minHeight={400}
              fixedSize={{ width: 400, height: 400 }}
            />
          )}

          {activeSection === 'nepali-products' && (
            <section>
              {nepaliProductsLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading products...
                </div>
              )}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">Nepali Products Review</h2>
                    <div className="flex gap-2">
                      <select
                        value={nepaliProductsStatusFilter}
                        onChange={(e) => setNepaliProductsStatusFilter(e.target.value)}
                        className="px-3 py-2 border rounded-md"
                      >
                        <option value="pending">Pending Review</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                      </select>
                    </div>
                  </div>

                  {nepaliProducts.length === 0 ? (
                    <p className="text-center text-[hsl(var(--muted-foreground))] py-8">
                      No {nepaliProductsStatusFilter} products found.
                    </p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b">
                            <th className="text-left p-2">Image</th>
                            <th className="text-left p-2">Title</th>
                            <th className="text-left p-2">Company</th>
                            <th className="text-left p-2">Owner</th>
                            <th className="text-left p-2">Price</th>
                            <th className="text-left p-2">Status</th>
                            <th className="text-left p-2">Created</th>
                            <th className="text-left p-2">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {nepaliProducts.map((product) => (
                            <tr key={product.id} className="border-b hover:bg-[hsl(var(--accent))]">
                              <td className="p-2">
                                {product.primary_image ? (
                                  <img
                                    src={product.primary_image}
                                    alt={product.title}
                                    className="w-16 h-16 object-cover rounded"
                                  />
                                ) : (
                                  <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-500">
                                    No Image
                                  </div>
                                )}
                              </td>
                              <td className="p-2">
                                <button
                                  onClick={() => setViewingNepaliProduct(product)}
                                  className="text-blue-600 hover:underline"
                                >
                                  {product.title}
                                </button>
                              </td>
                              <td className="p-2">{product.company_name}</td>
                              <td className="p-2">{product.user?.name || 'N/A'}</td>
                              <td className="p-2">Rs. {product.retail_price || '0.00'}</td>
                              <td className="p-2">
                                <span className={`px-2 py-1 rounded text-xs ${
                                  product.status === 'approved' ? 'bg-green-100 text-green-800' :
                                  product.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                  'bg-yellow-100 text-yellow-800'
                                }`}>
                                  {product.status}
                                </span>
                              </td>
                              <td className="p-2 text-sm text-[hsl(var(--muted-foreground))]">
                                {new Date(product.created_at).toLocaleDateString()}
                              </td>
                              <td className="p-2">
                                <div className="flex gap-2">
                                  {product.status === 'pending' && (
                                    <>
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => handleApproveNepaliProduct(product.id)}
                                        className="text-green-600 hover:text-green-700"
                                      >
                                        Approve
                                      </Button>
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => {
                                          const reason = prompt('Rejection reason (optional):');
                                          handleRejectNepaliProduct(product.id, reason || '');
                                        }}
                                        className="text-red-600 hover:text-red-700"
                                      >
                                        Reject
                                      </Button>
                                    </>
                                  )}
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => setViewingNepaliProduct(product)}
                                  >
                                    View
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => handleDeleteNepaliProduct(product.id)}
                                    className="text-red-600 hover:text-red-700"
                                  >
                                    Delete
                                  </Button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Product Detail Modal */}
              {viewingNepaliProduct && (
                <Card className="mt-4">
                  <CardContent className="p-6">
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="text-xl font-semibold">{viewingNepaliProduct.title}</h3>
                      <Button variant="ghost" onClick={() => setViewingNepaliProduct(null)}></Button>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <h4 className="font-semibold mb-2">Product Images</h4>
                        <div className="grid grid-cols-4 gap-2">
                          {viewingNepaliProduct.images?.map((img, idx) => (
                            <img
                              key={idx}
                              src={img.image_url || img}
                              alt={`${viewingNepaliProduct.title} ${idx + 1}`}
                              className="w-full h-24 object-cover rounded"
                            />
                          ))}
                        </div>
                      </div>
                      <div>
                        <h4 className="font-semibold mb-2">Product Details</h4>
                        <div className="space-y-2 text-sm">
                          <p><strong>Company:</strong> {viewingNepaliProduct.company_name}</p>
                          <p><strong>Category:</strong> {viewingNepaliProduct.category?.name || 'N/A'}</p>
                          <p><strong>Price:</strong> Rs. {viewingNepaliProduct.retail_price}</p>
                          <p><strong>Status:</strong> <span className={`px-2 py-1 rounded text-xs ${
                            viewingNepaliProduct.status === 'approved' ? 'bg-green-100 text-green-800' :
                            viewingNepaliProduct.status === 'rejected' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                          }`}>{viewingNepaliProduct.status}</span></p>
                          <p><strong>Made in Nepal:</strong> {viewingNepaliProduct.is_made_in_nepal ? 'Yes' : 'No'}</p>
                          <p><strong>Nepali Address:</strong> {viewingNepaliProduct.has_nepali_address ? 'Yes' : 'No'}</p>
                        </div>
                      </div>
                    </div>
                    {viewingNepaliProduct.status === 'pending' && (
                      <div className="mt-4 flex gap-2">
                        <Button
                          onClick={() => {
                            handleApproveNepaliProduct(viewingNepaliProduct.id);
                            setViewingNepaliProduct(null);
                          }}
                          className="bg-green-600 hover:bg-green-700"
                        >
                          Approve Product
                        </Button>
                        <Button
                          variant="outline"
                          onClick={() => {
                            const reason = prompt('Rejection reason (optional):');
                            handleRejectNepaliProduct(viewingNepaliProduct.id, reason || '');
                            setViewingNepaliProduct(null);
                          }}
                          className="text-red-600 hover:text-red-700"
                        >
                          Reject Product
                        </Button>
                      </div>
                    )}
                  </CardContent>
                </Card>
              )}
            </section>
          )}

          {activeSection === 'order-management' && (
            <section>
              {ordersLoading && (
                <div className="mb-4 text-center text-[hsl(var(--muted-foreground))]">
                  Loading orders...
                </div>
              )}
              <Card>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-semibold text-[hsl(var(--foreground))]">Order Management</h2>
                    <select
                      value={ordersStatusFilter}
                      onChange={(e) => setOrdersStatusFilter(e.target.value)}
                      className="px-3 py-2 border rounded-md"
                    >
                      <option value="">All Orders</option>
                      <option value="pending">Pending</option>
                      <option value="processing">Processing</option>
                      <option value="shipped">Shipped</option>
                      <option value="completed">Completed</option>
                      <option value="cancelled">Cancelled</option>
                      <option value="failed">Failed</option>
                    </select>
                  </div>

                  {orders.length === 0 ? (
                    <p className="text-center text-[hsl(var(--muted-foreground))] py-8">
                      No orders found.
                    </p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="border-b">
                            <th className="text-left p-2">Order ID</th>
                            <th className="text-left p-2">Customer</th>
                            <th className="text-left p-2">Product</th>
                            <th className="text-left p-2">Quantity</th>
                            <th className="text-left p-2">Total</th>
                            <th className="text-left p-2">Status</th>
                            <th className="text-left p-2">Date</th>
                            <th className="text-left p-2">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {orders.map((order) => (
                            <tr key={order.id} className="border-b hover:bg-[hsl(var(--accent))]">
                              <td className="p-2">#{order.id}</td>
                              <td className="p-2">{order.user?.name || 'N/A'}</td>
                              <td className="p-2">
                                <button
                                  onClick={() => setViewingOrder(order)}
                                  className="text-blue-600 hover:underline"
                                >
                                  {order.title}
                                </button>
                              </td>
                              <td className="p-2">{order.quantity}</td>
                              <td className="p-2">Rs. {order.total?.toLocaleString()}</td>
                              <td className="p-2">
                                <span className={`px-2 py-1 rounded text-xs ${
                                  order.status === 'completed' ? 'bg-green-100 text-green-800' :
                                  order.status === 'cancelled' || order.status === 'failed' ? 'bg-red-100 text-red-800' :
                                  order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-blue-100 text-blue-800'
                                }`}>
                                  {order.status}
                                </span>
                              </td>
                              <td className="p-2 text-sm text-[hsl(var(--muted-foreground))]">
                                {new Date(order.created_at).toLocaleDateString()}
                              </td>
                              <td className="p-2">
                                <div className="flex gap-2">
                                  <select
                                    value={order.status}
                                    onChange={(e) => handleUpdateOrderStatus(order.id, e.target.value)}
                                    className="text-xs px-2 py-1 border rounded"
                                  >
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="failed">Failed</option>
                                  </select>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={() => setViewingOrder(order)}
                                  >
                                    View
                                  </Button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Order Detail Modal */}
              {viewingOrder && (
                <Card className="mt-4">
                  <CardContent className="p-6">
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="text-xl font-semibold">Order #{viewingOrder.id}</h3>
                      <Button variant="ghost" onClick={() => setViewingOrder(null)}></Button>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <h4 className="font-semibold mb-2">Order Details</h4>
                        <div className="space-y-2 text-sm">
                          <p><strong>Customer:</strong> {viewingOrder.user?.name || 'N/A'}</p>
                          <p><strong>Email:</strong> {viewingOrder.user?.email || 'N/A'}</p>
                          <p><strong>Product:</strong> {viewingOrder.title}</p>
                          <p><strong>Quantity:</strong> {viewingOrder.quantity}</p>
                          <p><strong>Price:</strong> Rs. {viewingOrder.price?.toLocaleString()}</p>
                          <p><strong>Total:</strong> Rs. {viewingOrder.total?.toLocaleString()}</p>
                          <p><strong>Status:</strong> <span className={`px-2 py-1 rounded text-xs ${
                            viewingOrder.status === 'completed' ? 'bg-green-100 text-green-800' :
                            viewingOrder.status === 'cancelled' || viewingOrder.status === 'failed' ? 'bg-red-100 text-red-800' :
                            viewingOrder.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-blue-100 text-blue-800'
                          }`}>{viewingOrder.status}</span></p>
                          {viewingOrder.payment_id && <p><strong>Payment ID:</strong> {viewingOrder.payment_id}</p>}
                          <p><strong>Order Date:</strong> {new Date(viewingOrder.created_at).toLocaleString()}</p>
                        </div>
                      </div>
                      {viewingOrder.ad && (
                        <div>
                          <h4 className="font-semibold mb-2">Product Image</h4>
                          {viewingOrder.ad.photos?.[0] && (
                            <img
                              src={viewingOrder.ad.photos[0].photo_url}
                              alt={viewingOrder.title}
                              className="w-full h-48 object-cover rounded"
                            />
                          )}
                        </div>
                      )}
                    </div>
                    <div className="mt-4">
                      <label className="block mb-2">Update Status</label>
                      <select
                        value={viewingOrder.status}
                        onChange={(e) => {
                          handleUpdateOrderStatus(viewingOrder.id, e.target.value);
                          setViewingOrder({...viewingOrder, status: e.target.value});
                        }}
                        className="w-full px-3 py-2 border rounded-md"
                      >
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="failed">Failed</option>
                      </select>
                    </div>
                  </CardContent>
                </Card>
              )}
            </section>
          )}
        </main>
      </div>
    </Layout>
  );
}

export default AdminPanel;

